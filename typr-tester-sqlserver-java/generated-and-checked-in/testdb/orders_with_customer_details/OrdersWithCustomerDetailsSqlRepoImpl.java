/**
 * File has been automatically generated by `typo`.
 *
 * <p>IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.orders_with_customer_details;

import static typr.runtime.Fragment.interpolate;

import java.math.BigDecimal;
import java.sql.Connection;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;
import typr.runtime.Fragment;
import typr.runtime.SqlServerTypes;

public class OrdersWithCustomerDetailsSqlRepoImpl implements OrdersWithCustomerDetailsSqlRepo {
  @Override
  public List<OrdersWithCustomerDetailsSqlRow> apply(
      Optional<BigDecimal> minAmount, Optional<LocalDateTime> startDate, Connection c) {
    return interpolate(
            Fragment.lit(
                "-- Get orders with full customer details\n"
                    + "SELECT\n"
                    + "    o.order_id,\n"
                    + "    o.order_date,\n"
                    + "    o.total_amount,\n"
                    + "    c.customer_id,\n"
                    + "    c.name as customer_name,\n"
                    + "    c.email as customer_email\n"
                    + "FROM orders o\n"
                    + "INNER JOIN customers c ON o.customer_id = c.customer_id\n"
                    + "WHERE ("),
            Fragment.encode(SqlServerTypes.numeric.opt(), minAmount),
            Fragment.lit(" IS NULL OR o.total_amount >= "),
            Fragment.encode(SqlServerTypes.numeric.opt(), minAmount),
            Fragment.lit(")\n  AND ("),
            Fragment.encode(SqlServerTypes.datetime2.opt(), startDate),
            Fragment.lit(" IS NULL OR o.order_date >= "),
            Fragment.encode(SqlServerTypes.datetime2.opt(), startDate),
            Fragment.lit(")\nORDER BY o.order_date DESC\n"))
        .query(OrdersWithCustomerDetailsSqlRow._rowParser.all())
        .runUnchecked(c);
  }
  ;
}
