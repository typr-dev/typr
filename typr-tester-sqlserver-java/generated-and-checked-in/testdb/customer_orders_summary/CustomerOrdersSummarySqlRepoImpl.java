/**
 * File has been automatically generated by `typo`.
 *
 * <p>IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.customer_orders_summary;

import static typr.runtime.Fragment.interpolate;

import java.math.BigDecimal;
import java.sql.Connection;
import java.util.List;
import java.util.Optional;
import typr.runtime.Fragment;
import typr.runtime.SqlServerTypes;

public class CustomerOrdersSummarySqlRepoImpl implements CustomerOrdersSummarySqlRepo {
  @Override
  public List<CustomerOrdersSummarySqlRow> apply(
      Optional<String> customerNamePattern, Optional<BigDecimal> minTotal, Connection c) {
    return interpolate(
            Fragment.lit(
                "-- Get order summary statistics for customers\n"
                    + "SELECT\n"
                    + "    c.customer_id,\n"
                    + "    c.name as customer_name,\n"
                    + "    c.email as customer_email,\n"
                    + "    COUNT(o.order_id) as order_count,\n"
                    + "    COALESCE(SUM(o.total_amount), 0) as total_spent,\n"
                    + "    COALESCE(AVG(o.total_amount), 0) as avg_order_amount,\n"
                    + "    MAX(o.order_date) as last_order_date\n"
                    + "FROM customers c\n"
                    + "LEFT JOIN orders o ON c.customer_id = o.customer_id\n"
                    + "WHERE ("),
            Fragment.encode(SqlServerTypes.nvarchar.opt(), customerNamePattern),
            Fragment.lit(" IS NULL OR c.name LIKE "),
            Fragment.encode(SqlServerTypes.nvarchar.opt(), customerNamePattern),
            Fragment.lit(
                ")\n"
                    + "GROUP BY c.customer_id, c.name, c.email\n"
                    + "HAVING COUNT(o.order_id) > 0\n"
                    + "  AND ("),
            Fragment.encode(SqlServerTypes.numeric.opt(), minTotal),
            Fragment.lit(" IS NULL OR COALESCE(SUM(o.total_amount), 0) >= "),
            Fragment.encode(SqlServerTypes.numeric.opt(), minTotal),
            Fragment.lit(")\nORDER BY total_spent DESC\n"))
        .query(CustomerOrdersSummarySqlRow._rowParser.all())
        .runUnchecked(c);
  }
  ;
}
