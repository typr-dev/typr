/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.customer_orders_summary

import java.math.BigDecimal
import java.sql.Connection
import kotlin.collections.List
import typo.kotlindsl.Fragment
import typo.kotlindsl.KotlinDbTypes
import typo.kotlindsl.nullable
import typo.runtime.SqlServerTypes

class CustomerOrdersSummarySqlRepoImpl() : CustomerOrdersSummarySqlRepo {
  override fun apply(
    customerNamePattern: String?,
    minTotal: BigDecimal?,
    c: Connection
  ): List<CustomerOrdersSummarySqlRow> = Fragment.interpolate(Fragment.lit("-- Get order summary statistics for customers\nSELECT\n    c.customer_id,\n    c.name as customer_name,\n    c.email as customer_email,\n    COUNT(o.order_id) as order_count,\n    COALESCE(SUM(o.total_amount), 0) as total_spent,\n    COALESCE(AVG(o.total_amount), 0) as avg_order_amount,\n    MAX(o.order_date) as last_order_date\nFROM customers c\nLEFT JOIN orders o ON c.customer_id = o.customer_id\nWHERE ("), Fragment.encode(SqlServerTypes.nvarchar.nullable(), customerNamePattern), Fragment.lit(" IS NULL OR c.name LIKE "), Fragment.encode(SqlServerTypes.nvarchar.nullable(), customerNamePattern), Fragment.lit(")\nGROUP BY c.customer_id, c.name, c.email\nHAVING COUNT(o.order_id) > 0\n  AND ("), Fragment.encode(KotlinDbTypes.SqlServerTypes.numeric.nullable(), minTotal), Fragment.lit(" IS NULL OR COALESCE(SUM(o.total_amount), 0) >= "), Fragment.encode(KotlinDbTypes.SqlServerTypes.numeric.nullable(), minTotal), Fragment.lit(")\nORDER BY total_spent DESC\n")).query(CustomerOrdersSummarySqlRow._rowParser.all()).runUnchecked(c)
}