/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.product_details_with_sales

import java.sql.Connection
import typr.runtime.DuckDbTypes
import typr.scaladsl.DuckDbTypeOps
import typr.scaladsl.Fragment
import typr.scaladsl.ScalaDbTypes
import typr.scaladsl.Fragment.sql

class ProductDetailsWithSalesSqlRepoImpl extends ProductDetailsWithSalesSqlRepo {
  override def apply(
    productIds: Option[Array[Int]],
    skuPattern: Option[String],
    minPrice: Option[BigDecimal],
    maxPrice: Option[BigDecimal]
  )(using c: Connection): List[ProductDetailsWithSalesSqlRow] = {
    sql"""-- Product details with sales statistics and JSON metadata
    -- Tests: JSON column handling, complex aggregations, CASE expressions
  
    SELECT
        p.product_id,
        p.sku,
        p.name,
        p.price,
        p.metadata,
        COUNT(DISTINCT oi.order_id) AS times_ordered,
        COALESCE(SUM(oi.quantity), 0) AS total_quantity_sold,
        COALESCE(SUM(oi.quantity * oi.unit_price), 0.0) AS total_revenue,
        CASE
            WHEN COUNT(DISTINCT oi.order_id) = 0 THEN 'never_ordered'
            WHEN COUNT(DISTINCT oi.order_id) < 5 THEN 'low'
            WHEN COUNT(DISTINCT oi.order_id) < 20 THEN 'medium'
            ELSE 'high'
        END AS popularity
    FROM products p
    LEFT JOIN order_items oi ON p.product_id = oi.product_id
    WHERE
        (${Fragment.encode(ScalaDbTypes.DuckDbTypes.integerArrayUnboxed.nullable, productIds)} IS NULL OR p.product_id = ANY(CAST(${Fragment.encode(ScalaDbTypes.DuckDbTypes.integerArrayUnboxed.nullable, productIds)} AS INTEGER[])))
        AND (${Fragment.encode(DuckDbTypes.text.nullable, skuPattern)} IS NULL OR p.sku LIKE CAST(${Fragment.encode(DuckDbTypes.text.nullable, skuPattern)} AS VARCHAR))
        AND (${Fragment.encode(ScalaDbTypes.DuckDbTypes.numeric.nullable, minPrice)} IS NULL OR p.price >= CAST(${Fragment.encode(ScalaDbTypes.DuckDbTypes.numeric.nullable, minPrice)} AS DECIMAL))
        AND (${Fragment.encode(ScalaDbTypes.DuckDbTypes.numeric.nullable, maxPrice)} IS NULL OR p.price <= CAST(${Fragment.encode(ScalaDbTypes.DuckDbTypes.numeric.nullable, maxPrice)} AS DECIMAL))
    GROUP BY p.product_id, p.sku, p.name, p.price, p.metadata
    ORDER BY total_revenue DESC""".query(ProductDetailsWithSalesSqlRow.`_rowParser`.all()).runUnchecked(c)
  }
}