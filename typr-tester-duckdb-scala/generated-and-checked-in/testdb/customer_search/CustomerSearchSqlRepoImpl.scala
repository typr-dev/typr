/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.customer_search

import java.sql.Connection
import java.time.LocalDateTime
import testdb.Priority
import typr.runtime.DuckDbTypes
import typr.scaladsl.DuckDbTypeOps
import typr.scaladsl.Fragment
import typr.scaladsl.ScalaDbTypes
import typr.scaladsl.Fragment.sql

class CustomerSearchSqlRepoImpl extends CustomerSearchSqlRepo {
  override def apply(
    namePattern: Option[String],
    emailPattern: Option[String],
    minPriority: Option[/* user-picked */ Priority],
    createdAfter: Option[LocalDateTime],
    maxResults: Long
  )(using c: Connection): List[CustomerSearchSqlRow] = {
    sql"""-- Customer search with multiple optional filters and enum handling
    -- Tests: optional parameters, enum types, LIKE patterns, complex WHERE
  
    SELECT
        customer_id,
        name,
        email,
        created_at,
        priority
    FROM customers
    WHERE
        (${Fragment.encode(DuckDbTypes.varchar.nullable, namePattern)} IS NULL OR name LIKE ${Fragment.encode(DuckDbTypes.varchar.nullable, namePattern)})
        AND (${Fragment.encode(DuckDbTypes.varchar.nullable, emailPattern)} IS NULL OR email LIKE ${Fragment.encode(DuckDbTypes.varchar.nullable, emailPattern)})
        AND (${Fragment.encode(Priority.duckDbType.nullable, minPriority)} IS NULL OR priority >= ${Fragment.encode(Priority.duckDbType.nullable, minPriority)})
        AND (${Fragment.encode(DuckDbTypes.timestamp.nullable, createdAfter)} IS NULL OR created_at >= ${Fragment.encode(DuckDbTypes.timestamp.nullable, createdAfter)})
    ORDER BY created_at DESC, customer_id
    LIMIT ${Fragment.encode(ScalaDbTypes.DuckDbTypes.bigint, maxResults)}""".query(CustomerSearchSqlRow.`_rowParser`.all()).runUnchecked(c)
  }
}