/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.department_employee_details

import java.sql.Connection
import java.time.LocalDate
import typr.runtime.DuckDbTypes
import typr.scaladsl.DuckDbTypeOps
import typr.scaladsl.Fragment
import typr.scaladsl.ScalaDbTypes
import typr.scaladsl.Fragment.sql

class DepartmentEmployeeDetailsSqlRepoImpl extends DepartmentEmployeeDetailsSqlRepo {
  override def apply(
    deptCode: Option[String],
    deptRegion: Option[String],
    minSalary: Option[BigDecimal],
    hiredAfter: Option[LocalDate]
  )(using c: Connection): List[DepartmentEmployeeDetailsSqlRow] = {
    sql"""-- Department and employee details with composite key handling
    -- Tests: composite primary keys, composite foreign keys, multiple table joins
  
    SELECT
        d.dept_code,
        d.dept_region,
        d.dept_name,
        d.budget,
        e.emp_number,
        e.emp_suffix,
        e.emp_name,
        e.salary,
        e.hire_date,
        -- Calculate years of service
        DATE_DIFF('year', e.hire_date, CURRENT_DATE) AS years_of_service
    FROM departments d
    LEFT JOIN employees e ON d.dept_code = e.dept_code AND d.dept_region = e.dept_region
    WHERE
        (${Fragment.encode(DuckDbTypes.varchar.nullable, deptCode)} IS NULL OR d.dept_code = ${Fragment.encode(DuckDbTypes.varchar.nullable, deptCode)})
        AND (${Fragment.encode(DuckDbTypes.varchar.nullable, deptRegion)} IS NULL OR d.dept_region = ${Fragment.encode(DuckDbTypes.varchar.nullable, deptRegion)})
        AND (${Fragment.encode(ScalaDbTypes.DuckDbTypes.numeric.nullable, minSalary)} IS NULL OR e.salary >= ${Fragment.encode(ScalaDbTypes.DuckDbTypes.numeric.nullable, minSalary)})
        AND (${Fragment.encode(DuckDbTypes.date.nullable, hiredAfter)} IS NULL OR e.hire_date >= ${Fragment.encode(DuckDbTypes.date.nullable, hiredAfter)})
    ORDER BY d.dept_code, d.dept_region, e.emp_number""".query(DepartmentEmployeeDetailsSqlRow.`_rowParser`.all()).runUnchecked(c)
  }
}