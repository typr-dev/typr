/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.order_summary_by_customer

import java.sql.Connection
import typr.scaladsl.DuckDbTypeOps
import typr.scaladsl.Fragment
import typr.scaladsl.ScalaDbTypes
import typr.scaladsl.Fragment.sql

class OrderSummaryByCustomerSqlRepoImpl extends OrderSummaryByCustomerSqlRepo {
  override def apply(
    customerIds: Option[Array[Int]],
    minTotal: Option[BigDecimal],
    minOrderCount: Option[Int]
  )(using c: Connection): List[OrderSummaryByCustomerSqlRow] = {
    sql"""-- Order summary with aggregations and complex joins
    -- Tests: aggregations, GROUP BY, HAVING, multiple joins, type-safe IDs in WHERE
  
    SELECT
        c.customer_id,
        c.name AS customer_name,
        c.email,
        c.priority,
        COUNT(DISTINCT o.order_id) AS order_count,
        COALESCE(SUM(o.total_amount), 0.0) AS total_spent,
        MAX(o.order_date) AS last_order_date,
        MIN(o.order_date) AS first_order_date,
        COALESCE(AVG(o.total_amount), 0.0) AS avg_order_amount
    FROM customers c
    LEFT JOIN orders o ON c.customer_id = o.customer_id
    WHERE
        (${Fragment.encode(ScalaDbTypes.DuckDbTypes.integerArrayUnboxed.nullable, customerIds)} IS NULL OR c.customer_id = ANY(CAST(${Fragment.encode(ScalaDbTypes.DuckDbTypes.integerArrayUnboxed.nullable, customerIds)} AS INTEGER[])))
        AND (${Fragment.encode(ScalaDbTypes.DuckDbTypes.numeric.nullable, minTotal)} IS NULL OR c.customer_id IN (
            SELECT customer_id
            FROM orders
            GROUP BY customer_id
            HAVING SUM(total_amount) >= CAST(${Fragment.encode(ScalaDbTypes.DuckDbTypes.numeric.nullable, minTotal)} AS DECIMAL)
        ))
    GROUP BY c.customer_id, c.name, c.email, c.priority
    HAVING
        (${Fragment.encode(ScalaDbTypes.DuckDbTypes.integer.nullable, minOrderCount)} IS NULL OR COUNT(DISTINCT o.order_id) >= CAST(${Fragment.encode(ScalaDbTypes.DuckDbTypes.integer.nullable, minOrderCount)} AS INTEGER))
    ORDER BY total_spent DESC, customer_name""".query(OrderSummaryByCustomerSqlRow.`_rowParser`.all()).runUnchecked(c)
  }
}