/**
 * File has been automatically generated by `typo`.
 *
 * <p>IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.test_connection;

import static typo.runtime.Fragment.interpolate;

import java.sql.Connection;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import typo.dsl.DeleteBuilder;
import typo.dsl.Dialect;
import typo.dsl.SelectBuilder;
import typo.dsl.UpdateBuilder;
import typo.runtime.Fragment;
import typo.runtime.SqlServerTypes;

public class TestConnectionRepoImpl implements TestConnectionRepo {
  @Override
  public DeleteBuilder<TestConnectionFields, TestConnectionRow> delete() {
    return DeleteBuilder.of(
        "[test_connection]", TestConnectionFields.structure(), Dialect.SQLSERVER);
  }
  ;

  @Override
  public Boolean deleteById(TestConnectionId id, Connection c) {
    return interpolate(
                Fragment.lit("delete from [test_connection] where [id] = "),
                Fragment.encode(TestConnectionId.sqlServerType, id),
                Fragment.lit(""))
            .update()
            .runUnchecked(c)
        > 0;
  }
  ;

  @Override
  public Integer deleteByIds(TestConnectionId[] ids, Connection c) {
    ArrayList<Fragment> fragments = new ArrayList<>();
    for (var id : ids) {
      fragments.add(Fragment.encode(TestConnectionId.sqlServerType, id));
    }
    ;
    return Fragment.interpolate(
            Fragment.lit("delete from [test_connection] where [id] in ("),
            Fragment.comma(fragments),
            Fragment.lit(")"))
        .update()
        .runUnchecked(c);
  }
  ;

  @Override
  public TestConnectionRow insert(TestConnectionRow unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "insert into [test_connection]([message], [created_at])\n"
                    + "OUTPUT INSERTED.[id], INSERTED.[message], INSERTED.[created_at]\n"
                    + "values ("),
            Fragment.encode(SqlServerTypes.nvarchar, unsaved.message()),
            Fragment.lit(", "),
            Fragment.encode(SqlServerTypes.datetime2.opt(), unsaved.createdAt()),
            Fragment.lit(")\n"))
        .updateReturning(TestConnectionRow._rowParser.exactlyOne())
        .runUnchecked(c);
  }
  ;

  @Override
  public TestConnectionRow insert(TestConnectionRowUnsaved unsaved, Connection c) {
    ArrayList<Fragment> columns = new ArrayList<>();
    ;
    ArrayList<Fragment> values = new ArrayList<>();
    ;
    columns.add(Fragment.lit("[message]"));
    values.add(
        interpolate(Fragment.encode(SqlServerTypes.nvarchar, unsaved.message()), Fragment.lit("")));
    unsaved
        .createdAt()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("[created_at]"));
              values.add(
                  interpolate(
                      Fragment.encode(SqlServerTypes.datetime2.opt(), value), Fragment.lit("")));
            });
    ;
    Fragment q =
        interpolate(
            Fragment.lit("insert into [test_connection]("),
            Fragment.comma(columns),
            Fragment.lit(
                ")\nOUTPUT INSERTED.[id], INSERTED.[message], INSERTED.[created_at]\nvalues ("),
            Fragment.comma(values),
            Fragment.lit(")\n"));
    ;
    return q.updateReturning(TestConnectionRow._rowParser.exactlyOne()).runUnchecked(c);
  }
  ;

  @Override
  public SelectBuilder<TestConnectionFields, TestConnectionRow> select() {
    return SelectBuilder.of(
        "[test_connection]",
        TestConnectionFields.structure(),
        TestConnectionRow._rowParser,
        Dialect.SQLSERVER);
  }
  ;

  @Override
  public List<TestConnectionRow> selectAll(Connection c) {
    return interpolate(
            Fragment.lit("select [id], [message], [created_at]\nfrom [test_connection]\n"))
        .query(TestConnectionRow._rowParser.all())
        .runUnchecked(c);
  }
  ;

  @Override
  public Optional<TestConnectionRow> selectById(TestConnectionId id, Connection c) {
    return interpolate(
            Fragment.lit(
                "select [id], [message], [created_at]\nfrom [test_connection]\nwhere [id] = "),
            Fragment.encode(TestConnectionId.sqlServerType, id),
            Fragment.lit(""))
        .query(TestConnectionRow._rowParser.first())
        .runUnchecked(c);
  }
  ;

  @Override
  public List<TestConnectionRow> selectByIds(TestConnectionId[] ids, Connection c) {
    ArrayList<Fragment> fragments = new ArrayList<>();
    for (var id : ids) {
      fragments.add(Fragment.encode(TestConnectionId.sqlServerType, id));
    }
    ;
    return Fragment.interpolate(
            Fragment.lit(
                "select [id], [message], [created_at] from [test_connection] where [id] in ("),
            Fragment.comma(fragments),
            Fragment.lit(")"))
        .query(TestConnectionRow._rowParser.all())
        .runUnchecked(c);
  }
  ;

  @Override
  public Map<TestConnectionId, TestConnectionRow> selectByIdsTracked(
      TestConnectionId[] ids, Connection c) {
    HashMap<TestConnectionId, TestConnectionRow> ret =
        new HashMap<TestConnectionId, TestConnectionRow>();
    selectByIds(ids, c).forEach(row -> ret.put(row.id(), row));
    return ret;
  }
  ;

  @Override
  public UpdateBuilder<TestConnectionFields, TestConnectionRow> update() {
    return UpdateBuilder.of(
        "[test_connection]",
        TestConnectionFields.structure(),
        TestConnectionRow._rowParser,
        Dialect.SQLSERVER);
  }
  ;

  @Override
  public Boolean update(TestConnectionRow row, Connection c) {
    TestConnectionId id = row.id();
    ;
    return interpolate(
                Fragment.lit("update [test_connection]\nset [message] = "),
                Fragment.encode(SqlServerTypes.nvarchar, row.message()),
                Fragment.lit(",\n[created_at] = "),
                Fragment.encode(SqlServerTypes.datetime2.opt(), row.createdAt()),
                Fragment.lit("\nwhere [id] = "),
                Fragment.encode(TestConnectionId.sqlServerType, id),
                Fragment.lit(""))
            .update()
            .runUnchecked(c)
        > 0;
  }
  ;

  @Override
  public TestConnectionRow upsert(TestConnectionRow unsaved, Connection c) {
    return interpolate(
            Fragment.lit("MERGE INTO [test_connection] AS target\nUSING (VALUES ("),
            Fragment.encode(SqlServerTypes.nvarchar, unsaved.message()),
            Fragment.lit(", "),
            Fragment.encode(SqlServerTypes.datetime2.opt(), unsaved.createdAt()),
            Fragment.lit(
                ")) AS source([message], [created_at])\n"
                    + "ON target.[id] = source.[id]\n"
                    + "WHEN MATCHED THEN UPDATE SET [message] = source.[message],\n"
                    + "[created_at] = source.[created_at]\n"
                    + "WHEN NOT MATCHED THEN INSERT ([message], [created_at]) VALUES ("),
            Fragment.encode(SqlServerTypes.nvarchar, unsaved.message()),
            Fragment.lit(", "),
            Fragment.encode(SqlServerTypes.datetime2.opt(), unsaved.createdAt()),
            Fragment.lit(")\nOUTPUT INSERTED.[id], INSERTED.[message], INSERTED.[created_at];"))
        .updateReturning(TestConnectionRow._rowParser.exactlyOne())
        .runUnchecked(c);
  }
  ;

  @Override
  public List<TestConnectionRow> upsertBatch(Iterator<TestConnectionRow> unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "MERGE INTO [test_connection] AS target\n"
                    + "USING (VALUES (?, ?, ?)) AS source([id], [message], [created_at])\n"
                    + "ON target.[id] = source.[id]\n"
                    + "WHEN MATCHED THEN UPDATE SET [message] = source.[message],\n"
                    + "[created_at] = source.[created_at]\n"
                    + "WHEN NOT MATCHED THEN INSERT ([id], [message], [created_at]) VALUES (?, ?,"
                    + " ?)\n"
                    + "OUTPUT INSERTED.[id], INSERTED.[message], INSERTED.[created_at];"))
        .updateReturningEach(TestConnectionRow._rowParser, unsaved)
        .runUnchecked(c);
  }
  ;
}
