/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package adventureworks
package person
package stateprovince

import adventureworks.customtypes.Defaulted
import adventureworks.customtypes.TypoLocalDateTime
import adventureworks.customtypes.TypoUUID
import adventureworks.person.countryregion.CountryregionId
import adventureworks.public.Flag
import adventureworks.public.Name
import adventureworks.sales.salesterritory.SalesterritoryId
import typo.dsl.DeleteBuilder
import typo.dsl.SelectBuilder
import typo.dsl.SelectBuilderSql
import typo.dsl.UpdateBuilder
import zio.ZIO
import zio.jdbc.SqlFragment
import zio.jdbc.SqlFragment.Segment
import zio.jdbc.SqlFragment.Setter
import zio.jdbc.UpdateResult
import zio.jdbc.ZConnection
import zio.jdbc.sqlInterpolator
import zio.stream.ZStream

class StateprovinceRepoImpl extends StateprovinceRepo {
  override def delete: DeleteBuilder[StateprovinceFields, StateprovinceRow] = {
    DeleteBuilder(""""person"."stateprovince"""", StateprovinceFields.structure)
  }
  override def deleteById(stateprovinceid: StateprovinceId): ZIO[ZConnection, Throwable, Boolean] = {
    sql"""delete from "person"."stateprovince" where "stateprovinceid" = ${Segment.paramSegment(stateprovinceid)(using StateprovinceId.setter)}""".delete.map(_ > 0)
  }
  override def deleteByIds(stateprovinceids: Array[StateprovinceId]): ZIO[ZConnection, Throwable, Long] = {
    sql"""delete from "person"."stateprovince" where "stateprovinceid" = ANY(${stateprovinceids})""".delete
  }
  override def insert(unsaved: StateprovinceRow): ZIO[ZConnection, Throwable, StateprovinceRow] = {
    sql"""insert into "person"."stateprovince"("stateprovinceid", "stateprovincecode", "countryregioncode", "isonlystateprovinceflag", "name", "territoryid", "rowguid", "modifieddate")
          values (${Segment.paramSegment(unsaved.stateprovinceid)(using StateprovinceId.setter)}::int4, ${Segment.paramSegment(unsaved.stateprovincecode)(using Setter.stringSetter)}::bpchar, ${Segment.paramSegment(unsaved.countryregioncode)(using CountryregionId.setter)}, ${Segment.paramSegment(unsaved.isonlystateprovinceflag)(using Flag.setter)}::bool, ${Segment.paramSegment(unsaved.name)(using Name.setter)}::varchar, ${Segment.paramSegment(unsaved.territoryid)(using SalesterritoryId.setter)}::int4, ${Segment.paramSegment(unsaved.rowguid)(using TypoUUID.setter)}::uuid, ${Segment.paramSegment(unsaved.modifieddate)(using TypoLocalDateTime.setter)}::timestamp)
          returning "stateprovinceid", "stateprovincecode", "countryregioncode", "isonlystateprovinceflag", "name", "territoryid", "rowguid", "modifieddate"::text
       """.insertReturning(using StateprovinceRow.jdbcDecoder).map(_.updatedKeys.head)
  }
  override def insert(unsaved: StateprovinceRowUnsaved): ZIO[ZConnection, Throwable, StateprovinceRow] = {
    val fs = List(
      Some((sql""""stateprovincecode"""", sql"${Segment.paramSegment(unsaved.stateprovincecode)(using Setter.stringSetter)}::bpchar")),
      Some((sql""""countryregioncode"""", sql"${Segment.paramSegment(unsaved.countryregioncode)(using CountryregionId.setter)}")),
      Some((sql""""name"""", sql"${Segment.paramSegment(unsaved.name)(using Name.setter)}::varchar")),
      Some((sql""""territoryid"""", sql"${Segment.paramSegment(unsaved.territoryid)(using SalesterritoryId.setter)}::int4")),
      unsaved.stateprovinceid match {
        case Defaulted.UseDefault => None
        case Defaulted.Provided(value) => Some((sql""""stateprovinceid"""", sql"${Segment.paramSegment(value: StateprovinceId)(using StateprovinceId.setter)}::int4"))
      },
      unsaved.isonlystateprovinceflag match {
        case Defaulted.UseDefault => None
        case Defaulted.Provided(value) => Some((sql""""isonlystateprovinceflag"""", sql"${Segment.paramSegment(value: Flag)(using Flag.setter)}::bool"))
      },
      unsaved.rowguid match {
        case Defaulted.UseDefault => None
        case Defaulted.Provided(value) => Some((sql""""rowguid"""", sql"${Segment.paramSegment(value: TypoUUID)(using TypoUUID.setter)}::uuid"))
      },
      unsaved.modifieddate match {
        case Defaulted.UseDefault => None
        case Defaulted.Provided(value) => Some((sql""""modifieddate"""", sql"${Segment.paramSegment(value: TypoLocalDateTime)(using TypoLocalDateTime.setter)}::timestamp"))
      }
    ).flatten
    
    val q = if (fs.isEmpty) {
      sql"""insert into "person"."stateprovince" default values
            returning "stateprovinceid", "stateprovincecode", "countryregioncode", "isonlystateprovinceflag", "name", "territoryid", "rowguid", "modifieddate"::text
         """
    } else {
      val names  = fs.map { case (n, _) => n }.mkFragment(SqlFragment(", "))
      val values = fs.map { case (_, f) => f }.mkFragment(SqlFragment(", "))
      sql"""insert into "person"."stateprovince"($names) values ($values) returning "stateprovinceid", "stateprovincecode", "countryregioncode", "isonlystateprovinceflag", "name", "territoryid", "rowguid", "modifieddate"::text"""
    }
    q.insertReturning(using StateprovinceRow.jdbcDecoder).map(_.updatedKeys.head)
    
  }
  override def insertStreaming(unsaved: ZStream[ZConnection, Throwable, StateprovinceRow], batchSize: Int = 10000): ZIO[ZConnection, Throwable, Long] = {
    streamingInsert(s"""COPY "person"."stateprovince"("stateprovinceid", "stateprovincecode", "countryregioncode", "isonlystateprovinceflag", "name", "territoryid", "rowguid", "modifieddate") FROM STDIN""", batchSize, unsaved)(using StateprovinceRow.text)
  }
  /* NOTE: this functionality requires PostgreSQL 16 or later! */
  override def insertUnsavedStreaming(unsaved: ZStream[ZConnection, Throwable, StateprovinceRowUnsaved], batchSize: Int = 10000): ZIO[ZConnection, Throwable, Long] = {
    streamingInsert(s"""COPY "person"."stateprovince"("stateprovincecode", "countryregioncode", "name", "territoryid", "stateprovinceid", "isonlystateprovinceflag", "rowguid", "modifieddate") FROM STDIN (DEFAULT '__DEFAULT_VALUE__')""", batchSize, unsaved)(using StateprovinceRowUnsaved.text)
  }
  override def select: SelectBuilder[StateprovinceFields, StateprovinceRow] = {
    SelectBuilderSql(""""person"."stateprovince"""", StateprovinceFields.structure, StateprovinceRow.jdbcDecoder)
  }
  override def selectAll: ZStream[ZConnection, Throwable, StateprovinceRow] = {
    sql"""select "stateprovinceid", "stateprovincecode", "countryregioncode", "isonlystateprovinceflag", "name", "territoryid", "rowguid", "modifieddate"::text from "person"."stateprovince"""".query(using StateprovinceRow.jdbcDecoder).selectStream()
  }
  override def selectById(stateprovinceid: StateprovinceId): ZIO[ZConnection, Throwable, Option[StateprovinceRow]] = {
    sql"""select "stateprovinceid", "stateprovincecode", "countryregioncode", "isonlystateprovinceflag", "name", "territoryid", "rowguid", "modifieddate"::text from "person"."stateprovince" where "stateprovinceid" = ${Segment.paramSegment(stateprovinceid)(using StateprovinceId.setter)}""".query(using StateprovinceRow.jdbcDecoder).selectOne
  }
  override def selectByIds(stateprovinceids: Array[StateprovinceId]): ZStream[ZConnection, Throwable, StateprovinceRow] = {
    sql"""select "stateprovinceid", "stateprovincecode", "countryregioncode", "isonlystateprovinceflag", "name", "territoryid", "rowguid", "modifieddate"::text from "person"."stateprovince" where "stateprovinceid" = ANY(${Segment.paramSegment(stateprovinceids)(using StateprovinceId.arraySetter)})""".query(using StateprovinceRow.jdbcDecoder).selectStream()
  }
  override def selectByIdsTracked(stateprovinceids: Array[StateprovinceId]): ZIO[ZConnection, Throwable, Map[StateprovinceId, StateprovinceRow]] = {
    selectByIds(stateprovinceids).runCollect.map { rows =>
      val byId = rows.view.map(x => (x.stateprovinceid, x)).toMap
      stateprovinceids.view.flatMap(id => byId.get(id).map(x => (id, x))).toMap
    }
  }
  override def update: UpdateBuilder[StateprovinceFields, StateprovinceRow] = {
    UpdateBuilder(""""person"."stateprovince"""", StateprovinceFields.structure, StateprovinceRow.jdbcDecoder)
  }
  override def update(row: StateprovinceRow): ZIO[ZConnection, Throwable, Option[StateprovinceRow]] = {
    val stateprovinceid = row.stateprovinceid
    sql"""update "person"."stateprovince"
          set "stateprovincecode" = ${Segment.paramSegment(row.stateprovincecode)(using Setter.stringSetter)}::bpchar,
              "countryregioncode" = ${Segment.paramSegment(row.countryregioncode)(using CountryregionId.setter)},
              "isonlystateprovinceflag" = ${Segment.paramSegment(row.isonlystateprovinceflag)(using Flag.setter)}::bool,
              "name" = ${Segment.paramSegment(row.name)(using Name.setter)}::varchar,
              "territoryid" = ${Segment.paramSegment(row.territoryid)(using SalesterritoryId.setter)}::int4,
              "rowguid" = ${Segment.paramSegment(row.rowguid)(using TypoUUID.setter)}::uuid,
              "modifieddate" = ${Segment.paramSegment(row.modifieddate)(using TypoLocalDateTime.setter)}::timestamp
          where "stateprovinceid" = ${Segment.paramSegment(stateprovinceid)(using StateprovinceId.setter)}
          returning "stateprovinceid", "stateprovincecode", "countryregioncode", "isonlystateprovinceflag", "name", "territoryid", "rowguid", "modifieddate"::text"""
      .query(using StateprovinceRow.jdbcDecoder)
      .selectOne
  }
  override def upsert(unsaved: StateprovinceRow): ZIO[ZConnection, Throwable, UpdateResult[StateprovinceRow]] = {
    sql"""insert into "person"."stateprovince"("stateprovinceid", "stateprovincecode", "countryregioncode", "isonlystateprovinceflag", "name", "territoryid", "rowguid", "modifieddate")
          values (
            ${Segment.paramSegment(unsaved.stateprovinceid)(using StateprovinceId.setter)}::int4,
            ${Segment.paramSegment(unsaved.stateprovincecode)(using Setter.stringSetter)}::bpchar,
            ${Segment.paramSegment(unsaved.countryregioncode)(using CountryregionId.setter)},
            ${Segment.paramSegment(unsaved.isonlystateprovinceflag)(using Flag.setter)}::bool,
            ${Segment.paramSegment(unsaved.name)(using Name.setter)}::varchar,
            ${Segment.paramSegment(unsaved.territoryid)(using SalesterritoryId.setter)}::int4,
            ${Segment.paramSegment(unsaved.rowguid)(using TypoUUID.setter)}::uuid,
            ${Segment.paramSegment(unsaved.modifieddate)(using TypoLocalDateTime.setter)}::timestamp
          )
          on conflict ("stateprovinceid")
          do update set
            "stateprovincecode" = EXCLUDED."stateprovincecode",
            "countryregioncode" = EXCLUDED."countryregioncode",
            "isonlystateprovinceflag" = EXCLUDED."isonlystateprovinceflag",
            "name" = EXCLUDED."name",
            "territoryid" = EXCLUDED."territoryid",
            "rowguid" = EXCLUDED."rowguid",
            "modifieddate" = EXCLUDED."modifieddate"
          returning "stateprovinceid", "stateprovincecode", "countryregioncode", "isonlystateprovinceflag", "name", "territoryid", "rowguid", "modifieddate"::text""".insertReturning(using StateprovinceRow.jdbcDecoder)
  }
  /* NOTE: this functionality is not safe if you use auto-commit mode! it runs 3 SQL statements */
  override def upsertStreaming(unsaved: ZStream[ZConnection, Throwable, StateprovinceRow], batchSize: Int = 10000): ZIO[ZConnection, Throwable, Long] = {
    val created = sql"""create temporary table stateprovince_TEMP (like "person"."stateprovince") on commit drop""".execute
    val copied = streamingInsert(s"""copy stateprovince_TEMP("stateprovinceid", "stateprovincecode", "countryregioncode", "isonlystateprovinceflag", "name", "territoryid", "rowguid", "modifieddate") from stdin""", batchSize, unsaved)(using StateprovinceRow.text)
    val merged = sql"""insert into "person"."stateprovince"("stateprovinceid", "stateprovincecode", "countryregioncode", "isonlystateprovinceflag", "name", "territoryid", "rowguid", "modifieddate")
                       select * from stateprovince_TEMP
                       on conflict ("stateprovinceid")
                       do update set
                         "stateprovincecode" = EXCLUDED."stateprovincecode",
                         "countryregioncode" = EXCLUDED."countryregioncode",
                         "isonlystateprovinceflag" = EXCLUDED."isonlystateprovinceflag",
                         "name" = EXCLUDED."name",
                         "territoryid" = EXCLUDED."territoryid",
                         "rowguid" = EXCLUDED."rowguid",
                         "modifieddate" = EXCLUDED."modifieddate"
                       ;
                       drop table stateprovince_TEMP;""".update
    created *> copied *> merged
  }
}
