/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package adventureworks.humanresources.employee

import adventureworks.customtypes.Defaulted
import adventureworks.customtypes.TypoLocalDate
import adventureworks.customtypes.TypoLocalDateTime
import adventureworks.customtypes.TypoShort
import adventureworks.customtypes.TypoUUID
import adventureworks.person.businessentity.BusinessentityId
import adventureworks.public.Flag
import adventureworks.streamingInsert
import typr.dsl.DeleteBuilder
import typr.dsl.SelectBuilder
import typr.dsl.UpdateBuilder
import zio.ZIO
import zio.jdbc.SqlFragment
import zio.jdbc.SqlFragment.Segment
import zio.jdbc.SqlFragment.Setter
import zio.jdbc.UpdateResult
import zio.jdbc.ZConnection
import zio.stream.ZStream
import zio.jdbc.sqlInterpolator

class EmployeeRepoImpl extends EmployeeRepo {
  override def delete: DeleteBuilder[EmployeeFields, EmployeeRow] = DeleteBuilder.of(""""humanresources"."employee"""", EmployeeFields.structure, EmployeeRow.jdbcDecoder)

  override def deleteById(businessentityid: BusinessentityId): ZIO[ZConnection, Throwable, Boolean] = sql"""delete from "humanresources"."employee" where "businessentityid" = ${Segment.paramSegment(businessentityid)(using BusinessentityId.setter)}""".delete.map(_ > 0)

  override def deleteByIds(businessentityids: Array[BusinessentityId]): ZIO[ZConnection, Throwable, Long] = sql"""delete from "humanresources"."employee" where "businessentityid" = ANY(${Segment.paramSegment(businessentityids)(using BusinessentityId.arraySetter)})""".delete

  override def insert(unsaved: EmployeeRow): ZIO[ZConnection, Throwable, EmployeeRow] = {
    sql"""insert into "humanresources"."employee"("businessentityid", "nationalidnumber", "loginid", "jobtitle", "birthdate", "maritalstatus", "gender", "hiredate", "salariedflag", "vacationhours", "sickleavehours", "currentflag", "rowguid", "modifieddate", "organizationnode")
    values (${Segment.paramSegment(unsaved.businessentityid)(using BusinessentityId.setter)}::int4, ${Segment.paramSegment(unsaved.nationalidnumber)(using Setter.stringSetter)}, ${Segment.paramSegment(unsaved.loginid)(using Setter.stringSetter)}, ${Segment.paramSegment(unsaved.jobtitle)(using Setter.stringSetter)}, ${Segment.paramSegment(unsaved.birthdate)(using TypoLocalDate.setter)}::date, ${Segment.paramSegment(unsaved.maritalstatus)(using Setter.stringSetter)}::bpchar, ${Segment.paramSegment(unsaved.gender)(using Setter.stringSetter)}::bpchar, ${Segment.paramSegment(unsaved.hiredate)(using TypoLocalDate.setter)}::date, ${Segment.paramSegment(unsaved.salariedflag)(using Flag.setter)}::bool, ${Segment.paramSegment(unsaved.vacationhours)(using TypoShort.setter)}::int2, ${Segment.paramSegment(unsaved.sickleavehours)(using TypoShort.setter)}::int2, ${Segment.paramSegment(unsaved.currentflag)(using Flag.setter)}::bool, ${Segment.paramSegment(unsaved.rowguid)(using TypoUUID.setter)}::uuid, ${Segment.paramSegment(unsaved.modifieddate)(using TypoLocalDateTime.setter)}::timestamp, ${Segment.paramSegment(unsaved.organizationnode)(using Setter.optionParamSetter(using Setter.stringSetter))})
    returning "businessentityid", "nationalidnumber", "loginid", "jobtitle", "birthdate"::text, "maritalstatus", "gender", "hiredate"::text, "salariedflag", "vacationhours", "sickleavehours", "currentflag", "rowguid", "modifieddate"::text, "organizationnode"
    """.insertReturning(using EmployeeRow.jdbcDecoder).map(_.updatedKeys.head)
  }

  override def insert(unsaved: EmployeeRowUnsaved): ZIO[ZConnection, Throwable, EmployeeRow] = {
    val fs = List(
      Some((sql""""businessentityid"""", sql"${Segment.paramSegment(unsaved.businessentityid)(using BusinessentityId.setter)}::int4")),
      Some((sql""""nationalidnumber"""", sql"${Segment.paramSegment(unsaved.nationalidnumber)(using Setter.stringSetter)}")),
      Some((sql""""loginid"""", sql"${Segment.paramSegment(unsaved.loginid)(using Setter.stringSetter)}")),
      Some((sql""""jobtitle"""", sql"${Segment.paramSegment(unsaved.jobtitle)(using Setter.stringSetter)}")),
      Some((sql""""birthdate"""", sql"${Segment.paramSegment(unsaved.birthdate)(using TypoLocalDate.setter)}::date")),
      Some((sql""""maritalstatus"""", sql"${Segment.paramSegment(unsaved.maritalstatus)(using Setter.stringSetter)}::bpchar")),
      Some((sql""""gender"""", sql"${Segment.paramSegment(unsaved.gender)(using Setter.stringSetter)}::bpchar")),
      Some((sql""""hiredate"""", sql"${Segment.paramSegment(unsaved.hiredate)(using TypoLocalDate.setter)}::date")),
      unsaved.salariedflag match {
        case Defaulted.UseDefault() => None
        case Defaulted.Provided(value) => Some((sql""""salariedflag"""", sql"${Segment.paramSegment(value: Flag)(using Flag.setter)}::bool"))
      },
      unsaved.vacationhours match {
        case Defaulted.UseDefault() => None
        case Defaulted.Provided(value) => Some((sql""""vacationhours"""", sql"${Segment.paramSegment(value: TypoShort)(using TypoShort.setter)}::int2"))
      },
      unsaved.sickleavehours match {
        case Defaulted.UseDefault() => None
        case Defaulted.Provided(value) => Some((sql""""sickleavehours"""", sql"${Segment.paramSegment(value: TypoShort)(using TypoShort.setter)}::int2"))
      },
      unsaved.currentflag match {
        case Defaulted.UseDefault() => None
        case Defaulted.Provided(value) => Some((sql""""currentflag"""", sql"${Segment.paramSegment(value: Flag)(using Flag.setter)}::bool"))
      },
      unsaved.rowguid match {
        case Defaulted.UseDefault() => None
        case Defaulted.Provided(value) => Some((sql""""rowguid"""", sql"${Segment.paramSegment(value: TypoUUID)(using TypoUUID.setter)}::uuid"))
      },
      unsaved.modifieddate match {
        case Defaulted.UseDefault() => None
        case Defaulted.Provided(value) => Some((sql""""modifieddate"""", sql"${Segment.paramSegment(value: TypoLocalDateTime)(using TypoLocalDateTime.setter)}::timestamp"))
      },
      unsaved.organizationnode match {
        case Defaulted.UseDefault() => None
        case Defaulted.Provided(value) => Some((sql""""organizationnode"""", sql"${Segment.paramSegment(value: Option[String])(using Setter.optionParamSetter(using Setter.stringSetter))}"))
      }
    ).flatten
    val q = if (fs.isEmpty) {
      sql"""insert into "humanresources"."employee" default values
      returning "businessentityid", "nationalidnumber", "loginid", "jobtitle", "birthdate"::text, "maritalstatus", "gender", "hiredate"::text, "salariedflag", "vacationhours", "sickleavehours", "currentflag", "rowguid", "modifieddate"::text, "organizationnode"
      """
    } else {
      val names  = fs.map { case (n, _) => n }.mkFragment(SqlFragment(", "))
      val values = fs.map { case (_, f) => f }.mkFragment(SqlFragment(", "))
      sql"""insert into "humanresources"."employee"($names) values ($values) returning "businessentityid", "nationalidnumber", "loginid", "jobtitle", "birthdate"::text, "maritalstatus", "gender", "hiredate"::text, "salariedflag", "vacationhours", "sickleavehours", "currentflag", "rowguid", "modifieddate"::text, "organizationnode""""
    }
    q.insertReturning(using EmployeeRow.jdbcDecoder).map(_.updatedKeys.head)
  }

  override def insertStreaming(
    unsaved: ZStream[ZConnection, Throwable, EmployeeRow],
    batchSize: Int = 10000
  ): ZIO[ZConnection, Throwable, Long] = streamingInsert(s"""COPY "humanresources"."employee"("businessentityid", "nationalidnumber", "loginid", "jobtitle", "birthdate", "maritalstatus", "gender", "hiredate", "salariedflag", "vacationhours", "sickleavehours", "currentflag", "rowguid", "modifieddate", "organizationnode") FROM STDIN""", batchSize, unsaved)(using EmployeeRow.pgText)

  /** NOTE: this functionality requires PostgreSQL 16 or later! */
  override def insertUnsavedStreaming(
    unsaved: ZStream[ZConnection, Throwable, EmployeeRowUnsaved],
    batchSize: Int = 10000
  ): ZIO[ZConnection, Throwable, Long] = streamingInsert(s"""COPY "humanresources"."employee"("businessentityid", "nationalidnumber", "loginid", "jobtitle", "birthdate", "maritalstatus", "gender", "hiredate", "salariedflag", "vacationhours", "sickleavehours", "currentflag", "rowguid", "modifieddate", "organizationnode") FROM STDIN (DEFAULT '__DEFAULT_VALUE__')""", batchSize, unsaved)(using EmployeeRowUnsaved.pgText)

  override def select: SelectBuilder[EmployeeFields, EmployeeRow] = SelectBuilder.of(""""humanresources"."employee"""", EmployeeFields.structure, EmployeeRow.jdbcDecoder)

  override def selectAll: ZStream[ZConnection, Throwable, EmployeeRow] = sql"""select "businessentityid", "nationalidnumber", "loginid", "jobtitle", "birthdate"::text, "maritalstatus", "gender", "hiredate"::text, "salariedflag", "vacationhours", "sickleavehours", "currentflag", "rowguid", "modifieddate"::text, "organizationnode" from "humanresources"."employee"""".query(using EmployeeRow.jdbcDecoder).selectStream()

  override def selectById(businessentityid: BusinessentityId): ZIO[ZConnection, Throwable, Option[EmployeeRow]] = sql"""select "businessentityid", "nationalidnumber", "loginid", "jobtitle", "birthdate"::text, "maritalstatus", "gender", "hiredate"::text, "salariedflag", "vacationhours", "sickleavehours", "currentflag", "rowguid", "modifieddate"::text, "organizationnode" from "humanresources"."employee" where "businessentityid" = ${Segment.paramSegment(businessentityid)(using BusinessentityId.setter)}""".query(using EmployeeRow.jdbcDecoder).selectOne

  override def selectByIds(businessentityids: Array[BusinessentityId]): ZStream[ZConnection, Throwable, EmployeeRow] = sql"""select "businessentityid", "nationalidnumber", "loginid", "jobtitle", "birthdate"::text, "maritalstatus", "gender", "hiredate"::text, "salariedflag", "vacationhours", "sickleavehours", "currentflag", "rowguid", "modifieddate"::text, "organizationnode" from "humanresources"."employee" where "businessentityid" = ANY(${Segment.paramSegment(businessentityids)(using BusinessentityId.arraySetter)})""".query(using EmployeeRow.jdbcDecoder).selectStream()

  override def selectByIdsTracked(businessentityids: Array[BusinessentityId]): ZIO[ZConnection, Throwable, Map[BusinessentityId, EmployeeRow]] = {
    selectByIds(businessentityids).runCollect.map { rows =>
      val byId = rows.view.map(x => (x.businessentityid, x)).toMap
      businessentityids.view.flatMap(id => byId.get(id).map(x => (id, x))).toMap
    }
  }

  override def update: UpdateBuilder[EmployeeFields, EmployeeRow] = UpdateBuilder.of(""""humanresources"."employee"""", EmployeeFields.structure, EmployeeRow.jdbcDecoder)

  override def update(row: EmployeeRow): ZIO[ZConnection, Throwable, Option[EmployeeRow]] = {
    val businessentityid = row.businessentityid
    sql"""update "humanresources"."employee"
    set "nationalidnumber" = ${Segment.paramSegment(row.nationalidnumber)(using Setter.stringSetter)},
    "loginid" = ${Segment.paramSegment(row.loginid)(using Setter.stringSetter)},
    "jobtitle" = ${Segment.paramSegment(row.jobtitle)(using Setter.stringSetter)},
    "birthdate" = ${Segment.paramSegment(row.birthdate)(using TypoLocalDate.setter)}::date,
    "maritalstatus" = ${Segment.paramSegment(row.maritalstatus)(using Setter.stringSetter)}::bpchar,
    "gender" = ${Segment.paramSegment(row.gender)(using Setter.stringSetter)}::bpchar,
    "hiredate" = ${Segment.paramSegment(row.hiredate)(using TypoLocalDate.setter)}::date,
    "salariedflag" = ${Segment.paramSegment(row.salariedflag)(using Flag.setter)}::bool,
    "vacationhours" = ${Segment.paramSegment(row.vacationhours)(using TypoShort.setter)}::int2,
    "sickleavehours" = ${Segment.paramSegment(row.sickleavehours)(using TypoShort.setter)}::int2,
    "currentflag" = ${Segment.paramSegment(row.currentflag)(using Flag.setter)}::bool,
    "rowguid" = ${Segment.paramSegment(row.rowguid)(using TypoUUID.setter)}::uuid,
    "modifieddate" = ${Segment.paramSegment(row.modifieddate)(using TypoLocalDateTime.setter)}::timestamp,
    "organizationnode" = ${Segment.paramSegment(row.organizationnode)(using Setter.optionParamSetter(using Setter.stringSetter))}
    where "businessentityid" = ${Segment.paramSegment(businessentityid)(using BusinessentityId.setter)}
    returning "businessentityid", "nationalidnumber", "loginid", "jobtitle", "birthdate"::text, "maritalstatus", "gender", "hiredate"::text, "salariedflag", "vacationhours", "sickleavehours", "currentflag", "rowguid", "modifieddate"::text, "organizationnode""""
      .query(using EmployeeRow.jdbcDecoder)
      .selectOne
  }

  override def upsert(unsaved: EmployeeRow): ZIO[ZConnection, Throwable, UpdateResult[EmployeeRow]] = {
    sql"""insert into "humanresources"."employee"("businessentityid", "nationalidnumber", "loginid", "jobtitle", "birthdate", "maritalstatus", "gender", "hiredate", "salariedflag", "vacationhours", "sickleavehours", "currentflag", "rowguid", "modifieddate", "organizationnode")
    values (
      ${Segment.paramSegment(unsaved.businessentityid)(using BusinessentityId.setter)}::int4,
    ${Segment.paramSegment(unsaved.nationalidnumber)(using Setter.stringSetter)},
    ${Segment.paramSegment(unsaved.loginid)(using Setter.stringSetter)},
    ${Segment.paramSegment(unsaved.jobtitle)(using Setter.stringSetter)},
    ${Segment.paramSegment(unsaved.birthdate)(using TypoLocalDate.setter)}::date,
    ${Segment.paramSegment(unsaved.maritalstatus)(using Setter.stringSetter)}::bpchar,
    ${Segment.paramSegment(unsaved.gender)(using Setter.stringSetter)}::bpchar,
    ${Segment.paramSegment(unsaved.hiredate)(using TypoLocalDate.setter)}::date,
    ${Segment.paramSegment(unsaved.salariedflag)(using Flag.setter)}::bool,
    ${Segment.paramSegment(unsaved.vacationhours)(using TypoShort.setter)}::int2,
    ${Segment.paramSegment(unsaved.sickleavehours)(using TypoShort.setter)}::int2,
    ${Segment.paramSegment(unsaved.currentflag)(using Flag.setter)}::bool,
    ${Segment.paramSegment(unsaved.rowguid)(using TypoUUID.setter)}::uuid,
    ${Segment.paramSegment(unsaved.modifieddate)(using TypoLocalDateTime.setter)}::timestamp,
    ${Segment.paramSegment(unsaved.organizationnode)(using Setter.optionParamSetter(using Setter.stringSetter))}
    )
    on conflict ("businessentityid")
    do update set
      "nationalidnumber" = EXCLUDED."nationalidnumber",
    "loginid" = EXCLUDED."loginid",
    "jobtitle" = EXCLUDED."jobtitle",
    "birthdate" = EXCLUDED."birthdate",
    "maritalstatus" = EXCLUDED."maritalstatus",
    "gender" = EXCLUDED."gender",
    "hiredate" = EXCLUDED."hiredate",
    "salariedflag" = EXCLUDED."salariedflag",
    "vacationhours" = EXCLUDED."vacationhours",
    "sickleavehours" = EXCLUDED."sickleavehours",
    "currentflag" = EXCLUDED."currentflag",
    "rowguid" = EXCLUDED."rowguid",
    "modifieddate" = EXCLUDED."modifieddate",
    "organizationnode" = EXCLUDED."organizationnode"
    returning "businessentityid", "nationalidnumber", "loginid", "jobtitle", "birthdate"::text, "maritalstatus", "gender", "hiredate"::text, "salariedflag", "vacationhours", "sickleavehours", "currentflag", "rowguid", "modifieddate"::text, "organizationnode"""".insertReturning(using EmployeeRow.jdbcDecoder)
  }

  /** NOTE: this functionality is not safe if you use auto-commit mode! it runs 3 SQL statements */
  override def upsertStreaming(
    unsaved: ZStream[ZConnection, Throwable, EmployeeRow],
    batchSize: Int = 10000
  ): ZIO[ZConnection, Throwable, Long] = {
    val created = sql"""create temporary table employee_TEMP (like "humanresources"."employee") on commit drop""".execute
    val copied = streamingInsert(s"""copy employee_TEMP("businessentityid", "nationalidnumber", "loginid", "jobtitle", "birthdate", "maritalstatus", "gender", "hiredate", "salariedflag", "vacationhours", "sickleavehours", "currentflag", "rowguid", "modifieddate", "organizationnode") from stdin""", batchSize, unsaved)(using EmployeeRow.pgText)
    val merged = sql"""insert into "humanresources"."employee"("businessentityid", "nationalidnumber", "loginid", "jobtitle", "birthdate", "maritalstatus", "gender", "hiredate", "salariedflag", "vacationhours", "sickleavehours", "currentflag", "rowguid", "modifieddate", "organizationnode")
    select * from employee_TEMP
    on conflict ("businessentityid")
    do update set
      "nationalidnumber" = EXCLUDED."nationalidnumber",
    "loginid" = EXCLUDED."loginid",
    "jobtitle" = EXCLUDED."jobtitle",
    "birthdate" = EXCLUDED."birthdate",
    "maritalstatus" = EXCLUDED."maritalstatus",
    "gender" = EXCLUDED."gender",
    "hiredate" = EXCLUDED."hiredate",
    "salariedflag" = EXCLUDED."salariedflag",
    "vacationhours" = EXCLUDED."vacationhours",
    "sickleavehours" = EXCLUDED."sickleavehours",
    "currentflag" = EXCLUDED."currentflag",
    "rowguid" = EXCLUDED."rowguid",
    "modifieddate" = EXCLUDED."modifieddate",
    "organizationnode" = EXCLUDED."organizationnode"
    ;
    drop table employee_TEMP;""".update
    created *> copied *> merged
  }
}