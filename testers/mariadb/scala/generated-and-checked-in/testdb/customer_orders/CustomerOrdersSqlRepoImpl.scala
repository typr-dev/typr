/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.customer_orders

import dev.typr.foundations.MariaTypes
import dev.typr.foundations.scala.Fragment
import dev.typr.foundations.scala.MariaTypeOps
import java.sql.Connection
import testdb.customers.CustomersId
import dev.typr.foundations.scala.Fragment.sql

class CustomerOrdersSqlRepoImpl extends CustomerOrdersSqlRepo {
  override def apply(
    customerId: /* user-picked */ CustomersId,
    orderStatus: Option[String]
  )(using c: Connection): List[CustomerOrdersSqlRow] = {
    sql"""-- Query customers with their orders
    SELECT c.customer_id,
           c.email,
           c.first_name,
           c.last_name,
           c.tier,
           o.order_id,
           o.order_number,
           o.order_status,
           o.total_amount,
           o.ordered_at
    FROM customers c
    LEFT JOIN orders o ON c.customer_id = o.customer_id
    WHERE c.customer_id = ${Fragment.encode(CustomersId.pgType, customerId)}
      AND (${Fragment.encode(MariaTypes.text.nullable, orderStatus)} IS NULL OR o.order_status = ${Fragment.encode(MariaTypes.text.nullable, orderStatus)})
    """.query(CustomerOrdersSqlRow.`_rowParser`.all()).runUnchecked(c)
  }
}