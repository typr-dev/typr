/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.update_order_status

import dev.typr.foundations.MariaTypes
import dev.typr.foundations.scala.Fragment
import java.sql.Connection
import testdb.orders.OrdersId
import dev.typr.foundations.scala.Fragment.sql

class UpdateOrderStatusSqlRepoImpl extends UpdateOrderStatusSqlRepo {
  override def apply(
    newStatus: String,
    orderId: /* user-picked */ OrdersId
  )(using c: Connection): Int = {
    sql"""-- Update order status
    UPDATE orders
    SET order_status = ${Fragment.encode(MariaTypes.varchar, newStatus)},
        confirmed_at = CASE WHEN ${Fragment.encode(MariaTypes.varchar, newStatus)} = 'confirmed' THEN NOW(6) ELSE confirmed_at END,
        shipped_at = CASE WHEN ${Fragment.encode(MariaTypes.varchar, newStatus)} = 'shipped' THEN NOW(6) ELSE shipped_at END,
        delivered_at = CASE WHEN ${Fragment.encode(MariaTypes.varchar, newStatus)} = 'delivered' THEN NOW(6) ELSE delivered_at END
    WHERE order_id = ${Fragment.encode(OrdersId.pgType, orderId)}
    """.update().runUnchecked(c)
  }
}