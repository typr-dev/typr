package testdb;

import static org.junit.Assert.*;

import dev.typr.foundations.data.HierarchyId;
import dev.typr.foundations.data.Json;
import dev.typr.foundations.data.Xml;
import java.math.BigDecimal;
import java.time.*;
import java.util.Optional;
import java.util.Random;
import java.util.UUID;
import org.junit.Test;
import testdb.all_scalar_types.*;
import testdb.customer_orders_view.*;
import testdb.customers.*;
import testdb.orders.*;
import testdb.userdefined.Email;

/**
 * Tests for SQL Server-specific features: MONEY, ROWVERSION, XML, JSON, UUID, DATETIMEOFFSET,
 * HIERARCHYID, and Views.
 */
public class DatabaseFeaturesTest {
  private final TestInsert testInsert = new TestInsert(new Random(42));
  private final AllScalarTypesRepoImpl allTypesRepo = new AllScalarTypesRepoImpl();
  private final CustomersRepoImpl customersRepo = new CustomersRepoImpl();
  private final CustomerOrdersViewViewRepoImpl customerOrdersViewRepo =
      new CustomerOrdersViewViewRepoImpl();

  // ==================== Money Type Tests ====================

  @Test
  public void testMoneyType() {
    SqlServerTestHelper.run(
        c -> {
          var money = new BigDecimal("922337203685477.5807"); // Max MONEY value
          var row =
              testInsert.AllScalarTypes().with(r -> r.withColMoney(Optional.of(money))).insert(c);

          assertTrue(row.colMoney().isPresent());
          assertEquals(0, money.compareTo(row.colMoney().get()));
        });
  }

  @Test
  public void testSmallmoneyType() {
    SqlServerTestHelper.run(
        c -> {
          var smallmoney = new BigDecimal("214748.3647"); // Max SMALLMONEY value
          var row =
              testInsert
                  .AllScalarTypes()
                  .with(r -> r.withColSmallmoney(Optional.of(smallmoney)))
                  .insert(c);

          assertTrue(row.colSmallmoney().isPresent());
          assertEquals(0, smallmoney.compareTo(row.colSmallmoney().get()));
        });
  }

  @Test
  public void testMoneyPrecision() {
    SqlServerTestHelper.run(
        c -> {
          var money = new BigDecimal("1234.5678");
          var row =
              testInsert.AllScalarTypes().with(r -> r.withColMoney(Optional.of(money))).insert(c);

          assertTrue(row.colMoney().isPresent());
          assertEquals(0, money.compareTo(row.colMoney().get()));
        });
  }

  // ==================== ROWVERSION Tests ====================

  @Test
  public void testRowversionAutoGenerated() {
    SqlServerTestHelper.run(
        c -> {
          var row = testInsert.AllScalarTypes().insert(c);

          assertNotNull(row.colRowversion());
          assertTrue(row.colRowversion().length > 0);
        });
  }

  @Test
  public void testRowversionUniquePerRow() {
    SqlServerTestHelper.run(
        c -> {
          var row1 = testInsert.AllScalarTypes().insert(c);
          var row2 = testInsert.AllScalarTypes().insert(c);

          assertNotNull(row1.colRowversion());
          assertNotNull(row2.colRowversion());
          assertFalse(java.util.Arrays.equals(row1.colRowversion(), row2.colRowversion()));
        });
  }

  @Test
  public void testRowversionChangesOnUpdate() {
    SqlServerTestHelper.run(
        c -> {
          var inserted = testInsert.AllScalarTypes().insert(c);
          var originalRowversion = inserted.colRowversion().clone();

          var updated = inserted.withColVarchar(Optional.of("updated value"));
          allTypesRepo.update(updated, c);

          var found = allTypesRepo.selectById(inserted.id(), c).orElseThrow();

          assertFalse(java.util.Arrays.equals(originalRowversion, found.colRowversion()));
        });
  }

  // ==================== XML Tests ====================

  @Test
  public void testXmlType() {
    SqlServerTestHelper.run(
        c -> {
          var xml = new Xml("<root><element attr=\"value\">content</element></root>");
          var row = testInsert.AllScalarTypes().with(r -> r.withColXml(Optional.of(xml))).insert(c);

          assertTrue(row.colXml().isPresent());
          assertTrue(row.colXml().get().value().contains("root"));
          assertTrue(row.colXml().get().value().contains("element"));
        });
  }

  @Test
  public void testXmlNestedStructure() {
    SqlServerTestHelper.run(
        c -> {
          var xml =
              new Xml(
                  "<catalog><book id=\"1\"><title>SQL"
                      + " Server</title><price>29.99</price></book></catalog>");
          var row = testInsert.AllScalarTypes().with(r -> r.withColXml(Optional.of(xml))).insert(c);

          assertTrue(row.colXml().isPresent());
          assertTrue(row.colXml().get().value().contains("catalog"));
          assertTrue(row.colXml().get().value().contains("book"));
        });
  }

  // ==================== JSON Tests ====================

  @Test
  public void testJsonType() {
    SqlServerTestHelper.run(
        c -> {
          var json =
              new Json(
                  "{\"name\": \"test\", \"values\": [1, 2, 3], \"nested\": {\"key\": \"value\"}}");
          var row =
              testInsert.AllScalarTypes().with(r -> r.withColJson(Optional.of(json))).insert(c);

          assertTrue(row.colJson().isPresent());
          assertTrue(row.colJson().get().value().contains("name"));
          assertTrue(row.colJson().get().value().contains("nested"));
        });
  }

  // ==================== UUID (UNIQUEIDENTIFIER) Tests ====================

  @Test
  public void testUniqueidentifierType() {
    SqlServerTestHelper.run(
        c -> {
          var uuid = UUID.randomUUID();
          var row =
              testInsert
                  .AllScalarTypes()
                  .with(r -> r.withColUniqueidentifier(Optional.of(uuid)))
                  .insert(c);

          assertEquals(Optional.of(uuid), row.colUniqueidentifier());
        });
  }

  @Test
  public void testUniqueidentifierUniqueness() {
    SqlServerTestHelper.run(
        c -> {
          var uuid1 = UUID.randomUUID();
          var uuid2 = UUID.randomUUID();

          var row1 =
              testInsert
                  .AllScalarTypes()
                  .with(r -> r.withColUniqueidentifier(Optional.of(uuid1)))
                  .insert(c);
          var row2 =
              testInsert
                  .AllScalarTypes()
                  .with(r -> r.withColUniqueidentifier(Optional.of(uuid2)))
                  .insert(c);

          assertNotEquals(row1.colUniqueidentifier(), row2.colUniqueidentifier());
        });
  }

  // ==================== DATETIMEOFFSET Tests ====================

  @Test
  public void testDatetimeoffsetType() {
    SqlServerTestHelper.run(
        c -> {
          var datetimeoffset =
              OffsetDateTime.of(2025, 6, 15, 14, 30, 45, 0, ZoneOffset.ofHours(-5));
          var row =
              testInsert
                  .AllScalarTypes()
                  .with(r -> r.withColDatetimeoffset(Optional.of(datetimeoffset)))
                  .insert(c);

          assertTrue(row.colDatetimeoffset().isPresent());
        });
  }

  @Test
  public void testDatetimeoffsetDifferentTimezones() {
    SqlServerTestHelper.run(
        c -> {
          var utc = OffsetDateTime.of(2025, 6, 15, 12, 0, 0, 0, ZoneOffset.UTC);
          var pst = OffsetDateTime.of(2025, 6, 15, 5, 0, 0, 0, ZoneOffset.ofHours(-7));

          var rowUtc =
              testInsert
                  .AllScalarTypes()
                  .with(r -> r.withColDatetimeoffset(Optional.of(utc)))
                  .insert(c);
          var rowPst =
              testInsert
                  .AllScalarTypes()
                  .with(r -> r.withColDatetimeoffset(Optional.of(pst)))
                  .insert(c);

          assertTrue(rowUtc.colDatetimeoffset().isPresent());
          assertTrue(rowPst.colDatetimeoffset().isPresent());
        });
  }

  // ==================== HIERARCHYID Tests ====================

  @Test
  public void testHierarchyidType() {
    SqlServerTestHelper.run(
        c -> {
          var hierarchyid = HierarchyId.parse("/1/2/3/");
          var row =
              testInsert
                  .AllScalarTypes()
                  .with(r -> r.withColHierarchyid(Optional.of(hierarchyid)))
                  .insert(c);

          assertTrue(row.colHierarchyid().isPresent());
          assertEquals("/1/2/3/", row.colHierarchyid().get().toString());
        });
  }

  @Test
  public void testHierarchyidRootLevel() {
    SqlServerTestHelper.run(
        c -> {
          var hierarchyid = HierarchyId.parse("/");
          var row =
              testInsert
                  .AllScalarTypes()
                  .with(r -> r.withColHierarchyid(Optional.of(hierarchyid)))
                  .insert(c);

          assertTrue(row.colHierarchyid().isPresent());
          assertEquals("/", row.colHierarchyid().get().toString());
        });
  }

  // ==================== View Tests ====================

  @Test
  public void testCustomerOrdersView() {
    SqlServerTestHelper.run(
        c -> {
          var customer =
              testInsert
                  .Customers()
                  .with(
                      r ->
                          r.withName("View Test Customer")
                              .withEmail(new Email("viewtest@example.com")))
                  .insert(c);
          var order =
              testInsert
                  .Orders(customer.customerId())
                  .with(r -> r.withTotalAmount(new BigDecimal("199.99")))
                  .insert(c);

          var viewResults = customerOrdersViewRepo.select().toList(c);

          assertTrue(viewResults.size() >= 1);
          var customerView =
              viewResults.stream()
                  .filter(v -> v.customerId().equals(customer.customerId().value()))
                  .findFirst();
          assertTrue(customerView.isPresent());
          assertEquals("View Test Customer", customerView.get().customerName());
          assertEquals("viewtest@example.com", customerView.get().customerEmail());
        });
  }

  @Test
  public void testViewDSLFilter() {
    SqlServerTestHelper.run(
        c -> {
          var customer1 = testInsert.Customers().with(r -> r.withName("View Filter A")).insert(c);
          var customer2 = testInsert.Customers().with(r -> r.withName("View Filter B")).insert(c);
          testInsert.Orders(customer1.customerId()).insert(c);
          testInsert.Orders(customer2.customerId()).insert(c);

          var filtered =
              customerOrdersViewRepo
                  .select()
                  .where(v -> v.customerName().isEqual("View Filter A"))
                  .toList(c);

          assertTrue(filtered.stream().allMatch(v -> v.customerName().equals("View Filter A")));
        });
  }

  // ==================== Date/Time Tests ====================

  @Test
  public void testDatetimeTypes() {
    SqlServerTestHelper.run(
        c -> {
          var date = LocalDate.of(2025, 6, 15);
          var time = LocalTime.of(14, 30, 45);
          var datetime = LocalDateTime.of(2025, 6, 15, 14, 30, 45);
          var datetime2 = LocalDateTime.of(2025, 6, 15, 14, 30, 45, 123456700);

          var row =
              testInsert
                  .AllScalarTypes()
                  .with(
                      r ->
                          r.withColDate(Optional.of(date))
                              .withColTime(Optional.of(time))
                              .withColDatetime(Optional.of(datetime))
                              .withColDatetime2(Optional.of(datetime2)))
                  .insert(c);

          assertEquals(Optional.of(date), row.colDate());
          assertEquals(Optional.of(time), row.colTime());
        });
  }

  @Test
  public void testSmalldatetimeType() {
    SqlServerTestHelper.run(
        c -> {
          // SMALLDATETIME has minute precision (no seconds)
          var smalldatetime = LocalDateTime.of(2025, 6, 15, 14, 30, 0);
          var row =
              testInsert
                  .AllScalarTypes()
                  .with(r -> r.withColSmalldatetime(Optional.of(smalldatetime)))
                  .insert(c);

          assertTrue(row.colSmalldatetime().isPresent());
        });
  }

  // ==================== Default Value Tests ====================

  @Test
  public void testDefaultValueApplied() {
    SqlServerTestHelper.run(
        c -> {
          var row = testInsert.AllScalarTypes().insert(c);

          assertEquals("default_value", row.colNotNull());
        });
  }
}
