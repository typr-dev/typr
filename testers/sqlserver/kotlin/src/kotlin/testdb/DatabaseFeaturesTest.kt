package testdb

import dev.typr.foundations.data.HierarchyId
import dev.typr.foundations.data.Json
import dev.typr.foundations.data.Xml
import org.junit.Assert.*
import org.junit.Test
import testdb.all_scalar_types.*
import testdb.customers.*
import testdb.orders.*
import testdb.customer_orders_view.*
import testdb.userdefined.Email
import java.math.BigDecimal
import java.time.*
import java.util.Random
import java.util.UUID

/**
 * Tests for SQL Server-specific features: MONEY, ROWVERSION, XML, JSON, UUID,
 * DATETIMEOFFSET, HIERARCHYID, and Views.
 */
class DatabaseFeaturesTest {
    private val testInsert = TestInsert(Random(42))
    private val allTypesRepo = AllScalarTypesRepoImpl()
    private val customersRepo = CustomersRepoImpl()
    private val customerOrdersViewRepo = CustomerOrdersViewViewRepoImpl()

    // ==================== Money Type Tests ====================

    @Test
    fun testMoneyType() {
        SqlServerTestHelper.run { c ->
            val money = BigDecimal("922337203685477.5807") // Max MONEY value
            val row = testInsert.AllScalarTypes(colMoney = money, c = c)

            assertNotNull(row.colMoney)
            assertEquals(0, money.compareTo(row.colMoney!!))
        }
    }

    @Test
    fun testSmallmoneyType() {
        SqlServerTestHelper.run { c ->
            val smallmoney = BigDecimal("214748.3647") // Max SMALLMONEY value
            val row = testInsert.AllScalarTypes(colSmallmoney = smallmoney, c = c)

            assertNotNull(row.colSmallmoney)
            assertEquals(0, smallmoney.compareTo(row.colSmallmoney!!))
        }
    }

    @Test
    fun testMoneyPrecision() {
        SqlServerTestHelper.run { c ->
            val money = BigDecimal("1234.5678")
            val row = testInsert.AllScalarTypes(colMoney = money, c = c)

            assertNotNull(row.colMoney)
            assertEquals(0, money.compareTo(row.colMoney!!))
        }
    }

    // ==================== ROWVERSION Tests ====================

    @Test
    fun testRowversionAutoGenerated() {
        SqlServerTestHelper.run { c ->
            val row = testInsert.AllScalarTypes(c = c)

            assertNotNull(row.colRowversion)
            assertTrue(row.colRowversion.isNotEmpty())
        }
    }

    @Test
    fun testRowversionUniquePerRow() {
        SqlServerTestHelper.run { c ->
            val row1 = testInsert.AllScalarTypes(c = c)
            val row2 = testInsert.AllScalarTypes(c = c)

            assertNotNull(row1.colRowversion)
            assertNotNull(row2.colRowversion)
            assertFalse(row1.colRowversion.contentEquals(row2.colRowversion))
        }
    }

    @Test
    fun testRowversionChangesOnUpdate() {
        SqlServerTestHelper.run { c ->
            val inserted = testInsert.AllScalarTypes(c = c)
            val originalRowversion = inserted.colRowversion.clone()

            val updated = inserted.copy(colVarchar = "updated value")
            allTypesRepo.update(updated, c)

            val found = allTypesRepo.selectById(inserted.id, c)!!

            assertFalse(originalRowversion.contentEquals(found.colRowversion))
        }
    }

    // ==================== XML Tests ====================

    @Test
    fun testXmlType() {
        SqlServerTestHelper.run { c ->
            val xml = Xml("<root><element attr=\"value\">content</element></root>")
            val row = testInsert.AllScalarTypes(colXml = xml, c = c)

            assertNotNull(row.colXml)
            assertTrue(row.colXml!!.value.contains("root"))
            assertTrue(row.colXml!!.value.contains("element"))
        }
    }

    @Test
    fun testXmlNestedStructure() {
        SqlServerTestHelper.run { c ->
            val xml = Xml("<catalog><book id=\"1\"><title>SQL Server</title><price>29.99</price></book></catalog>")
            val row = testInsert.AllScalarTypes(colXml = xml, c = c)

            assertNotNull(row.colXml)
            assertTrue(row.colXml!!.value.contains("catalog"))
            assertTrue(row.colXml!!.value.contains("book"))
        }
    }

    // ==================== JSON Tests ====================

    @Test
    fun testJsonType() {
        SqlServerTestHelper.run { c ->
            val json = Json("{\"name\": \"test\", \"values\": [1, 2, 3], \"nested\": {\"key\": \"value\"}}")
            val row = testInsert.AllScalarTypes(colJson = json, c = c)

            assertNotNull(row.colJson)
            assertTrue(row.colJson!!.value.contains("name"))
            assertTrue(row.colJson!!.value.contains("nested"))
        }
    }

    // ==================== UUID (UNIQUEIDENTIFIER) Tests ====================

    @Test
    fun testUniqueidentifierType() {
        SqlServerTestHelper.run { c ->
            val uuid = UUID.randomUUID()
            val row = testInsert.AllScalarTypes(colUniqueidentifier = uuid, c = c)

            assertEquals(uuid, row.colUniqueidentifier)
        }
    }

    @Test
    fun testUniqueidentifierUniqueness() {
        SqlServerTestHelper.run { c ->
            val uuid1 = UUID.randomUUID()
            val uuid2 = UUID.randomUUID()

            val row1 = testInsert.AllScalarTypes(colUniqueidentifier = uuid1, c = c)
            val row2 = testInsert.AllScalarTypes(colUniqueidentifier = uuid2, c = c)

            assertNotEquals(row1.colUniqueidentifier, row2.colUniqueidentifier)
        }
    }

    // ==================== DATETIMEOFFSET Tests ====================

    @Test
    fun testDatetimeoffsetType() {
        SqlServerTestHelper.run { c ->
            val datetimeoffset = OffsetDateTime.of(2025, 6, 15, 14, 30, 45, 0, ZoneOffset.ofHours(-5))
            val row = testInsert.AllScalarTypes(colDatetimeoffset = datetimeoffset, c = c)

            assertNotNull(row.colDatetimeoffset)
        }
    }

    @Test
    fun testDatetimeoffsetDifferentTimezones() {
        SqlServerTestHelper.run { c ->
            val utc = OffsetDateTime.of(2025, 6, 15, 12, 0, 0, 0, ZoneOffset.UTC)
            val pst = OffsetDateTime.of(2025, 6, 15, 5, 0, 0, 0, ZoneOffset.ofHours(-7))

            val rowUtc = testInsert.AllScalarTypes(colDatetimeoffset = utc, c = c)
            val rowPst = testInsert.AllScalarTypes(colDatetimeoffset = pst, c = c)

            assertNotNull(rowUtc.colDatetimeoffset)
            assertNotNull(rowPst.colDatetimeoffset)
        }
    }

    // ==================== HIERARCHYID Tests ====================

    @Test
    fun testHierarchyidType() {
        SqlServerTestHelper.run { c ->
            val hierarchyid = HierarchyId.parse("/1/2/3/")
            val row = testInsert.AllScalarTypes(colHierarchyid = hierarchyid, c = c)

            assertNotNull(row.colHierarchyid)
            assertEquals(hierarchyid.toString(), row.colHierarchyid?.toString())
        }
    }

    @Test
    fun testHierarchyidRootLevel() {
        SqlServerTestHelper.run { c ->
            val hierarchyid = HierarchyId.ROOT
            val row = testInsert.AllScalarTypes(colHierarchyid = hierarchyid, c = c)

            assertNotNull(row.colHierarchyid)
            assertEquals(hierarchyid.toString(), row.colHierarchyid?.toString())
        }
    }

    // ==================== View Tests ====================

    @Test
    fun testCustomerOrdersView() {
        SqlServerTestHelper.run { c ->
            val customer = testInsert.Customers(
                name = "View Test Customer",
                email = Email("viewtest@example.com"),
                c = c
            )
            testInsert.Orders(
                customerId = customer.customerId,
                totalAmount = BigDecimal("199.99"),
                c = c
            )

            val viewResults = customerOrdersViewRepo.select().toList(c)

            assertTrue(viewResults.isNotEmpty())
            val customerView = viewResults.find { it.customerId == customer.customerId.value }
            assertNotNull(customerView)
            assertEquals("View Test Customer", customerView!!.customerName)
            assertEquals("viewtest@example.com", customerView.customerEmail)
        }
    }

    @Test
    fun testViewDSLFilter() {
        SqlServerTestHelper.run { c ->
            val customer1 = testInsert.Customers(name = "View Filter A", email = Email("filter-a@test.com"), c = c)
            val customer2 = testInsert.Customers(name = "View Filter B", email = Email("filter-b@test.com"), c = c)
            testInsert.Orders(customerId = customer1.customerId, c = c)
            testInsert.Orders(customerId = customer2.customerId, c = c)

            val filtered = customerOrdersViewRepo.select()
                .where { v -> v.customerName().isEqual("View Filter A") }
                .toList(c)

            assertTrue(filtered.all { it.customerName == "View Filter A" })
        }
    }

    // ==================== Date/Time Tests ====================

    @Test
    fun testDatetimeTypes() {
        SqlServerTestHelper.run { c ->
            val date = LocalDate.of(2025, 6, 15)
            val time = LocalTime.of(14, 30, 45)
            val datetime = LocalDateTime.of(2025, 6, 15, 14, 30, 45)
            val datetime2 = LocalDateTime.of(2025, 6, 15, 14, 30, 45, 123456700)

            val row = testInsert.AllScalarTypes(
                colDate = date,
                colTime = time,
                colDatetime = datetime,
                colDatetime2 = datetime2,
                c = c
            )

            assertEquals(date, row.colDate)
            assertEquals(time, row.colTime)
        }
    }

    @Test
    fun testSmalldatetimeType() {
        SqlServerTestHelper.run { c ->
            // SMALLDATETIME has minute precision (no seconds)
            val smalldatetime = LocalDateTime.of(2025, 6, 15, 14, 30, 0)
            val row = testInsert.AllScalarTypes(colSmalldatetime = smalldatetime, c = c)

            assertNotNull(row.colSmalldatetime)
        }
    }

    // ==================== Default Value Tests ====================

    @Test
    fun testDefaultValueApplied() {
        SqlServerTestHelper.run { c ->
            val row = testInsert.AllScalarTypes(c = c)

            assertEquals("default_value", row.colNotNull)
        }
    }
}
