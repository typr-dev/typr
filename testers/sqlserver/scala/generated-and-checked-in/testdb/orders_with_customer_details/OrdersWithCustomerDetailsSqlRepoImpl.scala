/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.orders_with_customer_details

import dev.typr.foundations.SqlServerTypes
import dev.typr.foundations.scala.Fragment
import dev.typr.foundations.scala.ScalaDbTypes
import dev.typr.foundations.scala.SqlServerTypeOps
import java.sql.Connection
import java.time.LocalDateTime
import dev.typr.foundations.scala.Fragment.sql

class OrdersWithCustomerDetailsSqlRepoImpl extends OrdersWithCustomerDetailsSqlRepo {
  override def apply(
    minAmount: Option[BigDecimal],
    startDate: Option[LocalDateTime]
  )(using c: Connection): List[OrdersWithCustomerDetailsSqlRow] = {
    sql"""-- Get orders with full customer details
    SELECT
        o.order_id,
        o.order_date,
        o.total_amount,
        c.customer_id,
        c.name as customer_name,
        c.email as customer_email
    FROM orders o
    INNER JOIN customers c ON o.customer_id = c.customer_id
    WHERE (${Fragment.encode(ScalaDbTypes.SqlServerTypes.numeric.nullable, minAmount)} IS NULL OR o.total_amount >= ${Fragment.encode(ScalaDbTypes.SqlServerTypes.numeric.nullable, minAmount)})
      AND (${Fragment.encode(SqlServerTypes.datetime2.nullable, startDate)} IS NULL OR o.order_date >= ${Fragment.encode(SqlServerTypes.datetime2.nullable, startDate)})
    ORDER BY o.order_date DESC
    """.query(OrdersWithCustomerDetailsSqlRow.`_rowParser`.all()).runUnchecked(c)
  }
}