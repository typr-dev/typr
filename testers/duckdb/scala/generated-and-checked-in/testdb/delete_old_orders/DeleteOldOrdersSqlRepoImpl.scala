/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.delete_old_orders

import dev.typr.foundations.DuckDbTypes
import dev.typr.foundations.scala.DuckDbTypeOps
import dev.typr.foundations.scala.Fragment
import java.sql.Connection
import java.time.LocalDate
import dev.typr.foundations.scala.Fragment.sql

class DeleteOldOrdersSqlRepoImpl extends DeleteOldOrdersSqlRepo {
  override def apply(
    cutoffDate: LocalDate,
    status: Option[String]
  )(using c: Connection): Int = {
    sql"""-- Delete old orders and return what was deleted
    -- Tests: DELETE with RETURNING, date comparisons, status filtering
  
    DELETE FROM orders
    WHERE
        order_date < CAST(${Fragment.encode(DuckDbTypes.date, cutoffDate)} AS DATE)
        AND (${Fragment.encode(DuckDbTypes.text.nullable, status)} IS NULL OR status = CAST(${Fragment.encode(DuckDbTypes.text.nullable, status)} AS VARCHAR))
    RETURNING
        order_id,
        customer_id,
        order_date,
        total_amount,
        status""".update().runUnchecked(c)
  }
}