/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.employee_salary_update

import dev.typr.foundations.DuckDbTypes
import dev.typr.foundations.scala.DuckDbTypeOps
import dev.typr.foundations.scala.Fragment
import dev.typr.foundations.scala.ScalaDbTypes
import java.sql.Connection
import dev.typr.foundations.scala.Fragment.sql

class EmployeeSalaryUpdateSqlRepoImpl extends EmployeeSalaryUpdateSqlRepo {
  override def apply(
    raisePercentage: Option[BigDecimal],
    newSalary: BigDecimal,
    empNumber: Int,
    empSuffix: String
  )(using c: Connection): Int = {
    sql"""-- Update employee salary using composite primary key
    -- Tests: UPDATE with composite primary key, RETURNING, decimal arithmetic
  
    UPDATE employees
    SET salary = CASE
        WHEN ${Fragment.encode(ScalaDbTypes.DuckDbTypes.numeric.nullable, raisePercentage)} IS NOT NULL THEN salary * (1 + CAST(${Fragment.encode(ScalaDbTypes.DuckDbTypes.numeric.nullable, raisePercentage)} AS DECIMAL) / 100.0)
        ELSE CAST(${Fragment.encode(ScalaDbTypes.DuckDbTypes.numeric, newSalary)} AS DECIMAL)
    END
    WHERE emp_number = CAST(${Fragment.encode(ScalaDbTypes.DuckDbTypes.integer, empNumber)} AS INTEGER)
      AND emp_suffix = CAST(${Fragment.encode(DuckDbTypes.text, empSuffix)} AS VARCHAR)
    RETURNING
        emp_number,
        emp_suffix,
        dept_code,
        dept_region,
        emp_name,
        salary,
        hire_date""".update().runUnchecked(c)
  }
}