/**
 * File has been automatically generated by `typo`.
 *
 * <p>IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package oracledb.all_types_test;

import static dev.typr.foundations.Fragment.interpolate;

import dev.typr.foundations.Fragment;
import dev.typr.foundations.OracleTypes;
import dev.typr.foundations.dsl.DeleteBuilder;
import dev.typr.foundations.dsl.Dialect;
import dev.typr.foundations.dsl.SelectBuilder;
import dev.typr.foundations.dsl.UpdateBuilder;
import java.sql.Connection;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import oracledb.AllTypesStructNoLobs;
import oracledb.AllTypesStructNoLobsArray;

public class AllTypesTestRepoImpl implements AllTypesTestRepo {
  @Override
  public DeleteBuilder<AllTypesTestFields, AllTypesTestRow> delete() {
    return DeleteBuilder.of("\"ALL_TYPES_TEST\"", AllTypesTestFields.structure, Dialect.ORACLE);
  }

  @Override
  public Boolean deleteById(AllTypesTestId id, Connection c) {
    return interpolate(
                Fragment.lit("delete from \"ALL_TYPES_TEST\" where \"ID\" = "),
                Fragment.encode(AllTypesTestId.oracleType, id),
                Fragment.lit(""))
            .update()
            .runUnchecked(c)
        > 0;
  }

  @Override
  public Integer deleteByIds(AllTypesTestId[] ids, Connection c) {
    ArrayList<Fragment> fragments = new ArrayList<>();
    for (var id : ids) {
      fragments.add(Fragment.encode(AllTypesTestId.oracleType, id));
    }
    ;
    return Fragment.interpolate(
            Fragment.lit("delete from \"ALL_TYPES_TEST\" where \"ID\" in ("),
            Fragment.comma(fragments),
            Fragment.lit(")"))
        .update()
        .runUnchecked(c);
  }

  @Override
  public AllTypesTestId insert(AllTypesTestRow unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "insert into \"ALL_TYPES_TEST\"(\"ID\", \"NAME\", \"DATA\", \"DATA_ARRAY\")\n"
                    + "values ("),
            Fragment.encode(AllTypesTestId.oracleType, unsaved.id()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.name()),
            Fragment.lit(", "),
            Fragment.encode(AllTypesStructNoLobs.oracleType.opt(), unsaved.data()),
            Fragment.lit(", "),
            Fragment.encode(AllTypesStructNoLobsArray.oracleType.opt(), unsaved.dataArray()),
            Fragment.lit(")\n"))
        .updateReturningGeneratedKeys(new String[] {"ID"}, AllTypesTestId._rowParser.exactlyOne())
        .runUnchecked(c);
  }

  @Override
  public AllTypesTestId insert(AllTypesTestRowUnsaved unsaved, Connection c) {
    ArrayList<Fragment> columns = new ArrayList<>();
    ;
    ArrayList<Fragment> values = new ArrayList<>();
    ;
    columns.add(Fragment.lit("\"NAME\""));
    values.add(
        interpolate(Fragment.encode(OracleTypes.varchar2, unsaved.name()), Fragment.lit("")));
    columns.add(Fragment.lit("\"DATA\""));
    values.add(
        interpolate(
            Fragment.encode(AllTypesStructNoLobs.oracleType.opt(), unsaved.data()),
            Fragment.lit("")));
    columns.add(Fragment.lit("\"DATA_ARRAY\""));
    values.add(
        interpolate(
            Fragment.encode(AllTypesStructNoLobsArray.oracleType.opt(), unsaved.dataArray()),
            Fragment.lit("")));
    unsaved
        .id()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("\"ID\""));
              values.add(
                  interpolate(Fragment.encode(AllTypesTestId.oracleType, value), Fragment.lit("")));
            });
    ;
    Fragment q =
        interpolate(
            Fragment.lit("insert into \"ALL_TYPES_TEST\"("),
            Fragment.comma(columns),
            Fragment.lit(")\nvalues ("),
            Fragment.comma(values),
            Fragment.lit(")\n"));
    ;
    return q.updateReturningGeneratedKeys(
            new String[] {"ID"}, AllTypesTestId._rowParser.exactlyOne())
        .runUnchecked(c);
  }

  @Override
  public SelectBuilder<AllTypesTestFields, AllTypesTestRow> select() {
    return SelectBuilder.of(
        "\"ALL_TYPES_TEST\"",
        AllTypesTestFields.structure,
        AllTypesTestRow._rowParser,
        Dialect.ORACLE);
  }

  @Override
  public List<AllTypesTestRow> selectAll(Connection c) {
    return interpolate(
            Fragment.lit(
                "select \"ID\", \"NAME\", \"DATA\", \"DATA_ARRAY\"\nfrom \"ALL_TYPES_TEST\"\n"))
        .query(AllTypesTestRow._rowParser.all())
        .runUnchecked(c);
  }

  @Override
  public Optional<AllTypesTestRow> selectById(AllTypesTestId id, Connection c) {
    return interpolate(
            Fragment.lit(
                "select \"ID\", \"NAME\", \"DATA\", \"DATA_ARRAY\"\n"
                    + "from \"ALL_TYPES_TEST\"\n"
                    + "where \"ID\" = "),
            Fragment.encode(AllTypesTestId.oracleType, id),
            Fragment.lit(""))
        .query(AllTypesTestRow._rowParser.first())
        .runUnchecked(c);
  }

  @Override
  public List<AllTypesTestRow> selectByIds(AllTypesTestId[] ids, Connection c) {
    ArrayList<Fragment> fragments = new ArrayList<>();
    for (var id : ids) {
      fragments.add(Fragment.encode(AllTypesTestId.oracleType, id));
    }
    ;
    return Fragment.interpolate(
            Fragment.lit(
                "select \"ID\", \"NAME\", \"DATA\", \"DATA_ARRAY\" from \"ALL_TYPES_TEST\" where"
                    + " \"ID\" in ("),
            Fragment.comma(fragments),
            Fragment.lit(")"))
        .query(AllTypesTestRow._rowParser.all())
        .runUnchecked(c);
  }

  @Override
  public Map<AllTypesTestId, AllTypesTestRow> selectByIdsTracked(
      AllTypesTestId[] ids, Connection c) {
    HashMap<AllTypesTestId, AllTypesTestRow> ret = new HashMap<AllTypesTestId, AllTypesTestRow>();
    selectByIds(ids, c).forEach(row -> ret.put(row.id(), row));
    return ret;
  }

  @Override
  public UpdateBuilder<AllTypesTestFields, AllTypesTestRow> update() {
    return UpdateBuilder.of(
        "\"ALL_TYPES_TEST\"",
        AllTypesTestFields.structure,
        AllTypesTestRow._rowParser,
        Dialect.ORACLE);
  }

  @Override
  public Boolean update(AllTypesTestRow row, Connection c) {
    AllTypesTestId id = row.id();
    ;
    return interpolate(
                Fragment.lit("update \"ALL_TYPES_TEST\"\nset \"NAME\" = "),
                Fragment.encode(OracleTypes.varchar2, row.name()),
                Fragment.lit(",\n\"DATA\" = "),
                Fragment.encode(AllTypesStructNoLobs.oracleType.opt(), row.data()),
                Fragment.lit(",\n\"DATA_ARRAY\" = "),
                Fragment.encode(AllTypesStructNoLobsArray.oracleType.opt(), row.dataArray()),
                Fragment.lit("\nwhere \"ID\" = "),
                Fragment.encode(AllTypesTestId.oracleType, id),
                Fragment.lit(""))
            .update()
            .runUnchecked(c)
        > 0;
  }

  @Override
  public void upsert(AllTypesTestRow unsaved, Connection c) {
    interpolate(
            Fragment.lit("MERGE INTO \"ALL_TYPES_TEST\" t\nUSING (SELECT "),
            Fragment.encode(AllTypesTestId.oracleType, unsaved.id()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.name()),
            Fragment.lit(", "),
            Fragment.encode(AllTypesStructNoLobs.oracleType.opt(), unsaved.data()),
            Fragment.lit(", "),
            Fragment.encode(AllTypesStructNoLobsArray.oracleType.opt(), unsaved.dataArray()),
            Fragment.lit(
                " FROM DUAL) s\n"
                    + "ON (t.\"ID\" = s.\"ID\")\n"
                    + "WHEN MATCHED THEN UPDATE SET t.\"NAME\" = s.\"NAME\",\n"
                    + "t.\"DATA\" = s.\"DATA\",\n"
                    + "t.\"DATA_ARRAY\" = s.\"DATA_ARRAY\"\n"
                    + "WHEN NOT MATCHED THEN INSERT (\"ID\", \"NAME\", \"DATA\", \"DATA_ARRAY\")"
                    + " VALUES ("),
            Fragment.encode(AllTypesTestId.oracleType, unsaved.id()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.name()),
            Fragment.lit(", "),
            Fragment.encode(AllTypesStructNoLobs.oracleType.opt(), unsaved.data()),
            Fragment.lit(", "),
            Fragment.encode(AllTypesStructNoLobsArray.oracleType.opt(), unsaved.dataArray()),
            Fragment.lit(")"))
        .update()
        .runUnchecked(c);
  }

  @Override
  public void upsertBatch(Iterator<AllTypesTestRow> unsaved, Connection c) {
    interpolate(
            Fragment.lit(
                "MERGE INTO \"ALL_TYPES_TEST\" t\n"
                    + "USING (SELECT ?, ?, ?, ? FROM DUAL) s\n"
                    + "ON (t.\"ID\" = s.\"ID\")\n"
                    + "WHEN MATCHED THEN UPDATE SET t.\"NAME\" = s.\"NAME\",\n"
                    + "t.\"DATA\" = s.\"DATA\",\n"
                    + "t.\"DATA_ARRAY\" = s.\"DATA_ARRAY\"\n"
                    + "WHEN NOT MATCHED THEN INSERT (\"ID\", \"NAME\", \"DATA\", \"DATA_ARRAY\")"
                    + " VALUES (?, ?, ?, ?)"))
        .updateMany(AllTypesTestRow._rowParser, unsaved)
        .runUnchecked(c);
  }
}
