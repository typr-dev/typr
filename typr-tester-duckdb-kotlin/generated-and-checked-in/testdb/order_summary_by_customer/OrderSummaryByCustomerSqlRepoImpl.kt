/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.order_summary_by_customer

import java.math.BigDecimal
import java.sql.Connection
import kotlin.collections.List
import typr.kotlindsl.Fragment
import typr.kotlindsl.KotlinDbTypes
import typr.kotlindsl.nullable
import typr.runtime.DuckDbTypes

class OrderSummaryByCustomerSqlRepoImpl() : OrderSummaryByCustomerSqlRepo {
  override fun apply(
    customerIds: Array<Int>?,
    minTotal: BigDecimal?,
    minOrderCount: Int?,
    c: Connection
  ): List<OrderSummaryByCustomerSqlRow> = Fragment.interpolate(Fragment.lit("-- Order summary with aggregations and complex joins\n-- Tests: aggregations, GROUP BY, HAVING, multiple joins, type-safe IDs in WHERE\n\nSELECT\n    c.customer_id,\n    c.name AS customer_name,\n    c.email,\n    c.priority,\n    COUNT(DISTINCT o.order_id) AS order_count,\n    COALESCE(SUM(o.total_amount), 0.0) AS total_spent,\n    MAX(o.order_date) AS last_order_date,\n    MIN(o.order_date) AS first_order_date,\n    COALESCE(AVG(o.total_amount), 0.0) AS avg_order_amount\nFROM customers c\nLEFT JOIN orders o ON c.customer_id = o.customer_id\nWHERE\n    ("), Fragment.encode(DuckDbTypes.integerArray.nullable(), customerIds), Fragment.lit(" IS NULL OR c.customer_id = ANY(CAST("), Fragment.encode(DuckDbTypes.integerArray.nullable(), customerIds), Fragment.lit(" AS INTEGER[])))\n    AND ("), Fragment.encode(DuckDbTypes.numeric.nullable(), minTotal), Fragment.lit(" IS NULL OR c.customer_id IN (\n        SELECT customer_id\n        FROM orders\n        GROUP BY customer_id\n        HAVING SUM(total_amount) >= CAST("), Fragment.encode(DuckDbTypes.numeric.nullable(), minTotal), Fragment.lit(" AS DECIMAL)\n    ))\nGROUP BY c.customer_id, c.name, c.email, c.priority\nHAVING\n    ("), Fragment.encode(KotlinDbTypes.DuckDbTypes.integer.nullable(), minOrderCount), Fragment.lit(" IS NULL OR COUNT(DISTINCT o.order_id) >= CAST("), Fragment.encode(KotlinDbTypes.DuckDbTypes.integer.nullable(), minOrderCount), Fragment.lit(" AS INTEGER))\nORDER BY total_spent DESC, customer_name")).query(OrderSummaryByCustomerSqlRow._rowParser.all()).runUnchecked(c)
}