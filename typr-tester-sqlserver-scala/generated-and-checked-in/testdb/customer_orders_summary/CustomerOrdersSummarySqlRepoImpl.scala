/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.customer_orders_summary

import java.sql.Connection
import typr.runtime.SqlServerTypes
import typr.scaladsl.Fragment
import typr.scaladsl.ScalaDbTypes
import typr.scaladsl.SqlServerTypeOps
import typr.scaladsl.Fragment.sql

class CustomerOrdersSummarySqlRepoImpl extends CustomerOrdersSummarySqlRepo {
  override def apply(
    customerNamePattern: Option[String],
    minTotal: Option[BigDecimal]
  )(using c: Connection): List[CustomerOrdersSummarySqlRow] = {
    sql"""-- Get order summary statistics for customers
    SELECT
        c.customer_id,
        c.name as customer_name,
        c.email as customer_email,
        COUNT(o.order_id) as order_count,
        COALESCE(SUM(o.total_amount), 0) as total_spent,
        COALESCE(AVG(o.total_amount), 0) as avg_order_amount,
        MAX(o.order_date) as last_order_date
    FROM customers c
    LEFT JOIN orders o ON c.customer_id = o.customer_id
    WHERE (${Fragment.encode(SqlServerTypes.nvarchar.nullable, customerNamePattern)} IS NULL OR c.name LIKE ${Fragment.encode(SqlServerTypes.nvarchar.nullable, customerNamePattern)})
    GROUP BY c.customer_id, c.name, c.email
    HAVING COUNT(o.order_id) > 0
      AND (${Fragment.encode(ScalaDbTypes.SqlServerTypes.numeric.nullable, minTotal)} IS NULL OR COALESCE(SUM(o.total_amount), 0) >= ${Fragment.encode(ScalaDbTypes.SqlServerTypes.numeric.nullable, minTotal)})
    ORDER BY total_spent DESC
    """.query(CustomerOrdersSummarySqlRow.`_rowParser`.all()).runUnchecked(c)
  }
}