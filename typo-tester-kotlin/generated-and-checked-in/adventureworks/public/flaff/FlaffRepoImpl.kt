/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package adventureworks.public.flaff

import adventureworks.public.ShortText
import java.sql.Connection
import java.util.HashMap
import java.util.Iterator
import kotlin.collections.List
import kotlin.collections.Map
import typo.runtime.PgTypes
import typo.runtime.internal.arrayMap
import typo.runtime.streamingInsert
import typo.runtime.Fragment.interpolate
import typo.runtime.internal.stringInterpolator.str

data class FlaffRepoImpl() : FlaffRepo {
  fun deleteById(
    compositeId: FlaffId,
    c: Connection
  ): Boolean = interpolate(
    typo.runtime.Fragment.lit("""
    delete from "public"."flaff" where "code" = 
    """.trimMargin()),
    ShortText.pgType.encode(compositeId.code),
    typo.runtime.Fragment.lit("""
     AND "another_code" = 
    """.trimMargin()),
    PgTypes.text.encode(compositeId.anotherCode),
    typo.runtime.Fragment.lit("""
     AND "some_number" = 
    """.trimMargin()),
    PgTypes.int4.encode(compositeId.someNumber),
    typo.runtime.Fragment.lit("""
     AND "specifier" = 
    """.trimMargin()),
    ShortText.pgType.encode(compositeId.specifier),
    typo.runtime.Fragment.lit("")
  ).update().runUnchecked(c) > 0

  fun deleteByIds(
    compositeIds: Array<FlaffId>,
    c: Connection
  ): Int {
    val code: Array<ShortText> = arrayMap.map(compositeIds, FlaffId::code, ShortText::class.java)
      val anotherCode: Array</* max 20 chars */ java.lang.String> = arrayMap.map(compositeIds, FlaffId::anotherCode, /* max 20 chars */ java.lang.String::class.java)
      val someNumber: Array<Int> = arrayMap.map(compositeIds, FlaffId::someNumber, Int::class.java)
      val specifier: Array<ShortText> = arrayMap.map(compositeIds, FlaffId::specifier, ShortText::class.java)
    return interpolate(
             typo.runtime.Fragment.lit("""
               delete
               from "public"."flaff"
               where ("code", "another_code", "some_number", "specifier")
               in (select unnest(""".trimMargin()),
             ShortText.pgTypeArray.encode(code),
             typo.runtime.Fragment.lit("::text[]), unnest("),
             PgTypes.textArray.encode(anotherCode),
             typo.runtime.Fragment.lit("::varchar[]), unnest("),
             PgTypes.int4Array.encode(someNumber),
             typo.runtime.Fragment.lit("::int4[]), unnest("),
             ShortText.pgTypeArray.encode(specifier),
             typo.runtime.Fragment.lit("""
             ::text[]))

             """.trimMargin())
           ).update().runUnchecked(c)
  }

  fun insert(
    unsaved: FlaffRow,
    c: Connection
  ): FlaffRow = interpolate(
    typo.runtime.Fragment.lit("""
      insert into "public"."flaff"("code", "another_code", "some_number", "specifier", "parentspecifier")
      values (""".trimMargin()),
    ShortText.pgType.encode(unsaved.code),
    typo.runtime.Fragment.lit("::text, "),
    PgTypes.text.encode(unsaved.anotherCode),
    typo.runtime.Fragment.lit(", "),
    PgTypes.int4.encode(unsaved.someNumber),
    typo.runtime.Fragment.lit("::int4, "),
    ShortText.pgType.encode(unsaved.specifier),
    typo.runtime.Fragment.lit("::text, "),
    ShortText.pgType.opt().encode(unsaved.parentspecifier),
    typo.runtime.Fragment.lit("""
      ::text)
      returning "code", "another_code", "some_number", "specifier", "parentspecifier"
    """.trimMargin())
  )
    .updateReturning(FlaffRow._rowParser.exactlyOne()).runUnchecked(c)

  fun insertStreaming(
    unsaved: Iterator<FlaffRow>,
    batchSize: Int,
    c: Connection
  ): Long = streamingInsert.insertUnchecked(str("""
  COPY "public"."flaff"("code", "another_code", "some_number", "specifier", "parentspecifier") FROM STDIN
  """.trimMargin()), batchSize, unsaved, c, FlaffRow.pgText)

  fun selectAll(c: Connection): List<FlaffRow> = interpolate(typo.runtime.Fragment.lit("""
    select "code", "another_code", "some_number", "specifier", "parentspecifier"
    from "public"."flaff"
  """.trimMargin())).as(FlaffRow._rowParser.all()).runUnchecked(c)

  fun selectById(
    compositeId: FlaffId,
    c: Connection
  ): FlaffRow? = interpolate(
    typo.runtime.Fragment.lit("""
      select "code", "another_code", "some_number", "specifier", "parentspecifier"
      from "public"."flaff"
      where "code" = """.trimMargin()),
    ShortText.pgType.encode(compositeId.code),
    typo.runtime.Fragment.lit("""
     AND "another_code" = 
    """.trimMargin()),
    PgTypes.text.encode(compositeId.anotherCode),
    typo.runtime.Fragment.lit("""
     AND "some_number" = 
    """.trimMargin()),
    PgTypes.int4.encode(compositeId.someNumber),
    typo.runtime.Fragment.lit("""
     AND "specifier" = 
    """.trimMargin()),
    ShortText.pgType.encode(compositeId.specifier),
    typo.runtime.Fragment.lit("")
  ).as(FlaffRow._rowParser.first()).runUnchecked(c)

  fun selectByIds(
    compositeIds: Array<FlaffId>,
    c: Connection
  ): List<FlaffRow> {
    val code: Array<ShortText> = arrayMap.map(compositeIds, FlaffId::code, ShortText::class.java)
      val anotherCode: Array</* max 20 chars */ java.lang.String> = arrayMap.map(compositeIds, FlaffId::anotherCode, /* max 20 chars */ java.lang.String::class.java)
      val someNumber: Array<Int> = arrayMap.map(compositeIds, FlaffId::someNumber, Int::class.java)
      val specifier: Array<ShortText> = arrayMap.map(compositeIds, FlaffId::specifier, ShortText::class.java)
    return interpolate(
             typo.runtime.Fragment.lit("""
               select "code", "another_code", "some_number", "specifier", "parentspecifier"
               from "public"."flaff"
               where ("code", "another_code", "some_number", "specifier")
               in (select unnest(""".trimMargin()),
             ShortText.pgTypeArray.encode(code),
             typo.runtime.Fragment.lit("::text[]), unnest("),
             PgTypes.textArray.encode(anotherCode),
             typo.runtime.Fragment.lit("::varchar[]), unnest("),
             PgTypes.int4Array.encode(someNumber),
             typo.runtime.Fragment.lit("::int4[]), unnest("),
             ShortText.pgTypeArray.encode(specifier),
             typo.runtime.Fragment.lit("""
             ::text[]))

             """.trimMargin())
           ).as(FlaffRow._rowParser.all()).runUnchecked(c)
  }

  fun selectByIdsTracked(
    compositeIds: Array<FlaffId>,
    c: Connection
  ): Map<FlaffId, FlaffRow> {
    val ret: java.util.Map<FlaffId, FlaffRow> = HashMap()
      for (var row : selectByIds(compositeIds, c)) {
          ret.put(row.id(), row);
      }
    return ret
  }

  fun update(
    row: FlaffRow,
    c: Connection
  ): Boolean {
    val compositeId: FlaffId = row.compositeId
    return interpolate(
             typo.runtime.Fragment.lit("""
               update "public"."flaff"
               set "parentspecifier" = """.trimMargin()),
             ShortText.pgType.opt().encode(row.parentspecifier),
             typo.runtime.Fragment.lit("""
               ::text
               where "code" = """.trimMargin()),
             ShortText.pgType.encode(compositeId.code),
             typo.runtime.Fragment.lit("""
              AND "another_code" = 
             """.trimMargin()),
             PgTypes.text.encode(compositeId.anotherCode),
             typo.runtime.Fragment.lit("""
              AND "some_number" = 
             """.trimMargin()),
             PgTypes.int4.encode(compositeId.someNumber),
             typo.runtime.Fragment.lit("""
              AND "specifier" = 
             """.trimMargin()),
             ShortText.pgType.encode(compositeId.specifier),
             typo.runtime.Fragment.lit("")
           ).update().runUnchecked(c) > 0
  }

  fun upsert(
    unsaved: FlaffRow,
    c: Connection
  ): FlaffRow = interpolate(
    typo.runtime.Fragment.lit("""
      insert into "public"."flaff"("code", "another_code", "some_number", "specifier", "parentspecifier")
      values (""".trimMargin()),
    ShortText.pgType.encode(unsaved.code),
    typo.runtime.Fragment.lit("::text, "),
    PgTypes.text.encode(unsaved.anotherCode),
    typo.runtime.Fragment.lit(", "),
    PgTypes.int4.encode(unsaved.someNumber),
    typo.runtime.Fragment.lit("::int4, "),
    ShortText.pgType.encode(unsaved.specifier),
    typo.runtime.Fragment.lit("::text, "),
    ShortText.pgType.opt().encode(unsaved.parentspecifier),
    typo.runtime.Fragment.lit("""
      ::text)
      on conflict ("code", "another_code", "some_number", "specifier")
      do update set
        "parentspecifier" = EXCLUDED."parentspecifier"
      returning "code", "another_code", "some_number", "specifier", "parentspecifier"
    """.trimMargin())
  )
    .updateReturning(FlaffRow._rowParser.exactlyOne())
    .runUnchecked(c)

  fun upsertBatch(
    unsaved: Iterator<FlaffRow>,
    c: Connection
  ): List<FlaffRow> = interpolate(typo.runtime.Fragment.lit("""
                        insert into "public"."flaff"("code", "another_code", "some_number", "specifier", "parentspecifier")
                        values (?::text, ?, ?::int4, ?::text, ?::text)
                        on conflict ("code", "another_code", "some_number", "specifier")
                        do update set
                          "parentspecifier" = EXCLUDED."parentspecifier"
                        returning "code", "another_code", "some_number", "specifier", "parentspecifier"
                      """.trimMargin()))
    .updateManyReturning(FlaffRow._rowParser, unsaved)
    .runUnchecked(c)

  /** NOTE: this functionality is not safe if you use auto-commit mode! it runs 3 SQL statements */
  fun upsertStreaming(
    unsaved: Iterator<FlaffRow>,
    batchSize: Int,
    c: Connection
  ): Int {
    interpolate(typo.runtime.Fragment.lit("""
      create temporary table flaff_TEMP (like "public"."flaff") on commit drop
      """.trimMargin())).update().runUnchecked(c)
      streamingInsert.insertUnchecked(str("""
      copy flaff_TEMP("code", "another_code", "some_number", "specifier", "parentspecifier") from stdin
      """.trimMargin()), batchSize, unsaved, c, FlaffRow.pgText)
    return interpolate(typo.runtime.Fragment.lit("""
             insert into "public"."flaff"("code", "another_code", "some_number", "specifier", "parentspecifier")
             select * from flaff_TEMP
             on conflict ("code", "another_code", "some_number", "specifier")
             do update set
               "parentspecifier" = EXCLUDED."parentspecifier"
             ;
             drop table flaff_TEMP;""".trimMargin())).update().runUnchecked(c)
  }
}