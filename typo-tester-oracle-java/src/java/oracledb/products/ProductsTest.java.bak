package oracledb.products;

import oracledb.MoneyT;
import oracledb.OracleTestHelper;
import oracledb.TagVarrayT;
import oracledb.customtypes.Defaulted;
import org.junit.Test;

import java.math.BigDecimal;
import java.util.Arrays;
import java.util.List;
import java.util.Optional;

import static org.junit.Assert.*;

public class ProductsTest {
    private final ProductsRepoImpl repo = new ProductsRepoImpl();

    @Test
    public void testInsertProductWithVarrayTags() {
        OracleTestHelper.run(c -> {
            MoneyT price = new MoneyT(new BigDecimal("99.99"), "USD");
            TagVarrayT tags = new TagVarrayT(new String[]{"electronics", "gadget", "new"});

            ProductsRowUnsaved unsaved = new ProductsRowUnsaved(
                "PROD-001",
                "Test Product",
                price,
                Optional.of(tags),
                new Defaulted.UseDefault<>()
            );

            ProductsId insertedId = repo.insert(unsaved, c);

            assertNotNull(insertedId);
            ProductsRow inserted = repo.selectById(insertedId, c).orElseThrow();
            assertEquals("PROD-001", inserted.sku());
            assertEquals("Test Product", inserted.name());
            assertEquals(price, inserted.price());
            assertTrue(inserted.tags().isPresent());
            assertArrayEquals(new String[]{"electronics", "gadget", "new"}, inserted.tags().get().value());
        });
    }

    @Test
    public void testInsertProductWithoutTags() {
        OracleTestHelper.run(c -> {
            MoneyT price = new MoneyT(new BigDecimal("49.99"), "EUR");

            ProductsRowUnsaved unsaved = new ProductsRowUnsaved(
                "PROD-002",
                "Product Without Tags",
                price,
                Optional.empty(),
                new Defaulted.UseDefault<>()
            );

            ProductsRow inserted = repo.insert(unsaved, c);

            assertNotNull(inserted.productId());
            assertEquals("PROD-002", inserted.sku());
            assertFalse(inserted.tags().isPresent());
        });
    }

    @Test
    public void testVarrayRoundtrip() {
        OracleTestHelper.run(c -> {
            String[] tagArray = new String[]{"tag1", "tag2", "tag3", "tag4", "tag5"};
            TagVarrayT tags = new TagVarrayT(tagArray);

            MoneyT price = new MoneyT(new BigDecimal("199.99"), "USD");

            ProductsRowUnsaved unsaved = new ProductsRowUnsaved(
                "PROD-VARRAY",
                "Varray Test Product",
                price,
                Optional.of(tags),
                new Defaulted.UseDefault<>()
            );

            ProductsRow inserted = repo.insert(unsaved, c);

            Optional<ProductsRow> found = repo.selectById(inserted.productId(), c);
            assertTrue(found.isPresent());
            assertTrue(found.get().tags().isPresent());
            assertArrayEquals(tagArray, found.get().tags().get().value());
        });
    }

    @Test
    public void testUpdateTags() {
        OracleTestHelper.run(c -> {
            TagVarrayT originalTags = new TagVarrayT(new String[]{"old", "tags"});
            MoneyT price = new MoneyT(new BigDecimal("99.99"), "USD");

            ProductsRowUnsaved unsaved = new ProductsRowUnsaved(
                "PROD-UPDATE",
                "Update Tags Test",
                price,
                Optional.of(originalTags),
                new Defaulted.UseDefault<>()
            );

            ProductsRow inserted = repo.insert(unsaved, c);

            TagVarrayT newTags = new TagVarrayT(new String[]{"new", "updated", "tags"});
            ProductsRow updatedRow = inserted.withTags(Optional.of(newTags));

            Boolean wasUpdated = repo.update(updatedRow, c);
            assertTrue(wasUpdated);
            assertTrue(updatedRow.tags().isPresent());
            assertArrayEquals(new String[]{"new", "updated", "tags"}, updatedRow.tags().get().value());
        });
    }

    @Test
    public void testUpdatePrice() {
        OracleTestHelper.run(c -> {
            MoneyT originalPrice = new MoneyT(new BigDecimal("100.00"), "USD");
            ProductsRowUnsaved unsaved = new ProductsRowUnsaved(
                "PROD-PRICE",
                "Price Update Test",
                originalPrice,
                Optional.empty(),
                new Defaulted.UseDefault<>()
            );

            ProductsRow inserted = repo.insert(unsaved, c);

            MoneyT newPrice = new MoneyT(new BigDecimal("150.00"), "EUR");
            ProductsRow updatedRow = inserted.withPrice(newPrice);

            Boolean wasUpdated = repo.update(updatedRow, c);
            assertTrue(wasUpdated);
            assertEquals(new BigDecimal("150.00"), updatedRow.price().amount());
            assertEquals("EUR", updatedRow.price().currency());
        });
    }

    @Test
    public void testVarrayWithSingleElement() {
        OracleTestHelper.run(c -> {
            TagVarrayT tags = new TagVarrayT(new String[]{"single"});
            MoneyT price = new MoneyT(new BigDecimal("10.00"), "USD");

            ProductsRowUnsaved unsaved = new ProductsRowUnsaved(
                "PROD-SINGLE",
                "Single Tag Product",
                price,
                Optional.of(tags),
                new Defaulted.UseDefault<>()
            );

            ProductsRow inserted = repo.insert(unsaved, c);
            assertTrue(inserted.tags().isPresent());
            assertEquals(1, inserted.tags().get().value().length);
            assertEquals("single", inserted.tags().get().value()[0]);
        });
    }

    @Test
    public void testVarrayWithMaxSize() {
        OracleTestHelper.run(c -> {
            String[] maxTags = new String[]{"tag1", "tag2", "tag3", "tag4", "tag5", "tag6", "tag7", "tag8", "tag9", "tag10"};
            TagVarrayT tags = new TagVarrayT(maxTags);
            MoneyT price = new MoneyT(new BigDecimal("299.99"), "USD");

            ProductsRowUnsaved unsaved = new ProductsRowUnsaved(
                "PROD-MAX",
                "Max Tags Product",
                price,
                Optional.of(tags),
                new Defaulted.UseDefault<>()
            );

            ProductsRow inserted = repo.insert(unsaved, c);
            assertTrue(inserted.tags().isPresent());
            assertEquals(10, inserted.tags().get().value().length);
            assertArrayEquals(maxTags, inserted.tags().get().value());
        });
    }

    @Test
    public void testVarrayEquality() {
        TagVarrayT tags1 = new TagVarrayT(new String[]{"a", "b", "c"});
        TagVarrayT tags2 = new TagVarrayT(new String[]{"a", "b", "c"});

        assertFalse(tags1.equals(tags2));
        assertArrayEquals(tags1.value(), tags2.value());
    }

    @Test
    public void testDeleteProduct() {
        OracleTestHelper.run(c -> {
            MoneyT price = new MoneyT(new BigDecimal("99.99"), "USD");
            ProductsRowUnsaved unsaved = new ProductsRowUnsaved(
                "PROD-DELETE",
                "To Delete",
                price,
                Optional.of(new TagVarrayT(new String[]{"delete"})),
                new Defaulted.UseDefault<>()
            );

            ProductsRow inserted = repo.insert(unsaved, c);

            boolean deleted = repo.deleteById(inserted.productId(), c);
            assertTrue(deleted);

            Optional<ProductsRow> found = repo.selectById(inserted.productId(), c);
            assertFalse(found.isPresent());
        });
    }

    @Test
    public void testSelectAll() {
        OracleTestHelper.run(c -> {
            MoneyT price1 = new MoneyT(new BigDecimal("10.00"), "USD");
            MoneyT price2 = new MoneyT(new BigDecimal("20.00"), "EUR");

            ProductsRowUnsaved unsaved1 = new ProductsRowUnsaved(
                "PROD-ALL-1",
                "Product 1",
                price1,
                Optional.of(new TagVarrayT(new String[]{"tag1"})),
                new Defaulted.UseDefault<>()
            );

            ProductsRowUnsaved unsaved2 = new ProductsRowUnsaved(
                "PROD-ALL-2",
                "Product 2",
                price2,
                Optional.empty(),
                new Defaulted.UseDefault<>()
            );

            repo.insert(unsaved1, c);
            repo.insert(unsaved2, c);

            List<ProductsRow> all = repo.selectAll(c);
            assertTrue(all.size() >= 2);
        });
    }

    @Test
    public void testClearTags() {
        OracleTestHelper.run(c -> {
            TagVarrayT originalTags = new TagVarrayT(new String[]{"tag1", "tag2"});
            MoneyT price = new MoneyT(new BigDecimal("50.00"), "USD");

            ProductsRowUnsaved unsaved = new ProductsRowUnsaved(
                "PROD-CLEAR",
                "Clear Tags Test",
                price,
                Optional.of(originalTags),
                new Defaulted.UseDefault<>()
            );

            ProductsRow inserted = repo.insert(unsaved, c);
            assertTrue(inserted.tags().isPresent());

            ProductsRow cleared = inserted.withTags(Optional.empty());
            Boolean wasUpdated = repo.update(cleared, c);

            assertTrue(wasUpdated);
            assertFalse(cleared.tags().isPresent());
        });
    }

    @Test
    public void debugGetGeneratedKeys() {
        OracleTestHelper.run(c -> {
            String sql = "insert into \"PRODUCTS\"(\"SKU\", \"NAME\", \"PRICE\", \"TAGS\") values (?, ?, ?, ?)";

            // Test 1: Just generated column
            System.out.println("\n=== Test 1: Just PRODUCT_ID ===");
            try {
                testInsertDebug(c, sql, new String[]{"PRODUCT_ID"});
                System.out.println("✓ SUCCESS: Just PRODUCT_ID works");
            } catch (Exception e) {
                System.out.println("✗ FAILED: " + e.getMessage());
                e.printStackTrace();
            }

            // Test 2: Generated + scalar columns
            System.out.println("\n=== Test 2: PRODUCT_ID + SKU + NAME ===");
            try {
                testInsertDebug(c, sql, new String[]{"PRODUCT_ID", "SKU", "NAME"});
                System.out.println("✓ SUCCESS: PRODUCT_ID + scalars works");
            } catch (Exception e) {
                System.out.println("✗ FAILED: " + e.getMessage());
            }

            // Test 3: Generated + STRUCT
            System.out.println("\n=== Test 3: PRODUCT_ID + PRICE (STRUCT) ===");
            try {
                testInsertDebug(c, sql, new String[]{"PRODUCT_ID", "PRICE"});
                System.out.println("✓ SUCCESS: PRODUCT_ID + STRUCT works");
            } catch (Exception e) {
                System.out.println("✗ FAILED: " + e.getMessage());
            }

            // Test 4: Generated + ARRAY
            System.out.println("\n=== Test 4: PRODUCT_ID + TAGS (ARRAY) ===");
            try {
                testInsertDebug(c, sql, new String[]{"PRODUCT_ID", "TAGS"});
                System.out.println("✓ SUCCESS: PRODUCT_ID + ARRAY works");
            } catch (Exception e) {
                System.out.println("✗ FAILED: " + e.getMessage());
            }

            // Test 5: All columns
            System.out.println("\n=== Test 5: All columns ===");
            try {
                testInsertDebug(c, sql, new String[]{"PRODUCT_ID", "SKU", "NAME", "PRICE", "TAGS"});
                System.out.println("✓ SUCCESS: All columns works");
            } catch (Exception e) {
                System.out.println("✗ FAILED: " + e.getMessage());
            }
        });
    }

    private void testInsertDebug(java.sql.Connection c, String sql, String[] columns) throws Exception {
        try (java.sql.PreparedStatement ps = c.prepareStatement(sql, columns)) {
            ps.setString(1, "TEST-" + System.currentTimeMillis());
            ps.setString(2, "Test Product");
            ps.setObject(3, null);  // PRICE - null for simplicity
            ps.setObject(4, null);  // TAGS - null for simplicity

            ps.executeUpdate();

            java.sql.ResultSet rs = ps.getGeneratedKeys();
            java.sql.ResultSetMetaData meta = rs.getMetaData();
            System.out.println("  Columns returned: " + meta.getColumnCount());
            for (int i = 1; i <= meta.getColumnCount(); i++) {
                System.out.println("    " + i + ": " + meta.getColumnName(i) + " (" + meta.getColumnTypeName(i) + ")");
            }

            if (rs.next()) {
                System.out.println("  Got result row");
                for (int i = 1; i <= meta.getColumnCount(); i++) {
                    Object val = rs.getObject(i);
                    System.out.println("    " + meta.getColumnName(i) + " = " + val);
                }
            }
            rs.close();
        }
        c.rollback(); // Clean up
    }
}
