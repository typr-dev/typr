/**
 * File has been automatically generated by `typo`.
 *
 * <p>IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package oracledb.products;

import static typo.runtime.Fragment.interpolate;

import java.sql.Connection;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import oracledb.MoneyT;
import oracledb.TagVarrayT;
import typo.dsl.DeleteBuilder;
import typo.dsl.Dialect;
import typo.dsl.SelectBuilder;
import typo.dsl.UpdateBuilder;
import typo.runtime.Fragment;
import typo.runtime.OracleTypes;

public class ProductsRepoImpl implements ProductsRepo {
  @Override
  public DeleteBuilder<ProductsFields, ProductsRow> delete() {
    return DeleteBuilder.of("\"PRODUCTS\"", ProductsFields.structure(), Dialect.ORACLE);
  }
  ;

  @Override
  public Boolean deleteById(ProductsId productId, Connection c) {
    return interpolate(
                Fragment.lit("delete from \"PRODUCTS\" where \"PRODUCT_ID\" = "),
                Fragment.encode(ProductsId.oracleType, productId),
                Fragment.lit(""))
            .update()
            .runUnchecked(c)
        > 0;
  }
  ;

  @Override
  public Integer deleteByIds(ProductsId[] productIds, Connection c) {
    ArrayList<Fragment> fragments = new ArrayList<>();
    for (var id : productIds) {
      fragments.add(Fragment.encode(ProductsId.oracleType, id));
    }
    ;
    return Fragment.interpolate(
            Fragment.lit("delete from \"PRODUCTS\" where \"PRODUCT_ID\" in ("),
            Fragment.comma(fragments),
            Fragment.lit(")"))
        .update()
        .runUnchecked(c);
  }
  ;

  @Override
  public ProductsId insert(ProductsRow unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "insert into \"PRODUCTS\"(\"PRODUCT_ID\", \"SKU\", \"NAME\", \"PRICE\", \"TAGS\")\n"
                    + "values ("),
            Fragment.encode(ProductsId.oracleType, unsaved.productId()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.sku()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.name()),
            Fragment.lit(", "),
            Fragment.encode(MoneyT.oracleType, unsaved.price()),
            Fragment.lit(", "),
            Fragment.encode(TagVarrayT.oracleType.opt(), unsaved.tags()),
            Fragment.lit(")\n"))
        .updateReturningGeneratedKeys(
            new String[] {"PRODUCT_ID"}, ProductsId._rowParser.exactlyOne())
        .runUnchecked(c);
  }
  ;

  @Override
  public ProductsId insert(ProductsRowUnsaved unsaved, Connection c) {
    ArrayList<Fragment> columns = new ArrayList<>();
    ;
    ArrayList<Fragment> values = new ArrayList<>();
    ;
    columns.add(Fragment.lit("\"SKU\""));
    values.add(interpolate(Fragment.encode(OracleTypes.varchar2, unsaved.sku()), Fragment.lit("")));
    columns.add(Fragment.lit("\"NAME\""));
    values.add(
        interpolate(Fragment.encode(OracleTypes.varchar2, unsaved.name()), Fragment.lit("")));
    columns.add(Fragment.lit("\"PRICE\""));
    values.add(interpolate(Fragment.encode(MoneyT.oracleType, unsaved.price()), Fragment.lit("")));
    columns.add(Fragment.lit("\"TAGS\""));
    values.add(
        interpolate(
            Fragment.encode(TagVarrayT.oracleType.opt(), unsaved.tags()), Fragment.lit("")));
    unsaved
        .productId()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("\"PRODUCT_ID\""));
              values.add(
                  interpolate(Fragment.encode(ProductsId.oracleType, value), Fragment.lit("")));
            });
    ;
    Fragment q =
        interpolate(
            Fragment.lit("insert into \"PRODUCTS\"("),
            Fragment.comma(columns),
            Fragment.lit(")\nvalues ("),
            Fragment.comma(values),
            Fragment.lit(")\n"));
    ;
    return q.updateReturningGeneratedKeys(
            new String[] {"PRODUCT_ID"}, ProductsId._rowParser.exactlyOne())
        .runUnchecked(c);
  }
  ;

  @Override
  public SelectBuilder<ProductsFields, ProductsRow> select() {
    return SelectBuilder.of(
        "\"PRODUCTS\"", ProductsFields.structure(), ProductsRow._rowParser, Dialect.ORACLE);
  }
  ;

  @Override
  public List<ProductsRow> selectAll(Connection c) {
    return interpolate(
            Fragment.lit(
                "select \"PRODUCT_ID\", \"SKU\", \"NAME\", \"PRICE\", \"TAGS\"\n"
                    + "from \"PRODUCTS\"\n"))
        .query(ProductsRow._rowParser.all())
        .runUnchecked(c);
  }
  ;

  @Override
  public Optional<ProductsRow> selectById(ProductsId productId, Connection c) {
    return interpolate(
            Fragment.lit(
                "select \"PRODUCT_ID\", \"SKU\", \"NAME\", \"PRICE\", \"TAGS\"\n"
                    + "from \"PRODUCTS\"\n"
                    + "where \"PRODUCT_ID\" = "),
            Fragment.encode(ProductsId.oracleType, productId),
            Fragment.lit(""))
        .query(ProductsRow._rowParser.first())
        .runUnchecked(c);
  }
  ;

  @Override
  public List<ProductsRow> selectByIds(ProductsId[] productIds, Connection c) {
    ArrayList<Fragment> fragments = new ArrayList<>();
    for (var id : productIds) {
      fragments.add(Fragment.encode(ProductsId.oracleType, id));
    }
    ;
    return Fragment.interpolate(
            Fragment.lit(
                "select \"PRODUCT_ID\", \"SKU\", \"NAME\", \"PRICE\", \"TAGS\" from \"PRODUCTS\""
                    + " where \"PRODUCT_ID\" in ("),
            Fragment.comma(fragments),
            Fragment.lit(")"))
        .query(ProductsRow._rowParser.all())
        .runUnchecked(c);
  }
  ;

  @Override
  public Map<ProductsId, ProductsRow> selectByIdsTracked(ProductsId[] productIds, Connection c) {
    HashMap<ProductsId, ProductsRow> ret = new HashMap<ProductsId, ProductsRow>();
    selectByIds(productIds, c).forEach(row -> ret.put(row.productId(), row));
    return ret;
  }
  ;

  @Override
  public Optional<ProductsRow> selectByUniqueSku(String sku, Connection c) {
    return interpolate(
            Fragment.lit(
                "select \"PRODUCT_ID\", \"SKU\", \"NAME\", \"PRICE\", \"TAGS\"\n"
                    + "from \"PRODUCTS\"\n"
                    + "where \"SKU\" = "),
            Fragment.encode(OracleTypes.varchar2, sku),
            Fragment.lit("\n"))
        .query(ProductsRow._rowParser.first())
        .runUnchecked(c);
  }
  ;

  @Override
  public UpdateBuilder<ProductsFields, ProductsRow> update() {
    return UpdateBuilder.of(
        "\"PRODUCTS\"", ProductsFields.structure(), ProductsRow._rowParser, Dialect.ORACLE);
  }
  ;

  @Override
  public Boolean update(ProductsRow row, Connection c) {
    ProductsId productId = row.productId();
    ;
    return interpolate(
                Fragment.lit("update \"PRODUCTS\"\nset \"SKU\" = "),
                Fragment.encode(OracleTypes.varchar2, row.sku()),
                Fragment.lit(",\n\"NAME\" = "),
                Fragment.encode(OracleTypes.varchar2, row.name()),
                Fragment.lit(",\n\"PRICE\" = "),
                Fragment.encode(MoneyT.oracleType, row.price()),
                Fragment.lit(",\n\"TAGS\" = "),
                Fragment.encode(TagVarrayT.oracleType.opt(), row.tags()),
                Fragment.lit("\nwhere \"PRODUCT_ID\" = "),
                Fragment.encode(ProductsId.oracleType, productId),
                Fragment.lit(""))
            .update()
            .runUnchecked(c)
        > 0;
  }
  ;

  @Override
  public ProductsRow upsert(ProductsRow unsaved, Connection c) {
    return interpolate(
            Fragment.lit("MERGE INTO \"PRODUCTS\" t\nUSING (SELECT "),
            Fragment.encode(ProductsId.oracleType, unsaved.productId()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.sku()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.name()),
            Fragment.lit(", "),
            Fragment.encode(MoneyT.oracleType, unsaved.price()),
            Fragment.lit(", "),
            Fragment.encode(TagVarrayT.oracleType.opt(), unsaved.tags()),
            Fragment.lit(
                " FROM DUAL) s\n"
                    + "ON (\"PRODUCT_ID\")\n"
                    + "WHEN MATCHED THEN UPDATE SET t.\"SKU\" = s.\"SKU\",\n"
                    + "t.\"NAME\" = s.\"NAME\",\n"
                    + "t.\"PRICE\" = s.\"PRICE\",\n"
                    + "t.\"TAGS\" = s.\"TAGS\"\n"
                    + "WHEN NOT MATCHED THEN INSERT (\"PRODUCT_ID\", \"SKU\", \"NAME\", \"PRICE\","
                    + " \"TAGS\") VALUES ("),
            Fragment.encode(ProductsId.oracleType, unsaved.productId()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.sku()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.name()),
            Fragment.lit(", "),
            Fragment.encode(MoneyT.oracleType, unsaved.price()),
            Fragment.lit(", "),
            Fragment.encode(TagVarrayT.oracleType.opt(), unsaved.tags()),
            Fragment.lit(")"))
        .updateReturning(ProductsRow._rowParser.exactlyOne())
        .runUnchecked(c);
  }
  ;

  @Override
  public List<ProductsRow> upsertBatch(Iterator<ProductsRow> unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "MERGE INTO \"PRODUCTS\" t\n"
                    + "USING (SELECT ?, ?, ?, ?, ? FROM DUAL) s\n"
                    + "ON (\"PRODUCT_ID\")\n"
                    + "WHEN MATCHED THEN UPDATE SET t.\"SKU\" = s.\"SKU\",\n"
                    + "t.\"NAME\" = s.\"NAME\",\n"
                    + "t.\"PRICE\" = s.\"PRICE\",\n"
                    + "t.\"TAGS\" = s.\"TAGS\"\n"
                    + "WHEN NOT MATCHED THEN INSERT (\"PRODUCT_ID\", \"SKU\", \"NAME\", \"PRICE\","
                    + " \"TAGS\") VALUES (?, ?, ?, ?, ?)"))
        .updateReturningEach(ProductsRow._rowParser, unsaved)
        .runUnchecked(c);
  }
  ;
}
