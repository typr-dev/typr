/**
 * File has been automatically generated by `typo`.
 *
 * <p>IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package oracledb.employees;

import static typo.runtime.Fragment.interpolate;

import java.sql.Connection;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import oracledb.MoneyT;
import typo.dsl.DeleteBuilder;
import typo.dsl.Dialect;
import typo.dsl.SelectBuilder;
import typo.dsl.UpdateBuilder;
import typo.runtime.Fragment;
import typo.runtime.OracleTypes;

public class EmployeesRepoImpl implements EmployeesRepo {
  @Override
  public DeleteBuilder<EmployeesFields, EmployeesRow> delete() {
    return DeleteBuilder.of("\"EMPLOYEES\"", EmployeesFields.structure(), Dialect.ORACLE);
  }
  ;

  @Override
  public Boolean deleteById(EmployeesId compositeId, Connection c) {
    return interpolate(
                Fragment.lit("delete from \"EMPLOYEES\" where \"EMP_NUMBER\" = "),
                Fragment.encode(OracleTypes.number, compositeId.empNumber()),
                Fragment.lit(" AND \"EMP_SUFFIX\" = "),
                Fragment.encode(OracleTypes.varchar2, compositeId.empSuffix()),
                Fragment.lit(""))
            .update()
            .runUnchecked(c)
        > 0;
  }
  ;

  @Override
  public Integer deleteByIds(EmployeesId[] compositeIds, Connection c) {
    ArrayList<Fragment> fragments = new ArrayList<>();
    for (var id : compositeIds) {
      fragments.add(
          Fragment.interpolate(
              Fragment.lit("("),
              Fragment.encode(OracleTypes.number, id.empNumber()),
              Fragment.lit(", "),
              Fragment.encode(OracleTypes.varchar2, id.empSuffix()),
              Fragment.lit(")")));
    }
    ;
    return Fragment.interpolate(
            Fragment.lit("delete from \"EMPLOYEES\" where (\"EMP_NUMBER\", \"EMP_SUFFIX\") in ("),
            Fragment.comma(fragments),
            Fragment.lit(")"))
        .update()
        .runUnchecked(c);
  }
  ;

  @Override
  public EmployeesId insert(EmployeesRow unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "insert into \"EMPLOYEES\"(\"EMP_NUMBER\", \"EMP_SUFFIX\", \"DEPT_CODE\","
                    + " \"DEPT_REGION\", \"EMP_NAME\", \"SALARY\", \"HIRE_DATE\")\n"
                    + "values ("),
            Fragment.encode(OracleTypes.number, unsaved.empNumber()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.empSuffix()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.deptCode()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.deptRegion()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.empName()),
            Fragment.lit(", "),
            Fragment.encode(MoneyT.oracleType.opt(), unsaved.salary()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.date, unsaved.hireDate()),
            Fragment.lit(")\n"))
        .updateReturningGeneratedKeys(
            new String[] {"EMP_NUMBER", "EMP_SUFFIX"}, EmployeesId._rowParser.exactlyOne())
        .runUnchecked(c);
  }
  ;

  @Override
  public EmployeesId insert(EmployeesRowUnsaved unsaved, Connection c) {
    ArrayList<Fragment> columns = new ArrayList<>();
    ;
    ArrayList<Fragment> values = new ArrayList<>();
    ;
    columns.add(Fragment.lit("\"EMP_NUMBER\""));
    values.add(
        interpolate(Fragment.encode(OracleTypes.number, unsaved.empNumber()), Fragment.lit("")));
    columns.add(Fragment.lit("\"EMP_SUFFIX\""));
    values.add(
        interpolate(Fragment.encode(OracleTypes.varchar2, unsaved.empSuffix()), Fragment.lit("")));
    columns.add(Fragment.lit("\"DEPT_CODE\""));
    values.add(
        interpolate(Fragment.encode(OracleTypes.varchar2, unsaved.deptCode()), Fragment.lit("")));
    columns.add(Fragment.lit("\"DEPT_REGION\""));
    values.add(
        interpolate(Fragment.encode(OracleTypes.varchar2, unsaved.deptRegion()), Fragment.lit("")));
    columns.add(Fragment.lit("\"EMP_NAME\""));
    values.add(
        interpolate(Fragment.encode(OracleTypes.varchar2, unsaved.empName()), Fragment.lit("")));
    columns.add(Fragment.lit("\"SALARY\""));
    values.add(
        interpolate(Fragment.encode(MoneyT.oracleType.opt(), unsaved.salary()), Fragment.lit("")));
    unsaved
        .hireDate()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("\"HIRE_DATE\""));
              values.add(interpolate(Fragment.encode(OracleTypes.date, value), Fragment.lit("")));
            });
    ;
    Fragment q =
        interpolate(
            Fragment.lit("insert into \"EMPLOYEES\"("),
            Fragment.comma(columns),
            Fragment.lit(")\nvalues ("),
            Fragment.comma(values),
            Fragment.lit(")\n"));
    ;
    return q.updateReturningGeneratedKeys(
            new String[] {"EMP_NUMBER", "EMP_SUFFIX"}, EmployeesId._rowParser.exactlyOne())
        .runUnchecked(c);
  }
  ;

  @Override
  public SelectBuilder<EmployeesFields, EmployeesRow> select() {
    return SelectBuilder.of(
        "\"EMPLOYEES\"", EmployeesFields.structure(), EmployeesRow._rowParser, Dialect.ORACLE);
  }
  ;

  @Override
  public List<EmployeesRow> selectAll(Connection c) {
    return interpolate(
            Fragment.lit(
                "select \"EMP_NUMBER\", \"EMP_SUFFIX\", \"DEPT_CODE\", \"DEPT_REGION\","
                    + " \"EMP_NAME\", \"SALARY\", \"HIRE_DATE\"\n"
                    + "from \"EMPLOYEES\"\n"))
        .query(EmployeesRow._rowParser.all())
        .runUnchecked(c);
  }
  ;

  @Override
  public Optional<EmployeesRow> selectById(EmployeesId compositeId, Connection c) {
    return interpolate(
            Fragment.lit(
                "select \"EMP_NUMBER\", \"EMP_SUFFIX\", \"DEPT_CODE\", \"DEPT_REGION\","
                    + " \"EMP_NAME\", \"SALARY\", \"HIRE_DATE\"\n"
                    + "from \"EMPLOYEES\"\n"
                    + "where \"EMP_NUMBER\" = "),
            Fragment.encode(OracleTypes.number, compositeId.empNumber()),
            Fragment.lit(" AND \"EMP_SUFFIX\" = "),
            Fragment.encode(OracleTypes.varchar2, compositeId.empSuffix()),
            Fragment.lit(""))
        .query(EmployeesRow._rowParser.first())
        .runUnchecked(c);
  }
  ;

  @Override
  public List<EmployeesRow> selectByIds(EmployeesId[] compositeIds, Connection c) {
    ArrayList<Fragment> fragments = new ArrayList<>();
    for (var id : compositeIds) {
      fragments.add(
          Fragment.interpolate(
              Fragment.lit("("),
              Fragment.encode(OracleTypes.number, id.empNumber()),
              Fragment.lit(", "),
              Fragment.encode(OracleTypes.varchar2, id.empSuffix()),
              Fragment.lit(")")));
    }
    ;
    return Fragment.interpolate(
            Fragment.lit(
                "select \"EMP_NUMBER\", \"EMP_SUFFIX\", \"DEPT_CODE\", \"DEPT_REGION\","
                    + " \"EMP_NAME\", \"SALARY\", \"HIRE_DATE\" from \"EMPLOYEES\" where"
                    + " (\"EMP_NUMBER\", \"EMP_SUFFIX\") in ("),
            Fragment.comma(fragments),
            Fragment.lit(")"))
        .query(EmployeesRow._rowParser.all())
        .runUnchecked(c);
  }
  ;

  @Override
  public Map<EmployeesId, EmployeesRow> selectByIdsTracked(
      EmployeesId[] compositeIds, Connection c) {
    HashMap<EmployeesId, EmployeesRow> ret = new HashMap<EmployeesId, EmployeesRow>();
    selectByIds(compositeIds, c).forEach(row -> ret.put(row.compositeId(), row));
    return ret;
  }
  ;

  @Override
  public UpdateBuilder<EmployeesFields, EmployeesRow> update() {
    return UpdateBuilder.of(
        "\"EMPLOYEES\"", EmployeesFields.structure(), EmployeesRow._rowParser, Dialect.ORACLE);
  }
  ;

  @Override
  public Boolean update(EmployeesRow row, Connection c) {
    EmployeesId compositeId = row.compositeId();
    ;
    return interpolate(
                Fragment.lit("update \"EMPLOYEES\"\nset \"DEPT_CODE\" = "),
                Fragment.encode(OracleTypes.varchar2, row.deptCode()),
                Fragment.lit(",\n\"DEPT_REGION\" = "),
                Fragment.encode(OracleTypes.varchar2, row.deptRegion()),
                Fragment.lit(",\n\"EMP_NAME\" = "),
                Fragment.encode(OracleTypes.varchar2, row.empName()),
                Fragment.lit(",\n\"SALARY\" = "),
                Fragment.encode(MoneyT.oracleType.opt(), row.salary()),
                Fragment.lit(",\n\"HIRE_DATE\" = "),
                Fragment.encode(OracleTypes.date, row.hireDate()),
                Fragment.lit("\nwhere \"EMP_NUMBER\" = "),
                Fragment.encode(OracleTypes.number, compositeId.empNumber()),
                Fragment.lit(" AND \"EMP_SUFFIX\" = "),
                Fragment.encode(OracleTypes.varchar2, compositeId.empSuffix()),
                Fragment.lit(""))
            .update()
            .runUnchecked(c)
        > 0;
  }
  ;

  @Override
  public EmployeesRow upsert(EmployeesRow unsaved, Connection c) {
    return interpolate(
            Fragment.lit("MERGE INTO \"EMPLOYEES\" t\nUSING (SELECT "),
            Fragment.encode(OracleTypes.number, unsaved.empNumber()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.empSuffix()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.deptCode()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.deptRegion()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.empName()),
            Fragment.lit(", "),
            Fragment.encode(MoneyT.oracleType.opt(), unsaved.salary()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.date, unsaved.hireDate()),
            Fragment.lit(
                " FROM DUAL) s\n"
                    + "ON (\"EMP_NUMBER\", \"EMP_SUFFIX\")\n"
                    + "WHEN MATCHED THEN UPDATE SET t.\"DEPT_CODE\" = s.\"DEPT_CODE\",\n"
                    + "t.\"DEPT_REGION\" = s.\"DEPT_REGION\",\n"
                    + "t.\"EMP_NAME\" = s.\"EMP_NAME\",\n"
                    + "t.\"SALARY\" = s.\"SALARY\",\n"
                    + "t.\"HIRE_DATE\" = s.\"HIRE_DATE\"\n"
                    + "WHEN NOT MATCHED THEN INSERT (\"EMP_NUMBER\", \"EMP_SUFFIX\", \"DEPT_CODE\","
                    + " \"DEPT_REGION\", \"EMP_NAME\", \"SALARY\", \"HIRE_DATE\") VALUES ("),
            Fragment.encode(OracleTypes.number, unsaved.empNumber()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.empSuffix()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.deptCode()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.deptRegion()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.varchar2, unsaved.empName()),
            Fragment.lit(", "),
            Fragment.encode(MoneyT.oracleType.opt(), unsaved.salary()),
            Fragment.lit(", "),
            Fragment.encode(OracleTypes.date, unsaved.hireDate()),
            Fragment.lit(")"))
        .updateReturning(EmployeesRow._rowParser.exactlyOne())
        .runUnchecked(c);
  }
  ;

  @Override
  public List<EmployeesRow> upsertBatch(Iterator<EmployeesRow> unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "MERGE INTO \"EMPLOYEES\" t\n"
                    + "USING (SELECT ?, ?, ?, ?, ?, ?, ? FROM DUAL) s\n"
                    + "ON (\"EMP_NUMBER\", \"EMP_SUFFIX\")\n"
                    + "WHEN MATCHED THEN UPDATE SET t.\"DEPT_CODE\" = s.\"DEPT_CODE\",\n"
                    + "t.\"DEPT_REGION\" = s.\"DEPT_REGION\",\n"
                    + "t.\"EMP_NAME\" = s.\"EMP_NAME\",\n"
                    + "t.\"SALARY\" = s.\"SALARY\",\n"
                    + "t.\"HIRE_DATE\" = s.\"HIRE_DATE\"\n"
                    + "WHEN NOT MATCHED THEN INSERT (\"EMP_NUMBER\", \"EMP_SUFFIX\", \"DEPT_CODE\","
                    + " \"DEPT_REGION\", \"EMP_NAME\", \"SALARY\", \"HIRE_DATE\") VALUES (?, ?, ?,"
                    + " ?, ?, ?, ?)"))
        .updateReturningEach(EmployeesRow._rowParser, unsaved)
        .runUnchecked(c);
  }
  ;
}
