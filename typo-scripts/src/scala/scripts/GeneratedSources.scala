package scripts

import typo.*
import typo.internal.codegen.LangScala

import java.nio.file.Path
import scala.annotation.nowarn

object GeneratedSources {
  def main(args: Array[String]): Unit = {
    val ds = TypoDataSource.hikariPostgres(server = "localhost", port = 6432, databaseName = "Adventureworks", username = "postgres", password = "password")

    val header =
      """|/**
         | * File has been automatically generated by `typo` for internal use.
         | *
         | * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
         | *
         | * (If you're developing `typo` and want to change it: run `bleep generate-sources`)
         | */
         |""".stripMargin

    val buildDir = Path.of(sys.props("user.dir"))
    val typoSources = buildDir.resolve("typo/generated-and-checked-in")

    val options = Options(
      pkg = "typo.generated",
      lang = LangScala(Dialect.Scala2XSource3, TypeSupportScala),
      jsonLibs = List(JsonLibName.PlayJson),
      dbLib = Some(DbLibName.Anorm),
      fileHeader = header,
      debugTypes = true
    )

    val files = generateFromDb(
      ds,
      options,
      typoSources,
      None,
      Selector.relationNames(
        "columns",
        "key_column_usage",
        "pg_namespace",
        "referential_constraints",
        "table_constraints",
        "tables",
        "foo",
        "pg_prepared_statements"
      ),
      List(buildDir.resolve("sql"))
    )

    files.foreach(_.overwriteFolder())

    import scala.sys.process.*
    List("git", "add", "-f", typoSources.toString).!! : @nowarn
    ()
  }
}
