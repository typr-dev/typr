/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.inventory_check

import java.math.BigInteger
import java.sql.Connection
import java.util.Optional
import typo.runtime.MariaTypes
import typo.runtime.FragmentInterpolator.interpolate

class InventoryCheckSqlRepoImpl extends InventoryCheckSqlRepo {
  override def apply(
    warehouseId: Optional[java.lang.Short],
    productId: Optional[BigInteger],
    lowStockOnly: Optional[/* user-picked */ java.lang.Boolean]
  )(using c: Connection): java.util.List[InventoryCheckSqlRow] = {
    interpolate"""-- Check inventory levels across warehouses
    SELECT i.inventory_id,
           p.product_id,
           p.sku,
           p.name AS product_name,
           w.warehouse_id,
           w.code AS warehouse_code,
           w.name AS warehouse_name,
           i.quantity_on_hand,
           i.quantity_reserved,
           (i.quantity_on_hand - i.quantity_reserved) AS available,
           i.reorder_point,
           i.bin_location
    FROM inventory i
    JOIN products p ON i.product_id = p.product_id
    JOIN warehouses w ON i.warehouse_id = w.warehouse_id
    WHERE (${MariaTypes.smallint.opt().encode(warehouseId)} IS NULL OR i.warehouse_id = ${MariaTypes.smallint.opt().encode(warehouseId)})
      AND (${MariaTypes.bigintUnsigned.opt().encode(productId)} IS NULL OR i.product_id = ${MariaTypes.bigintUnsigned.opt().encode(productId)})
      AND (${MariaTypes.bool.opt().encode(lowStockOnly)} IS NULL OR (i.quantity_on_hand - i.quantity_reserved) <= i.reorder_point)
    """.query(InventoryCheckSqlRow.`_rowParser`.all()).runUnchecked(c)
  }
}