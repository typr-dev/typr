/**
 * File automatically generated by `typo` for its own test suite.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN
 */
package testdb.hardcoded;

import com.fasterxml.jackson.core.JsonParser;
import com.fasterxml.jackson.core.JsonToken;
import com.fasterxml.jackson.databind.BeanProperty;
import com.fasterxml.jackson.databind.DeserializationContext;
import com.fasterxml.jackson.databind.JavaType;
import com.fasterxml.jackson.databind.JsonDeserializer;
import com.fasterxml.jackson.databind.deser.ContextualDeserializer;
import java.io.IOException;
import java.lang.Class;
import java.lang.Object;
import java.lang.RuntimeException;
import testdb.hardcoded.customtypes.Defaulted;
import testdb.hardcoded.customtypes.Defaulted.Provided;
import testdb.hardcoded.customtypes.Defaulted.UseDefault;

/** Jackson deserializer for Defaulted types */
public class DefaultedDeserializer extends JsonDeserializer<Defaulted<?>> implements ContextualDeserializer {
  JavaType valueType;;

  Class<?> defaultedClass;;

  public DefaultedDeserializer(
    JavaType valueType,
    Class<?> defaultedClass
  ) {
    this.valueType = valueType;
    this.defaultedClass = defaultedClass;
  };

  @Override
  public JsonDeserializer<?> createContextual(
    DeserializationContext ctxt,
    BeanProperty property
  ) {
    JavaType contextType = ctxt.getContextualType();
    JavaType type = (contextType == null && property != null
      ? property.getType()
      : contextType);
    if (type != null && type.containedTypeCount() > 0) {
      return new DefaultedDeserializer(type.containedType(0), type.getRawClass());
    };
    throw new RuntimeException("unexpected");
  };

  @Override
  public Defaulted<?> deserialize(
    JsonParser p,
    DeserializationContext ctxt
  ) throws IOException {
    if (p.currentToken() == JsonToken.VALUE_STRING) {
      String text = p.getText();
      if ("defaulted".equals(text)) {
        return new UseDefault<Object>();
      }
      throw new IOException("Expected 'defaulted' but got: " + text);
    }
    if (p.currentToken() == JsonToken.START_OBJECT) {
      p.nextToken();
      if (p.currentToken() == JsonToken.FIELD_NAME && "provided".equals(p.currentName())) {
        p.nextToken();
        Object value = ctxt.readValue(p, valueType);
        p.nextToken();
        return new Provided<Object>(value);
      }

    };
    throw new IOException("Expected 'provided' field but got: " + p.currentName());
  };
}