/**
 * File has been automatically generated by `typo`.
 *
 * <p>IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package adventureworks.production.product;

import static typo.runtime.Fragment.interpolate;

import adventureworks.production.productmodel.ProductmodelId;
import adventureworks.production.productsubcategory.ProductsubcategoryId;
import adventureworks.production.unitmeasure.UnitmeasureId;
import adventureworks.public_.Flag;
import adventureworks.public_.Name;
import java.sql.Connection;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import typo.dsl.DeleteBuilder;
import typo.dsl.Dialect;
import typo.dsl.SelectBuilder;
import typo.dsl.UpdateBuilder;
import typo.runtime.Fragment;
import typo.runtime.PgTypes;
import typo.runtime.streamingInsert;

public class ProductRepoImpl implements ProductRepo {
  @Override
  public DeleteBuilder<ProductFields, ProductRow> delete() {
    return DeleteBuilder.of(
        "\"production\".\"product\"", ProductFields.structure(), Dialect.POSTGRESQL);
  }
  ;

  @Override
  public Boolean deleteById(ProductId productid, Connection c) {
    return interpolate(
                Fragment.lit("delete from \"production\".\"product\" where \"productid\" = "),
                Fragment.encode(ProductId.pgType, productid),
                Fragment.lit(""))
            .update()
            .runUnchecked(c)
        > 0;
  }
  ;

  @Override
  public Integer deleteByIds(ProductId[] productids, Connection c) {
    return interpolate(
            Fragment.lit("delete\nfrom \"production\".\"product\"\nwhere \"productid\" = ANY("),
            Fragment.encode(ProductId.pgTypeArray, productids),
            Fragment.lit(")"))
        .update()
        .runUnchecked(c);
  }
  ;

  @Override
  public ProductRow insert(ProductRow unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "insert into \"production\".\"product\"(\"productid\", \"name\", \"productnumber\","
                    + " \"makeflag\", \"finishedgoodsflag\", \"color\", \"safetystocklevel\","
                    + " \"reorderpoint\", \"standardcost\", \"listprice\", \"size\","
                    + " \"sizeunitmeasurecode\", \"weightunitmeasurecode\", \"weight\","
                    + " \"daystomanufacture\", \"productline\", \"class\", \"style\","
                    + " \"productsubcategoryid\", \"productmodelid\", \"sellstartdate\","
                    + " \"sellenddate\", \"discontinueddate\", \"rowguid\", \"modifieddate\")\n"
                    + "values ("),
            Fragment.encode(ProductId.pgType, unsaved.productid()),
            Fragment.lit("::int4, "),
            Fragment.encode(Name.pgType, unsaved.name()),
            Fragment.lit("::varchar, "),
            Fragment.encode(PgTypes.text, unsaved.productnumber()),
            Fragment.lit(", "),
            Fragment.encode(Flag.pgType, unsaved.makeflag()),
            Fragment.lit("::bool, "),
            Fragment.encode(Flag.pgType, unsaved.finishedgoodsflag()),
            Fragment.lit("::bool, "),
            Fragment.encode(PgTypes.text.opt(), unsaved.color()),
            Fragment.lit(", "),
            Fragment.encode(PgTypes.int2, unsaved.safetystocklevel()),
            Fragment.lit("::int2, "),
            Fragment.encode(PgTypes.int2, unsaved.reorderpoint()),
            Fragment.lit("::int2, "),
            Fragment.encode(PgTypes.numeric, unsaved.standardcost()),
            Fragment.lit("::numeric, "),
            Fragment.encode(PgTypes.numeric, unsaved.listprice()),
            Fragment.lit("::numeric, "),
            Fragment.encode(PgTypes.text.opt(), unsaved.size()),
            Fragment.lit(", "),
            Fragment.encode(UnitmeasureId.pgType.opt(), unsaved.sizeunitmeasurecode()),
            Fragment.lit("::bpchar, "),
            Fragment.encode(UnitmeasureId.pgType.opt(), unsaved.weightunitmeasurecode()),
            Fragment.lit("::bpchar, "),
            Fragment.encode(PgTypes.numeric.opt(), unsaved.weight()),
            Fragment.lit("::numeric, "),
            Fragment.encode(PgTypes.int4, unsaved.daystomanufacture()),
            Fragment.lit("::int4, "),
            Fragment.encode(PgTypes.bpchar.opt(), unsaved.productline()),
            Fragment.lit("::bpchar, "),
            Fragment.encode(PgTypes.bpchar.opt(), unsaved.class_()),
            Fragment.lit("::bpchar, "),
            Fragment.encode(PgTypes.bpchar.opt(), unsaved.style()),
            Fragment.lit("::bpchar, "),
            Fragment.encode(ProductsubcategoryId.pgType.opt(), unsaved.productsubcategoryid()),
            Fragment.lit("::int4, "),
            Fragment.encode(ProductmodelId.pgType.opt(), unsaved.productmodelid()),
            Fragment.lit("::int4, "),
            Fragment.encode(PgTypes.timestamp, unsaved.sellstartdate()),
            Fragment.lit("::timestamp, "),
            Fragment.encode(PgTypes.timestamp.opt(), unsaved.sellenddate()),
            Fragment.lit("::timestamp, "),
            Fragment.encode(PgTypes.timestamp.opt(), unsaved.discontinueddate()),
            Fragment.lit("::timestamp, "),
            Fragment.encode(PgTypes.uuid, unsaved.rowguid()),
            Fragment.lit("::uuid, "),
            Fragment.encode(PgTypes.timestamp, unsaved.modifieddate()),
            Fragment.lit(
                "::timestamp)\n"
                    + "RETURNING \"productid\", \"name\", \"productnumber\", \"makeflag\","
                    + " \"finishedgoodsflag\", \"color\", \"safetystocklevel\", \"reorderpoint\","
                    + " \"standardcost\", \"listprice\", \"size\", \"sizeunitmeasurecode\","
                    + " \"weightunitmeasurecode\", \"weight\", \"daystomanufacture\","
                    + " \"productline\", \"class\", \"style\", \"productsubcategoryid\","
                    + " \"productmodelid\", \"sellstartdate\", \"sellenddate\","
                    + " \"discontinueddate\", \"rowguid\", \"modifieddate\"\n"))
        .updateReturning(ProductRow._rowParser.exactlyOne())
        .runUnchecked(c);
  }
  ;

  @Override
  public ProductRow insert(ProductRowUnsaved unsaved, Connection c) {
    ArrayList<Fragment> columns = new ArrayList<>();
    ;
    ArrayList<Fragment> values = new ArrayList<>();
    ;
    columns.add(Fragment.lit("\"name\""));
    values.add(
        interpolate(Fragment.encode(Name.pgType, unsaved.name()), Fragment.lit("::varchar")));
    columns.add(Fragment.lit("\"productnumber\""));
    values.add(
        interpolate(Fragment.encode(PgTypes.text, unsaved.productnumber()), Fragment.lit("")));
    columns.add(Fragment.lit("\"color\""));
    values.add(interpolate(Fragment.encode(PgTypes.text.opt(), unsaved.color()), Fragment.lit("")));
    columns.add(Fragment.lit("\"safetystocklevel\""));
    values.add(
        interpolate(
            Fragment.encode(PgTypes.int2, unsaved.safetystocklevel()), Fragment.lit("::int2")));
    columns.add(Fragment.lit("\"reorderpoint\""));
    values.add(
        interpolate(Fragment.encode(PgTypes.int2, unsaved.reorderpoint()), Fragment.lit("::int2")));
    columns.add(Fragment.lit("\"standardcost\""));
    values.add(
        interpolate(
            Fragment.encode(PgTypes.numeric, unsaved.standardcost()), Fragment.lit("::numeric")));
    columns.add(Fragment.lit("\"listprice\""));
    values.add(
        interpolate(
            Fragment.encode(PgTypes.numeric, unsaved.listprice()), Fragment.lit("::numeric")));
    columns.add(Fragment.lit("\"size\""));
    values.add(interpolate(Fragment.encode(PgTypes.text.opt(), unsaved.size()), Fragment.lit("")));
    columns.add(Fragment.lit("\"sizeunitmeasurecode\""));
    values.add(
        interpolate(
            Fragment.encode(UnitmeasureId.pgType.opt(), unsaved.sizeunitmeasurecode()),
            Fragment.lit("::bpchar")));
    columns.add(Fragment.lit("\"weightunitmeasurecode\""));
    values.add(
        interpolate(
            Fragment.encode(UnitmeasureId.pgType.opt(), unsaved.weightunitmeasurecode()),
            Fragment.lit("::bpchar")));
    columns.add(Fragment.lit("\"weight\""));
    values.add(
        interpolate(
            Fragment.encode(PgTypes.numeric.opt(), unsaved.weight()), Fragment.lit("::numeric")));
    columns.add(Fragment.lit("\"daystomanufacture\""));
    values.add(
        interpolate(
            Fragment.encode(PgTypes.int4, unsaved.daystomanufacture()), Fragment.lit("::int4")));
    columns.add(Fragment.lit("\"productline\""));
    values.add(
        interpolate(
            Fragment.encode(PgTypes.bpchar.opt(), unsaved.productline()),
            Fragment.lit("::bpchar")));
    columns.add(Fragment.lit("\"class\""));
    values.add(
        interpolate(
            Fragment.encode(PgTypes.bpchar.opt(), unsaved.class_()), Fragment.lit("::bpchar")));
    columns.add(Fragment.lit("\"style\""));
    values.add(
        interpolate(
            Fragment.encode(PgTypes.bpchar.opt(), unsaved.style()), Fragment.lit("::bpchar")));
    columns.add(Fragment.lit("\"productsubcategoryid\""));
    values.add(
        interpolate(
            Fragment.encode(ProductsubcategoryId.pgType.opt(), unsaved.productsubcategoryid()),
            Fragment.lit("::int4")));
    columns.add(Fragment.lit("\"productmodelid\""));
    values.add(
        interpolate(
            Fragment.encode(ProductmodelId.pgType.opt(), unsaved.productmodelid()),
            Fragment.lit("::int4")));
    columns.add(Fragment.lit("\"sellstartdate\""));
    values.add(
        interpolate(
            Fragment.encode(PgTypes.timestamp, unsaved.sellstartdate()),
            Fragment.lit("::timestamp")));
    columns.add(Fragment.lit("\"sellenddate\""));
    values.add(
        interpolate(
            Fragment.encode(PgTypes.timestamp.opt(), unsaved.sellenddate()),
            Fragment.lit("::timestamp")));
    columns.add(Fragment.lit("\"discontinueddate\""));
    values.add(
        interpolate(
            Fragment.encode(PgTypes.timestamp.opt(), unsaved.discontinueddate()),
            Fragment.lit("::timestamp")));
    unsaved
        .productid()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("\"productid\""));
              values.add(
                  interpolate(Fragment.encode(ProductId.pgType, value), Fragment.lit("::int4")));
            });
    ;
    unsaved
        .makeflag()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("\"makeflag\""));
              values.add(interpolate(Fragment.encode(Flag.pgType, value), Fragment.lit("::bool")));
            });
    ;
    unsaved
        .finishedgoodsflag()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("\"finishedgoodsflag\""));
              values.add(interpolate(Fragment.encode(Flag.pgType, value), Fragment.lit("::bool")));
            });
    ;
    unsaved
        .rowguid()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("\"rowguid\""));
              values.add(interpolate(Fragment.encode(PgTypes.uuid, value), Fragment.lit("::uuid")));
            });
    ;
    unsaved
        .modifieddate()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("\"modifieddate\""));
              values.add(
                  interpolate(
                      Fragment.encode(PgTypes.timestamp, value), Fragment.lit("::timestamp")));
            });
    ;
    Fragment q =
        interpolate(
            Fragment.lit("insert into \"production\".\"product\"("),
            Fragment.comma(columns),
            Fragment.lit(")\nvalues ("),
            Fragment.comma(values),
            Fragment.lit(
                ")\n"
                    + "RETURNING \"productid\", \"name\", \"productnumber\", \"makeflag\","
                    + " \"finishedgoodsflag\", \"color\", \"safetystocklevel\", \"reorderpoint\","
                    + " \"standardcost\", \"listprice\", \"size\", \"sizeunitmeasurecode\","
                    + " \"weightunitmeasurecode\", \"weight\", \"daystomanufacture\","
                    + " \"productline\", \"class\", \"style\", \"productsubcategoryid\","
                    + " \"productmodelid\", \"sellstartdate\", \"sellenddate\","
                    + " \"discontinueddate\", \"rowguid\", \"modifieddate\"\n"));
    ;
    return q.updateReturning(ProductRow._rowParser.exactlyOne()).runUnchecked(c);
  }
  ;

  @Override
  public Long insertStreaming(Iterator<ProductRow> unsaved, Integer batchSize, Connection c) {
    return streamingInsert.insertUnchecked(
        "COPY \"production\".\"product\"(\"productid\", \"name\", \"productnumber\", \"makeflag\","
            + " \"finishedgoodsflag\", \"color\", \"safetystocklevel\", \"reorderpoint\","
            + " \"standardcost\", \"listprice\", \"size\", \"sizeunitmeasurecode\","
            + " \"weightunitmeasurecode\", \"weight\", \"daystomanufacture\", \"productline\","
            + " \"class\", \"style\", \"productsubcategoryid\", \"productmodelid\","
            + " \"sellstartdate\", \"sellenddate\", \"discontinueddate\", \"rowguid\","
            + " \"modifieddate\") FROM STDIN",
        batchSize,
        unsaved,
        c,
        ProductRow.pgText);
  }
  ;

  /** NOTE: this functionality requires PostgreSQL 16 or later! */
  @Override
  public Long insertUnsavedStreaming(
      Iterator<ProductRowUnsaved> unsaved, Integer batchSize, Connection c) {
    return streamingInsert.insertUnchecked(
        "COPY \"production\".\"product\"(\"name\", \"productnumber\", \"color\","
            + " \"safetystocklevel\", \"reorderpoint\", \"standardcost\", \"listprice\", \"size\","
            + " \"sizeunitmeasurecode\", \"weightunitmeasurecode\", \"weight\","
            + " \"daystomanufacture\", \"productline\", \"class\", \"style\","
            + " \"productsubcategoryid\", \"productmodelid\", \"sellstartdate\", \"sellenddate\","
            + " \"discontinueddate\", \"productid\", \"makeflag\", \"finishedgoodsflag\","
            + " \"rowguid\", \"modifieddate\") FROM STDIN (DEFAULT '__DEFAULT_VALUE__')",
        batchSize,
        unsaved,
        c,
        ProductRowUnsaved.pgText);
  }
  ;

  @Override
  public SelectBuilder<ProductFields, ProductRow> select() {
    return SelectBuilder.of(
        "\"production\".\"product\"",
        ProductFields.structure(),
        ProductRow._rowParser,
        Dialect.POSTGRESQL);
  }
  ;

  @Override
  public List<ProductRow> selectAll(Connection c) {
    return interpolate(
            Fragment.lit(
                "select \"productid\", \"name\", \"productnumber\", \"makeflag\","
                    + " \"finishedgoodsflag\", \"color\", \"safetystocklevel\", \"reorderpoint\","
                    + " \"standardcost\", \"listprice\", \"size\", \"sizeunitmeasurecode\","
                    + " \"weightunitmeasurecode\", \"weight\", \"daystomanufacture\","
                    + " \"productline\", \"class\", \"style\", \"productsubcategoryid\","
                    + " \"productmodelid\", \"sellstartdate\", \"sellenddate\","
                    + " \"discontinueddate\", \"rowguid\", \"modifieddate\"\n"
                    + "from \"production\".\"product\"\n"))
        .query(ProductRow._rowParser.all())
        .runUnchecked(c);
  }
  ;

  @Override
  public Optional<ProductRow> selectById(ProductId productid, Connection c) {
    return interpolate(
            Fragment.lit(
                "select \"productid\", \"name\", \"productnumber\", \"makeflag\","
                    + " \"finishedgoodsflag\", \"color\", \"safetystocklevel\", \"reorderpoint\","
                    + " \"standardcost\", \"listprice\", \"size\", \"sizeunitmeasurecode\","
                    + " \"weightunitmeasurecode\", \"weight\", \"daystomanufacture\","
                    + " \"productline\", \"class\", \"style\", \"productsubcategoryid\","
                    + " \"productmodelid\", \"sellstartdate\", \"sellenddate\","
                    + " \"discontinueddate\", \"rowguid\", \"modifieddate\"\n"
                    + "from \"production\".\"product\"\n"
                    + "where \"productid\" = "),
            Fragment.encode(ProductId.pgType, productid),
            Fragment.lit(""))
        .query(ProductRow._rowParser.first())
        .runUnchecked(c);
  }
  ;

  @Override
  public List<ProductRow> selectByIds(ProductId[] productids, Connection c) {
    return interpolate(
            Fragment.lit(
                "select \"productid\", \"name\", \"productnumber\", \"makeflag\","
                    + " \"finishedgoodsflag\", \"color\", \"safetystocklevel\", \"reorderpoint\","
                    + " \"standardcost\", \"listprice\", \"size\", \"sizeunitmeasurecode\","
                    + " \"weightunitmeasurecode\", \"weight\", \"daystomanufacture\","
                    + " \"productline\", \"class\", \"style\", \"productsubcategoryid\","
                    + " \"productmodelid\", \"sellstartdate\", \"sellenddate\","
                    + " \"discontinueddate\", \"rowguid\", \"modifieddate\"\n"
                    + "from \"production\".\"product\"\n"
                    + "where \"productid\" = ANY("),
            Fragment.encode(ProductId.pgTypeArray, productids),
            Fragment.lit(")"))
        .query(ProductRow._rowParser.all())
        .runUnchecked(c);
  }
  ;

  @Override
  public Map<ProductId, ProductRow> selectByIdsTracked(ProductId[] productids, Connection c) {
    HashMap<ProductId, ProductRow> ret = new HashMap<ProductId, ProductRow>();
    selectByIds(productids, c).forEach(row -> ret.put(row.productid(), row));
    return ret;
  }
  ;

  @Override
  public UpdateBuilder<ProductFields, ProductRow> update() {
    return UpdateBuilder.of(
        "\"production\".\"product\"",
        ProductFields.structure(),
        ProductRow._rowParser,
        Dialect.POSTGRESQL);
  }
  ;

  @Override
  public Boolean update(ProductRow row, Connection c) {
    ProductId productid = row.productid();
    ;
    return interpolate(
                Fragment.lit("update \"production\".\"product\"\nset \"name\" = "),
                Fragment.encode(Name.pgType, row.name()),
                Fragment.lit("::varchar,\n\"productnumber\" = "),
                Fragment.encode(PgTypes.text, row.productnumber()),
                Fragment.lit(",\n\"makeflag\" = "),
                Fragment.encode(Flag.pgType, row.makeflag()),
                Fragment.lit("::bool,\n\"finishedgoodsflag\" = "),
                Fragment.encode(Flag.pgType, row.finishedgoodsflag()),
                Fragment.lit("::bool,\n\"color\" = "),
                Fragment.encode(PgTypes.text.opt(), row.color()),
                Fragment.lit(",\n\"safetystocklevel\" = "),
                Fragment.encode(PgTypes.int2, row.safetystocklevel()),
                Fragment.lit("::int2,\n\"reorderpoint\" = "),
                Fragment.encode(PgTypes.int2, row.reorderpoint()),
                Fragment.lit("::int2,\n\"standardcost\" = "),
                Fragment.encode(PgTypes.numeric, row.standardcost()),
                Fragment.lit("::numeric,\n\"listprice\" = "),
                Fragment.encode(PgTypes.numeric, row.listprice()),
                Fragment.lit("::numeric,\n\"size\" = "),
                Fragment.encode(PgTypes.text.opt(), row.size()),
                Fragment.lit(",\n\"sizeunitmeasurecode\" = "),
                Fragment.encode(UnitmeasureId.pgType.opt(), row.sizeunitmeasurecode()),
                Fragment.lit("::bpchar,\n\"weightunitmeasurecode\" = "),
                Fragment.encode(UnitmeasureId.pgType.opt(), row.weightunitmeasurecode()),
                Fragment.lit("::bpchar,\n\"weight\" = "),
                Fragment.encode(PgTypes.numeric.opt(), row.weight()),
                Fragment.lit("::numeric,\n\"daystomanufacture\" = "),
                Fragment.encode(PgTypes.int4, row.daystomanufacture()),
                Fragment.lit("::int4,\n\"productline\" = "),
                Fragment.encode(PgTypes.bpchar.opt(), row.productline()),
                Fragment.lit("::bpchar,\n\"class\" = "),
                Fragment.encode(PgTypes.bpchar.opt(), row.class_()),
                Fragment.lit("::bpchar,\n\"style\" = "),
                Fragment.encode(PgTypes.bpchar.opt(), row.style()),
                Fragment.lit("::bpchar,\n\"productsubcategoryid\" = "),
                Fragment.encode(ProductsubcategoryId.pgType.opt(), row.productsubcategoryid()),
                Fragment.lit("::int4,\n\"productmodelid\" = "),
                Fragment.encode(ProductmodelId.pgType.opt(), row.productmodelid()),
                Fragment.lit("::int4,\n\"sellstartdate\" = "),
                Fragment.encode(PgTypes.timestamp, row.sellstartdate()),
                Fragment.lit("::timestamp,\n\"sellenddate\" = "),
                Fragment.encode(PgTypes.timestamp.opt(), row.sellenddate()),
                Fragment.lit("::timestamp,\n\"discontinueddate\" = "),
                Fragment.encode(PgTypes.timestamp.opt(), row.discontinueddate()),
                Fragment.lit("::timestamp,\n\"rowguid\" = "),
                Fragment.encode(PgTypes.uuid, row.rowguid()),
                Fragment.lit("::uuid,\n\"modifieddate\" = "),
                Fragment.encode(PgTypes.timestamp, row.modifieddate()),
                Fragment.lit("::timestamp\nwhere \"productid\" = "),
                Fragment.encode(ProductId.pgType, productid),
                Fragment.lit(""))
            .update()
            .runUnchecked(c)
        > 0;
  }
  ;

  @Override
  public ProductRow upsert(ProductRow unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "insert into \"production\".\"product\"(\"productid\", \"name\", \"productnumber\","
                    + " \"makeflag\", \"finishedgoodsflag\", \"color\", \"safetystocklevel\","
                    + " \"reorderpoint\", \"standardcost\", \"listprice\", \"size\","
                    + " \"sizeunitmeasurecode\", \"weightunitmeasurecode\", \"weight\","
                    + " \"daystomanufacture\", \"productline\", \"class\", \"style\","
                    + " \"productsubcategoryid\", \"productmodelid\", \"sellstartdate\","
                    + " \"sellenddate\", \"discontinueddate\", \"rowguid\", \"modifieddate\")\n"
                    + "values ("),
            Fragment.encode(ProductId.pgType, unsaved.productid()),
            Fragment.lit("::int4, "),
            Fragment.encode(Name.pgType, unsaved.name()),
            Fragment.lit("::varchar, "),
            Fragment.encode(PgTypes.text, unsaved.productnumber()),
            Fragment.lit(", "),
            Fragment.encode(Flag.pgType, unsaved.makeflag()),
            Fragment.lit("::bool, "),
            Fragment.encode(Flag.pgType, unsaved.finishedgoodsflag()),
            Fragment.lit("::bool, "),
            Fragment.encode(PgTypes.text.opt(), unsaved.color()),
            Fragment.lit(", "),
            Fragment.encode(PgTypes.int2, unsaved.safetystocklevel()),
            Fragment.lit("::int2, "),
            Fragment.encode(PgTypes.int2, unsaved.reorderpoint()),
            Fragment.lit("::int2, "),
            Fragment.encode(PgTypes.numeric, unsaved.standardcost()),
            Fragment.lit("::numeric, "),
            Fragment.encode(PgTypes.numeric, unsaved.listprice()),
            Fragment.lit("::numeric, "),
            Fragment.encode(PgTypes.text.opt(), unsaved.size()),
            Fragment.lit(", "),
            Fragment.encode(UnitmeasureId.pgType.opt(), unsaved.sizeunitmeasurecode()),
            Fragment.lit("::bpchar, "),
            Fragment.encode(UnitmeasureId.pgType.opt(), unsaved.weightunitmeasurecode()),
            Fragment.lit("::bpchar, "),
            Fragment.encode(PgTypes.numeric.opt(), unsaved.weight()),
            Fragment.lit("::numeric, "),
            Fragment.encode(PgTypes.int4, unsaved.daystomanufacture()),
            Fragment.lit("::int4, "),
            Fragment.encode(PgTypes.bpchar.opt(), unsaved.productline()),
            Fragment.lit("::bpchar, "),
            Fragment.encode(PgTypes.bpchar.opt(), unsaved.class_()),
            Fragment.lit("::bpchar, "),
            Fragment.encode(PgTypes.bpchar.opt(), unsaved.style()),
            Fragment.lit("::bpchar, "),
            Fragment.encode(ProductsubcategoryId.pgType.opt(), unsaved.productsubcategoryid()),
            Fragment.lit("::int4, "),
            Fragment.encode(ProductmodelId.pgType.opt(), unsaved.productmodelid()),
            Fragment.lit("::int4, "),
            Fragment.encode(PgTypes.timestamp, unsaved.sellstartdate()),
            Fragment.lit("::timestamp, "),
            Fragment.encode(PgTypes.timestamp.opt(), unsaved.sellenddate()),
            Fragment.lit("::timestamp, "),
            Fragment.encode(PgTypes.timestamp.opt(), unsaved.discontinueddate()),
            Fragment.lit("::timestamp, "),
            Fragment.encode(PgTypes.uuid, unsaved.rowguid()),
            Fragment.lit("::uuid, "),
            Fragment.encode(PgTypes.timestamp, unsaved.modifieddate()),
            Fragment.lit(
                "::timestamp)\n"
                    + "on conflict (\"productid\")\n"
                    + "do update set\n"
                    + "  \"name\" = EXCLUDED.\"name\",\n"
                    + "\"productnumber\" = EXCLUDED.\"productnumber\",\n"
                    + "\"makeflag\" = EXCLUDED.\"makeflag\",\n"
                    + "\"finishedgoodsflag\" = EXCLUDED.\"finishedgoodsflag\",\n"
                    + "\"color\" = EXCLUDED.\"color\",\n"
                    + "\"safetystocklevel\" = EXCLUDED.\"safetystocklevel\",\n"
                    + "\"reorderpoint\" = EXCLUDED.\"reorderpoint\",\n"
                    + "\"standardcost\" = EXCLUDED.\"standardcost\",\n"
                    + "\"listprice\" = EXCLUDED.\"listprice\",\n"
                    + "\"size\" = EXCLUDED.\"size\",\n"
                    + "\"sizeunitmeasurecode\" = EXCLUDED.\"sizeunitmeasurecode\",\n"
                    + "\"weightunitmeasurecode\" = EXCLUDED.\"weightunitmeasurecode\",\n"
                    + "\"weight\" = EXCLUDED.\"weight\",\n"
                    + "\"daystomanufacture\" = EXCLUDED.\"daystomanufacture\",\n"
                    + "\"productline\" = EXCLUDED.\"productline\",\n"
                    + "\"class\" = EXCLUDED.\"class\",\n"
                    + "\"style\" = EXCLUDED.\"style\",\n"
                    + "\"productsubcategoryid\" = EXCLUDED.\"productsubcategoryid\",\n"
                    + "\"productmodelid\" = EXCLUDED.\"productmodelid\",\n"
                    + "\"sellstartdate\" = EXCLUDED.\"sellstartdate\",\n"
                    + "\"sellenddate\" = EXCLUDED.\"sellenddate\",\n"
                    + "\"discontinueddate\" = EXCLUDED.\"discontinueddate\",\n"
                    + "\"rowguid\" = EXCLUDED.\"rowguid\",\n"
                    + "\"modifieddate\" = EXCLUDED.\"modifieddate\"\n"
                    + "returning \"productid\", \"name\", \"productnumber\", \"makeflag\","
                    + " \"finishedgoodsflag\", \"color\", \"safetystocklevel\", \"reorderpoint\","
                    + " \"standardcost\", \"listprice\", \"size\", \"sizeunitmeasurecode\","
                    + " \"weightunitmeasurecode\", \"weight\", \"daystomanufacture\","
                    + " \"productline\", \"class\", \"style\", \"productsubcategoryid\","
                    + " \"productmodelid\", \"sellstartdate\", \"sellenddate\","
                    + " \"discontinueddate\", \"rowguid\", \"modifieddate\""))
        .updateReturning(ProductRow._rowParser.exactlyOne())
        .runUnchecked(c);
  }
  ;

  @Override
  public List<ProductRow> upsertBatch(Iterator<ProductRow> unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "insert into \"production\".\"product\"(\"productid\", \"name\", \"productnumber\","
                    + " \"makeflag\", \"finishedgoodsflag\", \"color\", \"safetystocklevel\","
                    + " \"reorderpoint\", \"standardcost\", \"listprice\", \"size\","
                    + " \"sizeunitmeasurecode\", \"weightunitmeasurecode\", \"weight\","
                    + " \"daystomanufacture\", \"productline\", \"class\", \"style\","
                    + " \"productsubcategoryid\", \"productmodelid\", \"sellstartdate\","
                    + " \"sellenddate\", \"discontinueddate\", \"rowguid\", \"modifieddate\")\n"
                    + "values (?::int4, ?::varchar, ?, ?::bool, ?::bool, ?, ?::int2, ?::int2,"
                    + " ?::numeric, ?::numeric, ?, ?::bpchar, ?::bpchar, ?::numeric, ?::int4,"
                    + " ?::bpchar, ?::bpchar, ?::bpchar, ?::int4, ?::int4, ?::timestamp,"
                    + " ?::timestamp, ?::timestamp, ?::uuid, ?::timestamp)\n"
                    + "on conflict (\"productid\")\n"
                    + "do update set\n"
                    + "  \"name\" = EXCLUDED.\"name\",\n"
                    + "\"productnumber\" = EXCLUDED.\"productnumber\",\n"
                    + "\"makeflag\" = EXCLUDED.\"makeflag\",\n"
                    + "\"finishedgoodsflag\" = EXCLUDED.\"finishedgoodsflag\",\n"
                    + "\"color\" = EXCLUDED.\"color\",\n"
                    + "\"safetystocklevel\" = EXCLUDED.\"safetystocklevel\",\n"
                    + "\"reorderpoint\" = EXCLUDED.\"reorderpoint\",\n"
                    + "\"standardcost\" = EXCLUDED.\"standardcost\",\n"
                    + "\"listprice\" = EXCLUDED.\"listprice\",\n"
                    + "\"size\" = EXCLUDED.\"size\",\n"
                    + "\"sizeunitmeasurecode\" = EXCLUDED.\"sizeunitmeasurecode\",\n"
                    + "\"weightunitmeasurecode\" = EXCLUDED.\"weightunitmeasurecode\",\n"
                    + "\"weight\" = EXCLUDED.\"weight\",\n"
                    + "\"daystomanufacture\" = EXCLUDED.\"daystomanufacture\",\n"
                    + "\"productline\" = EXCLUDED.\"productline\",\n"
                    + "\"class\" = EXCLUDED.\"class\",\n"
                    + "\"style\" = EXCLUDED.\"style\",\n"
                    + "\"productsubcategoryid\" = EXCLUDED.\"productsubcategoryid\",\n"
                    + "\"productmodelid\" = EXCLUDED.\"productmodelid\",\n"
                    + "\"sellstartdate\" = EXCLUDED.\"sellstartdate\",\n"
                    + "\"sellenddate\" = EXCLUDED.\"sellenddate\",\n"
                    + "\"discontinueddate\" = EXCLUDED.\"discontinueddate\",\n"
                    + "\"rowguid\" = EXCLUDED.\"rowguid\",\n"
                    + "\"modifieddate\" = EXCLUDED.\"modifieddate\"\n"
                    + "returning \"productid\", \"name\", \"productnumber\", \"makeflag\","
                    + " \"finishedgoodsflag\", \"color\", \"safetystocklevel\", \"reorderpoint\","
                    + " \"standardcost\", \"listprice\", \"size\", \"sizeunitmeasurecode\","
                    + " \"weightunitmeasurecode\", \"weight\", \"daystomanufacture\","
                    + " \"productline\", \"class\", \"style\", \"productsubcategoryid\","
                    + " \"productmodelid\", \"sellstartdate\", \"sellenddate\","
                    + " \"discontinueddate\", \"rowguid\", \"modifieddate\""))
        .updateManyReturning(ProductRow._rowParser, unsaved)
        .runUnchecked(c);
  }
  ;

  /** NOTE: this functionality is not safe if you use auto-commit mode! it runs 3 SQL statements */
  @Override
  public Integer upsertStreaming(Iterator<ProductRow> unsaved, Integer batchSize, Connection c) {
    interpolate(
            Fragment.lit(
                "create temporary table product_TEMP (like \"production\".\"product\") on commit"
                    + " drop"))
        .update()
        .runUnchecked(c);
    streamingInsert.insertUnchecked(
        "copy product_TEMP(\"productid\", \"name\", \"productnumber\", \"makeflag\","
            + " \"finishedgoodsflag\", \"color\", \"safetystocklevel\", \"reorderpoint\","
            + " \"standardcost\", \"listprice\", \"size\", \"sizeunitmeasurecode\","
            + " \"weightunitmeasurecode\", \"weight\", \"daystomanufacture\", \"productline\","
            + " \"class\", \"style\", \"productsubcategoryid\", \"productmodelid\","
            + " \"sellstartdate\", \"sellenddate\", \"discontinueddate\", \"rowguid\","
            + " \"modifieddate\") from stdin",
        batchSize,
        unsaved,
        c,
        ProductRow.pgText);
    return interpolate(
            Fragment.lit(
                "insert into \"production\".\"product\"(\"productid\", \"name\", \"productnumber\","
                    + " \"makeflag\", \"finishedgoodsflag\", \"color\", \"safetystocklevel\","
                    + " \"reorderpoint\", \"standardcost\", \"listprice\", \"size\","
                    + " \"sizeunitmeasurecode\", \"weightunitmeasurecode\", \"weight\","
                    + " \"daystomanufacture\", \"productline\", \"class\", \"style\","
                    + " \"productsubcategoryid\", \"productmodelid\", \"sellstartdate\","
                    + " \"sellenddate\", \"discontinueddate\", \"rowguid\", \"modifieddate\")\n"
                    + "select * from product_TEMP\n"
                    + "on conflict (\"productid\")\n"
                    + "do update set\n"
                    + "  \"name\" = EXCLUDED.\"name\",\n"
                    + "\"productnumber\" = EXCLUDED.\"productnumber\",\n"
                    + "\"makeflag\" = EXCLUDED.\"makeflag\",\n"
                    + "\"finishedgoodsflag\" = EXCLUDED.\"finishedgoodsflag\",\n"
                    + "\"color\" = EXCLUDED.\"color\",\n"
                    + "\"safetystocklevel\" = EXCLUDED.\"safetystocklevel\",\n"
                    + "\"reorderpoint\" = EXCLUDED.\"reorderpoint\",\n"
                    + "\"standardcost\" = EXCLUDED.\"standardcost\",\n"
                    + "\"listprice\" = EXCLUDED.\"listprice\",\n"
                    + "\"size\" = EXCLUDED.\"size\",\n"
                    + "\"sizeunitmeasurecode\" = EXCLUDED.\"sizeunitmeasurecode\",\n"
                    + "\"weightunitmeasurecode\" = EXCLUDED.\"weightunitmeasurecode\",\n"
                    + "\"weight\" = EXCLUDED.\"weight\",\n"
                    + "\"daystomanufacture\" = EXCLUDED.\"daystomanufacture\",\n"
                    + "\"productline\" = EXCLUDED.\"productline\",\n"
                    + "\"class\" = EXCLUDED.\"class\",\n"
                    + "\"style\" = EXCLUDED.\"style\",\n"
                    + "\"productsubcategoryid\" = EXCLUDED.\"productsubcategoryid\",\n"
                    + "\"productmodelid\" = EXCLUDED.\"productmodelid\",\n"
                    + "\"sellstartdate\" = EXCLUDED.\"sellstartdate\",\n"
                    + "\"sellenddate\" = EXCLUDED.\"sellenddate\",\n"
                    + "\"discontinueddate\" = EXCLUDED.\"discontinueddate\",\n"
                    + "\"rowguid\" = EXCLUDED.\"rowguid\",\n"
                    + "\"modifieddate\" = EXCLUDED.\"modifieddate\"\n"
                    + ";\n"
                    + "drop table product_TEMP;"))
        .update()
        .runUnchecked(c);
  }
  ;
}
