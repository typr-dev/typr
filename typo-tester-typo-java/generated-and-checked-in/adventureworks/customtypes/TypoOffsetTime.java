/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package adventureworks.customtypes;

import com.fasterxml.jackson.annotation.JsonValue;
import java.time.OffsetTime;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeFormatterBuilder;
import java.time.temporal.ChronoField;
import java.time.temporal.ChronoUnit;
import typo.dsl.Bijection;
import typo.runtime.PgRead;
import typo.runtime.PgText;
import typo.runtime.PgType;
import typo.runtime.PgTypes;
import typo.runtime.PgWrite;
import typo.runtime.internal.arrayMap;

/** This is `java.time.OffsetTime`, but with microsecond precision and transferred to and from postgres as strings. The reason is that postgres driver and db libs are broken */
public record TypoOffsetTime(@JsonValue OffsetTime value) {
  public TypoOffsetTime withValue(OffsetTime value) {
    return new TypoOffsetTime(value);
  };

  static public TypoOffsetTime apply(OffsetTime value) {
    return new TypoOffsetTime(value.truncatedTo(ChronoUnit.MICROS));
  };

  static public TypoOffsetTime apply(String str) {
    return TypoOffsetTime.apply(OffsetTime.parse(str, parser));
  };

  static public Bijection<TypoOffsetTime, OffsetTime> bijection =
    Bijection.of(TypoOffsetTime::value, TypoOffsetTime::new);

  static public TypoOffsetTime now() {
    return TypoOffsetTime.apply(OffsetTime.now());
  };

  static DateTimeFormatter parser = new DateTimeFormatterBuilder().appendPattern("HH:mm:ss").appendFraction(ChronoField.MICRO_OF_SECOND, 0, 6, true).appendPattern("X").toFormatter();;

  static public PgText<TypoOffsetTime> pgText =
    PgText.textString.contramap(v -> v.value().toString());

  static public PgType<TypoOffsetTime> pgType =
    PgTypes.text.bimap(v -> new TypoOffsetTime(OffsetTime.parse(v, parser)), v -> v.value().toString()).renamed("timetz");

  static public PgType<TypoOffsetTime[]> pgTypeArray =
    TypoOffsetTime.pgType.array(PgRead.massageJdbcArrayTo(String[].class).map(xs -> arrayMap.map(xs, v -> new TypoOffsetTime(OffsetTime.parse(v, parser)), TypoOffsetTime.class)), PgWrite.<String>passObjectToJdbc().array(TypoOffsetTime.pgType.typename().<String>as()).contramap(xs -> arrayMap.map(xs, (TypoOffsetTime v) -> v.value().toString(), String.class)));
}