/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package adventureworks.customtypes;

import com.fasterxml.jackson.annotation.JsonValue;
import java.time.Instant;
import java.time.OffsetDateTime;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeFormatterBuilder;
import java.time.temporal.ChronoField;
import java.time.temporal.ChronoUnit;
import typo.dsl.Bijection;
import typo.runtime.PgRead;
import typo.runtime.PgText;
import typo.runtime.PgType;
import typo.runtime.PgTypes;
import typo.runtime.PgWrite;
import typo.runtime.internal.arrayMap;

/** This is `java.time.TypoInstant`, but with microsecond precision and transferred to and from postgres as strings. The reason is that postgres driver and db libs are broken */
public record TypoInstant(@JsonValue Instant value) {
  public TypoInstant withValue(Instant value) {
    return new TypoInstant(value);
  };

  static public TypoInstant apply(Instant value) {
    return new TypoInstant(value.truncatedTo(ChronoUnit.MICROS));
  };

  static public TypoInstant apply(String str) {
    return TypoInstant.apply(OffsetDateTime.parse(str, parser).toInstant());
  };

  static public Bijection<TypoInstant, Instant> bijection =
    Bijection.of(TypoInstant::value, TypoInstant::new);

  static public TypoInstant now() {
    return TypoInstant.apply(Instant.now());
  };

  static DateTimeFormatter parser = new DateTimeFormatterBuilder().appendPattern("yyyy-MM-dd HH:mm:ss").appendFraction(ChronoField.MICRO_OF_SECOND, 0, 6, true).appendPattern("X").toFormatter();;

  static public PgText<TypoInstant> pgText =
    PgText.textString.contramap(v -> v.value().toString());

  static public PgType<TypoInstant> pgType =
    PgTypes.text.bimap(v -> apply(v), v -> v.value().toString()).renamed("timestamptz");

  static public PgType<TypoInstant[]> pgTypeArray =
    TypoInstant.pgType.array(PgRead.massageJdbcArrayTo(String[].class).map(xs -> arrayMap.map(xs, v -> apply(v), TypoInstant.class)), PgWrite.<String>passObjectToJdbc().array(TypoInstant.pgType.typename().<String>as()).contramap(xs -> arrayMap.map(xs, (TypoInstant v) -> v.value().toString(), String.class)));
}