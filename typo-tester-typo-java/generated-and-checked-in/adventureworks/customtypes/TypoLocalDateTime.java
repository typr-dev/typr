/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package adventureworks.customtypes;

import com.fasterxml.jackson.annotation.JsonValue;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeFormatterBuilder;
import java.time.temporal.ChronoField;
import java.time.temporal.ChronoUnit;
import typo.dsl.Bijection;
import typo.runtime.PgRead;
import typo.runtime.PgText;
import typo.runtime.PgType;
import typo.runtime.PgTypes;
import typo.runtime.PgWrite;
import typo.runtime.internal.arrayMap;

/** This is `java.time.LocalDateTime`, but with microsecond precision and transferred to and from postgres as strings. The reason is that postgres driver and db libs are broken */
public record TypoLocalDateTime(@JsonValue LocalDateTime value) {
  public TypoLocalDateTime withValue(LocalDateTime value) {
    return new TypoLocalDateTime(value);
  };

  static public TypoLocalDateTime apply(LocalDateTime value) {
    return new TypoLocalDateTime(value.truncatedTo(ChronoUnit.MICROS));
  };

  static public TypoLocalDateTime apply(String str) {
    return TypoLocalDateTime.apply(LocalDateTime.parse(str, (str.contains("T") ? jsonParser : parser)));
  };

  static public Bijection<TypoLocalDateTime, LocalDateTime> bijection =
    Bijection.of(TypoLocalDateTime::value, TypoLocalDateTime::new);

  static DateTimeFormatter jsonParser = new DateTimeFormatterBuilder().appendPattern("yyyy-MM-dd'T'HH:mm:ss").appendFraction(ChronoField.MICRO_OF_SECOND, 0, 6, true).toFormatter();;

  static public TypoLocalDateTime now() {
    return TypoLocalDateTime.apply(LocalDateTime.now());
  };

  static DateTimeFormatter parser = new DateTimeFormatterBuilder().appendPattern("yyyy-MM-dd HH:mm:ss").appendFraction(ChronoField.MICRO_OF_SECOND, 0, 6, true).toFormatter();;

  static public PgText<TypoLocalDateTime> pgText =
    PgText.textString.contramap(v -> v.value().toString());

  static public PgType<TypoLocalDateTime> pgType =
    PgTypes.text.bimap((String v) -> TypoLocalDateTime.apply(v), (TypoLocalDateTime v) -> v.value().toString()).renamed("timestamp");

  static public PgType<TypoLocalDateTime[]> pgTypeArray =
    TypoLocalDateTime.pgType.array(PgRead.massageJdbcArrayTo(String[].class).map((String[] xs) -> arrayMap.map(xs, (String v) -> TypoLocalDateTime.apply(v), TypoLocalDateTime.class)), PgWrite.<String>passObjectToJdbc().array(TypoLocalDateTime.pgType.typename().<String>as()).contramap((TypoLocalDateTime[] xs) -> arrayMap.map(xs, (TypoLocalDateTime v) -> v.value().toString(), String.class)));
}