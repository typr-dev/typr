/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package adventureworks.purchasing.productvendor;

import adventureworks.customtypes.TypoLocalDateTime;
import adventureworks.person.businessentity.BusinessentityId;
import adventureworks.production.product.ProductId;
import adventureworks.production.unitmeasure.UnitmeasureId;
import java.sql.Connection;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import typo.dsl.DeleteBuilder;
import typo.dsl.Dialect;
import typo.dsl.SelectBuilder;
import typo.dsl.UpdateBuilder;
import typo.runtime.Fragment;
import typo.runtime.Fragment.Literal;
import typo.runtime.PgTypes;
import typo.runtime.internal.arrayMap;
import typo.runtime.streamingInsert;
import static typo.runtime.Fragment.interpolate;
import static typo.runtime.internal.stringInterpolator.str;

public class ProductvendorRepoImpl implements ProductvendorRepo {
  @Override
  public DeleteBuilder<ProductvendorFields, ProductvendorRow> delete() {
    return DeleteBuilder.of("\"purchasing\".\"productvendor\"", ProductvendorFields.structure(), Dialect.POSTGRESQL);
  };

  @Override
  public Boolean deleteById(
    ProductvendorId compositeId,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
      delete from "purchasing"."productvendor" where "productid" = 
      """),
      ProductId.pgType.encode(compositeId.productid()),
      typo.runtime.Fragment.lit("""
       AND "businessentityid" = 
      """),
      BusinessentityId.pgType.encode(compositeId.businessentityid()),
      typo.runtime.Fragment.lit("")
    ).update().runUnchecked(c) > 0;
  };

  @Override
  public Integer deleteByIds(
    ProductvendorId[] compositeIds,
    Connection c
  ) {
    ProductId[] productid = arrayMap.map(compositeIds, ProductvendorId::productid, ProductId.class);;
    BusinessentityId[] businessentityid = arrayMap.map(compositeIds, ProductvendorId::businessentityid, BusinessentityId.class);;
    return interpolate(
      typo.runtime.Fragment.lit("""
         delete
         from "purchasing"."productvendor"
         where ("productid", "businessentityid")
         in (select unnest("""),
      ProductId.pgTypeArray.encode(productid),
      typo.runtime.Fragment.lit("::int4[]), unnest("),
      BusinessentityId.pgTypeArray.encode(businessentityid),
      typo.runtime.Fragment.lit("""
      ::int4[]))

      """)
    ).update().runUnchecked(c);
  };

  @Override
  public ProductvendorRow insert(
    ProductvendorRow unsaved,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
         insert into "purchasing"."productvendor"("productid", "businessentityid", "averageleadtime", "standardprice", "lastreceiptcost", "lastreceiptdate", "minorderqty", "maxorderqty", "onorderqty", "unitmeasurecode", "modifieddate")
         values ("""),
      ProductId.pgType.encode(unsaved.productid()),
      typo.runtime.Fragment.lit("::int4, "),
      BusinessentityId.pgType.encode(unsaved.businessentityid()),
      typo.runtime.Fragment.lit("::int4, "),
      PgTypes.int4.encode(unsaved.averageleadtime()),
      typo.runtime.Fragment.lit("::int4, "),
      PgTypes.numeric.encode(unsaved.standardprice()),
      typo.runtime.Fragment.lit("::numeric, "),
      PgTypes.numeric.opt().encode(unsaved.lastreceiptcost()),
      typo.runtime.Fragment.lit("::numeric, "),
      TypoLocalDateTime.pgType.opt().encode(unsaved.lastreceiptdate()),
      typo.runtime.Fragment.lit("::timestamp, "),
      PgTypes.int4.encode(unsaved.minorderqty()),
      typo.runtime.Fragment.lit("::int4, "),
      PgTypes.int4.encode(unsaved.maxorderqty()),
      typo.runtime.Fragment.lit("::int4, "),
      PgTypes.int4.opt().encode(unsaved.onorderqty()),
      typo.runtime.Fragment.lit("::int4, "),
      UnitmeasureId.pgType.encode(unsaved.unitmeasurecode()),
      typo.runtime.Fragment.lit("::bpchar, "),
      TypoLocalDateTime.pgType.encode(unsaved.modifieddate()),
      typo.runtime.Fragment.lit("""
         ::timestamp)
         returning "productid", "businessentityid", "averageleadtime", "standardprice", "lastreceiptcost", "lastreceiptdate"::text, "minorderqty", "maxorderqty", "onorderqty", "unitmeasurecode", "modifieddate"::text
      """)
    )
      .updateReturning(ProductvendorRow._rowParser.exactlyOne()).runUnchecked(c);
  };

  @Override
  public ProductvendorRow insert(
    ProductvendorRowUnsaved unsaved,
    Connection c
  ) {
    ArrayList<Literal> columns = new ArrayList<Literal>();;
    ArrayList<Fragment> values = new ArrayList<Fragment>();;
    columns.add(Fragment.lit("\"productid\""));
    values.add(interpolate(
      ProductId.pgType.encode(unsaved.productid()),
      typo.runtime.Fragment.lit("::int4")
    ));
    columns.add(Fragment.lit("\"businessentityid\""));
    values.add(interpolate(
      BusinessentityId.pgType.encode(unsaved.businessentityid()),
      typo.runtime.Fragment.lit("::int4")
    ));
    columns.add(Fragment.lit("\"averageleadtime\""));
    values.add(interpolate(
      PgTypes.int4.encode(unsaved.averageleadtime()),
      typo.runtime.Fragment.lit("::int4")
    ));
    columns.add(Fragment.lit("\"standardprice\""));
    values.add(interpolate(
      PgTypes.numeric.encode(unsaved.standardprice()),
      typo.runtime.Fragment.lit("::numeric")
    ));
    columns.add(Fragment.lit("\"lastreceiptcost\""));
    values.add(interpolate(
      PgTypes.numeric.opt().encode(unsaved.lastreceiptcost()),
      typo.runtime.Fragment.lit("::numeric")
    ));
    columns.add(Fragment.lit("\"lastreceiptdate\""));
    values.add(interpolate(
      TypoLocalDateTime.pgType.opt().encode(unsaved.lastreceiptdate()),
      typo.runtime.Fragment.lit("::timestamp")
    ));
    columns.add(Fragment.lit("\"minorderqty\""));
    values.add(interpolate(
      PgTypes.int4.encode(unsaved.minorderqty()),
      typo.runtime.Fragment.lit("::int4")
    ));
    columns.add(Fragment.lit("\"maxorderqty\""));
    values.add(interpolate(
      PgTypes.int4.encode(unsaved.maxorderqty()),
      typo.runtime.Fragment.lit("::int4")
    ));
    columns.add(Fragment.lit("\"onorderqty\""));
    values.add(interpolate(
      PgTypes.int4.opt().encode(unsaved.onorderqty()),
      typo.runtime.Fragment.lit("::int4")
    ));
    columns.add(Fragment.lit("\"unitmeasurecode\""));
    values.add(interpolate(
      UnitmeasureId.pgType.encode(unsaved.unitmeasurecode()),
      typo.runtime.Fragment.lit("::bpchar")
    ));
    unsaved.modifieddate().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("\"modifieddate\""));
        values.add(interpolate(
        TypoLocalDateTime.pgType.encode(value),
        typo.runtime.Fragment.lit("::timestamp")
      ));
      }
    );;
    Fragment q = interpolate(
      typo.runtime.Fragment.lit("""
      insert into "purchasing"."productvendor"(
      """),
      Fragment.comma(columns),
      typo.runtime.Fragment.lit("""
         )
         values ("""),
      Fragment.comma(values),
      typo.runtime.Fragment.lit("""
         )
         returning "productid", "businessentityid", "averageleadtime", "standardprice", "lastreceiptcost", "lastreceiptdate"::text, "minorderqty", "maxorderqty", "onorderqty", "unitmeasurecode", "modifieddate"::text
      """)
    );;
    return q.updateReturning(ProductvendorRow._rowParser.exactlyOne()).runUnchecked(c);
  };

  @Override
  public Long insertStreaming(
    Iterator<ProductvendorRow> unsaved,
    Integer batchSize,
    Connection c
  ) {
    return streamingInsert.insertUnchecked(str("""
    COPY "purchasing"."productvendor"("productid", "businessentityid", "averageleadtime", "standardprice", "lastreceiptcost", "lastreceiptdate", "minorderqty", "maxorderqty", "onorderqty", "unitmeasurecode", "modifieddate") FROM STDIN
    """), batchSize, unsaved, c, ProductvendorRow.pgText);
  };

  /** NOTE: this functionality requires PostgreSQL 16 or later! */
  @Override
  public Long insertUnsavedStreaming(
    Iterator<ProductvendorRowUnsaved> unsaved,
    Integer batchSize,
    Connection c
  ) {
    return streamingInsert.insertUnchecked(str("""
    COPY "purchasing"."productvendor"("productid", "businessentityid", "averageleadtime", "standardprice", "lastreceiptcost", "lastreceiptdate", "minorderqty", "maxorderqty", "onorderqty", "unitmeasurecode", "modifieddate") FROM STDIN (DEFAULT '__DEFAULT_VALUE__')
    """), batchSize, unsaved, c, ProductvendorRowUnsaved.pgText);
  };

  @Override
  public SelectBuilder<ProductvendorFields, ProductvendorRow> select() {
    return SelectBuilder.of("\"purchasing\".\"productvendor\"", ProductvendorFields.structure(), ProductvendorRow._rowParser, Dialect.POSTGRESQL);
  };

  @Override
  public List<ProductvendorRow> selectAll(Connection c) {
    return interpolate(typo.runtime.Fragment.lit("""
       select "productid", "businessentityid", "averageleadtime", "standardprice", "lastreceiptcost", "lastreceiptdate"::text, "minorderqty", "maxorderqty", "onorderqty", "unitmeasurecode", "modifieddate"::text
       from "purchasing"."productvendor"
    """)).query(ProductvendorRow._rowParser.all()).runUnchecked(c);
  };

  @Override
  public Optional<ProductvendorRow> selectById(
    ProductvendorId compositeId,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
         select "productid", "businessentityid", "averageleadtime", "standardprice", "lastreceiptcost", "lastreceiptdate"::text, "minorderqty", "maxorderqty", "onorderqty", "unitmeasurecode", "modifieddate"::text
         from "purchasing"."productvendor"
         where "productid" = """),
      ProductId.pgType.encode(compositeId.productid()),
      typo.runtime.Fragment.lit("""
       AND "businessentityid" = 
      """),
      BusinessentityId.pgType.encode(compositeId.businessentityid()),
      typo.runtime.Fragment.lit("")
    ).query(ProductvendorRow._rowParser.first()).runUnchecked(c);
  };

  @Override
  public List<ProductvendorRow> selectByIds(
    ProductvendorId[] compositeIds,
    Connection c
  ) {
    ProductId[] productid = arrayMap.map(compositeIds, ProductvendorId::productid, ProductId.class);;
    BusinessentityId[] businessentityid = arrayMap.map(compositeIds, ProductvendorId::businessentityid, BusinessentityId.class);;
    return interpolate(
      typo.runtime.Fragment.lit("""
         select "productid", "businessentityid", "averageleadtime", "standardprice", "lastreceiptcost", "lastreceiptdate"::text, "minorderqty", "maxorderqty", "onorderqty", "unitmeasurecode", "modifieddate"::text
         from "purchasing"."productvendor"
         where ("productid", "businessentityid")
         in (select unnest("""),
      ProductId.pgTypeArray.encode(productid),
      typo.runtime.Fragment.lit("::int4[]), unnest("),
      BusinessentityId.pgTypeArray.encode(businessentityid),
      typo.runtime.Fragment.lit("""
      ::int4[]))

      """)
    ).query(ProductvendorRow._rowParser.all()).runUnchecked(c);
  };

  @Override
  public Map<ProductvendorId, ProductvendorRow> selectByIdsTracked(
    ProductvendorId[] compositeIds,
    Connection c
  ) {
    HashMap<ProductvendorId, ProductvendorRow> ret = new HashMap<ProductvendorId, ProductvendorRow>();
    selectByIds(compositeIds, c).forEach(row -> ret.put(row.compositeId(), row));
    return ret;
  };

  @Override
  public UpdateBuilder<ProductvendorFields, ProductvendorRow> update() {
    return UpdateBuilder.of("\"purchasing\".\"productvendor\"", ProductvendorFields.structure(), ProductvendorRow._rowParser.all(), Dialect.POSTGRESQL);
  };

  @Override
  public Boolean update(
    ProductvendorRow row,
    Connection c
  ) {
    ProductvendorId compositeId = row.compositeId();;
    return interpolate(
      typo.runtime.Fragment.lit("""
         update "purchasing"."productvendor"
         set "averageleadtime" = """),
      PgTypes.int4.encode(row.averageleadtime()),
      typo.runtime.Fragment.lit("""
         ::int4,
         "standardprice" = """),
      PgTypes.numeric.encode(row.standardprice()),
      typo.runtime.Fragment.lit("""
         ::numeric,
         "lastreceiptcost" = """),
      PgTypes.numeric.opt().encode(row.lastreceiptcost()),
      typo.runtime.Fragment.lit("""
         ::numeric,
         "lastreceiptdate" = """),
      TypoLocalDateTime.pgType.opt().encode(row.lastreceiptdate()),
      typo.runtime.Fragment.lit("""
         ::timestamp,
         "minorderqty" = """),
      PgTypes.int4.encode(row.minorderqty()),
      typo.runtime.Fragment.lit("""
         ::int4,
         "maxorderqty" = """),
      PgTypes.int4.encode(row.maxorderqty()),
      typo.runtime.Fragment.lit("""
         ::int4,
         "onorderqty" = """),
      PgTypes.int4.opt().encode(row.onorderqty()),
      typo.runtime.Fragment.lit("""
         ::int4,
         "unitmeasurecode" = """),
      UnitmeasureId.pgType.encode(row.unitmeasurecode()),
      typo.runtime.Fragment.lit("""
         ::bpchar,
         "modifieddate" = """),
      TypoLocalDateTime.pgType.encode(row.modifieddate()),
      typo.runtime.Fragment.lit("""
         ::timestamp
         where "productid" = """),
      ProductId.pgType.encode(compositeId.productid()),
      typo.runtime.Fragment.lit("""
       AND "businessentityid" = 
      """),
      BusinessentityId.pgType.encode(compositeId.businessentityid()),
      typo.runtime.Fragment.lit("")
    ).update().runUnchecked(c) > 0;
  };

  @Override
  public ProductvendorRow upsert(
    ProductvendorRow unsaved,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
         insert into "purchasing"."productvendor"("productid", "businessentityid", "averageleadtime", "standardprice", "lastreceiptcost", "lastreceiptdate", "minorderqty", "maxorderqty", "onorderqty", "unitmeasurecode", "modifieddate")
         values ("""),
      ProductId.pgType.encode(unsaved.productid()),
      typo.runtime.Fragment.lit("::int4, "),
      BusinessentityId.pgType.encode(unsaved.businessentityid()),
      typo.runtime.Fragment.lit("::int4, "),
      PgTypes.int4.encode(unsaved.averageleadtime()),
      typo.runtime.Fragment.lit("::int4, "),
      PgTypes.numeric.encode(unsaved.standardprice()),
      typo.runtime.Fragment.lit("::numeric, "),
      PgTypes.numeric.opt().encode(unsaved.lastreceiptcost()),
      typo.runtime.Fragment.lit("::numeric, "),
      TypoLocalDateTime.pgType.opt().encode(unsaved.lastreceiptdate()),
      typo.runtime.Fragment.lit("::timestamp, "),
      PgTypes.int4.encode(unsaved.minorderqty()),
      typo.runtime.Fragment.lit("::int4, "),
      PgTypes.int4.encode(unsaved.maxorderqty()),
      typo.runtime.Fragment.lit("::int4, "),
      PgTypes.int4.opt().encode(unsaved.onorderqty()),
      typo.runtime.Fragment.lit("::int4, "),
      UnitmeasureId.pgType.encode(unsaved.unitmeasurecode()),
      typo.runtime.Fragment.lit("::bpchar, "),
      TypoLocalDateTime.pgType.encode(unsaved.modifieddate()),
      typo.runtime.Fragment.lit("""
         ::timestamp)
         on conflict ("productid", "businessentityid")
         do update set
           "averageleadtime" = EXCLUDED."averageleadtime",
         "standardprice" = EXCLUDED."standardprice",
         "lastreceiptcost" = EXCLUDED."lastreceiptcost",
         "lastreceiptdate" = EXCLUDED."lastreceiptdate",
         "minorderqty" = EXCLUDED."minorderqty",
         "maxorderqty" = EXCLUDED."maxorderqty",
         "onorderqty" = EXCLUDED."onorderqty",
         "unitmeasurecode" = EXCLUDED."unitmeasurecode",
         "modifieddate" = EXCLUDED."modifieddate"
         returning "productid", "businessentityid", "averageleadtime", "standardprice", "lastreceiptcost", "lastreceiptdate"::text, "minorderqty", "maxorderqty", "onorderqty", "unitmeasurecode", "modifieddate"::text""")
    )
      .updateReturning(ProductvendorRow._rowParser.exactlyOne())
      .runUnchecked(c);
  };

  @Override
  public List<ProductvendorRow> upsertBatch(
    Iterator<ProductvendorRow> unsaved,
    Connection c
  ) {
    return interpolate(typo.runtime.Fragment.lit("""
                insert into "purchasing"."productvendor"("productid", "businessentityid", "averageleadtime", "standardprice", "lastreceiptcost", "lastreceiptdate", "minorderqty", "maxorderqty", "onorderqty", "unitmeasurecode", "modifieddate")
                values (?::int4, ?::int4, ?::int4, ?::numeric, ?::numeric, ?::timestamp, ?::int4, ?::int4, ?::int4, ?::bpchar, ?::timestamp)
                on conflict ("productid", "businessentityid")
                do update set
                  "averageleadtime" = EXCLUDED."averageleadtime",
                "standardprice" = EXCLUDED."standardprice",
                "lastreceiptcost" = EXCLUDED."lastreceiptcost",
                "lastreceiptdate" = EXCLUDED."lastreceiptdate",
                "minorderqty" = EXCLUDED."minorderqty",
                "maxorderqty" = EXCLUDED."maxorderqty",
                "onorderqty" = EXCLUDED."onorderqty",
                "unitmeasurecode" = EXCLUDED."unitmeasurecode",
                "modifieddate" = EXCLUDED."modifieddate"
                returning "productid", "businessentityid", "averageleadtime", "standardprice", "lastreceiptcost", "lastreceiptdate"::text, "minorderqty", "maxorderqty", "onorderqty", "unitmeasurecode", "modifieddate"::text"""))
      .updateManyReturning(ProductvendorRow._rowParser, unsaved)
      .runUnchecked(c);
  };

  /** NOTE: this functionality is not safe if you use auto-commit mode! it runs 3 SQL statements */
  @Override
  public Integer upsertStreaming(
    Iterator<ProductvendorRow> unsaved,
    Integer batchSize,
    Connection c
  ) {
    interpolate(typo.runtime.Fragment.lit("""
    create temporary table productvendor_TEMP (like "purchasing"."productvendor") on commit drop
    """)).update().runUnchecked(c);
    streamingInsert.insertUnchecked(str("""
    copy productvendor_TEMP("productid", "businessentityid", "averageleadtime", "standardprice", "lastreceiptcost", "lastreceiptdate", "minorderqty", "maxorderqty", "onorderqty", "unitmeasurecode", "modifieddate") from stdin
    """), batchSize, unsaved, c, ProductvendorRow.pgText);
    return interpolate(typo.runtime.Fragment.lit("""
       insert into "purchasing"."productvendor"("productid", "businessentityid", "averageleadtime", "standardprice", "lastreceiptcost", "lastreceiptdate", "minorderqty", "maxorderqty", "onorderqty", "unitmeasurecode", "modifieddate")
       select * from productvendor_TEMP
       on conflict ("productid", "businessentityid")
       do update set
         "averageleadtime" = EXCLUDED."averageleadtime",
       "standardprice" = EXCLUDED."standardprice",
       "lastreceiptcost" = EXCLUDED."lastreceiptcost",
       "lastreceiptdate" = EXCLUDED."lastreceiptdate",
       "minorderqty" = EXCLUDED."minorderqty",
       "maxorderqty" = EXCLUDED."maxorderqty",
       "onorderqty" = EXCLUDED."onorderqty",
       "unitmeasurecode" = EXCLUDED."unitmeasurecode",
       "modifieddate" = EXCLUDED."modifieddate"
       ;
       drop table productvendor_TEMP;""")).update().runUnchecked(c);
  };
}