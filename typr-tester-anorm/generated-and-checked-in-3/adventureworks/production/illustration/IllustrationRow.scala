/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package adventureworks.production.illustration

import adventureworks.Text
import adventureworks.customtypes.Defaulted
import adventureworks.customtypes.TypoLocalDateTime
import adventureworks.customtypes.TypoXml
import anorm.Column
import anorm.RowParser
import anorm.Success
import play.api.libs.json.JsObject
import play.api.libs.json.JsResult
import play.api.libs.json.JsValue
import play.api.libs.json.OWrites
import play.api.libs.json.Reads
import play.api.libs.json.Writes
import scala.collection.immutable.ListMap
import scala.util.Try

/** Table: production.illustration
 * Bicycle assembly diagrams.
 * Primary key: illustrationid
 */
case class IllustrationRow(
  /** Primary key for Illustration records.
   * Default: nextval('production.illustration_illustrationid_seq'::regclass)
   */
  illustrationid: IllustrationId,
  /** Illustrations used in manufacturing instructions. Stored as XML. */
  diagram: Option[TypoXml],
  /** Default: now() */
  modifieddate: TypoLocalDateTime
) {
  def id: IllustrationId = illustrationid

  def toUnsavedRow(
    illustrationid: Defaulted[IllustrationId],
    modifieddate: Defaulted[TypoLocalDateTime] = Defaulted.Provided(this.modifieddate)
  ): IllustrationRowUnsaved = new IllustrationRowUnsaved(diagram, illustrationid, modifieddate)
}

object IllustrationRow {
  given pgText: Text[IllustrationRow] = {
    Text.instance[IllustrationRow]{ (row, sb) =>
      IllustrationId.pgText.unsafeEncode(row.illustrationid, sb)
      sb.append(Text.DELIMETER)
      Text.option(using TypoXml.pgText).unsafeEncode(row.diagram, sb)
      sb.append(Text.DELIMETER)
      TypoLocalDateTime.pgText.unsafeEncode(row.modifieddate, sb)
    }
  }

  given reads: Reads[IllustrationRow] = {
    Reads[IllustrationRow](json => JsResult.fromTry(
        Try(
          IllustrationRow(
            illustrationid = json.\("illustrationid").as(using IllustrationId.reads),
            diagram = json.\("diagram").toOption.map(_.as(using TypoXml.reads)),
            modifieddate = json.\("modifieddate").as(using TypoLocalDateTime.reads)
          )
        )
      ),
    )
  }

  def rowParser(idx: Int): RowParser[IllustrationRow] = {
    RowParser[IllustrationRow] { row =>
      Success(
        IllustrationRow(
          illustrationid = row(idx + 0)(using IllustrationId.column),
          diagram = row(idx + 1)(using Column.columnToOption(using TypoXml.column)),
          modifieddate = row(idx + 2)(using TypoLocalDateTime.column)
        )
      )
    }
  }

  given writes: OWrites[IllustrationRow] = {
    OWrites[IllustrationRow](o =>
      new JsObject(ListMap[String, JsValue](
        "illustrationid" -> IllustrationId.writes.writes(o.illustrationid),
        "diagram" -> Writes.OptionWrites(using TypoXml.writes).writes(o.diagram),
        "modifieddate" -> TypoLocalDateTime.writes.writes(o.modifieddate)
      ))
    )
  }
}