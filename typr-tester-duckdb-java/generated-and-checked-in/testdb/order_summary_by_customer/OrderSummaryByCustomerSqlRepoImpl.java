/**
 * File has been automatically generated by `typo`.
 *
 * <p>IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.order_summary_by_customer;

import static typr.runtime.Fragment.interpolate;

import java.math.BigDecimal;
import java.sql.Connection;
import java.util.List;
import java.util.Optional;
import typr.runtime.DuckDbTypes;
import typr.runtime.Fragment;

public class OrderSummaryByCustomerSqlRepoImpl implements OrderSummaryByCustomerSqlRepo {
  @Override
  public List<OrderSummaryByCustomerSqlRow> apply(
      Optional<Integer[]> customerIds,
      Optional<BigDecimal> minTotal,
      Optional<Integer> minOrderCount,
      Connection c) {
    return interpolate(
            Fragment.lit(
                "-- Order summary with aggregations and complex joins\n"
                    + "-- Tests: aggregations, GROUP BY, HAVING, multiple joins, type-safe IDs in"
                    + " WHERE\n\n"
                    + "SELECT\n"
                    + "    c.customer_id,\n"
                    + "    c.name AS customer_name,\n"
                    + "    c.email,\n"
                    + "    c.priority,\n"
                    + "    COUNT(DISTINCT o.order_id) AS order_count,\n"
                    + "    COALESCE(SUM(o.total_amount), 0.0) AS total_spent,\n"
                    + "    MAX(o.order_date) AS last_order_date,\n"
                    + "    MIN(o.order_date) AS first_order_date,\n"
                    + "    COALESCE(AVG(o.total_amount), 0.0) AS avg_order_amount\n"
                    + "FROM customers c\n"
                    + "LEFT JOIN orders o ON c.customer_id = o.customer_id\n"
                    + "WHERE\n"
                    + "    ("),
            Fragment.encode(DuckDbTypes.integerArray.opt(), customerIds),
            Fragment.lit(" IS NULL OR c.customer_id = ANY(CAST("),
            Fragment.encode(DuckDbTypes.integerArray.opt(), customerIds),
            Fragment.lit(" AS INTEGER[])))\n    AND ("),
            Fragment.encode(DuckDbTypes.numeric.opt(), minTotal),
            Fragment.lit(
                " IS NULL OR c.customer_id IN (\n"
                    + "        SELECT customer_id\n"
                    + "        FROM orders\n"
                    + "        GROUP BY customer_id\n"
                    + "        HAVING SUM(total_amount) >= CAST("),
            Fragment.encode(DuckDbTypes.numeric.opt(), minTotal),
            Fragment.lit(
                " AS DECIMAL)\n"
                    + "    ))\n"
                    + "GROUP BY c.customer_id, c.name, c.email, c.priority\n"
                    + "HAVING\n"
                    + "    ("),
            Fragment.encode(DuckDbTypes.integer.opt(), minOrderCount),
            Fragment.lit(" IS NULL OR COUNT(DISTINCT o.order_id) >= CAST("),
            Fragment.encode(DuckDbTypes.integer.opt(), minOrderCount),
            Fragment.lit(" AS INTEGER))\nORDER BY total_spent DESC, customer_name"))
        .query(OrderSummaryByCustomerSqlRow._rowParser.all())
        .runUnchecked(c);
  }
  ;
}
