/**
 * File has been automatically generated by `typo`.
 *
 * <p>IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.delete_old_orders;

import static typr.runtime.Fragment.interpolate;

import java.sql.Connection;
import java.time.LocalDate;
import java.util.Optional;
import typr.runtime.DuckDbTypes;
import typr.runtime.Fragment;

public class DeleteOldOrdersSqlRepoImpl implements DeleteOldOrdersSqlRepo {
  @Override
  public Integer apply(LocalDate cutoffDate, Optional<String> status, Connection c) {
    return interpolate(
            Fragment.lit(
                "-- Delete old orders and return what was deleted\n"
                    + "-- Tests: DELETE with RETURNING, date comparisons, status filtering\n\n"
                    + "DELETE FROM orders\n"
                    + "WHERE\n"
                    + "    order_date < CAST("),
            Fragment.encode(DuckDbTypes.date, cutoffDate),
            Fragment.lit(" AS DATE)\n    AND ("),
            Fragment.encode(DuckDbTypes.text.opt(), status),
            Fragment.lit(" IS NULL OR status = CAST("),
            Fragment.encode(DuckDbTypes.text.opt(), status),
            Fragment.lit(
                " AS VARCHAR))\n"
                    + "RETURNING\n"
                    + "    order_id,\n"
                    + "    customer_id,\n"
                    + "    order_date,\n"
                    + "    total_amount,\n"
                    + "    status"))
        .update()
        .runUnchecked(c);
  }
  ;
}
