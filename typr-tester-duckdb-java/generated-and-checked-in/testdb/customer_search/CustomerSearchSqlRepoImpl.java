/**
 * File has been automatically generated by `typo`.
 *
 * <p>IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.customer_search;

import static typr.runtime.Fragment.interpolate;

import java.sql.Connection;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;
import testdb.Priority;
import typr.runtime.DuckDbTypes;
import typr.runtime.Fragment;

public class CustomerSearchSqlRepoImpl implements CustomerSearchSqlRepo {
  @Override
  public List<CustomerSearchSqlRow> apply(
      Optional<String> namePattern,
      Optional<String> emailPattern,
      Optional</* user-picked */ Priority> minPriority,
      Optional<LocalDateTime> createdAfter,
      Long maxResults,
      Connection c) {
    return interpolate(
            Fragment.lit(
                "-- Customer search with multiple optional filters and enum handling\n"
                    + "-- Tests: optional parameters, enum types, LIKE patterns, complex WHERE\n\n"
                    + "SELECT\n"
                    + "    customer_id,\n"
                    + "    name,\n"
                    + "    email,\n"
                    + "    created_at,\n"
                    + "    priority\n"
                    + "FROM customers\n"
                    + "WHERE\n"
                    + "    ("),
            Fragment.encode(DuckDbTypes.varchar.opt(), namePattern),
            Fragment.lit(" IS NULL OR name LIKE "),
            Fragment.encode(DuckDbTypes.varchar.opt(), namePattern),
            Fragment.lit(")\n    AND ("),
            Fragment.encode(DuckDbTypes.varchar.opt(), emailPattern),
            Fragment.lit(" IS NULL OR email LIKE "),
            Fragment.encode(DuckDbTypes.varchar.opt(), emailPattern),
            Fragment.lit(")\n    AND ("),
            Fragment.encode(Priority.duckDbType.opt(), minPriority),
            Fragment.lit(" IS NULL OR priority >= "),
            Fragment.encode(Priority.duckDbType.opt(), minPriority),
            Fragment.lit(")\n    AND ("),
            Fragment.encode(DuckDbTypes.timestamp.opt(), createdAfter),
            Fragment.lit(" IS NULL OR created_at >= "),
            Fragment.encode(DuckDbTypes.timestamp.opt(), createdAfter),
            Fragment.lit(")\nORDER BY created_at DESC, customer_id\nLIMIT "),
            Fragment.encode(DuckDbTypes.bigint, maxResults),
            Fragment.lit(""))
        .query(CustomerSearchSqlRow._rowParser.all())
        .runUnchecked(c);
  }
  ;
}
