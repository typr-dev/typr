/**
 * File has been automatically generated by `typo`.
 *
 * <p>IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.product_details_with_sales;

import static typr.runtime.Fragment.interpolate;

import java.math.BigDecimal;
import java.sql.Connection;
import java.util.List;
import java.util.Optional;
import typr.runtime.DuckDbTypes;
import typr.runtime.Fragment;

public class ProductDetailsWithSalesSqlRepoImpl implements ProductDetailsWithSalesSqlRepo {
  @Override
  public List<ProductDetailsWithSalesSqlRow> apply(
      Optional<Integer[]> productIds,
      Optional<String> skuPattern,
      Optional<BigDecimal> minPrice,
      Optional<BigDecimal> maxPrice,
      Connection c) {
    return interpolate(
            Fragment.lit(
                "-- Product details with sales statistics and JSON metadata\n"
                    + "-- Tests: JSON column handling, complex aggregations, CASE expressions\n\n"
                    + "SELECT\n"
                    + "    p.product_id,\n"
                    + "    p.sku,\n"
                    + "    p.name,\n"
                    + "    p.price,\n"
                    + "    p.metadata,\n"
                    + "    COUNT(DISTINCT oi.order_id) AS times_ordered,\n"
                    + "    COALESCE(SUM(oi.quantity), 0) AS total_quantity_sold,\n"
                    + "    COALESCE(SUM(oi.quantity * oi.unit_price), 0.0) AS total_revenue,\n"
                    + "    CASE\n"
                    + "        WHEN COUNT(DISTINCT oi.order_id) = 0 THEN 'never_ordered'\n"
                    + "        WHEN COUNT(DISTINCT oi.order_id) < 5 THEN 'low'\n"
                    + "        WHEN COUNT(DISTINCT oi.order_id) < 20 THEN 'medium'\n"
                    + "        ELSE 'high'\n"
                    + "    END AS popularity\n"
                    + "FROM products p\n"
                    + "LEFT JOIN order_items oi ON p.product_id = oi.product_id\n"
                    + "WHERE\n"
                    + "    ("),
            Fragment.encode(DuckDbTypes.integerArray.opt(), productIds),
            Fragment.lit(" IS NULL OR p.product_id = ANY(CAST("),
            Fragment.encode(DuckDbTypes.integerArray.opt(), productIds),
            Fragment.lit(" AS INTEGER[])))\n    AND ("),
            Fragment.encode(DuckDbTypes.text.opt(), skuPattern),
            Fragment.lit(" IS NULL OR p.sku LIKE CAST("),
            Fragment.encode(DuckDbTypes.text.opt(), skuPattern),
            Fragment.lit(" AS VARCHAR))\n    AND ("),
            Fragment.encode(DuckDbTypes.numeric.opt(), minPrice),
            Fragment.lit(" IS NULL OR p.price >= CAST("),
            Fragment.encode(DuckDbTypes.numeric.opt(), minPrice),
            Fragment.lit(" AS DECIMAL))\n    AND ("),
            Fragment.encode(DuckDbTypes.numeric.opt(), maxPrice),
            Fragment.lit(" IS NULL OR p.price <= CAST("),
            Fragment.encode(DuckDbTypes.numeric.opt(), maxPrice),
            Fragment.lit(
                " AS DECIMAL))\n"
                    + "GROUP BY p.product_id, p.sku, p.name, p.price, p.metadata\n"
                    + "ORDER BY total_revenue DESC"))
        .query(ProductDetailsWithSalesSqlRow._rowParser.all())
        .runUnchecked(c);
  }
  ;
}
