/**
 * File has been automatically generated by `typo`.
 *
 * <p>IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.department_employee_details;

import static typr.runtime.Fragment.interpolate;

import java.math.BigDecimal;
import java.sql.Connection;
import java.time.LocalDate;
import java.util.List;
import java.util.Optional;
import typr.runtime.DuckDbTypes;
import typr.runtime.Fragment;

public class DepartmentEmployeeDetailsSqlRepoImpl implements DepartmentEmployeeDetailsSqlRepo {
  @Override
  public List<DepartmentEmployeeDetailsSqlRow> apply(
      Optional<String> deptCode,
      Optional<String> deptRegion,
      Optional<BigDecimal> minSalary,
      Optional<LocalDate> hiredAfter,
      Connection c) {
    return interpolate(
            Fragment.lit(
                "-- Department and employee details with composite key handling\n"
                    + "-- Tests: composite primary keys, composite foreign keys, multiple table"
                    + " joins\n\n"
                    + "SELECT\n"
                    + "    d.dept_code,\n"
                    + "    d.dept_region,\n"
                    + "    d.dept_name,\n"
                    + "    d.budget,\n"
                    + "    e.emp_number,\n"
                    + "    e.emp_suffix,\n"
                    + "    e.emp_name,\n"
                    + "    e.salary,\n"
                    + "    e.hire_date,\n"
                    + "    -- Calculate years of service\n"
                    + "    DATE_DIFF('year', e.hire_date, CURRENT_DATE) AS years_of_service\n"
                    + "FROM departments d\n"
                    + "LEFT JOIN employees e ON d.dept_code = e.dept_code AND d.dept_region ="
                    + " e.dept_region\n"
                    + "WHERE\n"
                    + "    ("),
            Fragment.encode(DuckDbTypes.varchar.opt(), deptCode),
            Fragment.lit(" IS NULL OR d.dept_code = "),
            Fragment.encode(DuckDbTypes.varchar.opt(), deptCode),
            Fragment.lit(")\n    AND ("),
            Fragment.encode(DuckDbTypes.varchar.opt(), deptRegion),
            Fragment.lit(" IS NULL OR d.dept_region = "),
            Fragment.encode(DuckDbTypes.varchar.opt(), deptRegion),
            Fragment.lit(")\n    AND ("),
            Fragment.encode(DuckDbTypes.numeric.opt(), minSalary),
            Fragment.lit(" IS NULL OR e.salary >= "),
            Fragment.encode(DuckDbTypes.numeric.opt(), minSalary),
            Fragment.lit(")\n    AND ("),
            Fragment.encode(DuckDbTypes.date.opt(), hiredAfter),
            Fragment.lit(" IS NULL OR e.hire_date >= "),
            Fragment.encode(DuckDbTypes.date.opt(), hiredAfter),
            Fragment.lit(")\nORDER BY d.dept_code, d.dept_region, e.emp_number"))
        .query(DepartmentEmployeeDetailsSqlRow._rowParser.all())
        .runUnchecked(c);
  }
  ;
}
