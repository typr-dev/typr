/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package adventureworks.production.product

import adventureworks.customtypes.TypoLocalDateTime
import adventureworks.customtypes.TypoShort
import adventureworks.customtypes.TypoUUID
import adventureworks.production.productmodel.ProductmodelId
import adventureworks.production.productsubcategory.ProductsubcategoryId
import adventureworks.production.unitmeasure.UnitmeasureId
import adventureworks.public.Flag
import adventureworks.public.Name
import java.sql.Connection
import java.util.ArrayList
import java.util.Optional
import kotlin.collections.List
import kotlin.collections.Map
import kotlin.collections.MutableIterator
import kotlin.collections.MutableMap
import typo.dsl.DeleteBuilder
import typo.dsl.Dialect
import typo.dsl.SelectBuilder
import typo.dsl.UpdateBuilder
import typo.runtime.Fragment
import typo.runtime.Fragment.Literal
import typo.runtime.PgTypes
import typo.runtime.streamingInsert
import typo.runtime.Fragment.interpolate
import typo.runtime.internal.stringInterpolator.str

class ProductRepoImpl() : ProductRepo {
  override fun delete(): DeleteBuilder<ProductFields, ProductRow> = DeleteBuilder.of("\"production\".\"product\"", ProductFields.structure, Dialect.POSTGRESQL)

  override fun deleteById(
    productid: ProductId,
    c: Connection
  ): Boolean = interpolate(
    typo.runtime.Fragment.lit("""
    delete from "production"."product" where "productid" = 
    """.trimMargin()),
    ProductId.pgType.encode(productid),
    typo.runtime.Fragment.lit("")
  ).update().runUnchecked(c) > 0

  override fun deleteByIds(
    productids: Array<ProductId>,
    c: Connection
  ): Int = interpolate(
             typo.runtime.Fragment.lit("""
               delete
               from "production"."product"
               where "productid" = ANY(""".trimMargin()),
             ProductId.pgTypeArray.encode(productids),
             typo.runtime.Fragment.lit(")")
           )
    .update()
    .runUnchecked(c)

  override fun insert(
    unsaved: ProductRow,
    c: Connection
  ): ProductRow = interpolate(
    typo.runtime.Fragment.lit("""
      insert into "production"."product"("productid", "name", "productnumber", "makeflag", "finishedgoodsflag", "color", "safetystocklevel", "reorderpoint", "standardcost", "listprice", "size", "sizeunitmeasurecode", "weightunitmeasurecode", "weight", "daystomanufacture", "productline", "class", "style", "productsubcategoryid", "productmodelid", "sellstartdate", "sellenddate", "discontinueddate", "rowguid", "modifieddate")
      values (""".trimMargin()),
    ProductId.pgType.encode(unsaved.productid),
    typo.runtime.Fragment.lit("::int4, "),
    Name.pgType.encode(unsaved.name),
    typo.runtime.Fragment.lit("::varchar, "),
    PgTypes.text.encode(unsaved.productnumber),
    typo.runtime.Fragment.lit(", "),
    Flag.pgType.encode(unsaved.makeflag),
    typo.runtime.Fragment.lit("::bool, "),
    Flag.pgType.encode(unsaved.finishedgoodsflag),
    typo.runtime.Fragment.lit("::bool, "),
    PgTypes.text.opt().encode(unsaved.color),
    typo.runtime.Fragment.lit(", "),
    TypoShort.pgType.encode(unsaved.safetystocklevel),
    typo.runtime.Fragment.lit("::int2, "),
    TypoShort.pgType.encode(unsaved.reorderpoint),
    typo.runtime.Fragment.lit("::int2, "),
    PgTypes.numeric.encode(unsaved.standardcost),
    typo.runtime.Fragment.lit("::numeric, "),
    PgTypes.numeric.encode(unsaved.listprice),
    typo.runtime.Fragment.lit("::numeric, "),
    PgTypes.text.opt().encode(unsaved.size),
    typo.runtime.Fragment.lit(", "),
    UnitmeasureId.pgType.opt().encode(unsaved.sizeunitmeasurecode),
    typo.runtime.Fragment.lit("::bpchar, "),
    UnitmeasureId.pgType.opt().encode(unsaved.weightunitmeasurecode),
    typo.runtime.Fragment.lit("::bpchar, "),
    PgTypes.numeric.opt().encode(unsaved.weight),
    typo.runtime.Fragment.lit("::numeric, "),
    PgTypes.int4.encode(unsaved.daystomanufacture),
    typo.runtime.Fragment.lit("::int4, "),
    PgTypes.text.opt().encode(unsaved.productline),
    typo.runtime.Fragment.lit("::bpchar, "),
    PgTypes.text.opt().encode(unsaved.`class`),
    typo.runtime.Fragment.lit("::bpchar, "),
    PgTypes.text.opt().encode(unsaved.style),
    typo.runtime.Fragment.lit("::bpchar, "),
    ProductsubcategoryId.pgType.opt().encode(unsaved.productsubcategoryid),
    typo.runtime.Fragment.lit("::int4, "),
    ProductmodelId.pgType.opt().encode(unsaved.productmodelid),
    typo.runtime.Fragment.lit("::int4, "),
    TypoLocalDateTime.pgType.encode(unsaved.sellstartdate),
    typo.runtime.Fragment.lit("::timestamp, "),
    TypoLocalDateTime.pgType.opt().encode(unsaved.sellenddate),
    typo.runtime.Fragment.lit("::timestamp, "),
    TypoLocalDateTime.pgType.opt().encode(unsaved.discontinueddate),
    typo.runtime.Fragment.lit("::timestamp, "),
    TypoUUID.pgType.encode(unsaved.rowguid),
    typo.runtime.Fragment.lit("::uuid, "),
    TypoLocalDateTime.pgType.encode(unsaved.modifieddate),
    typo.runtime.Fragment.lit("""
      ::timestamp)
      returning "productid", "name", "productnumber", "makeflag", "finishedgoodsflag", "color", "safetystocklevel", "reorderpoint", "standardcost", "listprice", "size", "sizeunitmeasurecode", "weightunitmeasurecode", "weight", "daystomanufacture", "productline", "class", "style", "productsubcategoryid", "productmodelid", "sellstartdate"::text, "sellenddate"::text, "discontinueddate"::text, "rowguid", "modifieddate"::text
    """.trimMargin())
  )
    .updateReturning(ProductRow._rowParser.exactlyOne()).runUnchecked(c)

  override fun insert(
    unsaved: ProductRowUnsaved,
    c: Connection
  ): ProductRow {
    val columns: ArrayList<Literal> = ArrayList<Literal>()
    val values: ArrayList<Fragment> = ArrayList<Fragment>()
    columns.add(Fragment.lit("\"name\""))
    values.add(interpolate(
      Name.pgType.encode(unsaved.name),
      typo.runtime.Fragment.lit("::varchar")
    ))
    columns.add(Fragment.lit("\"productnumber\""))
    values.add(interpolate(
      PgTypes.text.encode(unsaved.productnumber),
      typo.runtime.Fragment.lit("""
      """.trimMargin())
    ))
    columns.add(Fragment.lit("\"color\""))
    values.add(interpolate(
      PgTypes.text.opt().encode(unsaved.color),
      typo.runtime.Fragment.lit("""
      """.trimMargin())
    ))
    columns.add(Fragment.lit("\"safetystocklevel\""))
    values.add(interpolate(
      TypoShort.pgType.encode(unsaved.safetystocklevel),
      typo.runtime.Fragment.lit("::int2")
    ))
    columns.add(Fragment.lit("\"reorderpoint\""))
    values.add(interpolate(
      TypoShort.pgType.encode(unsaved.reorderpoint),
      typo.runtime.Fragment.lit("::int2")
    ))
    columns.add(Fragment.lit("\"standardcost\""))
    values.add(interpolate(
      PgTypes.numeric.encode(unsaved.standardcost),
      typo.runtime.Fragment.lit("::numeric")
    ))
    columns.add(Fragment.lit("\"listprice\""))
    values.add(interpolate(
      PgTypes.numeric.encode(unsaved.listprice),
      typo.runtime.Fragment.lit("::numeric")
    ))
    columns.add(Fragment.lit("\"size\""))
    values.add(interpolate(
      PgTypes.text.opt().encode(unsaved.size),
      typo.runtime.Fragment.lit("""
      """.trimMargin())
    ))
    columns.add(Fragment.lit("\"sizeunitmeasurecode\""))
    values.add(interpolate(
      UnitmeasureId.pgType.opt().encode(unsaved.sizeunitmeasurecode),
      typo.runtime.Fragment.lit("::bpchar")
    ))
    columns.add(Fragment.lit("\"weightunitmeasurecode\""))
    values.add(interpolate(
      UnitmeasureId.pgType.opt().encode(unsaved.weightunitmeasurecode),
      typo.runtime.Fragment.lit("::bpchar")
    ))
    columns.add(Fragment.lit("\"weight\""))
    values.add(interpolate(
      PgTypes.numeric.opt().encode(unsaved.weight),
      typo.runtime.Fragment.lit("::numeric")
    ))
    columns.add(Fragment.lit("\"daystomanufacture\""))
    values.add(interpolate(
      PgTypes.int4.encode(unsaved.daystomanufacture),
      typo.runtime.Fragment.lit("::int4")
    ))
    columns.add(Fragment.lit("\"productline\""))
    values.add(interpolate(
      PgTypes.text.opt().encode(unsaved.productline),
      typo.runtime.Fragment.lit("::bpchar")
    ))
    columns.add(Fragment.lit("\"class\""))
    values.add(interpolate(
      PgTypes.text.opt().encode(unsaved.`class`),
      typo.runtime.Fragment.lit("::bpchar")
    ))
    columns.add(Fragment.lit("\"style\""))
    values.add(interpolate(
      PgTypes.text.opt().encode(unsaved.style),
      typo.runtime.Fragment.lit("::bpchar")
    ))
    columns.add(Fragment.lit("\"productsubcategoryid\""))
    values.add(interpolate(
      ProductsubcategoryId.pgType.opt().encode(unsaved.productsubcategoryid),
      typo.runtime.Fragment.lit("::int4")
    ))
    columns.add(Fragment.lit("\"productmodelid\""))
    values.add(interpolate(
      ProductmodelId.pgType.opt().encode(unsaved.productmodelid),
      typo.runtime.Fragment.lit("::int4")
    ))
    columns.add(Fragment.lit("\"sellstartdate\""))
    values.add(interpolate(
      TypoLocalDateTime.pgType.encode(unsaved.sellstartdate),
      typo.runtime.Fragment.lit("::timestamp")
    ))
    columns.add(Fragment.lit("\"sellenddate\""))
    values.add(interpolate(
      TypoLocalDateTime.pgType.opt().encode(unsaved.sellenddate),
      typo.runtime.Fragment.lit("::timestamp")
    ))
    columns.add(Fragment.lit("\"discontinueddate\""))
    values.add(interpolate(
      TypoLocalDateTime.pgType.opt().encode(unsaved.discontinueddate),
      typo.runtime.Fragment.lit("::timestamp")
    ))
    unsaved.productid.visit(
      {  },
      { value -> columns.add(Fragment.lit("\"productid\""))
      values.add(interpolate(
        ProductId.pgType.encode(value),
        typo.runtime.Fragment.lit("::int4")
      )) }
    );
    unsaved.makeflag.visit(
      {  },
      { value -> columns.add(Fragment.lit("\"makeflag\""))
      values.add(interpolate(
        Flag.pgType.encode(value),
        typo.runtime.Fragment.lit("::bool")
      )) }
    );
    unsaved.finishedgoodsflag.visit(
      {  },
      { value -> columns.add(Fragment.lit("\"finishedgoodsflag\""))
      values.add(interpolate(
        Flag.pgType.encode(value),
        typo.runtime.Fragment.lit("::bool")
      )) }
    );
    unsaved.rowguid.visit(
      {  },
      { value -> columns.add(Fragment.lit("\"rowguid\""))
      values.add(interpolate(
        TypoUUID.pgType.encode(value),
        typo.runtime.Fragment.lit("::uuid")
      )) }
    );
    unsaved.modifieddate.visit(
      {  },
      { value -> columns.add(Fragment.lit("\"modifieddate\""))
      values.add(interpolate(
        TypoLocalDateTime.pgType.encode(value),
        typo.runtime.Fragment.lit("::timestamp")
      )) }
    );
    val q: Fragment = interpolate(
      typo.runtime.Fragment.lit("""
      insert into "production"."product"(
      """.trimMargin()),
      Fragment.comma(columns),
      typo.runtime.Fragment.lit("""
        )
        values (""".trimMargin()),
      Fragment.comma(values),
      typo.runtime.Fragment.lit("""
        )
        returning "productid", "name", "productnumber", "makeflag", "finishedgoodsflag", "color", "safetystocklevel", "reorderpoint", "standardcost", "listprice", "size", "sizeunitmeasurecode", "weightunitmeasurecode", "weight", "daystomanufacture", "productline", "class", "style", "productsubcategoryid", "productmodelid", "sellstartdate"::text, "sellenddate"::text, "discontinueddate"::text, "rowguid", "modifieddate"::text
      """.trimMargin())
    )
    return q.updateReturning(ProductRow._rowParser.exactlyOne()).runUnchecked(c)
  }

  override fun insertStreaming(
    unsaved: MutableIterator<ProductRow>,
    batchSize: Int,
    c: Connection
  ): Long = streamingInsert.insertUnchecked(str("""
  COPY "production"."product"("productid", "name", "productnumber", "makeflag", "finishedgoodsflag", "color", "safetystocklevel", "reorderpoint", "standardcost", "listprice", "size", "sizeunitmeasurecode", "weightunitmeasurecode", "weight", "daystomanufacture", "productline", "class", "style", "productsubcategoryid", "productmodelid", "sellstartdate", "sellenddate", "discontinueddate", "rowguid", "modifieddate") FROM STDIN
  """.trimMargin()), batchSize, unsaved, c, ProductRow.pgText)

  /** NOTE: this functionality requires PostgreSQL 16 or later! */
  override fun insertUnsavedStreaming(
    unsaved: MutableIterator<ProductRowUnsaved>,
    batchSize: Int,
    c: Connection
  ): Long = streamingInsert.insertUnchecked(str("""
  COPY "production"."product"("name", "productnumber", "color", "safetystocklevel", "reorderpoint", "standardcost", "listprice", "size", "sizeunitmeasurecode", "weightunitmeasurecode", "weight", "daystomanufacture", "productline", "class", "style", "productsubcategoryid", "productmodelid", "sellstartdate", "sellenddate", "discontinueddate", "productid", "makeflag", "finishedgoodsflag", "rowguid", "modifieddate") FROM STDIN (DEFAULT '__DEFAULT_VALUE__')
  """.trimMargin()), batchSize, unsaved, c, ProductRowUnsaved.pgText)

  override fun select(): SelectBuilder<ProductFields, ProductRow> = SelectBuilder.of("\"production\".\"product\"", ProductFields.structure, ProductRow._rowParser, Dialect.POSTGRESQL)

  override fun selectAll(c: Connection): List<ProductRow> = interpolate(typo.runtime.Fragment.lit("""
    select "productid", "name", "productnumber", "makeflag", "finishedgoodsflag", "color", "safetystocklevel", "reorderpoint", "standardcost", "listprice", "size", "sizeunitmeasurecode", "weightunitmeasurecode", "weight", "daystomanufacture", "productline", "class", "style", "productsubcategoryid", "productmodelid", "sellstartdate"::text, "sellenddate"::text, "discontinueddate"::text, "rowguid", "modifieddate"::text
    from "production"."product"
  """.trimMargin())).query(ProductRow._rowParser.all()).runUnchecked(c)

  override fun selectById(
    productid: ProductId,
    c: Connection
  ): Optional<ProductRow> = interpolate(
    typo.runtime.Fragment.lit("""
      select "productid", "name", "productnumber", "makeflag", "finishedgoodsflag", "color", "safetystocklevel", "reorderpoint", "standardcost", "listprice", "size", "sizeunitmeasurecode", "weightunitmeasurecode", "weight", "daystomanufacture", "productline", "class", "style", "productsubcategoryid", "productmodelid", "sellstartdate"::text, "sellenddate"::text, "discontinueddate"::text, "rowguid", "modifieddate"::text
      from "production"."product"
      where "productid" = """.trimMargin()),
    ProductId.pgType.encode(productid),
    typo.runtime.Fragment.lit("")
  ).query(ProductRow._rowParser.first()).runUnchecked(c)

  override fun selectByIds(
    productids: Array<ProductId>,
    c: Connection
  ): List<ProductRow> = interpolate(
    typo.runtime.Fragment.lit("""
      select "productid", "name", "productnumber", "makeflag", "finishedgoodsflag", "color", "safetystocklevel", "reorderpoint", "standardcost", "listprice", "size", "sizeunitmeasurecode", "weightunitmeasurecode", "weight", "daystomanufacture", "productline", "class", "style", "productsubcategoryid", "productmodelid", "sellstartdate"::text, "sellenddate"::text, "discontinueddate"::text, "rowguid", "modifieddate"::text
      from "production"."product"
      where "productid" = ANY(""".trimMargin()),
    ProductId.pgTypeArray.encode(productids),
    typo.runtime.Fragment.lit(")")
  ).query(ProductRow._rowParser.all()).runUnchecked(c)

  override fun selectByIdsTracked(
    productids: Array<ProductId>,
    c: Connection
  ): Map<ProductId, ProductRow> {
    val ret: MutableMap<ProductId, ProductRow> = mutableMapOf<ProductId, ProductRow>()
    selectByIds(productids, c).forEach({ row -> ret.put(row.productid, row) })
    return ret
  }

  override fun update(): UpdateBuilder<ProductFields, ProductRow> = UpdateBuilder.of("\"production\".\"product\"", ProductFields.structure, ProductRow._rowParser.all(), Dialect.POSTGRESQL)

  override fun update(
    row: ProductRow,
    c: Connection
  ): Boolean {
    val productid: ProductId = row.productid
    return interpolate(
      typo.runtime.Fragment.lit("""
        update "production"."product"
        set "name" = """.trimMargin()),
      Name.pgType.encode(row.name),
      typo.runtime.Fragment.lit("""
        ::varchar,
        "productnumber" = """.trimMargin()),
      PgTypes.text.encode(row.productnumber),
      typo.runtime.Fragment.lit("""
        ,
        "makeflag" = """.trimMargin()),
      Flag.pgType.encode(row.makeflag),
      typo.runtime.Fragment.lit("""
        ::bool,
        "finishedgoodsflag" = """.trimMargin()),
      Flag.pgType.encode(row.finishedgoodsflag),
      typo.runtime.Fragment.lit("""
        ::bool,
        "color" = """.trimMargin()),
      PgTypes.text.opt().encode(row.color),
      typo.runtime.Fragment.lit("""
        ,
        "safetystocklevel" = """.trimMargin()),
      TypoShort.pgType.encode(row.safetystocklevel),
      typo.runtime.Fragment.lit("""
        ::int2,
        "reorderpoint" = """.trimMargin()),
      TypoShort.pgType.encode(row.reorderpoint),
      typo.runtime.Fragment.lit("""
        ::int2,
        "standardcost" = """.trimMargin()),
      PgTypes.numeric.encode(row.standardcost),
      typo.runtime.Fragment.lit("""
        ::numeric,
        "listprice" = """.trimMargin()),
      PgTypes.numeric.encode(row.listprice),
      typo.runtime.Fragment.lit("""
        ::numeric,
        "size" = """.trimMargin()),
      PgTypes.text.opt().encode(row.size),
      typo.runtime.Fragment.lit("""
        ,
        "sizeunitmeasurecode" = """.trimMargin()),
      UnitmeasureId.pgType.opt().encode(row.sizeunitmeasurecode),
      typo.runtime.Fragment.lit("""
        ::bpchar,
        "weightunitmeasurecode" = """.trimMargin()),
      UnitmeasureId.pgType.opt().encode(row.weightunitmeasurecode),
      typo.runtime.Fragment.lit("""
        ::bpchar,
        "weight" = """.trimMargin()),
      PgTypes.numeric.opt().encode(row.weight),
      typo.runtime.Fragment.lit("""
        ::numeric,
        "daystomanufacture" = """.trimMargin()),
      PgTypes.int4.encode(row.daystomanufacture),
      typo.runtime.Fragment.lit("""
        ::int4,
        "productline" = """.trimMargin()),
      PgTypes.text.opt().encode(row.productline),
      typo.runtime.Fragment.lit("""
        ::bpchar,
        "class" = """.trimMargin()),
      PgTypes.text.opt().encode(row.`class`),
      typo.runtime.Fragment.lit("""
        ::bpchar,
        "style" = """.trimMargin()),
      PgTypes.text.opt().encode(row.style),
      typo.runtime.Fragment.lit("""
        ::bpchar,
        "productsubcategoryid" = """.trimMargin()),
      ProductsubcategoryId.pgType.opt().encode(row.productsubcategoryid),
      typo.runtime.Fragment.lit("""
        ::int4,
        "productmodelid" = """.trimMargin()),
      ProductmodelId.pgType.opt().encode(row.productmodelid),
      typo.runtime.Fragment.lit("""
        ::int4,
        "sellstartdate" = """.trimMargin()),
      TypoLocalDateTime.pgType.encode(row.sellstartdate),
      typo.runtime.Fragment.lit("""
        ::timestamp,
        "sellenddate" = """.trimMargin()),
      TypoLocalDateTime.pgType.opt().encode(row.sellenddate),
      typo.runtime.Fragment.lit("""
        ::timestamp,
        "discontinueddate" = """.trimMargin()),
      TypoLocalDateTime.pgType.opt().encode(row.discontinueddate),
      typo.runtime.Fragment.lit("""
        ::timestamp,
        "rowguid" = """.trimMargin()),
      TypoUUID.pgType.encode(row.rowguid),
      typo.runtime.Fragment.lit("""
        ::uuid,
        "modifieddate" = """.trimMargin()),
      TypoLocalDateTime.pgType.encode(row.modifieddate),
      typo.runtime.Fragment.lit("""
        ::timestamp
        where "productid" = """.trimMargin()),
      ProductId.pgType.encode(productid),
      typo.runtime.Fragment.lit("")
    ).update().runUnchecked(c) > 0
  }

  override fun upsert(
    unsaved: ProductRow,
    c: Connection
  ): ProductRow = interpolate(
    typo.runtime.Fragment.lit("""
      insert into "production"."product"("productid", "name", "productnumber", "makeflag", "finishedgoodsflag", "color", "safetystocklevel", "reorderpoint", "standardcost", "listprice", "size", "sizeunitmeasurecode", "weightunitmeasurecode", "weight", "daystomanufacture", "productline", "class", "style", "productsubcategoryid", "productmodelid", "sellstartdate", "sellenddate", "discontinueddate", "rowguid", "modifieddate")
      values (""".trimMargin()),
    ProductId.pgType.encode(unsaved.productid),
    typo.runtime.Fragment.lit("::int4, "),
    Name.pgType.encode(unsaved.name),
    typo.runtime.Fragment.lit("::varchar, "),
    PgTypes.text.encode(unsaved.productnumber),
    typo.runtime.Fragment.lit(", "),
    Flag.pgType.encode(unsaved.makeflag),
    typo.runtime.Fragment.lit("::bool, "),
    Flag.pgType.encode(unsaved.finishedgoodsflag),
    typo.runtime.Fragment.lit("::bool, "),
    PgTypes.text.opt().encode(unsaved.color),
    typo.runtime.Fragment.lit(", "),
    TypoShort.pgType.encode(unsaved.safetystocklevel),
    typo.runtime.Fragment.lit("::int2, "),
    TypoShort.pgType.encode(unsaved.reorderpoint),
    typo.runtime.Fragment.lit("::int2, "),
    PgTypes.numeric.encode(unsaved.standardcost),
    typo.runtime.Fragment.lit("::numeric, "),
    PgTypes.numeric.encode(unsaved.listprice),
    typo.runtime.Fragment.lit("::numeric, "),
    PgTypes.text.opt().encode(unsaved.size),
    typo.runtime.Fragment.lit(", "),
    UnitmeasureId.pgType.opt().encode(unsaved.sizeunitmeasurecode),
    typo.runtime.Fragment.lit("::bpchar, "),
    UnitmeasureId.pgType.opt().encode(unsaved.weightunitmeasurecode),
    typo.runtime.Fragment.lit("::bpchar, "),
    PgTypes.numeric.opt().encode(unsaved.weight),
    typo.runtime.Fragment.lit("::numeric, "),
    PgTypes.int4.encode(unsaved.daystomanufacture),
    typo.runtime.Fragment.lit("::int4, "),
    PgTypes.text.opt().encode(unsaved.productline),
    typo.runtime.Fragment.lit("::bpchar, "),
    PgTypes.text.opt().encode(unsaved.`class`),
    typo.runtime.Fragment.lit("::bpchar, "),
    PgTypes.text.opt().encode(unsaved.style),
    typo.runtime.Fragment.lit("::bpchar, "),
    ProductsubcategoryId.pgType.opt().encode(unsaved.productsubcategoryid),
    typo.runtime.Fragment.lit("::int4, "),
    ProductmodelId.pgType.opt().encode(unsaved.productmodelid),
    typo.runtime.Fragment.lit("::int4, "),
    TypoLocalDateTime.pgType.encode(unsaved.sellstartdate),
    typo.runtime.Fragment.lit("::timestamp, "),
    TypoLocalDateTime.pgType.opt().encode(unsaved.sellenddate),
    typo.runtime.Fragment.lit("::timestamp, "),
    TypoLocalDateTime.pgType.opt().encode(unsaved.discontinueddate),
    typo.runtime.Fragment.lit("::timestamp, "),
    TypoUUID.pgType.encode(unsaved.rowguid),
    typo.runtime.Fragment.lit("::uuid, "),
    TypoLocalDateTime.pgType.encode(unsaved.modifieddate),
    typo.runtime.Fragment.lit("""
      ::timestamp)
      on conflict ("productid")
      do update set
        "name" = EXCLUDED."name",
      "productnumber" = EXCLUDED."productnumber",
      "makeflag" = EXCLUDED."makeflag",
      "finishedgoodsflag" = EXCLUDED."finishedgoodsflag",
      "color" = EXCLUDED."color",
      "safetystocklevel" = EXCLUDED."safetystocklevel",
      "reorderpoint" = EXCLUDED."reorderpoint",
      "standardcost" = EXCLUDED."standardcost",
      "listprice" = EXCLUDED."listprice",
      "size" = EXCLUDED."size",
      "sizeunitmeasurecode" = EXCLUDED."sizeunitmeasurecode",
      "weightunitmeasurecode" = EXCLUDED."weightunitmeasurecode",
      "weight" = EXCLUDED."weight",
      "daystomanufacture" = EXCLUDED."daystomanufacture",
      "productline" = EXCLUDED."productline",
      "class" = EXCLUDED."class",
      "style" = EXCLUDED."style",
      "productsubcategoryid" = EXCLUDED."productsubcategoryid",
      "productmodelid" = EXCLUDED."productmodelid",
      "sellstartdate" = EXCLUDED."sellstartdate",
      "sellenddate" = EXCLUDED."sellenddate",
      "discontinueddate" = EXCLUDED."discontinueddate",
      "rowguid" = EXCLUDED."rowguid",
      "modifieddate" = EXCLUDED."modifieddate"
      returning "productid", "name", "productnumber", "makeflag", "finishedgoodsflag", "color", "safetystocklevel", "reorderpoint", "standardcost", "listprice", "size", "sizeunitmeasurecode", "weightunitmeasurecode", "weight", "daystomanufacture", "productline", "class", "style", "productsubcategoryid", "productmodelid", "sellstartdate"::text, "sellenddate"::text, "discontinueddate"::text, "rowguid", "modifieddate"::text""".trimMargin())
  )
    .updateReturning(ProductRow._rowParser.exactlyOne())
    .runUnchecked(c)

  override fun upsertBatch(
    unsaved: MutableIterator<ProductRow>,
    c: Connection
  ): List<ProductRow> = interpolate(typo.runtime.Fragment.lit("""
                          insert into "production"."product"("productid", "name", "productnumber", "makeflag", "finishedgoodsflag", "color", "safetystocklevel", "reorderpoint", "standardcost", "listprice", "size", "sizeunitmeasurecode", "weightunitmeasurecode", "weight", "daystomanufacture", "productline", "class", "style", "productsubcategoryid", "productmodelid", "sellstartdate", "sellenddate", "discontinueddate", "rowguid", "modifieddate")
                          values (?::int4, ?::varchar, ?, ?::bool, ?::bool, ?, ?::int2, ?::int2, ?::numeric, ?::numeric, ?, ?::bpchar, ?::bpchar, ?::numeric, ?::int4, ?::bpchar, ?::bpchar, ?::bpchar, ?::int4, ?::int4, ?::timestamp, ?::timestamp, ?::timestamp, ?::uuid, ?::timestamp)
                          on conflict ("productid")
                          do update set
                            "name" = EXCLUDED."name",
                          "productnumber" = EXCLUDED."productnumber",
                          "makeflag" = EXCLUDED."makeflag",
                          "finishedgoodsflag" = EXCLUDED."finishedgoodsflag",
                          "color" = EXCLUDED."color",
                          "safetystocklevel" = EXCLUDED."safetystocklevel",
                          "reorderpoint" = EXCLUDED."reorderpoint",
                          "standardcost" = EXCLUDED."standardcost",
                          "listprice" = EXCLUDED."listprice",
                          "size" = EXCLUDED."size",
                          "sizeunitmeasurecode" = EXCLUDED."sizeunitmeasurecode",
                          "weightunitmeasurecode" = EXCLUDED."weightunitmeasurecode",
                          "weight" = EXCLUDED."weight",
                          "daystomanufacture" = EXCLUDED."daystomanufacture",
                          "productline" = EXCLUDED."productline",
                          "class" = EXCLUDED."class",
                          "style" = EXCLUDED."style",
                          "productsubcategoryid" = EXCLUDED."productsubcategoryid",
                          "productmodelid" = EXCLUDED."productmodelid",
                          "sellstartdate" = EXCLUDED."sellstartdate",
                          "sellenddate" = EXCLUDED."sellenddate",
                          "discontinueddate" = EXCLUDED."discontinueddate",
                          "rowguid" = EXCLUDED."rowguid",
                          "modifieddate" = EXCLUDED."modifieddate"
                          returning "productid", "name", "productnumber", "makeflag", "finishedgoodsflag", "color", "safetystocklevel", "reorderpoint", "standardcost", "listprice", "size", "sizeunitmeasurecode", "weightunitmeasurecode", "weight", "daystomanufacture", "productline", "class", "style", "productsubcategoryid", "productmodelid", "sellstartdate"::text, "sellenddate"::text, "discontinueddate"::text, "rowguid", "modifieddate"::text""".trimMargin()))
    .updateManyReturning(ProductRow._rowParser, unsaved)
    .runUnchecked(c)

  /** NOTE: this functionality is not safe if you use auto-commit mode! it runs 3 SQL statements */
  override fun upsertStreaming(
    unsaved: MutableIterator<ProductRow>,
    batchSize: Int,
    c: Connection
  ): Int {
    interpolate(typo.runtime.Fragment.lit("""
    create temporary table product_TEMP (like "production"."product") on commit drop
    """.trimMargin())).update().runUnchecked(c)
    streamingInsert.insertUnchecked(str("""
    copy product_TEMP("productid", "name", "productnumber", "makeflag", "finishedgoodsflag", "color", "safetystocklevel", "reorderpoint", "standardcost", "listprice", "size", "sizeunitmeasurecode", "weightunitmeasurecode", "weight", "daystomanufacture", "productline", "class", "style", "productsubcategoryid", "productmodelid", "sellstartdate", "sellenddate", "discontinueddate", "rowguid", "modifieddate") from stdin
    """.trimMargin()), batchSize, unsaved, c, ProductRow.pgText)
    return interpolate(typo.runtime.Fragment.lit("""
      insert into "production"."product"("productid", "name", "productnumber", "makeflag", "finishedgoodsflag", "color", "safetystocklevel", "reorderpoint", "standardcost", "listprice", "size", "sizeunitmeasurecode", "weightunitmeasurecode", "weight", "daystomanufacture", "productline", "class", "style", "productsubcategoryid", "productmodelid", "sellstartdate", "sellenddate", "discontinueddate", "rowguid", "modifieddate")
      select * from product_TEMP
      on conflict ("productid")
      do update set
        "name" = EXCLUDED."name",
      "productnumber" = EXCLUDED."productnumber",
      "makeflag" = EXCLUDED."makeflag",
      "finishedgoodsflag" = EXCLUDED."finishedgoodsflag",
      "color" = EXCLUDED."color",
      "safetystocklevel" = EXCLUDED."safetystocklevel",
      "reorderpoint" = EXCLUDED."reorderpoint",
      "standardcost" = EXCLUDED."standardcost",
      "listprice" = EXCLUDED."listprice",
      "size" = EXCLUDED."size",
      "sizeunitmeasurecode" = EXCLUDED."sizeunitmeasurecode",
      "weightunitmeasurecode" = EXCLUDED."weightunitmeasurecode",
      "weight" = EXCLUDED."weight",
      "daystomanufacture" = EXCLUDED."daystomanufacture",
      "productline" = EXCLUDED."productline",
      "class" = EXCLUDED."class",
      "style" = EXCLUDED."style",
      "productsubcategoryid" = EXCLUDED."productsubcategoryid",
      "productmodelid" = EXCLUDED."productmodelid",
      "sellstartdate" = EXCLUDED."sellstartdate",
      "sellenddate" = EXCLUDED."sellenddate",
      "discontinueddate" = EXCLUDED."discontinueddate",
      "rowguid" = EXCLUDED."rowguid",
      "modifieddate" = EXCLUDED."modifieddate"
      ;
      drop table product_TEMP;""".trimMargin())).update().runUnchecked(c)
  }
}