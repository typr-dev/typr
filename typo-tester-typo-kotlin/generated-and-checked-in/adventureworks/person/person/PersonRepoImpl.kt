/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package adventureworks.person.person

import adventureworks.customtypes.TypoLocalDateTime
import adventureworks.customtypes.TypoUUID
import adventureworks.customtypes.TypoXml
import adventureworks.person.businessentity.BusinessentityId
import adventureworks.public.Name
import adventureworks.public.NameStyle
import adventureworks.userdefined.FirstName
import java.sql.Connection
import java.util.ArrayList
import java.util.Optional
import kotlin.collections.List
import kotlin.collections.Map
import kotlin.collections.MutableIterator
import kotlin.collections.MutableMap
import typo.dsl.DeleteBuilder
import typo.dsl.Dialect
import typo.dsl.SelectBuilder
import typo.dsl.UpdateBuilder
import typo.runtime.Fragment
import typo.runtime.Fragment.Literal
import typo.runtime.PgTypes
import typo.runtime.streamingInsert
import typo.runtime.Fragment.interpolate
import typo.runtime.internal.stringInterpolator.str

class PersonRepoImpl() : PersonRepo {
  override fun delete(): DeleteBuilder<PersonFields, PersonRow> = DeleteBuilder.of("\"person\".\"person\"", PersonFields.structure, Dialect.POSTGRESQL)

  override fun deleteById(
    businessentityid: BusinessentityId,
    c: Connection
  ): Boolean = interpolate(
    typo.runtime.Fragment.lit("""
    delete from "person"."person" where "businessentityid" = 
    """.trimMargin()),
    BusinessentityId.pgType.encode(businessentityid),
    typo.runtime.Fragment.lit("")
  ).update().runUnchecked(c) > 0

  override fun deleteByIds(
    businessentityids: Array<BusinessentityId>,
    c: Connection
  ): Int = interpolate(
             typo.runtime.Fragment.lit("""
               delete
               from "person"."person"
               where "businessentityid" = ANY(""".trimMargin()),
             BusinessentityId.pgTypeArray.encode(businessentityids),
             typo.runtime.Fragment.lit(")")
           )
    .update()
    .runUnchecked(c)

  override fun insert(
    unsaved: PersonRow,
    c: Connection
  ): PersonRow = interpolate(
    typo.runtime.Fragment.lit("""
      insert into "person"."person"("businessentityid", "persontype", "namestyle", "title", "firstname", "middlename", "lastname", "suffix", "emailpromotion", "additionalcontactinfo", "demographics", "rowguid", "modifieddate")
      values (""".trimMargin()),
    BusinessentityId.pgType.encode(unsaved.businessentityid),
    typo.runtime.Fragment.lit("::int4, "),
    PgTypes.text.encode(unsaved.persontype),
    typo.runtime.Fragment.lit("::bpchar, "),
    NameStyle.pgType.encode(unsaved.namestyle),
    typo.runtime.Fragment.lit("::bool, "),
    PgTypes.text.opt().encode(unsaved.title),
    typo.runtime.Fragment.lit(", "),
    /* user-picked */ FirstName.pgType.encode(unsaved.firstname),
    typo.runtime.Fragment.lit("::varchar, "),
    Name.pgType.opt().encode(unsaved.middlename),
    typo.runtime.Fragment.lit("::varchar, "),
    Name.pgType.encode(unsaved.lastname),
    typo.runtime.Fragment.lit("::varchar, "),
    PgTypes.text.opt().encode(unsaved.suffix),
    typo.runtime.Fragment.lit(", "),
    PgTypes.int4.encode(unsaved.emailpromotion),
    typo.runtime.Fragment.lit("::int4, "),
    TypoXml.pgType.opt().encode(unsaved.additionalcontactinfo),
    typo.runtime.Fragment.lit("::xml, "),
    TypoXml.pgType.opt().encode(unsaved.demographics),
    typo.runtime.Fragment.lit("::xml, "),
    TypoUUID.pgType.encode(unsaved.rowguid),
    typo.runtime.Fragment.lit("::uuid, "),
    TypoLocalDateTime.pgType.encode(unsaved.modifieddate),
    typo.runtime.Fragment.lit("""
      ::timestamp)
      returning "businessentityid", "persontype", "namestyle", "title", "firstname", "middlename", "lastname", "suffix", "emailpromotion", "additionalcontactinfo", "demographics", "rowguid", "modifieddate"::text
    """.trimMargin())
  )
    .updateReturning(PersonRow._rowParser.exactlyOne()).runUnchecked(c)

  override fun insert(
    unsaved: PersonRowUnsaved,
    c: Connection
  ): PersonRow {
    val columns: ArrayList<Literal> = ArrayList<Literal>()
    val values: ArrayList<Fragment> = ArrayList<Fragment>()
    columns.add(Fragment.lit("\"businessentityid\""))
    values.add(interpolate(
      BusinessentityId.pgType.encode(unsaved.businessentityid),
      typo.runtime.Fragment.lit("::int4")
    ))
    columns.add(Fragment.lit("\"persontype\""))
    values.add(interpolate(
      PgTypes.text.encode(unsaved.persontype),
      typo.runtime.Fragment.lit("::bpchar")
    ))
    columns.add(Fragment.lit("\"title\""))
    values.add(interpolate(
      PgTypes.text.opt().encode(unsaved.title),
      typo.runtime.Fragment.lit("""
      """.trimMargin())
    ))
    columns.add(Fragment.lit("\"firstname\""))
    values.add(interpolate(
      /* user-picked */ FirstName.pgType.encode(unsaved.firstname),
      typo.runtime.Fragment.lit("::varchar")
    ))
    columns.add(Fragment.lit("\"middlename\""))
    values.add(interpolate(
      Name.pgType.opt().encode(unsaved.middlename),
      typo.runtime.Fragment.lit("::varchar")
    ))
    columns.add(Fragment.lit("\"lastname\""))
    values.add(interpolate(
      Name.pgType.encode(unsaved.lastname),
      typo.runtime.Fragment.lit("::varchar")
    ))
    columns.add(Fragment.lit("\"suffix\""))
    values.add(interpolate(
      PgTypes.text.opt().encode(unsaved.suffix),
      typo.runtime.Fragment.lit("""
      """.trimMargin())
    ))
    columns.add(Fragment.lit("\"additionalcontactinfo\""))
    values.add(interpolate(
      TypoXml.pgType.opt().encode(unsaved.additionalcontactinfo),
      typo.runtime.Fragment.lit("::xml")
    ))
    columns.add(Fragment.lit("\"demographics\""))
    values.add(interpolate(
      TypoXml.pgType.opt().encode(unsaved.demographics),
      typo.runtime.Fragment.lit("::xml")
    ))
    unsaved.namestyle.visit(
      {  },
      { value -> columns.add(Fragment.lit("\"namestyle\""))
      values.add(interpolate(
        NameStyle.pgType.encode(value),
        typo.runtime.Fragment.lit("::bool")
      )) }
    );
    unsaved.emailpromotion.visit(
      {  },
      { value -> columns.add(Fragment.lit("\"emailpromotion\""))
      values.add(interpolate(
        PgTypes.int4.encode(value),
        typo.runtime.Fragment.lit("::int4")
      )) }
    );
    unsaved.rowguid.visit(
      {  },
      { value -> columns.add(Fragment.lit("\"rowguid\""))
      values.add(interpolate(
        TypoUUID.pgType.encode(value),
        typo.runtime.Fragment.lit("::uuid")
      )) }
    );
    unsaved.modifieddate.visit(
      {  },
      { value -> columns.add(Fragment.lit("\"modifieddate\""))
      values.add(interpolate(
        TypoLocalDateTime.pgType.encode(value),
        typo.runtime.Fragment.lit("::timestamp")
      )) }
    );
    val q: Fragment = interpolate(
      typo.runtime.Fragment.lit("""
      insert into "person"."person"(
      """.trimMargin()),
      Fragment.comma(columns),
      typo.runtime.Fragment.lit("""
        )
        values (""".trimMargin()),
      Fragment.comma(values),
      typo.runtime.Fragment.lit("""
        )
        returning "businessentityid", "persontype", "namestyle", "title", "firstname", "middlename", "lastname", "suffix", "emailpromotion", "additionalcontactinfo", "demographics", "rowguid", "modifieddate"::text
      """.trimMargin())
    )
    return q.updateReturning(PersonRow._rowParser.exactlyOne()).runUnchecked(c)
  }

  override fun insertStreaming(
    unsaved: MutableIterator<PersonRow>,
    batchSize: Int,
    c: Connection
  ): Long = streamingInsert.insertUnchecked(str("""
  COPY "person"."person"("businessentityid", "persontype", "namestyle", "title", "firstname", "middlename", "lastname", "suffix", "emailpromotion", "additionalcontactinfo", "demographics", "rowguid", "modifieddate") FROM STDIN
  """.trimMargin()), batchSize, unsaved, c, PersonRow.pgText)

  /** NOTE: this functionality requires PostgreSQL 16 or later! */
  override fun insertUnsavedStreaming(
    unsaved: MutableIterator<PersonRowUnsaved>,
    batchSize: Int,
    c: Connection
  ): Long = streamingInsert.insertUnchecked(str("""
  COPY "person"."person"("businessentityid", "persontype", "title", "firstname", "middlename", "lastname", "suffix", "additionalcontactinfo", "demographics", "namestyle", "emailpromotion", "rowguid", "modifieddate") FROM STDIN (DEFAULT '__DEFAULT_VALUE__')
  """.trimMargin()), batchSize, unsaved, c, PersonRowUnsaved.pgText)

  override fun select(): SelectBuilder<PersonFields, PersonRow> = SelectBuilder.of("\"person\".\"person\"", PersonFields.structure, PersonRow._rowParser, Dialect.POSTGRESQL)

  override fun selectAll(c: Connection): List<PersonRow> = interpolate(typo.runtime.Fragment.lit("""
    select "businessentityid", "persontype", "namestyle", "title", "firstname", "middlename", "lastname", "suffix", "emailpromotion", "additionalcontactinfo", "demographics", "rowguid", "modifieddate"::text
    from "person"."person"
  """.trimMargin())).query(PersonRow._rowParser.all()).runUnchecked(c)

  override fun selectById(
    businessentityid: BusinessentityId,
    c: Connection
  ): Optional<PersonRow> = interpolate(
    typo.runtime.Fragment.lit("""
      select "businessentityid", "persontype", "namestyle", "title", "firstname", "middlename", "lastname", "suffix", "emailpromotion", "additionalcontactinfo", "demographics", "rowguid", "modifieddate"::text
      from "person"."person"
      where "businessentityid" = """.trimMargin()),
    BusinessentityId.pgType.encode(businessentityid),
    typo.runtime.Fragment.lit("")
  ).query(PersonRow._rowParser.first()).runUnchecked(c)

  override fun selectByIds(
    businessentityids: Array<BusinessentityId>,
    c: Connection
  ): List<PersonRow> = interpolate(
    typo.runtime.Fragment.lit("""
      select "businessentityid", "persontype", "namestyle", "title", "firstname", "middlename", "lastname", "suffix", "emailpromotion", "additionalcontactinfo", "demographics", "rowguid", "modifieddate"::text
      from "person"."person"
      where "businessentityid" = ANY(""".trimMargin()),
    BusinessentityId.pgTypeArray.encode(businessentityids),
    typo.runtime.Fragment.lit(")")
  ).query(PersonRow._rowParser.all()).runUnchecked(c)

  override fun selectByIdsTracked(
    businessentityids: Array<BusinessentityId>,
    c: Connection
  ): Map<BusinessentityId, PersonRow> {
    val ret: MutableMap<BusinessentityId, PersonRow> = mutableMapOf<BusinessentityId, PersonRow>()
    selectByIds(businessentityids, c).forEach({ row -> ret.put(row.businessentityid, row) })
    return ret
  }

  override fun update(): UpdateBuilder<PersonFields, PersonRow> = UpdateBuilder.of("\"person\".\"person\"", PersonFields.structure, PersonRow._rowParser.all(), Dialect.POSTGRESQL)

  override fun update(
    row: PersonRow,
    c: Connection
  ): Boolean {
    val businessentityid: BusinessentityId = row.businessentityid
    return interpolate(
      typo.runtime.Fragment.lit("""
        update "person"."person"
        set "persontype" = """.trimMargin()),
      PgTypes.text.encode(row.persontype),
      typo.runtime.Fragment.lit("""
        ::bpchar,
        "namestyle" = """.trimMargin()),
      NameStyle.pgType.encode(row.namestyle),
      typo.runtime.Fragment.lit("""
        ::bool,
        "title" = """.trimMargin()),
      PgTypes.text.opt().encode(row.title),
      typo.runtime.Fragment.lit("""
        ,
        "firstname" = """.trimMargin()),
      /* user-picked */ FirstName.pgType.encode(row.firstname),
      typo.runtime.Fragment.lit("""
        ::varchar,
        "middlename" = """.trimMargin()),
      Name.pgType.opt().encode(row.middlename),
      typo.runtime.Fragment.lit("""
        ::varchar,
        "lastname" = """.trimMargin()),
      Name.pgType.encode(row.lastname),
      typo.runtime.Fragment.lit("""
        ::varchar,
        "suffix" = """.trimMargin()),
      PgTypes.text.opt().encode(row.suffix),
      typo.runtime.Fragment.lit("""
        ,
        "emailpromotion" = """.trimMargin()),
      PgTypes.int4.encode(row.emailpromotion),
      typo.runtime.Fragment.lit("""
        ::int4,
        "additionalcontactinfo" = """.trimMargin()),
      TypoXml.pgType.opt().encode(row.additionalcontactinfo),
      typo.runtime.Fragment.lit("""
        ::xml,
        "demographics" = """.trimMargin()),
      TypoXml.pgType.opt().encode(row.demographics),
      typo.runtime.Fragment.lit("""
        ::xml,
        "rowguid" = """.trimMargin()),
      TypoUUID.pgType.encode(row.rowguid),
      typo.runtime.Fragment.lit("""
        ::uuid,
        "modifieddate" = """.trimMargin()),
      TypoLocalDateTime.pgType.encode(row.modifieddate),
      typo.runtime.Fragment.lit("""
        ::timestamp
        where "businessentityid" = """.trimMargin()),
      BusinessentityId.pgType.encode(businessentityid),
      typo.runtime.Fragment.lit("")
    ).update().runUnchecked(c) > 0
  }

  override fun upsert(
    unsaved: PersonRow,
    c: Connection
  ): PersonRow = interpolate(
    typo.runtime.Fragment.lit("""
      insert into "person"."person"("businessentityid", "persontype", "namestyle", "title", "firstname", "middlename", "lastname", "suffix", "emailpromotion", "additionalcontactinfo", "demographics", "rowguid", "modifieddate")
      values (""".trimMargin()),
    BusinessentityId.pgType.encode(unsaved.businessentityid),
    typo.runtime.Fragment.lit("::int4, "),
    PgTypes.text.encode(unsaved.persontype),
    typo.runtime.Fragment.lit("::bpchar, "),
    NameStyle.pgType.encode(unsaved.namestyle),
    typo.runtime.Fragment.lit("::bool, "),
    PgTypes.text.opt().encode(unsaved.title),
    typo.runtime.Fragment.lit(", "),
    /* user-picked */ FirstName.pgType.encode(unsaved.firstname),
    typo.runtime.Fragment.lit("::varchar, "),
    Name.pgType.opt().encode(unsaved.middlename),
    typo.runtime.Fragment.lit("::varchar, "),
    Name.pgType.encode(unsaved.lastname),
    typo.runtime.Fragment.lit("::varchar, "),
    PgTypes.text.opt().encode(unsaved.suffix),
    typo.runtime.Fragment.lit(", "),
    PgTypes.int4.encode(unsaved.emailpromotion),
    typo.runtime.Fragment.lit("::int4, "),
    TypoXml.pgType.opt().encode(unsaved.additionalcontactinfo),
    typo.runtime.Fragment.lit("::xml, "),
    TypoXml.pgType.opt().encode(unsaved.demographics),
    typo.runtime.Fragment.lit("::xml, "),
    TypoUUID.pgType.encode(unsaved.rowguid),
    typo.runtime.Fragment.lit("::uuid, "),
    TypoLocalDateTime.pgType.encode(unsaved.modifieddate),
    typo.runtime.Fragment.lit("""
      ::timestamp)
      on conflict ("businessentityid")
      do update set
        "persontype" = EXCLUDED."persontype",
      "namestyle" = EXCLUDED."namestyle",
      "title" = EXCLUDED."title",
      "firstname" = EXCLUDED."firstname",
      "middlename" = EXCLUDED."middlename",
      "lastname" = EXCLUDED."lastname",
      "suffix" = EXCLUDED."suffix",
      "emailpromotion" = EXCLUDED."emailpromotion",
      "additionalcontactinfo" = EXCLUDED."additionalcontactinfo",
      "demographics" = EXCLUDED."demographics",
      "rowguid" = EXCLUDED."rowguid",
      "modifieddate" = EXCLUDED."modifieddate"
      returning "businessentityid", "persontype", "namestyle", "title", "firstname", "middlename", "lastname", "suffix", "emailpromotion", "additionalcontactinfo", "demographics", "rowguid", "modifieddate"::text""".trimMargin())
  )
    .updateReturning(PersonRow._rowParser.exactlyOne())
    .runUnchecked(c)

  override fun upsertBatch(
    unsaved: MutableIterator<PersonRow>,
    c: Connection
  ): List<PersonRow> = interpolate(typo.runtime.Fragment.lit("""
                         insert into "person"."person"("businessentityid", "persontype", "namestyle", "title", "firstname", "middlename", "lastname", "suffix", "emailpromotion", "additionalcontactinfo", "demographics", "rowguid", "modifieddate")
                         values (?::int4, ?::bpchar, ?::bool, ?, ?::varchar, ?::varchar, ?::varchar, ?, ?::int4, ?::xml, ?::xml, ?::uuid, ?::timestamp)
                         on conflict ("businessentityid")
                         do update set
                           "persontype" = EXCLUDED."persontype",
                         "namestyle" = EXCLUDED."namestyle",
                         "title" = EXCLUDED."title",
                         "firstname" = EXCLUDED."firstname",
                         "middlename" = EXCLUDED."middlename",
                         "lastname" = EXCLUDED."lastname",
                         "suffix" = EXCLUDED."suffix",
                         "emailpromotion" = EXCLUDED."emailpromotion",
                         "additionalcontactinfo" = EXCLUDED."additionalcontactinfo",
                         "demographics" = EXCLUDED."demographics",
                         "rowguid" = EXCLUDED."rowguid",
                         "modifieddate" = EXCLUDED."modifieddate"
                         returning "businessentityid", "persontype", "namestyle", "title", "firstname", "middlename", "lastname", "suffix", "emailpromotion", "additionalcontactinfo", "demographics", "rowguid", "modifieddate"::text""".trimMargin()))
    .updateManyReturning(PersonRow._rowParser, unsaved)
    .runUnchecked(c)

  /** NOTE: this functionality is not safe if you use auto-commit mode! it runs 3 SQL statements */
  override fun upsertStreaming(
    unsaved: MutableIterator<PersonRow>,
    batchSize: Int,
    c: Connection
  ): Int {
    interpolate(typo.runtime.Fragment.lit("""
    create temporary table person_TEMP (like "person"."person") on commit drop
    """.trimMargin())).update().runUnchecked(c)
    streamingInsert.insertUnchecked(str("""
    copy person_TEMP("businessentityid", "persontype", "namestyle", "title", "firstname", "middlename", "lastname", "suffix", "emailpromotion", "additionalcontactinfo", "demographics", "rowguid", "modifieddate") from stdin
    """.trimMargin()), batchSize, unsaved, c, PersonRow.pgText)
    return interpolate(typo.runtime.Fragment.lit("""
      insert into "person"."person"("businessentityid", "persontype", "namestyle", "title", "firstname", "middlename", "lastname", "suffix", "emailpromotion", "additionalcontactinfo", "demographics", "rowguid", "modifieddate")
      select * from person_TEMP
      on conflict ("businessentityid")
      do update set
        "persontype" = EXCLUDED."persontype",
      "namestyle" = EXCLUDED."namestyle",
      "title" = EXCLUDED."title",
      "firstname" = EXCLUDED."firstname",
      "middlename" = EXCLUDED."middlename",
      "lastname" = EXCLUDED."lastname",
      "suffix" = EXCLUDED."suffix",
      "emailpromotion" = EXCLUDED."emailpromotion",
      "additionalcontactinfo" = EXCLUDED."additionalcontactinfo",
      "demographics" = EXCLUDED."demographics",
      "rowguid" = EXCLUDED."rowguid",
      "modifieddate" = EXCLUDED."modifieddate"
      ;
      drop table person_TEMP;""".trimMargin())).update().runUnchecked(c)
  }
}