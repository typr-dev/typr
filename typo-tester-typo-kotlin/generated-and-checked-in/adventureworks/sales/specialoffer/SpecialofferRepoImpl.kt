/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package adventureworks.sales.specialoffer

import adventureworks.customtypes.TypoLocalDateTime
import adventureworks.customtypes.TypoUUID
import java.sql.Connection
import java.util.ArrayList
import java.util.Optional
import kotlin.collections.List
import kotlin.collections.Map
import kotlin.collections.MutableIterator
import kotlin.collections.MutableMap
import typo.dsl.DeleteBuilder
import typo.dsl.Dialect
import typo.dsl.SelectBuilder
import typo.dsl.UpdateBuilder
import typo.runtime.Fragment
import typo.runtime.Fragment.Literal
import typo.runtime.PgTypes
import typo.runtime.streamingInsert
import typo.runtime.Fragment.interpolate
import typo.runtime.internal.stringInterpolator.str

class SpecialofferRepoImpl() : SpecialofferRepo {
  override fun delete(): DeleteBuilder<SpecialofferFields, SpecialofferRow> = DeleteBuilder.of("\"sales\".\"specialoffer\"", SpecialofferFields.structure, Dialect.POSTGRESQL)

  override fun deleteById(
    specialofferid: SpecialofferId,
    c: Connection
  ): Boolean = interpolate(
    typo.runtime.Fragment.lit("""
    delete from "sales"."specialoffer" where "specialofferid" = 
    """.trimMargin()),
    SpecialofferId.pgType.encode(specialofferid),
    typo.runtime.Fragment.lit("")
  ).update().runUnchecked(c) > 0

  override fun deleteByIds(
    specialofferids: Array<SpecialofferId>,
    c: Connection
  ): Int = interpolate(
             typo.runtime.Fragment.lit("""
               delete
               from "sales"."specialoffer"
               where "specialofferid" = ANY(""".trimMargin()),
             SpecialofferId.pgTypeArray.encode(specialofferids),
             typo.runtime.Fragment.lit(")")
           )
    .update()
    .runUnchecked(c)

  override fun insert(
    unsaved: SpecialofferRow,
    c: Connection
  ): SpecialofferRow = interpolate(
    typo.runtime.Fragment.lit("""
      insert into "sales"."specialoffer"("specialofferid", "description", "discountpct", "type", "category", "startdate", "enddate", "minqty", "maxqty", "rowguid", "modifieddate")
      values (""".trimMargin()),
    SpecialofferId.pgType.encode(unsaved.specialofferid),
    typo.runtime.Fragment.lit("::int4, "),
    PgTypes.text.encode(unsaved.description),
    typo.runtime.Fragment.lit(", "),
    PgTypes.numeric.encode(unsaved.discountpct),
    typo.runtime.Fragment.lit("::numeric, "),
    PgTypes.text.encode(unsaved.type),
    typo.runtime.Fragment.lit(", "),
    PgTypes.text.encode(unsaved.category),
    typo.runtime.Fragment.lit(", "),
    TypoLocalDateTime.pgType.encode(unsaved.startdate),
    typo.runtime.Fragment.lit("::timestamp, "),
    TypoLocalDateTime.pgType.encode(unsaved.enddate),
    typo.runtime.Fragment.lit("::timestamp, "),
    PgTypes.int4.encode(unsaved.minqty),
    typo.runtime.Fragment.lit("::int4, "),
    PgTypes.int4.opt().encode(unsaved.maxqty),
    typo.runtime.Fragment.lit("::int4, "),
    TypoUUID.pgType.encode(unsaved.rowguid),
    typo.runtime.Fragment.lit("::uuid, "),
    TypoLocalDateTime.pgType.encode(unsaved.modifieddate),
    typo.runtime.Fragment.lit("""
      ::timestamp)
      returning "specialofferid", "description", "discountpct", "type", "category", "startdate"::text, "enddate"::text, "minqty", "maxqty", "rowguid", "modifieddate"::text
    """.trimMargin())
  )
    .updateReturning(SpecialofferRow._rowParser.exactlyOne()).runUnchecked(c)

  override fun insert(
    unsaved: SpecialofferRowUnsaved,
    c: Connection
  ): SpecialofferRow {
    val columns: ArrayList<Literal> = ArrayList<Literal>()
    val values: ArrayList<Fragment> = ArrayList<Fragment>()
    columns.add(Fragment.lit("\"description\""))
    values.add(interpolate(
      PgTypes.text.encode(unsaved.description),
      typo.runtime.Fragment.lit("""
      """.trimMargin())
    ))
    columns.add(Fragment.lit("\"type\""))
    values.add(interpolate(
      PgTypes.text.encode(unsaved.type),
      typo.runtime.Fragment.lit("""
      """.trimMargin())
    ))
    columns.add(Fragment.lit("\"category\""))
    values.add(interpolate(
      PgTypes.text.encode(unsaved.category),
      typo.runtime.Fragment.lit("""
      """.trimMargin())
    ))
    columns.add(Fragment.lit("\"startdate\""))
    values.add(interpolate(
      TypoLocalDateTime.pgType.encode(unsaved.startdate),
      typo.runtime.Fragment.lit("::timestamp")
    ))
    columns.add(Fragment.lit("\"enddate\""))
    values.add(interpolate(
      TypoLocalDateTime.pgType.encode(unsaved.enddate),
      typo.runtime.Fragment.lit("::timestamp")
    ))
    columns.add(Fragment.lit("\"maxqty\""))
    values.add(interpolate(
      PgTypes.int4.opt().encode(unsaved.maxqty),
      typo.runtime.Fragment.lit("::int4")
    ))
    unsaved.specialofferid.visit(
      {  },
      { value -> columns.add(Fragment.lit("\"specialofferid\""))
      values.add(interpolate(
        SpecialofferId.pgType.encode(value),
        typo.runtime.Fragment.lit("::int4")
      )) }
    );
    unsaved.discountpct.visit(
      {  },
      { value -> columns.add(Fragment.lit("\"discountpct\""))
      values.add(interpolate(
        PgTypes.numeric.encode(value),
        typo.runtime.Fragment.lit("::numeric")
      )) }
    );
    unsaved.minqty.visit(
      {  },
      { value -> columns.add(Fragment.lit("\"minqty\""))
      values.add(interpolate(
        PgTypes.int4.encode(value),
        typo.runtime.Fragment.lit("::int4")
      )) }
    );
    unsaved.rowguid.visit(
      {  },
      { value -> columns.add(Fragment.lit("\"rowguid\""))
      values.add(interpolate(
        TypoUUID.pgType.encode(value),
        typo.runtime.Fragment.lit("::uuid")
      )) }
    );
    unsaved.modifieddate.visit(
      {  },
      { value -> columns.add(Fragment.lit("\"modifieddate\""))
      values.add(interpolate(
        TypoLocalDateTime.pgType.encode(value),
        typo.runtime.Fragment.lit("::timestamp")
      )) }
    );
    val q: Fragment = interpolate(
      typo.runtime.Fragment.lit("""
      insert into "sales"."specialoffer"(
      """.trimMargin()),
      Fragment.comma(columns),
      typo.runtime.Fragment.lit("""
        )
        values (""".trimMargin()),
      Fragment.comma(values),
      typo.runtime.Fragment.lit("""
        )
        returning "specialofferid", "description", "discountpct", "type", "category", "startdate"::text, "enddate"::text, "minqty", "maxqty", "rowguid", "modifieddate"::text
      """.trimMargin())
    )
    return q.updateReturning(SpecialofferRow._rowParser.exactlyOne()).runUnchecked(c)
  }

  override fun insertStreaming(
    unsaved: MutableIterator<SpecialofferRow>,
    batchSize: Int,
    c: Connection
  ): Long = streamingInsert.insertUnchecked(str("""
  COPY "sales"."specialoffer"("specialofferid", "description", "discountpct", "type", "category", "startdate", "enddate", "minqty", "maxqty", "rowguid", "modifieddate") FROM STDIN
  """.trimMargin()), batchSize, unsaved, c, SpecialofferRow.pgText)

  /** NOTE: this functionality requires PostgreSQL 16 or later! */
  override fun insertUnsavedStreaming(
    unsaved: MutableIterator<SpecialofferRowUnsaved>,
    batchSize: Int,
    c: Connection
  ): Long = streamingInsert.insertUnchecked(str("""
  COPY "sales"."specialoffer"("description", "type", "category", "startdate", "enddate", "maxqty", "specialofferid", "discountpct", "minqty", "rowguid", "modifieddate") FROM STDIN (DEFAULT '__DEFAULT_VALUE__')
  """.trimMargin()), batchSize, unsaved, c, SpecialofferRowUnsaved.pgText)

  override fun select(): SelectBuilder<SpecialofferFields, SpecialofferRow> = SelectBuilder.of("\"sales\".\"specialoffer\"", SpecialofferFields.structure, SpecialofferRow._rowParser, Dialect.POSTGRESQL)

  override fun selectAll(c: Connection): List<SpecialofferRow> = interpolate(typo.runtime.Fragment.lit("""
    select "specialofferid", "description", "discountpct", "type", "category", "startdate"::text, "enddate"::text, "minqty", "maxqty", "rowguid", "modifieddate"::text
    from "sales"."specialoffer"
  """.trimMargin())).query(SpecialofferRow._rowParser.all()).runUnchecked(c)

  override fun selectById(
    specialofferid: SpecialofferId,
    c: Connection
  ): Optional<SpecialofferRow> = interpolate(
    typo.runtime.Fragment.lit("""
      select "specialofferid", "description", "discountpct", "type", "category", "startdate"::text, "enddate"::text, "minqty", "maxqty", "rowguid", "modifieddate"::text
      from "sales"."specialoffer"
      where "specialofferid" = """.trimMargin()),
    SpecialofferId.pgType.encode(specialofferid),
    typo.runtime.Fragment.lit("")
  ).query(SpecialofferRow._rowParser.first()).runUnchecked(c)

  override fun selectByIds(
    specialofferids: Array<SpecialofferId>,
    c: Connection
  ): List<SpecialofferRow> = interpolate(
    typo.runtime.Fragment.lit("""
      select "specialofferid", "description", "discountpct", "type", "category", "startdate"::text, "enddate"::text, "minqty", "maxqty", "rowguid", "modifieddate"::text
      from "sales"."specialoffer"
      where "specialofferid" = ANY(""".trimMargin()),
    SpecialofferId.pgTypeArray.encode(specialofferids),
    typo.runtime.Fragment.lit(")")
  ).query(SpecialofferRow._rowParser.all()).runUnchecked(c)

  override fun selectByIdsTracked(
    specialofferids: Array<SpecialofferId>,
    c: Connection
  ): Map<SpecialofferId, SpecialofferRow> {
    val ret: MutableMap<SpecialofferId, SpecialofferRow> = mutableMapOf<SpecialofferId, SpecialofferRow>()
    selectByIds(specialofferids, c).forEach({ row -> ret.put(row.specialofferid, row) })
    return ret
  }

  override fun update(): UpdateBuilder<SpecialofferFields, SpecialofferRow> = UpdateBuilder.of("\"sales\".\"specialoffer\"", SpecialofferFields.structure, SpecialofferRow._rowParser.all(), Dialect.POSTGRESQL)

  override fun update(
    row: SpecialofferRow,
    c: Connection
  ): Boolean {
    val specialofferid: SpecialofferId = row.specialofferid
    return interpolate(
      typo.runtime.Fragment.lit("""
        update "sales"."specialoffer"
        set "description" = """.trimMargin()),
      PgTypes.text.encode(row.description),
      typo.runtime.Fragment.lit("""
        ,
        "discountpct" = """.trimMargin()),
      PgTypes.numeric.encode(row.discountpct),
      typo.runtime.Fragment.lit("""
        ::numeric,
        "type" = """.trimMargin()),
      PgTypes.text.encode(row.type),
      typo.runtime.Fragment.lit("""
        ,
        "category" = """.trimMargin()),
      PgTypes.text.encode(row.category),
      typo.runtime.Fragment.lit("""
        ,
        "startdate" = """.trimMargin()),
      TypoLocalDateTime.pgType.encode(row.startdate),
      typo.runtime.Fragment.lit("""
        ::timestamp,
        "enddate" = """.trimMargin()),
      TypoLocalDateTime.pgType.encode(row.enddate),
      typo.runtime.Fragment.lit("""
        ::timestamp,
        "minqty" = """.trimMargin()),
      PgTypes.int4.encode(row.minqty),
      typo.runtime.Fragment.lit("""
        ::int4,
        "maxqty" = """.trimMargin()),
      PgTypes.int4.opt().encode(row.maxqty),
      typo.runtime.Fragment.lit("""
        ::int4,
        "rowguid" = """.trimMargin()),
      TypoUUID.pgType.encode(row.rowguid),
      typo.runtime.Fragment.lit("""
        ::uuid,
        "modifieddate" = """.trimMargin()),
      TypoLocalDateTime.pgType.encode(row.modifieddate),
      typo.runtime.Fragment.lit("""
        ::timestamp
        where "specialofferid" = """.trimMargin()),
      SpecialofferId.pgType.encode(specialofferid),
      typo.runtime.Fragment.lit("")
    ).update().runUnchecked(c) > 0
  }

  override fun upsert(
    unsaved: SpecialofferRow,
    c: Connection
  ): SpecialofferRow = interpolate(
    typo.runtime.Fragment.lit("""
      insert into "sales"."specialoffer"("specialofferid", "description", "discountpct", "type", "category", "startdate", "enddate", "minqty", "maxqty", "rowguid", "modifieddate")
      values (""".trimMargin()),
    SpecialofferId.pgType.encode(unsaved.specialofferid),
    typo.runtime.Fragment.lit("::int4, "),
    PgTypes.text.encode(unsaved.description),
    typo.runtime.Fragment.lit(", "),
    PgTypes.numeric.encode(unsaved.discountpct),
    typo.runtime.Fragment.lit("::numeric, "),
    PgTypes.text.encode(unsaved.type),
    typo.runtime.Fragment.lit(", "),
    PgTypes.text.encode(unsaved.category),
    typo.runtime.Fragment.lit(", "),
    TypoLocalDateTime.pgType.encode(unsaved.startdate),
    typo.runtime.Fragment.lit("::timestamp, "),
    TypoLocalDateTime.pgType.encode(unsaved.enddate),
    typo.runtime.Fragment.lit("::timestamp, "),
    PgTypes.int4.encode(unsaved.minqty),
    typo.runtime.Fragment.lit("::int4, "),
    PgTypes.int4.opt().encode(unsaved.maxqty),
    typo.runtime.Fragment.lit("::int4, "),
    TypoUUID.pgType.encode(unsaved.rowguid),
    typo.runtime.Fragment.lit("::uuid, "),
    TypoLocalDateTime.pgType.encode(unsaved.modifieddate),
    typo.runtime.Fragment.lit("""
      ::timestamp)
      on conflict ("specialofferid")
      do update set
        "description" = EXCLUDED."description",
      "discountpct" = EXCLUDED."discountpct",
      "type" = EXCLUDED."type",
      "category" = EXCLUDED."category",
      "startdate" = EXCLUDED."startdate",
      "enddate" = EXCLUDED."enddate",
      "minqty" = EXCLUDED."minqty",
      "maxqty" = EXCLUDED."maxqty",
      "rowguid" = EXCLUDED."rowguid",
      "modifieddate" = EXCLUDED."modifieddate"
      returning "specialofferid", "description", "discountpct", "type", "category", "startdate"::text, "enddate"::text, "minqty", "maxqty", "rowguid", "modifieddate"::text""".trimMargin())
  )
    .updateReturning(SpecialofferRow._rowParser.exactlyOne())
    .runUnchecked(c)

  override fun upsertBatch(
    unsaved: MutableIterator<SpecialofferRow>,
    c: Connection
  ): List<SpecialofferRow> = interpolate(typo.runtime.Fragment.lit("""
                               insert into "sales"."specialoffer"("specialofferid", "description", "discountpct", "type", "category", "startdate", "enddate", "minqty", "maxqty", "rowguid", "modifieddate")
                               values (?::int4, ?, ?::numeric, ?, ?, ?::timestamp, ?::timestamp, ?::int4, ?::int4, ?::uuid, ?::timestamp)
                               on conflict ("specialofferid")
                               do update set
                                 "description" = EXCLUDED."description",
                               "discountpct" = EXCLUDED."discountpct",
                               "type" = EXCLUDED."type",
                               "category" = EXCLUDED."category",
                               "startdate" = EXCLUDED."startdate",
                               "enddate" = EXCLUDED."enddate",
                               "minqty" = EXCLUDED."minqty",
                               "maxqty" = EXCLUDED."maxqty",
                               "rowguid" = EXCLUDED."rowguid",
                               "modifieddate" = EXCLUDED."modifieddate"
                               returning "specialofferid", "description", "discountpct", "type", "category", "startdate"::text, "enddate"::text, "minqty", "maxqty", "rowguid", "modifieddate"::text""".trimMargin()))
    .updateManyReturning(SpecialofferRow._rowParser, unsaved)
    .runUnchecked(c)

  /** NOTE: this functionality is not safe if you use auto-commit mode! it runs 3 SQL statements */
  override fun upsertStreaming(
    unsaved: MutableIterator<SpecialofferRow>,
    batchSize: Int,
    c: Connection
  ): Int {
    interpolate(typo.runtime.Fragment.lit("""
    create temporary table specialoffer_TEMP (like "sales"."specialoffer") on commit drop
    """.trimMargin())).update().runUnchecked(c)
    streamingInsert.insertUnchecked(str("""
    copy specialoffer_TEMP("specialofferid", "description", "discountpct", "type", "category", "startdate", "enddate", "minqty", "maxqty", "rowguid", "modifieddate") from stdin
    """.trimMargin()), batchSize, unsaved, c, SpecialofferRow.pgText)
    return interpolate(typo.runtime.Fragment.lit("""
      insert into "sales"."specialoffer"("specialofferid", "description", "discountpct", "type", "category", "startdate", "enddate", "minqty", "maxqty", "rowguid", "modifieddate")
      select * from specialoffer_TEMP
      on conflict ("specialofferid")
      do update set
        "description" = EXCLUDED."description",
      "discountpct" = EXCLUDED."discountpct",
      "type" = EXCLUDED."type",
      "category" = EXCLUDED."category",
      "startdate" = EXCLUDED."startdate",
      "enddate" = EXCLUDED."enddate",
      "minqty" = EXCLUDED."minqty",
      "maxqty" = EXCLUDED."maxqty",
      "rowguid" = EXCLUDED."rowguid",
      "modifieddate" = EXCLUDED."modifieddate"
      ;
      drop table specialoffer_TEMP;""".trimMargin())).update().runUnchecked(c)
  }
}