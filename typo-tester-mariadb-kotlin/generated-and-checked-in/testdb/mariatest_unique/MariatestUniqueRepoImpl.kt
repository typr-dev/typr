/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.mariatest_unique

import java.sql.Connection
import java.util.ArrayList
import kotlin.collections.Iterator
import kotlin.collections.List
import kotlin.collections.Map
import kotlin.collections.MutableMap
import typo.kotlindsl.DeleteBuilder
import typo.kotlindsl.Dialect
import typo.kotlindsl.Fragment
import typo.kotlindsl.SelectBuilder
import typo.kotlindsl.UpdateBuilder
import typo.runtime.MariaTypes

class MariatestUniqueRepoImpl() : MariatestUniqueRepo {
  override fun delete(): DeleteBuilder<MariatestUniqueFields, MariatestUniqueRow> = DeleteBuilder.of("`mariatest_unique`", MariatestUniqueFields.structure, Dialect.MARIADB)

  override fun deleteById(
    id: MariatestUniqueId,
    c: Connection
  ): Boolean = Fragment.interpolate(Fragment.lit("delete from `mariatest_unique` where `id` = "), Fragment.encode(MariatestUniqueId.pgType, id), Fragment.lit("")).update().runUnchecked(c) > 0

  override fun deleteByIds(
    ids: Array<MariatestUniqueId>,
    c: Connection
  ): Int {
    val fragments: ArrayList<Fragment> = ArrayList()
    for (id in ids) { fragments.add(Fragment.encode(MariatestUniqueId.pgType, id)) }
    return Fragment.interpolate(Fragment.lit("delete from `mariatest_unique` where `id` in ("), Fragment.comma(fragments.toMutableList()), Fragment.lit(")")).update().runUnchecked(c)
  }

  override fun insert(
    unsaved: MariatestUniqueRow,
    c: Connection
  ): MariatestUniqueRow = Fragment.interpolate(Fragment.lit("insert into `mariatest_unique`(`email`, `code`, `category`)\nvalues ("), Fragment.encode(MariaTypes.varchar, unsaved.email), Fragment.lit(", "), Fragment.encode(MariaTypes.varchar, unsaved.code), Fragment.lit(", "), Fragment.encode(MariaTypes.varchar, unsaved.category), Fragment.lit(")\nreturning `id`, `email`, `code`, `category`\n"))
    .updateReturning(MariatestUniqueRow._rowParser.exactlyOne()).runUnchecked(c)

  override fun insert(
    unsaved: MariatestUniqueRowUnsaved,
    c: Connection
  ): MariatestUniqueRow {
    val columns: ArrayList<Fragment> = ArrayList()
    val values: ArrayList<Fragment> = ArrayList()
    columns.add(Fragment.lit("`email`"))
    values.add(Fragment.interpolate(Fragment.encode(MariaTypes.varchar, unsaved.email), Fragment.lit("")))
    columns.add(Fragment.lit("`code`"))
    values.add(Fragment.interpolate(Fragment.encode(MariaTypes.varchar, unsaved.code), Fragment.lit("")))
    columns.add(Fragment.lit("`category`"))
    values.add(Fragment.interpolate(Fragment.encode(MariaTypes.varchar, unsaved.category), Fragment.lit("")))
    val q: Fragment = Fragment.interpolate(Fragment.lit("insert into `mariatest_unique`("), Fragment.comma(columns.toMutableList()), Fragment.lit(")\nvalues ("), Fragment.comma(values.toMutableList()), Fragment.lit(")\nreturning `id`, `email`, `code`, `category`\n"))
    return q.updateReturning(MariatestUniqueRow._rowParser.exactlyOne()).runUnchecked(c)
  }

  override fun select(): SelectBuilder<MariatestUniqueFields, MariatestUniqueRow> = SelectBuilder.of("`mariatest_unique`", MariatestUniqueFields.structure, MariatestUniqueRow._rowParser, Dialect.MARIADB)

  override fun selectAll(c: Connection): List<MariatestUniqueRow> = Fragment.interpolate(Fragment.lit("select `id`, `email`, `code`, `category`\nfrom `mariatest_unique`\n")).query(MariatestUniqueRow._rowParser.all()).runUnchecked(c)

  override fun selectById(
    id: MariatestUniqueId,
    c: Connection
  ): MariatestUniqueRow? = Fragment.interpolate(Fragment.lit("select `id`, `email`, `code`, `category`\nfrom `mariatest_unique`\nwhere `id` = "), Fragment.encode(MariatestUniqueId.pgType, id), Fragment.lit("")).query(MariatestUniqueRow._rowParser.first()).runUnchecked(c)

  override fun selectByIds(
    ids: Array<MariatestUniqueId>,
    c: Connection
  ): List<MariatestUniqueRow> {
    val fragments: ArrayList<Fragment> = ArrayList()
    for (id in ids) { fragments.add(Fragment.encode(MariatestUniqueId.pgType, id)) }
    return Fragment.interpolate(Fragment.lit("select `id`, `email`, `code`, `category` from `mariatest_unique` where `id` in ("), Fragment.comma(fragments.toMutableList()), Fragment.lit(")")).query(MariatestUniqueRow._rowParser.all()).runUnchecked(c)
  }

  override fun selectByIdsTracked(
    ids: Array<MariatestUniqueId>,
    c: Connection
  ): Map<MariatestUniqueId, MariatestUniqueRow> {
    val ret: MutableMap<MariatestUniqueId, MariatestUniqueRow> = mutableMapOf<MariatestUniqueId, MariatestUniqueRow>()
    selectByIds(ids, c).forEach({ row -> ret.put(row.id, row) })
    return ret.toMap()
  }

  override fun selectByUniqueCodeAndCategory(
    code: String,
    category: String,
    c: Connection
  ): MariatestUniqueRow? = Fragment.interpolate(Fragment.lit("select `id`, `email`, `code`, `category`\nfrom `mariatest_unique`\nwhere `code` = "), Fragment.encode(MariaTypes.varchar, code), Fragment.lit(" AND `category` = "), Fragment.encode(MariaTypes.varchar, category), Fragment.lit("\n")).query(MariatestUniqueRow._rowParser.first()).runUnchecked(c)

  override fun selectByUniqueEmail(
    email: String,
    c: Connection
  ): MariatestUniqueRow? = Fragment.interpolate(Fragment.lit("select `id`, `email`, `code`, `category`\nfrom `mariatest_unique`\nwhere `email` = "), Fragment.encode(MariaTypes.varchar, email), Fragment.lit("\n")).query(MariatestUniqueRow._rowParser.first()).runUnchecked(c)

  override fun update(): UpdateBuilder<MariatestUniqueFields, MariatestUniqueRow> = UpdateBuilder.of("`mariatest_unique`", MariatestUniqueFields.structure, MariatestUniqueRow._rowParser, Dialect.MARIADB)

  override fun update(
    row: MariatestUniqueRow,
    c: Connection
  ): Boolean {
    val id: MariatestUniqueId = row.id
    return Fragment.interpolate(Fragment.lit("update `mariatest_unique`\nset `email` = "), Fragment.encode(MariaTypes.varchar, row.email), Fragment.lit(",\n`code` = "), Fragment.encode(MariaTypes.varchar, row.code), Fragment.lit(",\n`category` = "), Fragment.encode(MariaTypes.varchar, row.category), Fragment.lit("\nwhere `id` = "), Fragment.encode(MariatestUniqueId.pgType, id), Fragment.lit("")).update().runUnchecked(c) > 0
  }

  override fun upsert(
    unsaved: MariatestUniqueRow,
    c: Connection
  ): MariatestUniqueRow = Fragment.interpolate(Fragment.lit("INSERT INTO `mariatest_unique`(`email`, `code`, `category`)\nVALUES ("), Fragment.encode(MariaTypes.varchar, unsaved.email), Fragment.lit(", "), Fragment.encode(MariaTypes.varchar, unsaved.code), Fragment.lit(", "), Fragment.encode(MariaTypes.varchar, unsaved.category), Fragment.lit(")\nON DUPLICATE KEY UPDATE `email` = VALUES(`email`),\n`code` = VALUES(`code`),\n`category` = VALUES(`category`)\nRETURNING `id`, `email`, `code`, `category`"))
    .updateReturning(MariatestUniqueRow._rowParser.exactlyOne())
    .runUnchecked(c)

  override fun upsertBatch(
    unsaved: Iterator<MariatestUniqueRow>,
    c: Connection
  ): List<MariatestUniqueRow> = Fragment.interpolate(Fragment.lit("INSERT INTO `mariatest_unique`(`id`, `email`, `code`, `category`)\nVALUES (?, ?, ?, ?)\nON DUPLICATE KEY UPDATE `email` = VALUES(`email`),\n`code` = VALUES(`code`),\n`category` = VALUES(`category`)\nRETURNING `id`, `email`, `code`, `category`"))
    .updateReturningEach(MariatestUniqueRow._rowParser, unsaved)
  .runUnchecked(c)
}