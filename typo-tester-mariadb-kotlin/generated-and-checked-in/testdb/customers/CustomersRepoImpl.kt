/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.customers

import java.sql.Connection
import java.util.ArrayList
import java.util.Optional
import kotlin.collections.List
import kotlin.collections.Map
import kotlin.collections.MutableIterator
import kotlin.collections.MutableMap
import testdb.customer_status.CustomerStatusId
import typo.dsl.DeleteBuilder
import typo.dsl.Dialect
import typo.dsl.SelectBuilder
import typo.dsl.UpdateBuilder
import typo.runtime.Fragment
import typo.runtime.Fragment.Literal
import typo.runtime.MariaTypes
import typo.runtime.Fragment.interpolate

class CustomersRepoImpl() : CustomersRepo {
  override fun delete(): DeleteBuilder<CustomersFields, CustomersRow> = DeleteBuilder.of("`customers`", CustomersFields.structure, Dialect.MARIADB)

  override fun deleteById(
    customerId: CustomersId,
    c: Connection
  ): Boolean = interpolate(
    typo.runtime.Fragment.lit("delete from `customers` where `customer_id` = "),
    CustomersId.pgType.encode(customerId),
    typo.runtime.Fragment.lit("")
  ).update().runUnchecked(c) > 0

  override fun deleteByIds(
    customerIds: Array<CustomersId>,
    c: Connection
  ): Int {
    val fragments: ArrayList<Fragment> = ArrayList<Fragment>()
    for (id in customerIds) { fragments.add(CustomersId.pgType.encode(id)) }
    return Fragment.interpolate(Fragment.lit("delete from `customers` where `customer_id` in ("), Fragment.comma(fragments), Fragment.lit(")")).update().runUnchecked(c)
  }

  override fun insert(
    unsaved: CustomersRow,
    c: Connection
  ): CustomersRow = interpolate(
    typo.runtime.Fragment.lit("""
      insert into `customers`(`email`, `password_hash`, `first_name`, `last_name`, `phone`, `status`, `tier`, `preferences`, `marketing_flags`, `notes`, `created_at`, `updated_at`, `last_login_at`)
      values (""".trimMargin()),
    MariaTypes.text.encode(unsaved.email),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.blob.encode(unsaved.passwordHash),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.text.encode(unsaved.firstName),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.text.encode(unsaved.lastName),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.text.opt().encode(unsaved.phone),
    typo.runtime.Fragment.lit(", "),
    CustomerStatusId.pgType.encode(unsaved.status),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.text.encode(unsaved.tier),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.text.opt().encode(unsaved.preferences),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.set.opt().encode(unsaved.marketingFlags),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.text.opt().encode(unsaved.notes),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.datetime.encode(unsaved.createdAt),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.datetime.encode(unsaved.updatedAt),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.datetime.opt().encode(unsaved.lastLoginAt),
    typo.runtime.Fragment.lit("""
      )
      returning `customer_id`, `email`, `password_hash`, `first_name`, `last_name`, `phone`, `status`, `tier`, `preferences`, `marketing_flags`, `notes`, `created_at`, `updated_at`, `last_login_at`
    """.trimMargin())
  )
    .updateReturning(CustomersRow._rowParser.exactlyOne()).runUnchecked(c)

  override fun insert(
    unsaved: CustomersRowUnsaved,
    c: Connection
  ): CustomersRow {
    val columns: ArrayList<Literal> = ArrayList<Literal>()
    val values: ArrayList<Fragment> = ArrayList<Fragment>()
    columns.add(Fragment.lit("`email`"))
    values.add(interpolate(
      MariaTypes.text.encode(unsaved.email),
      typo.runtime.Fragment.lit("""
      """.trimMargin())
    ))
    columns.add(Fragment.lit("`password_hash`"))
    values.add(interpolate(
      MariaTypes.blob.encode(unsaved.passwordHash),
      typo.runtime.Fragment.lit("""
      """.trimMargin())
    ))
    columns.add(Fragment.lit("`first_name`"))
    values.add(interpolate(
      MariaTypes.text.encode(unsaved.firstName),
      typo.runtime.Fragment.lit("""
      """.trimMargin())
    ))
    columns.add(Fragment.lit("`last_name`"))
    values.add(interpolate(
      MariaTypes.text.encode(unsaved.lastName),
      typo.runtime.Fragment.lit("""
      """.trimMargin())
    ))
    unsaved.phone.visit(
      {  },
      { value -> columns.add(Fragment.lit("`phone`"))
      values.add(interpolate(
        MariaTypes.text.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """.trimMargin())
      )) }
    );
    unsaved.status.visit(
      {  },
      { value -> columns.add(Fragment.lit("`status`"))
      values.add(interpolate(
        CustomerStatusId.pgType.encode(value),
        typo.runtime.Fragment.lit("""
        """.trimMargin())
      )) }
    );
    unsaved.tier.visit(
      {  },
      { value -> columns.add(Fragment.lit("`tier`"))
      values.add(interpolate(
        MariaTypes.text.encode(value),
        typo.runtime.Fragment.lit("""
        """.trimMargin())
      )) }
    );
    unsaved.preferences.visit(
      {  },
      { value -> columns.add(Fragment.lit("`preferences`"))
      values.add(interpolate(
        MariaTypes.text.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """.trimMargin())
      )) }
    );
    unsaved.marketingFlags.visit(
      {  },
      { value -> columns.add(Fragment.lit("`marketing_flags`"))
      values.add(interpolate(
        MariaTypes.set.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """.trimMargin())
      )) }
    );
    unsaved.notes.visit(
      {  },
      { value -> columns.add(Fragment.lit("`notes`"))
      values.add(interpolate(
        MariaTypes.text.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """.trimMargin())
      )) }
    );
    unsaved.createdAt.visit(
      {  },
      { value -> columns.add(Fragment.lit("`created_at`"))
      values.add(interpolate(
        MariaTypes.datetime.encode(value),
        typo.runtime.Fragment.lit("""
        """.trimMargin())
      )) }
    );
    unsaved.updatedAt.visit(
      {  },
      { value -> columns.add(Fragment.lit("`updated_at`"))
      values.add(interpolate(
        MariaTypes.datetime.encode(value),
        typo.runtime.Fragment.lit("""
        """.trimMargin())
      )) }
    );
    unsaved.lastLoginAt.visit(
      {  },
      { value -> columns.add(Fragment.lit("`last_login_at`"))
      values.add(interpolate(
        MariaTypes.datetime.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """.trimMargin())
      )) }
    );
    val q: Fragment = interpolate(
      typo.runtime.Fragment.lit("insert into `customers`("),
      Fragment.comma(columns),
      typo.runtime.Fragment.lit("""
        )
        values (""".trimMargin()),
      Fragment.comma(values),
      typo.runtime.Fragment.lit("""
        )
        returning `customer_id`, `email`, `password_hash`, `first_name`, `last_name`, `phone`, `status`, `tier`, `preferences`, `marketing_flags`, `notes`, `created_at`, `updated_at`, `last_login_at`
      """.trimMargin())
    )
    return q.updateReturning(CustomersRow._rowParser.exactlyOne()).runUnchecked(c)
  }

  override fun select(): SelectBuilder<CustomersFields, CustomersRow> = SelectBuilder.of("`customers`", CustomersFields.structure, CustomersRow._rowParser, Dialect.MARIADB)

  override fun selectAll(c: Connection): List<CustomersRow> = interpolate(typo.runtime.Fragment.lit("""
    select `customer_id`, `email`, `password_hash`, `first_name`, `last_name`, `phone`, `status`, `tier`, `preferences`, `marketing_flags`, `notes`, `created_at`, `updated_at`, `last_login_at`
    from `customers`
  """.trimMargin())).query(CustomersRow._rowParser.all()).runUnchecked(c)

  override fun selectById(
    customerId: CustomersId,
    c: Connection
  ): Optional<CustomersRow> = interpolate(
    typo.runtime.Fragment.lit("""
      select `customer_id`, `email`, `password_hash`, `first_name`, `last_name`, `phone`, `status`, `tier`, `preferences`, `marketing_flags`, `notes`, `created_at`, `updated_at`, `last_login_at`
      from `customers`
      where `customer_id` = """.trimMargin()),
    CustomersId.pgType.encode(customerId),
    typo.runtime.Fragment.lit("")
  ).query(CustomersRow._rowParser.first()).runUnchecked(c)

  override fun selectByIds(
    customerIds: Array<CustomersId>,
    c: Connection
  ): List<CustomersRow> {
    val fragments: ArrayList<Fragment> = ArrayList<Fragment>()
    for (id in customerIds) { fragments.add(CustomersId.pgType.encode(id)) }
    return Fragment.interpolate(Fragment.lit("select `customer_id`, `email`, `password_hash`, `first_name`, `last_name`, `phone`, `status`, `tier`, `preferences`, `marketing_flags`, `notes`, `created_at`, `updated_at`, `last_login_at` from `customers` where `customer_id` in ("), Fragment.comma(fragments), Fragment.lit(")")).query(CustomersRow._rowParser.all()).runUnchecked(c)
  }

  override fun selectByIdsTracked(
    customerIds: Array<CustomersId>,
    c: Connection
  ): Map<CustomersId, CustomersRow> {
    val ret: MutableMap<CustomersId, CustomersRow> = mutableMapOf<CustomersId, CustomersRow>()
    selectByIds(customerIds, c).forEach({ row -> ret.put(row.customerId, row) })
    return ret
  }

  override fun selectByUniqueEmail(
    email: String,
    c: Connection
  ): Optional<CustomersRow> = interpolate(
    typo.runtime.Fragment.lit("""
      select `customer_id`, `email`, `password_hash`, `first_name`, `last_name`, `phone`, `status`, `tier`, `preferences`, `marketing_flags`, `notes`, `created_at`, `updated_at`, `last_login_at`
      from `customers`
      where `email` = """.trimMargin()),
    MariaTypes.text.encode(email),
    typo.runtime.Fragment.lit("""


    """.trimMargin())
  ).query(CustomersRow._rowParser.first()).runUnchecked(c)

  override fun update(): UpdateBuilder<CustomersFields, CustomersRow> = UpdateBuilder.of("`customers`", CustomersFields.structure, CustomersRow._rowParser.all(), Dialect.MARIADB)

  override fun update(
    row: CustomersRow,
    c: Connection
  ): Boolean {
    val customerId: CustomersId = row.customerId
    return interpolate(
      typo.runtime.Fragment.lit("""
        update `customers`
        set `email` = """.trimMargin()),
      MariaTypes.text.encode(row.email),
      typo.runtime.Fragment.lit("""
        ,
        `password_hash` = """.trimMargin()),
      MariaTypes.blob.encode(row.passwordHash),
      typo.runtime.Fragment.lit("""
        ,
        `first_name` = """.trimMargin()),
      MariaTypes.text.encode(row.firstName),
      typo.runtime.Fragment.lit("""
        ,
        `last_name` = """.trimMargin()),
      MariaTypes.text.encode(row.lastName),
      typo.runtime.Fragment.lit("""
        ,
        `phone` = """.trimMargin()),
      MariaTypes.text.opt().encode(row.phone),
      typo.runtime.Fragment.lit("""
        ,
        `status` = """.trimMargin()),
      CustomerStatusId.pgType.encode(row.status),
      typo.runtime.Fragment.lit("""
        ,
        `tier` = """.trimMargin()),
      MariaTypes.text.encode(row.tier),
      typo.runtime.Fragment.lit("""
        ,
        `preferences` = """.trimMargin()),
      MariaTypes.text.opt().encode(row.preferences),
      typo.runtime.Fragment.lit("""
        ,
        `marketing_flags` = """.trimMargin()),
      MariaTypes.set.opt().encode(row.marketingFlags),
      typo.runtime.Fragment.lit("""
        ,
        `notes` = """.trimMargin()),
      MariaTypes.text.opt().encode(row.notes),
      typo.runtime.Fragment.lit("""
        ,
        `created_at` = """.trimMargin()),
      MariaTypes.datetime.encode(row.createdAt),
      typo.runtime.Fragment.lit("""
        ,
        `updated_at` = """.trimMargin()),
      MariaTypes.datetime.encode(row.updatedAt),
      typo.runtime.Fragment.lit("""
        ,
        `last_login_at` = """.trimMargin()),
      MariaTypes.datetime.opt().encode(row.lastLoginAt),
      typo.runtime.Fragment.lit("""
  
        where `customer_id` = """.trimMargin()),
      CustomersId.pgType.encode(customerId),
      typo.runtime.Fragment.lit("")
    ).update().runUnchecked(c) > 0
  }

  override fun upsert(
    unsaved: CustomersRow,
    c: Connection
  ): CustomersRow = interpolate(
    typo.runtime.Fragment.lit("""
      INSERT INTO `customers`(`email`, `password_hash`, `first_name`, `last_name`, `phone`, `status`, `tier`, `preferences`, `marketing_flags`, `notes`, `created_at`, `updated_at`, `last_login_at`)
      VALUES (""".trimMargin()),
    MariaTypes.text.encode(unsaved.email),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.blob.encode(unsaved.passwordHash),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.text.encode(unsaved.firstName),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.text.encode(unsaved.lastName),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.text.opt().encode(unsaved.phone),
    typo.runtime.Fragment.lit(", "),
    CustomerStatusId.pgType.encode(unsaved.status),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.text.encode(unsaved.tier),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.text.opt().encode(unsaved.preferences),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.set.opt().encode(unsaved.marketingFlags),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.text.opt().encode(unsaved.notes),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.datetime.encode(unsaved.createdAt),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.datetime.encode(unsaved.updatedAt),
    typo.runtime.Fragment.lit(", "),
    MariaTypes.datetime.opt().encode(unsaved.lastLoginAt),
    typo.runtime.Fragment.lit("""
      )
      ON DUPLICATE KEY UPDATE `email` = VALUES(`email`),
      `password_hash` = VALUES(`password_hash`),
      `first_name` = VALUES(`first_name`),
      `last_name` = VALUES(`last_name`),
      `phone` = VALUES(`phone`),
      `status` = VALUES(`status`),
      `tier` = VALUES(`tier`),
      `preferences` = VALUES(`preferences`),
      `marketing_flags` = VALUES(`marketing_flags`),
      `notes` = VALUES(`notes`),
      `created_at` = VALUES(`created_at`),
      `updated_at` = VALUES(`updated_at`),
      `last_login_at` = VALUES(`last_login_at`)
      RETURNING `customer_id`, `email`, `password_hash`, `first_name`, `last_name`, `phone`, `status`, `tier`, `preferences`, `marketing_flags`, `notes`, `created_at`, `updated_at`, `last_login_at`""".trimMargin())
  )
    .updateReturning(CustomersRow._rowParser.exactlyOne())
    .runUnchecked(c)

  override fun upsertBatch(
    unsaved: MutableIterator<CustomersRow>,
    c: Connection
  ): List<CustomersRow> = interpolate(typo.runtime.Fragment.lit("""
                            INSERT INTO `customers`(`customer_id`, `email`, `password_hash`, `first_name`, `last_name`, `phone`, `status`, `tier`, `preferences`, `marketing_flags`, `notes`, `created_at`, `updated_at`, `last_login_at`)
                            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                            ON DUPLICATE KEY UPDATE `email` = VALUES(`email`),
                            `password_hash` = VALUES(`password_hash`),
                            `first_name` = VALUES(`first_name`),
                            `last_name` = VALUES(`last_name`),
                            `phone` = VALUES(`phone`),
                            `status` = VALUES(`status`),
                            `tier` = VALUES(`tier`),
                            `preferences` = VALUES(`preferences`),
                            `marketing_flags` = VALUES(`marketing_flags`),
                            `notes` = VALUES(`notes`),
                            `created_at` = VALUES(`created_at`),
                            `updated_at` = VALUES(`updated_at`),
                            `last_login_at` = VALUES(`last_login_at`)
                            RETURNING `customer_id`, `email`, `password_hash`, `first_name`, `last_name`, `phone`, `status`, `tier`, `preferences`, `marketing_flags`, `notes`, `created_at`, `updated_at`, `last_login_at`""".trimMargin()))
    .updateReturningEach(CustomersRow._rowParser, unsaved)
    .runUnchecked(c)
}