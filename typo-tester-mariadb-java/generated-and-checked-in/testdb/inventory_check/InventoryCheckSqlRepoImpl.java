/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.inventory_check;

import java.math.BigInteger;
import java.sql.Connection;
import java.util.List;
import java.util.Optional;
import typo.runtime.MariaTypes;
import static typo.runtime.Fragment.interpolate;

public class InventoryCheckSqlRepoImpl implements InventoryCheckSqlRepo {
  @Override
  public List<InventoryCheckSqlRow> apply(
    Optional<Short> warehouseId,
    Optional<BigInteger> productId,
    Optional</* user-picked */ Boolean> lowStockOnly,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
         -- Check inventory levels across warehouses
         SELECT i.inventory_id,
                p.product_id,
                p.sku,
                p.name AS product_name,
                w.warehouse_id,
                w.code AS warehouse_code,
                w.name AS warehouse_name,
                i.quantity_on_hand,
                i.quantity_reserved,
                (i.quantity_on_hand - i.quantity_reserved) AS available,
                i.reorder_point,
                i.bin_location
         FROM inventory i
         JOIN products p ON i.product_id = p.product_id
         JOIN warehouses w ON i.warehouse_id = w.warehouse_id
         WHERE ("""),
      MariaTypes.smallint.opt().encode(warehouseId),
      typo.runtime.Fragment.lit(" IS NULL OR i.warehouse_id = "),
      MariaTypes.smallint.opt().encode(warehouseId),
      typo.runtime.Fragment.lit("""
         )
           AND ("""),
      MariaTypes.bigintUnsigned.opt().encode(productId),
      typo.runtime.Fragment.lit(" IS NULL OR i.product_id = "),
      MariaTypes.bigintUnsigned.opt().encode(productId),
      typo.runtime.Fragment.lit("""
         )
           AND ("""),
      MariaTypes.bool.opt().encode(lowStockOnly),
      typo.runtime.Fragment.lit("""
       IS NULL OR (i.quantity_on_hand - i.quantity_reserved) <= i.reorder_point)

      """)
    ).query(InventoryCheckSqlRow._rowParser.all()).runUnchecked(c);
  };
}