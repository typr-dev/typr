/**
 * File has been automatically generated by `typo`.
 *
 * <p>IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.product_images;

import static typo.runtime.Fragment.interpolate;

import java.sql.Connection;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import testdb.products.ProductsId;
import typo.dsl.DeleteBuilder;
import typo.dsl.Dialect;
import typo.dsl.SelectBuilder;
import typo.dsl.UpdateBuilder;
import typo.runtime.Fragment;
import typo.runtime.MariaTypes;

public class ProductImagesRepoImpl implements ProductImagesRepo {
  @Override
  public DeleteBuilder<ProductImagesFields, ProductImagesRow> delete() {
    return DeleteBuilder.of("`product_images`", ProductImagesFields.structure(), Dialect.MARIADB);
  }
  ;

  @Override
  public Boolean deleteById(ProductImagesId imageId, Connection c) {
    return interpolate(
                Fragment.lit("delete from `product_images` where `image_id` = "),
                Fragment.encode(ProductImagesId.pgType, imageId),
                Fragment.lit(""))
            .update()
            .runUnchecked(c)
        > 0;
  }
  ;

  @Override
  public Integer deleteByIds(ProductImagesId[] imageIds, Connection c) {
    ArrayList<Fragment> fragments = new ArrayList<>();
    for (var id : imageIds) {
      fragments.add(Fragment.encode(ProductImagesId.pgType, id));
    }
    ;
    return Fragment.interpolate(
            Fragment.lit("delete from `product_images` where `image_id` in ("),
            Fragment.comma(fragments),
            Fragment.lit(")"))
        .update()
        .runUnchecked(c);
  }
  ;

  @Override
  public ProductImagesRow insert(ProductImagesRow unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "insert into `product_images`(`product_id`, `image_url`, `thumbnail_url`,"
                    + " `alt_text`, `sort_order`, `is_primary`, `image_data`)\n"
                    + "values ("),
            Fragment.encode(ProductsId.pgType, unsaved.productId()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar, unsaved.imageUrl()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar.opt(), unsaved.thumbnailUrl()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar.opt(), unsaved.altText()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.tinyintUnsigned, unsaved.sortOrder()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.bool, unsaved.isPrimary()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.longblob.opt(), unsaved.imageData()),
            Fragment.lit(
                ")\n"
                    + "RETURNING `image_id`, `product_id`, `image_url`, `thumbnail_url`,"
                    + " `alt_text`, `sort_order`, `is_primary`, `image_data`\n"))
        .updateReturning(ProductImagesRow._rowParser.exactlyOne())
        .runUnchecked(c);
  }
  ;

  @Override
  public ProductImagesRow insert(ProductImagesRowUnsaved unsaved, Connection c) {
    ArrayList<Fragment> columns = new ArrayList<>();
    ;
    ArrayList<Fragment> values = new ArrayList<>();
    ;
    columns.add(Fragment.lit("`product_id`"));
    values.add(
        interpolate(Fragment.encode(ProductsId.pgType, unsaved.productId()), Fragment.lit("")));
    columns.add(Fragment.lit("`image_url`"));
    values.add(
        interpolate(Fragment.encode(MariaTypes.varchar, unsaved.imageUrl()), Fragment.lit("")));
    unsaved
        .thumbnailUrl()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`thumbnail_url`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.varchar.opt(), value), Fragment.lit("")));
            });
    ;
    unsaved
        .altText()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`alt_text`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.varchar.opt(), value), Fragment.lit("")));
            });
    ;
    unsaved
        .sortOrder()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`sort_order`"));
              values.add(
                  interpolate(
                      Fragment.encode(MariaTypes.tinyintUnsigned, value), Fragment.lit("")));
            });
    ;
    unsaved
        .isPrimary()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`is_primary`"));
              values.add(interpolate(Fragment.encode(MariaTypes.bool, value), Fragment.lit("")));
            });
    ;
    unsaved
        .imageData()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`image_data`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.longblob.opt(), value), Fragment.lit("")));
            });
    ;
    Fragment q =
        interpolate(
            Fragment.lit("insert into `product_images`("),
            Fragment.comma(columns),
            Fragment.lit(")\nvalues ("),
            Fragment.comma(values),
            Fragment.lit(
                ")\n"
                    + "RETURNING `image_id`, `product_id`, `image_url`, `thumbnail_url`,"
                    + " `alt_text`, `sort_order`, `is_primary`, `image_data`\n"));
    ;
    return q.updateReturning(ProductImagesRow._rowParser.exactlyOne()).runUnchecked(c);
  }
  ;

  @Override
  public SelectBuilder<ProductImagesFields, ProductImagesRow> select() {
    return SelectBuilder.of(
        "`product_images`",
        ProductImagesFields.structure(),
        ProductImagesRow._rowParser,
        Dialect.MARIADB);
  }
  ;

  @Override
  public List<ProductImagesRow> selectAll(Connection c) {
    return interpolate(
            Fragment.lit(
                "select `image_id`, `product_id`, `image_url`, `thumbnail_url`, `alt_text`,"
                    + " `sort_order`, `is_primary`, `image_data`\n"
                    + "from `product_images`\n"))
        .query(ProductImagesRow._rowParser.all())
        .runUnchecked(c);
  }
  ;

  @Override
  public Optional<ProductImagesRow> selectById(ProductImagesId imageId, Connection c) {
    return interpolate(
            Fragment.lit(
                "select `image_id`, `product_id`, `image_url`, `thumbnail_url`, `alt_text`,"
                    + " `sort_order`, `is_primary`, `image_data`\n"
                    + "from `product_images`\n"
                    + "where `image_id` = "),
            Fragment.encode(ProductImagesId.pgType, imageId),
            Fragment.lit(""))
        .query(ProductImagesRow._rowParser.first())
        .runUnchecked(c);
  }
  ;

  @Override
  public List<ProductImagesRow> selectByIds(ProductImagesId[] imageIds, Connection c) {
    ArrayList<Fragment> fragments = new ArrayList<>();
    for (var id : imageIds) {
      fragments.add(Fragment.encode(ProductImagesId.pgType, id));
    }
    ;
    return Fragment.interpolate(
            Fragment.lit(
                "select `image_id`, `product_id`, `image_url`, `thumbnail_url`, `alt_text`,"
                    + " `sort_order`, `is_primary`, `image_data` from `product_images` where"
                    + " `image_id` in ("),
            Fragment.comma(fragments),
            Fragment.lit(")"))
        .query(ProductImagesRow._rowParser.all())
        .runUnchecked(c);
  }
  ;

  @Override
  public Map<ProductImagesId, ProductImagesRow> selectByIdsTracked(
      ProductImagesId[] imageIds, Connection c) {
    HashMap<ProductImagesId, ProductImagesRow> ret =
        new HashMap<ProductImagesId, ProductImagesRow>();
    selectByIds(imageIds, c).forEach(row -> ret.put(row.imageId(), row));
    return ret;
  }
  ;

  @Override
  public UpdateBuilder<ProductImagesFields, ProductImagesRow> update() {
    return UpdateBuilder.of(
        "`product_images`",
        ProductImagesFields.structure(),
        ProductImagesRow._rowParser,
        Dialect.MARIADB);
  }
  ;

  @Override
  public Boolean update(ProductImagesRow row, Connection c) {
    ProductImagesId imageId = row.imageId();
    ;
    return interpolate(
                Fragment.lit("update `product_images`\nset `product_id` = "),
                Fragment.encode(ProductsId.pgType, row.productId()),
                Fragment.lit(",\n`image_url` = "),
                Fragment.encode(MariaTypes.varchar, row.imageUrl()),
                Fragment.lit(",\n`thumbnail_url` = "),
                Fragment.encode(MariaTypes.varchar.opt(), row.thumbnailUrl()),
                Fragment.lit(",\n`alt_text` = "),
                Fragment.encode(MariaTypes.varchar.opt(), row.altText()),
                Fragment.lit(",\n`sort_order` = "),
                Fragment.encode(MariaTypes.tinyintUnsigned, row.sortOrder()),
                Fragment.lit(",\n`is_primary` = "),
                Fragment.encode(MariaTypes.bool, row.isPrimary()),
                Fragment.lit(",\n`image_data` = "),
                Fragment.encode(MariaTypes.longblob.opt(), row.imageData()),
                Fragment.lit("\nwhere `image_id` = "),
                Fragment.encode(ProductImagesId.pgType, imageId),
                Fragment.lit(""))
            .update()
            .runUnchecked(c)
        > 0;
  }
  ;

  @Override
  public ProductImagesRow upsert(ProductImagesRow unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "INSERT INTO `product_images`(`product_id`, `image_url`, `thumbnail_url`,"
                    + " `alt_text`, `sort_order`, `is_primary`, `image_data`)\n"
                    + "VALUES ("),
            Fragment.encode(ProductsId.pgType, unsaved.productId()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar, unsaved.imageUrl()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar.opt(), unsaved.thumbnailUrl()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar.opt(), unsaved.altText()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.tinyintUnsigned, unsaved.sortOrder()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.bool, unsaved.isPrimary()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.longblob.opt(), unsaved.imageData()),
            Fragment.lit(
                ")\n"
                    + "ON DUPLICATE KEY UPDATE `product_id` = VALUES(`product_id`),\n"
                    + "`image_url` = VALUES(`image_url`),\n"
                    + "`thumbnail_url` = VALUES(`thumbnail_url`),\n"
                    + "`alt_text` = VALUES(`alt_text`),\n"
                    + "`sort_order` = VALUES(`sort_order`),\n"
                    + "`is_primary` = VALUES(`is_primary`),\n"
                    + "`image_data` = VALUES(`image_data`)\n"
                    + "RETURNING `image_id`, `product_id`, `image_url`, `thumbnail_url`,"
                    + " `alt_text`, `sort_order`, `is_primary`, `image_data`"))
        .updateReturning(ProductImagesRow._rowParser.exactlyOne())
        .runUnchecked(c);
  }
  ;

  @Override
  public List<ProductImagesRow> upsertBatch(Iterator<ProductImagesRow> unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "INSERT INTO `product_images`(`image_id`, `product_id`, `image_url`,"
                    + " `thumbnail_url`, `alt_text`, `sort_order`, `is_primary`, `image_data`)\n"
                    + "VALUES (?, ?, ?, ?, ?, ?, ?, ?)\n"
                    + "ON DUPLICATE KEY UPDATE `product_id` = VALUES(`product_id`),\n"
                    + "`image_url` = VALUES(`image_url`),\n"
                    + "`thumbnail_url` = VALUES(`thumbnail_url`),\n"
                    + "`alt_text` = VALUES(`alt_text`),\n"
                    + "`sort_order` = VALUES(`sort_order`),\n"
                    + "`is_primary` = VALUES(`is_primary`),\n"
                    + "`image_data` = VALUES(`image_data`)\n"
                    + "RETURNING `image_id`, `product_id`, `image_url`, `thumbnail_url`,"
                    + " `alt_text`, `sort_order`, `is_primary`, `image_data`"))
        .updateReturningEach(ProductImagesRow._rowParser, unsaved)
        .runUnchecked(c);
  }
  ;
}
