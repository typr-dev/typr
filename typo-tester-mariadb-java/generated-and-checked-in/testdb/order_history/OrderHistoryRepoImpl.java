/**
 * File has been automatically generated by `typo`.
 *
 * <p>IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.order_history;

import static typo.runtime.Fragment.interpolate;

import java.sql.Connection;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import testdb.orders.OrdersId;
import typo.dsl.DeleteBuilder;
import typo.dsl.Dialect;
import typo.dsl.SelectBuilder;
import typo.dsl.UpdateBuilder;
import typo.runtime.Fragment;
import typo.runtime.MariaTypes;

public class OrderHistoryRepoImpl implements OrderHistoryRepo {
  @Override
  public DeleteBuilder<OrderHistoryFields, OrderHistoryRow> delete() {
    return DeleteBuilder.of("`order_history`", OrderHistoryFields.structure(), Dialect.MARIADB);
  }
  ;

  @Override
  public Boolean deleteById(OrderHistoryId historyId, Connection c) {
    return interpolate(
                Fragment.lit("delete from `order_history` where `history_id` = "),
                Fragment.encode(OrderHistoryId.pgType, historyId),
                Fragment.lit(""))
            .update()
            .runUnchecked(c)
        > 0;
  }
  ;

  @Override
  public Integer deleteByIds(OrderHistoryId[] historyIds, Connection c) {
    ArrayList<Fragment> fragments = new ArrayList<>();
    for (var id : historyIds) {
      fragments.add(Fragment.encode(OrderHistoryId.pgType, id));
    }
    ;
    return Fragment.interpolate(
            Fragment.lit("delete from `order_history` where `history_id` in ("),
            Fragment.comma(fragments),
            Fragment.lit(")"))
        .update()
        .runUnchecked(c);
  }
  ;

  @Override
  public OrderHistoryRow insert(OrderHistoryRow unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "insert into `order_history`(`order_id`, `previous_status`, `new_status`,"
                    + " `changed_by`, `change_reason`, `metadata`, `created_at`)\n"
                    + "values ("),
            Fragment.encode(OrdersId.pgType, unsaved.orderId()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.text.opt(), unsaved.previousStatus()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.text, unsaved.newStatus()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar.opt(), unsaved.changedBy()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar.opt(), unsaved.changeReason()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.longtext.opt(), unsaved.metadata()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.datetime, unsaved.createdAt()),
            Fragment.lit(
                ")\n"
                    + "RETURNING `history_id`, `order_id`, `previous_status`, `new_status`,"
                    + " `changed_by`, `change_reason`, `metadata`, `created_at`\n"))
        .updateReturning(OrderHistoryRow._rowParser.exactlyOne())
        .runUnchecked(c);
  }
  ;

  @Override
  public OrderHistoryRow insert(OrderHistoryRowUnsaved unsaved, Connection c) {
    ArrayList<Fragment> columns = new ArrayList<>();
    ;
    ArrayList<Fragment> values = new ArrayList<>();
    ;
    columns.add(Fragment.lit("`order_id`"));
    values.add(interpolate(Fragment.encode(OrdersId.pgType, unsaved.orderId()), Fragment.lit("")));
    columns.add(Fragment.lit("`new_status`"));
    values.add(
        interpolate(Fragment.encode(MariaTypes.text, unsaved.newStatus()), Fragment.lit("")));
    unsaved
        .previousStatus()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`previous_status`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.text.opt(), value), Fragment.lit("")));
            });
    ;
    unsaved
        .changedBy()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`changed_by`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.varchar.opt(), value), Fragment.lit("")));
            });
    ;
    unsaved
        .changeReason()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`change_reason`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.varchar.opt(), value), Fragment.lit("")));
            });
    ;
    unsaved
        .metadata()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`metadata`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.longtext.opt(), value), Fragment.lit("")));
            });
    ;
    unsaved
        .createdAt()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`created_at`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.datetime, value), Fragment.lit("")));
            });
    ;
    Fragment q =
        interpolate(
            Fragment.lit("insert into `order_history`("),
            Fragment.comma(columns),
            Fragment.lit(")\nvalues ("),
            Fragment.comma(values),
            Fragment.lit(
                ")\n"
                    + "RETURNING `history_id`, `order_id`, `previous_status`, `new_status`,"
                    + " `changed_by`, `change_reason`, `metadata`, `created_at`\n"));
    ;
    return q.updateReturning(OrderHistoryRow._rowParser.exactlyOne()).runUnchecked(c);
  }
  ;

  @Override
  public SelectBuilder<OrderHistoryFields, OrderHistoryRow> select() {
    return SelectBuilder.of(
        "`order_history`",
        OrderHistoryFields.structure(),
        OrderHistoryRow._rowParser,
        Dialect.MARIADB);
  }
  ;

  @Override
  public List<OrderHistoryRow> selectAll(Connection c) {
    return interpolate(
            Fragment.lit(
                "select `history_id`, `order_id`, `previous_status`, `new_status`, `changed_by`,"
                    + " `change_reason`, `metadata`, `created_at`\n"
                    + "from `order_history`\n"))
        .query(OrderHistoryRow._rowParser.all())
        .runUnchecked(c);
  }
  ;

  @Override
  public Optional<OrderHistoryRow> selectById(OrderHistoryId historyId, Connection c) {
    return interpolate(
            Fragment.lit(
                "select `history_id`, `order_id`, `previous_status`, `new_status`, `changed_by`,"
                    + " `change_reason`, `metadata`, `created_at`\n"
                    + "from `order_history`\n"
                    + "where `history_id` = "),
            Fragment.encode(OrderHistoryId.pgType, historyId),
            Fragment.lit(""))
        .query(OrderHistoryRow._rowParser.first())
        .runUnchecked(c);
  }
  ;

  @Override
  public List<OrderHistoryRow> selectByIds(OrderHistoryId[] historyIds, Connection c) {
    ArrayList<Fragment> fragments = new ArrayList<>();
    for (var id : historyIds) {
      fragments.add(Fragment.encode(OrderHistoryId.pgType, id));
    }
    ;
    return Fragment.interpolate(
            Fragment.lit(
                "select `history_id`, `order_id`, `previous_status`, `new_status`, `changed_by`,"
                    + " `change_reason`, `metadata`, `created_at` from `order_history` where"
                    + " `history_id` in ("),
            Fragment.comma(fragments),
            Fragment.lit(")"))
        .query(OrderHistoryRow._rowParser.all())
        .runUnchecked(c);
  }
  ;

  @Override
  public Map<OrderHistoryId, OrderHistoryRow> selectByIdsTracked(
      OrderHistoryId[] historyIds, Connection c) {
    HashMap<OrderHistoryId, OrderHistoryRow> ret = new HashMap<OrderHistoryId, OrderHistoryRow>();
    selectByIds(historyIds, c).forEach(row -> ret.put(row.historyId(), row));
    return ret;
  }
  ;

  @Override
  public UpdateBuilder<OrderHistoryFields, OrderHistoryRow> update() {
    return UpdateBuilder.of(
        "`order_history`",
        OrderHistoryFields.structure(),
        OrderHistoryRow._rowParser,
        Dialect.MARIADB);
  }
  ;

  @Override
  public Boolean update(OrderHistoryRow row, Connection c) {
    OrderHistoryId historyId = row.historyId();
    ;
    return interpolate(
                Fragment.lit("update `order_history`\nset `order_id` = "),
                Fragment.encode(OrdersId.pgType, row.orderId()),
                Fragment.lit(",\n`previous_status` = "),
                Fragment.encode(MariaTypes.text.opt(), row.previousStatus()),
                Fragment.lit(",\n`new_status` = "),
                Fragment.encode(MariaTypes.text, row.newStatus()),
                Fragment.lit(",\n`changed_by` = "),
                Fragment.encode(MariaTypes.varchar.opt(), row.changedBy()),
                Fragment.lit(",\n`change_reason` = "),
                Fragment.encode(MariaTypes.varchar.opt(), row.changeReason()),
                Fragment.lit(",\n`metadata` = "),
                Fragment.encode(MariaTypes.longtext.opt(), row.metadata()),
                Fragment.lit(",\n`created_at` = "),
                Fragment.encode(MariaTypes.datetime, row.createdAt()),
                Fragment.lit("\nwhere `history_id` = "),
                Fragment.encode(OrderHistoryId.pgType, historyId),
                Fragment.lit(""))
            .update()
            .runUnchecked(c)
        > 0;
  }
  ;

  @Override
  public OrderHistoryRow upsert(OrderHistoryRow unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "INSERT INTO `order_history`(`order_id`, `previous_status`, `new_status`,"
                    + " `changed_by`, `change_reason`, `metadata`, `created_at`)\n"
                    + "VALUES ("),
            Fragment.encode(OrdersId.pgType, unsaved.orderId()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.text.opt(), unsaved.previousStatus()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.text, unsaved.newStatus()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar.opt(), unsaved.changedBy()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar.opt(), unsaved.changeReason()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.longtext.opt(), unsaved.metadata()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.datetime, unsaved.createdAt()),
            Fragment.lit(
                ")\n"
                    + "ON DUPLICATE KEY UPDATE `order_id` = VALUES(`order_id`),\n"
                    + "`previous_status` = VALUES(`previous_status`),\n"
                    + "`new_status` = VALUES(`new_status`),\n"
                    + "`changed_by` = VALUES(`changed_by`),\n"
                    + "`change_reason` = VALUES(`change_reason`),\n"
                    + "`metadata` = VALUES(`metadata`),\n"
                    + "`created_at` = VALUES(`created_at`)\n"
                    + "RETURNING `history_id`, `order_id`, `previous_status`, `new_status`,"
                    + " `changed_by`, `change_reason`, `metadata`, `created_at`"))
        .updateReturning(OrderHistoryRow._rowParser.exactlyOne())
        .runUnchecked(c);
  }
  ;

  @Override
  public List<OrderHistoryRow> upsertBatch(Iterator<OrderHistoryRow> unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "INSERT INTO `order_history`(`history_id`, `order_id`, `previous_status`,"
                    + " `new_status`, `changed_by`, `change_reason`, `metadata`, `created_at`)\n"
                    + "VALUES (?, ?, ?, ?, ?, ?, ?, ?)\n"
                    + "ON DUPLICATE KEY UPDATE `order_id` = VALUES(`order_id`),\n"
                    + "`previous_status` = VALUES(`previous_status`),\n"
                    + "`new_status` = VALUES(`new_status`),\n"
                    + "`changed_by` = VALUES(`changed_by`),\n"
                    + "`change_reason` = VALUES(`change_reason`),\n"
                    + "`metadata` = VALUES(`metadata`),\n"
                    + "`created_at` = VALUES(`created_at`)\n"
                    + "RETURNING `history_id`, `order_id`, `previous_status`, `new_status`,"
                    + " `changed_by`, `change_reason`, `metadata`, `created_at`"))
        .updateReturningEach(OrderHistoryRow._rowParser, unsaved)
        .runUnchecked(c);
  }
  ;
}
