/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.order_history;

import java.sql.Connection;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import testdb.orders.OrdersId;
import typo.dsl.DeleteBuilder;
import typo.dsl.Dialect;
import typo.dsl.SelectBuilder;
import typo.dsl.UpdateBuilder;
import typo.runtime.Fragment;
import typo.runtime.Fragment.Literal;
import typo.runtime.MariaTypes;
import static typo.runtime.Fragment.interpolate;

public class OrderHistoryRepoImpl implements OrderHistoryRepo {
  @Override
  public DeleteBuilder<OrderHistoryFields, OrderHistoryRow> delete() {
    return DeleteBuilder.of("`order_history`", OrderHistoryFields.structure(), Dialect.MARIADB);
  };

  @Override
  public Boolean deleteById(
    OrderHistoryId historyId,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("delete from `order_history` where `history_id` = "),
      OrderHistoryId.pgType.encode(historyId),
      typo.runtime.Fragment.lit("")
    ).update().runUnchecked(c) > 0;
  };

  @Override
  public Integer deleteByIds(
    OrderHistoryId[] historyIds,
    Connection c
  ) {
    ArrayList<Fragment> fragments = new ArrayList<Fragment>();
    for (var id : historyIds) { fragments.add(OrderHistoryId.pgType.encode(id)); };
    return Fragment.interpolate(Fragment.lit("delete from `order_history` where `history_id` in ("), Fragment.comma(fragments), Fragment.lit(")")).update().runUnchecked(c);
  };

  @Override
  public OrderHistoryRow insert(
    OrderHistoryRow unsaved,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
         insert into `order_history`(`order_id`, `previous_status`, `new_status`, `changed_by`, `change_reason`, `metadata`, `created_at`)
         values ("""),
      OrdersId.pgType.encode(unsaved.orderId()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.previousStatus()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.encode(unsaved.newStatus()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.changedBy()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.changeReason()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.metadata()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.datetime.encode(unsaved.createdAt()),
      typo.runtime.Fragment.lit("""
         )
         returning `history_id`, `order_id`, `previous_status`, `new_status`, `changed_by`, `change_reason`, `metadata`, `created_at`
      """)
    )
      .updateReturning(OrderHistoryRow._rowParser.exactlyOne()).runUnchecked(c);
  };

  @Override
  public OrderHistoryRow insert(
    OrderHistoryRowUnsaved unsaved,
    Connection c
  ) {
    ArrayList<Literal> columns = new ArrayList<Literal>();;
    ArrayList<Fragment> values = new ArrayList<Fragment>();;
    columns.add(Fragment.lit("`order_id`"));
    values.add(interpolate(
      OrdersId.pgType.encode(unsaved.orderId()),
      typo.runtime.Fragment.lit("""
      """)
    ));
    columns.add(Fragment.lit("`new_status`"));
    values.add(interpolate(
      MariaTypes.text.encode(unsaved.newStatus()),
      typo.runtime.Fragment.lit("""
      """)
    ));
    unsaved.previousStatus().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`previous_status`"));
        values.add(interpolate(
        MariaTypes.text.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.changedBy().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`changed_by`"));
        values.add(interpolate(
        MariaTypes.text.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.changeReason().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`change_reason`"));
        values.add(interpolate(
        MariaTypes.text.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.metadata().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`metadata`"));
        values.add(interpolate(
        MariaTypes.text.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.createdAt().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`created_at`"));
        values.add(interpolate(
        MariaTypes.datetime.encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    Fragment q = interpolate(
      typo.runtime.Fragment.lit("insert into `order_history`("),
      Fragment.comma(columns),
      typo.runtime.Fragment.lit("""
         )
         values ("""),
      Fragment.comma(values),
      typo.runtime.Fragment.lit("""
         )
         returning `history_id`, `order_id`, `previous_status`, `new_status`, `changed_by`, `change_reason`, `metadata`, `created_at`
      """)
    );;
    return q.updateReturning(OrderHistoryRow._rowParser.exactlyOne()).runUnchecked(c);
  };

  @Override
  public SelectBuilder<OrderHistoryFields, OrderHistoryRow> select() {
    return SelectBuilder.of("`order_history`", OrderHistoryFields.structure(), OrderHistoryRow._rowParser, Dialect.MARIADB);
  };

  @Override
  public List<OrderHistoryRow> selectAll(Connection c) {
    return interpolate(typo.runtime.Fragment.lit("""
       select `history_id`, `order_id`, `previous_status`, `new_status`, `changed_by`, `change_reason`, `metadata`, `created_at`
       from `order_history`
    """)).query(OrderHistoryRow._rowParser.all()).runUnchecked(c);
  };

  @Override
  public Optional<OrderHistoryRow> selectById(
    OrderHistoryId historyId,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
         select `history_id`, `order_id`, `previous_status`, `new_status`, `changed_by`, `change_reason`, `metadata`, `created_at`
         from `order_history`
         where `history_id` = """),
      OrderHistoryId.pgType.encode(historyId),
      typo.runtime.Fragment.lit("")
    ).query(OrderHistoryRow._rowParser.first()).runUnchecked(c);
  };

  @Override
  public List<OrderHistoryRow> selectByIds(
    OrderHistoryId[] historyIds,
    Connection c
  ) {
    ArrayList<Fragment> fragments = new ArrayList<Fragment>();
    for (var id : historyIds) { fragments.add(OrderHistoryId.pgType.encode(id)); };
    return Fragment.interpolate(Fragment.lit("select `history_id`, `order_id`, `previous_status`, `new_status`, `changed_by`, `change_reason`, `metadata`, `created_at` from `order_history` where `history_id` in ("), Fragment.comma(fragments), Fragment.lit(")")).query(OrderHistoryRow._rowParser.all()).runUnchecked(c);
  };

  @Override
  public Map<OrderHistoryId, OrderHistoryRow> selectByIdsTracked(
    OrderHistoryId[] historyIds,
    Connection c
  ) {
    HashMap<OrderHistoryId, OrderHistoryRow> ret = new HashMap<OrderHistoryId, OrderHistoryRow>();
    selectByIds(historyIds, c).forEach(row -> ret.put(row.historyId(), row));
    return ret;
  };

  @Override
  public UpdateBuilder<OrderHistoryFields, OrderHistoryRow> update() {
    return UpdateBuilder.of("`order_history`", OrderHistoryFields.structure(), OrderHistoryRow._rowParser.all(), Dialect.MARIADB);
  };

  @Override
  public Boolean update(
    OrderHistoryRow row,
    Connection c
  ) {
    OrderHistoryId historyId = row.historyId();;
    return interpolate(
      typo.runtime.Fragment.lit("""
         update `order_history`
         set `order_id` = """),
      OrdersId.pgType.encode(row.orderId()),
      typo.runtime.Fragment.lit("""
         ,
         `previous_status` = """),
      MariaTypes.text.opt().encode(row.previousStatus()),
      typo.runtime.Fragment.lit("""
         ,
         `new_status` = """),
      MariaTypes.text.encode(row.newStatus()),
      typo.runtime.Fragment.lit("""
         ,
         `changed_by` = """),
      MariaTypes.text.opt().encode(row.changedBy()),
      typo.runtime.Fragment.lit("""
         ,
         `change_reason` = """),
      MariaTypes.text.opt().encode(row.changeReason()),
      typo.runtime.Fragment.lit("""
         ,
         `metadata` = """),
      MariaTypes.text.opt().encode(row.metadata()),
      typo.runtime.Fragment.lit("""
         ,
         `created_at` = """),
      MariaTypes.datetime.encode(row.createdAt()),
      typo.runtime.Fragment.lit("""
   
         where `history_id` = """),
      OrderHistoryId.pgType.encode(historyId),
      typo.runtime.Fragment.lit("")
    ).update().runUnchecked(c) > 0;
  };

  @Override
  public OrderHistoryRow upsert(
    OrderHistoryRow unsaved,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
         INSERT INTO `order_history`(`order_id`, `previous_status`, `new_status`, `changed_by`, `change_reason`, `metadata`, `created_at`)
         VALUES ("""),
      OrdersId.pgType.encode(unsaved.orderId()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.previousStatus()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.encode(unsaved.newStatus()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.changedBy()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.changeReason()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.metadata()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.datetime.encode(unsaved.createdAt()),
      typo.runtime.Fragment.lit("""
         )
         ON DUPLICATE KEY UPDATE `order_id` = VALUES(`order_id`),
         `previous_status` = VALUES(`previous_status`),
         `new_status` = VALUES(`new_status`),
         `changed_by` = VALUES(`changed_by`),
         `change_reason` = VALUES(`change_reason`),
         `metadata` = VALUES(`metadata`),
         `created_at` = VALUES(`created_at`)
         RETURNING `history_id`, `order_id`, `previous_status`, `new_status`, `changed_by`, `change_reason`, `metadata`, `created_at`""")
    )
      .updateReturning(OrderHistoryRow._rowParser.exactlyOne())
      .runUnchecked(c);
  };

  @Override
  public List<OrderHistoryRow> upsertBatch(
    Iterator<OrderHistoryRow> unsaved,
    Connection c
  ) {
    return interpolate(typo.runtime.Fragment.lit("""
                INSERT INTO `order_history`(`history_id`, `order_id`, `previous_status`, `new_status`, `changed_by`, `change_reason`, `metadata`, `created_at`)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
                ON DUPLICATE KEY UPDATE `order_id` = VALUES(`order_id`),
                `previous_status` = VALUES(`previous_status`),
                `new_status` = VALUES(`new_status`),
                `changed_by` = VALUES(`changed_by`),
                `change_reason` = VALUES(`change_reason`),
                `metadata` = VALUES(`metadata`),
                `created_at` = VALUES(`created_at`)
                RETURNING `history_id`, `order_id`, `previous_status`, `new_status`, `changed_by`, `change_reason`, `metadata`, `created_at`"""))
      .updateReturningEach(OrderHistoryRow._rowParser, unsaved)
      .runUnchecked(c);
  };
}