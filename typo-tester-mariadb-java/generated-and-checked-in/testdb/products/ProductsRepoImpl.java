/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.products;

import java.sql.Connection;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import testdb.brands.BrandsId;
import typo.dsl.DeleteBuilder;
import typo.dsl.Dialect;
import typo.dsl.SelectBuilder;
import typo.dsl.UpdateBuilder;
import typo.runtime.Fragment;
import typo.runtime.Fragment.Literal;
import typo.runtime.MariaTypes;
import static typo.runtime.Fragment.interpolate;

public class ProductsRepoImpl implements ProductsRepo {
  @Override
  public DeleteBuilder<ProductsFields, ProductsRow> delete() {
    return DeleteBuilder.of("`products`", ProductsFields.structure(), Dialect.MARIADB);
  };

  @Override
  public Boolean deleteById(
    ProductsId productId,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("delete from `products` where `product_id` = "),
      ProductsId.pgType.encode(productId),
      typo.runtime.Fragment.lit("")
    ).update().runUnchecked(c) > 0;
  };

  @Override
  public Integer deleteByIds(
    ProductsId[] productIds,
    Connection c
  ) {
    ArrayList<Fragment> fragments = new ArrayList<Fragment>();
    for (var id : productIds) { fragments.add(ProductsId.pgType.encode(id)); };
    return Fragment.interpolate(Fragment.lit("delete from `products` where `product_id` in ("), Fragment.comma(fragments), Fragment.lit(")")).update().runUnchecked(c);
  };

  @Override
  public ProductsRow insert(
    ProductsRow unsaved,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
         insert into `products`(`sku`, `brand_id`, `name`, `short_description`, `full_description`, `base_price`, `cost_price`, `weight_kg`, `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`, `seo_metadata`, `created_at`, `updated_at`, `published_at`)
         values ("""),
      MariaTypes.text.encode(unsaved.sku()),
      typo.runtime.Fragment.lit(", "),
      BrandsId.pgType.opt().encode(unsaved.brandId()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.encode(unsaved.name()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.shortDescription()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.fullDescription()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.numeric.encode(unsaved.basePrice()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.numeric.opt().encode(unsaved.costPrice()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.numeric.opt().encode(unsaved.weightKg()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.dimensionsJson()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.encode(unsaved.status()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.encode(unsaved.taxClass()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.set.opt().encode(unsaved.tags()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.attributes()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.seoMetadata()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.datetime.encode(unsaved.createdAt()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.datetime.encode(unsaved.updatedAt()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.datetime.opt().encode(unsaved.publishedAt()),
      typo.runtime.Fragment.lit("""
         )
         returning `product_id`, `sku`, `brand_id`, `name`, `short_description`, `full_description`, `base_price`, `cost_price`, `weight_kg`, `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`, `seo_metadata`, `created_at`, `updated_at`, `published_at`
      """)
    )
      .updateReturning(ProductsRow._rowParser.exactlyOne()).runUnchecked(c);
  };

  @Override
  public ProductsRow insert(
    ProductsRowUnsaved unsaved,
    Connection c
  ) {
    ArrayList<Literal> columns = new ArrayList<Literal>();;
    ArrayList<Fragment> values = new ArrayList<Fragment>();;
    columns.add(Fragment.lit("`sku`"));
    values.add(interpolate(
      MariaTypes.text.encode(unsaved.sku()),
      typo.runtime.Fragment.lit("""
      """)
    ));
    columns.add(Fragment.lit("`name`"));
    values.add(interpolate(
      MariaTypes.text.encode(unsaved.name()),
      typo.runtime.Fragment.lit("""
      """)
    ));
    columns.add(Fragment.lit("`base_price`"));
    values.add(interpolate(
      MariaTypes.numeric.encode(unsaved.basePrice()),
      typo.runtime.Fragment.lit("""
      """)
    ));
    unsaved.brandId().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`brand_id`"));
        values.add(interpolate(
        BrandsId.pgType.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.shortDescription().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`short_description`"));
        values.add(interpolate(
        MariaTypes.text.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.fullDescription().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`full_description`"));
        values.add(interpolate(
        MariaTypes.text.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.costPrice().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`cost_price`"));
        values.add(interpolate(
        MariaTypes.numeric.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.weightKg().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`weight_kg`"));
        values.add(interpolate(
        MariaTypes.numeric.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.dimensionsJson().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`dimensions_json`"));
        values.add(interpolate(
        MariaTypes.text.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.status().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`status`"));
        values.add(interpolate(
        MariaTypes.text.encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.taxClass().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`tax_class`"));
        values.add(interpolate(
        MariaTypes.text.encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.tags().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`tags`"));
        values.add(interpolate(
        MariaTypes.set.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.attributes().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`attributes`"));
        values.add(interpolate(
        MariaTypes.text.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.seoMetadata().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`seo_metadata`"));
        values.add(interpolate(
        MariaTypes.text.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.createdAt().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`created_at`"));
        values.add(interpolate(
        MariaTypes.datetime.encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.updatedAt().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`updated_at`"));
        values.add(interpolate(
        MariaTypes.datetime.encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.publishedAt().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`published_at`"));
        values.add(interpolate(
        MariaTypes.datetime.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    Fragment q = interpolate(
      typo.runtime.Fragment.lit("insert into `products`("),
      Fragment.comma(columns),
      typo.runtime.Fragment.lit("""
         )
         values ("""),
      Fragment.comma(values),
      typo.runtime.Fragment.lit("""
         )
         returning `product_id`, `sku`, `brand_id`, `name`, `short_description`, `full_description`, `base_price`, `cost_price`, `weight_kg`, `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`, `seo_metadata`, `created_at`, `updated_at`, `published_at`
      """)
    );;
    return q.updateReturning(ProductsRow._rowParser.exactlyOne()).runUnchecked(c);
  };

  @Override
  public SelectBuilder<ProductsFields, ProductsRow> select() {
    return SelectBuilder.of("`products`", ProductsFields.structure(), ProductsRow._rowParser, Dialect.MARIADB);
  };

  @Override
  public List<ProductsRow> selectAll(Connection c) {
    return interpolate(typo.runtime.Fragment.lit("""
       select `product_id`, `sku`, `brand_id`, `name`, `short_description`, `full_description`, `base_price`, `cost_price`, `weight_kg`, `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`, `seo_metadata`, `created_at`, `updated_at`, `published_at`
       from `products`
    """)).query(ProductsRow._rowParser.all()).runUnchecked(c);
  };

  @Override
  public Optional<ProductsRow> selectById(
    ProductsId productId,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
         select `product_id`, `sku`, `brand_id`, `name`, `short_description`, `full_description`, `base_price`, `cost_price`, `weight_kg`, `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`, `seo_metadata`, `created_at`, `updated_at`, `published_at`
         from `products`
         where `product_id` = """),
      ProductsId.pgType.encode(productId),
      typo.runtime.Fragment.lit("")
    ).query(ProductsRow._rowParser.first()).runUnchecked(c);
  };

  @Override
  public List<ProductsRow> selectByIds(
    ProductsId[] productIds,
    Connection c
  ) {
    ArrayList<Fragment> fragments = new ArrayList<Fragment>();
    for (var id : productIds) { fragments.add(ProductsId.pgType.encode(id)); };
    return Fragment.interpolate(Fragment.lit("select `product_id`, `sku`, `brand_id`, `name`, `short_description`, `full_description`, `base_price`, `cost_price`, `weight_kg`, `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`, `seo_metadata`, `created_at`, `updated_at`, `published_at` from `products` where `product_id` in ("), Fragment.comma(fragments), Fragment.lit(")")).query(ProductsRow._rowParser.all()).runUnchecked(c);
  };

  @Override
  public Map<ProductsId, ProductsRow> selectByIdsTracked(
    ProductsId[] productIds,
    Connection c
  ) {
    HashMap<ProductsId, ProductsRow> ret = new HashMap<ProductsId, ProductsRow>();
    selectByIds(productIds, c).forEach(row -> ret.put(row.productId(), row));
    return ret;
  };

  @Override
  public Optional<ProductsRow> selectByUniqueSku(
    String sku,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
         select `product_id`, `sku`, `brand_id`, `name`, `short_description`, `full_description`, `base_price`, `cost_price`, `weight_kg`, `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`, `seo_metadata`, `created_at`, `updated_at`, `published_at`
         from `products`
         where `sku` = """),
      MariaTypes.text.encode(sku),
      typo.runtime.Fragment.lit("""


      """)
    ).query(ProductsRow._rowParser.first()).runUnchecked(c);
  };

  @Override
  public UpdateBuilder<ProductsFields, ProductsRow> update() {
    return UpdateBuilder.of("`products`", ProductsFields.structure(), ProductsRow._rowParser.all(), Dialect.MARIADB);
  };

  @Override
  public Boolean update(
    ProductsRow row,
    Connection c
  ) {
    ProductsId productId = row.productId();;
    return interpolate(
      typo.runtime.Fragment.lit("""
         update `products`
         set `sku` = """),
      MariaTypes.text.encode(row.sku()),
      typo.runtime.Fragment.lit("""
         ,
         `brand_id` = """),
      BrandsId.pgType.opt().encode(row.brandId()),
      typo.runtime.Fragment.lit("""
         ,
         `name` = """),
      MariaTypes.text.encode(row.name()),
      typo.runtime.Fragment.lit("""
         ,
         `short_description` = """),
      MariaTypes.text.opt().encode(row.shortDescription()),
      typo.runtime.Fragment.lit("""
         ,
         `full_description` = """),
      MariaTypes.text.opt().encode(row.fullDescription()),
      typo.runtime.Fragment.lit("""
         ,
         `base_price` = """),
      MariaTypes.numeric.encode(row.basePrice()),
      typo.runtime.Fragment.lit("""
         ,
         `cost_price` = """),
      MariaTypes.numeric.opt().encode(row.costPrice()),
      typo.runtime.Fragment.lit("""
         ,
         `weight_kg` = """),
      MariaTypes.numeric.opt().encode(row.weightKg()),
      typo.runtime.Fragment.lit("""
         ,
         `dimensions_json` = """),
      MariaTypes.text.opt().encode(row.dimensionsJson()),
      typo.runtime.Fragment.lit("""
         ,
         `status` = """),
      MariaTypes.text.encode(row.status()),
      typo.runtime.Fragment.lit("""
         ,
         `tax_class` = """),
      MariaTypes.text.encode(row.taxClass()),
      typo.runtime.Fragment.lit("""
         ,
         `tags` = """),
      MariaTypes.set.opt().encode(row.tags()),
      typo.runtime.Fragment.lit("""
         ,
         `attributes` = """),
      MariaTypes.text.opt().encode(row.attributes()),
      typo.runtime.Fragment.lit("""
         ,
         `seo_metadata` = """),
      MariaTypes.text.opt().encode(row.seoMetadata()),
      typo.runtime.Fragment.lit("""
         ,
         `created_at` = """),
      MariaTypes.datetime.encode(row.createdAt()),
      typo.runtime.Fragment.lit("""
         ,
         `updated_at` = """),
      MariaTypes.datetime.encode(row.updatedAt()),
      typo.runtime.Fragment.lit("""
         ,
         `published_at` = """),
      MariaTypes.datetime.opt().encode(row.publishedAt()),
      typo.runtime.Fragment.lit("""
   
         where `product_id` = """),
      ProductsId.pgType.encode(productId),
      typo.runtime.Fragment.lit("")
    ).update().runUnchecked(c) > 0;
  };

  @Override
  public ProductsRow upsert(
    ProductsRow unsaved,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
         INSERT INTO `products`(`sku`, `brand_id`, `name`, `short_description`, `full_description`, `base_price`, `cost_price`, `weight_kg`, `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`, `seo_metadata`, `created_at`, `updated_at`, `published_at`)
         VALUES ("""),
      MariaTypes.text.encode(unsaved.sku()),
      typo.runtime.Fragment.lit(", "),
      BrandsId.pgType.opt().encode(unsaved.brandId()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.encode(unsaved.name()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.shortDescription()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.fullDescription()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.numeric.encode(unsaved.basePrice()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.numeric.opt().encode(unsaved.costPrice()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.numeric.opt().encode(unsaved.weightKg()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.dimensionsJson()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.encode(unsaved.status()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.encode(unsaved.taxClass()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.set.opt().encode(unsaved.tags()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.attributes()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.seoMetadata()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.datetime.encode(unsaved.createdAt()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.datetime.encode(unsaved.updatedAt()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.datetime.opt().encode(unsaved.publishedAt()),
      typo.runtime.Fragment.lit("""
         )
         ON DUPLICATE KEY UPDATE `sku` = VALUES(`sku`),
         `brand_id` = VALUES(`brand_id`),
         `name` = VALUES(`name`),
         `short_description` = VALUES(`short_description`),
         `full_description` = VALUES(`full_description`),
         `base_price` = VALUES(`base_price`),
         `cost_price` = VALUES(`cost_price`),
         `weight_kg` = VALUES(`weight_kg`),
         `dimensions_json` = VALUES(`dimensions_json`),
         `status` = VALUES(`status`),
         `tax_class` = VALUES(`tax_class`),
         `tags` = VALUES(`tags`),
         `attributes` = VALUES(`attributes`),
         `seo_metadata` = VALUES(`seo_metadata`),
         `created_at` = VALUES(`created_at`),
         `updated_at` = VALUES(`updated_at`),
         `published_at` = VALUES(`published_at`)
         RETURNING `product_id`, `sku`, `brand_id`, `name`, `short_description`, `full_description`, `base_price`, `cost_price`, `weight_kg`, `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`, `seo_metadata`, `created_at`, `updated_at`, `published_at`""")
    )
      .updateReturning(ProductsRow._rowParser.exactlyOne())
      .runUnchecked(c);
  };

  @Override
  public List<ProductsRow> upsertBatch(
    Iterator<ProductsRow> unsaved,
    Connection c
  ) {
    return interpolate(typo.runtime.Fragment.lit("""
                INSERT INTO `products`(`product_id`, `sku`, `brand_id`, `name`, `short_description`, `full_description`, `base_price`, `cost_price`, `weight_kg`, `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`, `seo_metadata`, `created_at`, `updated_at`, `published_at`)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                ON DUPLICATE KEY UPDATE `sku` = VALUES(`sku`),
                `brand_id` = VALUES(`brand_id`),
                `name` = VALUES(`name`),
                `short_description` = VALUES(`short_description`),
                `full_description` = VALUES(`full_description`),
                `base_price` = VALUES(`base_price`),
                `cost_price` = VALUES(`cost_price`),
                `weight_kg` = VALUES(`weight_kg`),
                `dimensions_json` = VALUES(`dimensions_json`),
                `status` = VALUES(`status`),
                `tax_class` = VALUES(`tax_class`),
                `tags` = VALUES(`tags`),
                `attributes` = VALUES(`attributes`),
                `seo_metadata` = VALUES(`seo_metadata`),
                `created_at` = VALUES(`created_at`),
                `updated_at` = VALUES(`updated_at`),
                `published_at` = VALUES(`published_at`)
                RETURNING `product_id`, `sku`, `brand_id`, `name`, `short_description`, `full_description`, `base_price`, `cost_price`, `weight_kg`, `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`, `seo_metadata`, `created_at`, `updated_at`, `published_at`"""))
      .updateReturningEach(ProductsRow._rowParser, unsaved)
      .runUnchecked(c);
  };
}