/**
 * File has been automatically generated by `typo`.
 *
 * <p>IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.products;

import static typo.runtime.Fragment.interpolate;

import java.sql.Connection;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import testdb.brands.BrandsId;
import typo.dsl.DeleteBuilder;
import typo.dsl.Dialect;
import typo.dsl.SelectBuilder;
import typo.dsl.UpdateBuilder;
import typo.runtime.Fragment;
import typo.runtime.MariaTypes;

public class ProductsRepoImpl implements ProductsRepo {
  @Override
  public DeleteBuilder<ProductsFields, ProductsRow> delete() {
    return DeleteBuilder.of("`products`", ProductsFields.structure(), Dialect.MARIADB);
  }
  ;

  @Override
  public Boolean deleteById(ProductsId productId, Connection c) {
    return interpolate(
                Fragment.lit("delete from `products` where `product_id` = "),
                Fragment.encode(ProductsId.pgType, productId),
                Fragment.lit(""))
            .update()
            .runUnchecked(c)
        > 0;
  }
  ;

  @Override
  public Integer deleteByIds(ProductsId[] productIds, Connection c) {
    ArrayList<Fragment> fragments = new ArrayList<>();
    for (var id : productIds) {
      fragments.add(Fragment.encode(ProductsId.pgType, id));
    }
    ;
    return Fragment.interpolate(
            Fragment.lit("delete from `products` where `product_id` in ("),
            Fragment.comma(fragments),
            Fragment.lit(")"))
        .update()
        .runUnchecked(c);
  }
  ;

  @Override
  public ProductsRow insert(ProductsRow unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "insert into `products`(`sku`, `brand_id`, `name`, `short_description`,"
                    + " `full_description`, `base_price`, `cost_price`, `weight_kg`,"
                    + " `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`,"
                    + " `seo_metadata`, `created_at`, `updated_at`, `published_at`)\n"
                    + "values ("),
            Fragment.encode(MariaTypes.varchar, unsaved.sku()),
            Fragment.lit(", "),
            Fragment.encode(BrandsId.pgType.opt(), unsaved.brandId()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar, unsaved.name()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar.opt(), unsaved.shortDescription()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.longtext.opt(), unsaved.fullDescription()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.numeric, unsaved.basePrice()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.numeric.opt(), unsaved.costPrice()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.numeric.opt(), unsaved.weightKg()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.longtext.opt(), unsaved.dimensionsJson()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.text, unsaved.status()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.text, unsaved.taxClass()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.set.opt(), unsaved.tags()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.longtext.opt(), unsaved.attributes()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.longtext.opt(), unsaved.seoMetadata()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.datetime, unsaved.createdAt()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.datetime, unsaved.updatedAt()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.datetime.opt(), unsaved.publishedAt()),
            Fragment.lit(
                ")\n"
                    + "RETURNING `product_id`, `sku`, `brand_id`, `name`, `short_description`,"
                    + " `full_description`, `base_price`, `cost_price`, `weight_kg`,"
                    + " `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`,"
                    + " `seo_metadata`, `created_at`, `updated_at`, `published_at`\n"))
        .updateReturning(ProductsRow._rowParser.exactlyOne())
        .runUnchecked(c);
  }
  ;

  @Override
  public ProductsRow insert(ProductsRowUnsaved unsaved, Connection c) {
    ArrayList<Fragment> columns = new ArrayList<>();
    ;
    ArrayList<Fragment> values = new ArrayList<>();
    ;
    columns.add(Fragment.lit("`sku`"));
    values.add(interpolate(Fragment.encode(MariaTypes.varchar, unsaved.sku()), Fragment.lit("")));
    columns.add(Fragment.lit("`name`"));
    values.add(interpolate(Fragment.encode(MariaTypes.varchar, unsaved.name()), Fragment.lit("")));
    columns.add(Fragment.lit("`base_price`"));
    values.add(
        interpolate(Fragment.encode(MariaTypes.numeric, unsaved.basePrice()), Fragment.lit("")));
    unsaved
        .brandId()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`brand_id`"));
              values.add(
                  interpolate(Fragment.encode(BrandsId.pgType.opt(), value), Fragment.lit("")));
            });
    ;
    unsaved
        .shortDescription()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`short_description`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.varchar.opt(), value), Fragment.lit("")));
            });
    ;
    unsaved
        .fullDescription()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`full_description`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.longtext.opt(), value), Fragment.lit("")));
            });
    ;
    unsaved
        .costPrice()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`cost_price`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.numeric.opt(), value), Fragment.lit("")));
            });
    ;
    unsaved
        .weightKg()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`weight_kg`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.numeric.opt(), value), Fragment.lit("")));
            });
    ;
    unsaved
        .dimensionsJson()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`dimensions_json`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.longtext.opt(), value), Fragment.lit("")));
            });
    ;
    unsaved
        .status()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`status`"));
              values.add(interpolate(Fragment.encode(MariaTypes.text, value), Fragment.lit("")));
            });
    ;
    unsaved
        .taxClass()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`tax_class`"));
              values.add(interpolate(Fragment.encode(MariaTypes.text, value), Fragment.lit("")));
            });
    ;
    unsaved
        .tags()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`tags`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.set.opt(), value), Fragment.lit("")));
            });
    ;
    unsaved
        .attributes()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`attributes`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.longtext.opt(), value), Fragment.lit("")));
            });
    ;
    unsaved
        .seoMetadata()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`seo_metadata`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.longtext.opt(), value), Fragment.lit("")));
            });
    ;
    unsaved
        .createdAt()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`created_at`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.datetime, value), Fragment.lit("")));
            });
    ;
    unsaved
        .updatedAt()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`updated_at`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.datetime, value), Fragment.lit("")));
            });
    ;
    unsaved
        .publishedAt()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`published_at`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.datetime.opt(), value), Fragment.lit("")));
            });
    ;
    Fragment q =
        interpolate(
            Fragment.lit("insert into `products`("),
            Fragment.comma(columns),
            Fragment.lit(")\nvalues ("),
            Fragment.comma(values),
            Fragment.lit(
                ")\n"
                    + "RETURNING `product_id`, `sku`, `brand_id`, `name`, `short_description`,"
                    + " `full_description`, `base_price`, `cost_price`, `weight_kg`,"
                    + " `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`,"
                    + " `seo_metadata`, `created_at`, `updated_at`, `published_at`\n"));
    ;
    return q.updateReturning(ProductsRow._rowParser.exactlyOne()).runUnchecked(c);
  }
  ;

  @Override
  public SelectBuilder<ProductsFields, ProductsRow> select() {
    return SelectBuilder.of(
        "`products`", ProductsFields.structure(), ProductsRow._rowParser, Dialect.MARIADB);
  }
  ;

  @Override
  public List<ProductsRow> selectAll(Connection c) {
    return interpolate(
            Fragment.lit(
                "select `product_id`, `sku`, `brand_id`, `name`, `short_description`,"
                    + " `full_description`, `base_price`, `cost_price`, `weight_kg`,"
                    + " `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`,"
                    + " `seo_metadata`, `created_at`, `updated_at`, `published_at`\n"
                    + "from `products`\n"))
        .query(ProductsRow._rowParser.all())
        .runUnchecked(c);
  }
  ;

  @Override
  public Optional<ProductsRow> selectById(ProductsId productId, Connection c) {
    return interpolate(
            Fragment.lit(
                "select `product_id`, `sku`, `brand_id`, `name`, `short_description`,"
                    + " `full_description`, `base_price`, `cost_price`, `weight_kg`,"
                    + " `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`,"
                    + " `seo_metadata`, `created_at`, `updated_at`, `published_at`\n"
                    + "from `products`\n"
                    + "where `product_id` = "),
            Fragment.encode(ProductsId.pgType, productId),
            Fragment.lit(""))
        .query(ProductsRow._rowParser.first())
        .runUnchecked(c);
  }
  ;

  @Override
  public List<ProductsRow> selectByIds(ProductsId[] productIds, Connection c) {
    ArrayList<Fragment> fragments = new ArrayList<>();
    for (var id : productIds) {
      fragments.add(Fragment.encode(ProductsId.pgType, id));
    }
    ;
    return Fragment.interpolate(
            Fragment.lit(
                "select `product_id`, `sku`, `brand_id`, `name`, `short_description`,"
                    + " `full_description`, `base_price`, `cost_price`, `weight_kg`,"
                    + " `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`,"
                    + " `seo_metadata`, `created_at`, `updated_at`, `published_at` from `products`"
                    + " where `product_id` in ("),
            Fragment.comma(fragments),
            Fragment.lit(")"))
        .query(ProductsRow._rowParser.all())
        .runUnchecked(c);
  }
  ;

  @Override
  public Map<ProductsId, ProductsRow> selectByIdsTracked(ProductsId[] productIds, Connection c) {
    HashMap<ProductsId, ProductsRow> ret = new HashMap<ProductsId, ProductsRow>();
    selectByIds(productIds, c).forEach(row -> ret.put(row.productId(), row));
    return ret;
  }
  ;

  @Override
  public Optional<ProductsRow> selectByUniqueSku(String sku, Connection c) {
    return interpolate(
            Fragment.lit(
                "select `product_id`, `sku`, `brand_id`, `name`, `short_description`,"
                    + " `full_description`, `base_price`, `cost_price`, `weight_kg`,"
                    + " `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`,"
                    + " `seo_metadata`, `created_at`, `updated_at`, `published_at`\n"
                    + "from `products`\n"
                    + "where `sku` = "),
            Fragment.encode(MariaTypes.varchar, sku),
            Fragment.lit("\n"))
        .query(ProductsRow._rowParser.first())
        .runUnchecked(c);
  }
  ;

  @Override
  public UpdateBuilder<ProductsFields, ProductsRow> update() {
    return UpdateBuilder.of(
        "`products`", ProductsFields.structure(), ProductsRow._rowParser, Dialect.MARIADB);
  }
  ;

  @Override
  public Boolean update(ProductsRow row, Connection c) {
    ProductsId productId = row.productId();
    ;
    return interpolate(
                Fragment.lit("update `products`\nset `sku` = "),
                Fragment.encode(MariaTypes.varchar, row.sku()),
                Fragment.lit(",\n`brand_id` = "),
                Fragment.encode(BrandsId.pgType.opt(), row.brandId()),
                Fragment.lit(",\n`name` = "),
                Fragment.encode(MariaTypes.varchar, row.name()),
                Fragment.lit(",\n`short_description` = "),
                Fragment.encode(MariaTypes.varchar.opt(), row.shortDescription()),
                Fragment.lit(",\n`full_description` = "),
                Fragment.encode(MariaTypes.longtext.opt(), row.fullDescription()),
                Fragment.lit(",\n`base_price` = "),
                Fragment.encode(MariaTypes.numeric, row.basePrice()),
                Fragment.lit(",\n`cost_price` = "),
                Fragment.encode(MariaTypes.numeric.opt(), row.costPrice()),
                Fragment.lit(",\n`weight_kg` = "),
                Fragment.encode(MariaTypes.numeric.opt(), row.weightKg()),
                Fragment.lit(",\n`dimensions_json` = "),
                Fragment.encode(MariaTypes.longtext.opt(), row.dimensionsJson()),
                Fragment.lit(",\n`status` = "),
                Fragment.encode(MariaTypes.text, row.status()),
                Fragment.lit(",\n`tax_class` = "),
                Fragment.encode(MariaTypes.text, row.taxClass()),
                Fragment.lit(",\n`tags` = "),
                Fragment.encode(MariaTypes.set.opt(), row.tags()),
                Fragment.lit(",\n`attributes` = "),
                Fragment.encode(MariaTypes.longtext.opt(), row.attributes()),
                Fragment.lit(",\n`seo_metadata` = "),
                Fragment.encode(MariaTypes.longtext.opt(), row.seoMetadata()),
                Fragment.lit(",\n`created_at` = "),
                Fragment.encode(MariaTypes.datetime, row.createdAt()),
                Fragment.lit(",\n`updated_at` = "),
                Fragment.encode(MariaTypes.datetime, row.updatedAt()),
                Fragment.lit(",\n`published_at` = "),
                Fragment.encode(MariaTypes.datetime.opt(), row.publishedAt()),
                Fragment.lit("\nwhere `product_id` = "),
                Fragment.encode(ProductsId.pgType, productId),
                Fragment.lit(""))
            .update()
            .runUnchecked(c)
        > 0;
  }
  ;

  @Override
  public ProductsRow upsert(ProductsRow unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "INSERT INTO `products`(`sku`, `brand_id`, `name`, `short_description`,"
                    + " `full_description`, `base_price`, `cost_price`, `weight_kg`,"
                    + " `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`,"
                    + " `seo_metadata`, `created_at`, `updated_at`, `published_at`)\n"
                    + "VALUES ("),
            Fragment.encode(MariaTypes.varchar, unsaved.sku()),
            Fragment.lit(", "),
            Fragment.encode(BrandsId.pgType.opt(), unsaved.brandId()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar, unsaved.name()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar.opt(), unsaved.shortDescription()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.longtext.opt(), unsaved.fullDescription()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.numeric, unsaved.basePrice()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.numeric.opt(), unsaved.costPrice()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.numeric.opt(), unsaved.weightKg()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.longtext.opt(), unsaved.dimensionsJson()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.text, unsaved.status()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.text, unsaved.taxClass()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.set.opt(), unsaved.tags()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.longtext.opt(), unsaved.attributes()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.longtext.opt(), unsaved.seoMetadata()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.datetime, unsaved.createdAt()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.datetime, unsaved.updatedAt()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.datetime.opt(), unsaved.publishedAt()),
            Fragment.lit(
                ")\n"
                    + "ON DUPLICATE KEY UPDATE `sku` = VALUES(`sku`),\n"
                    + "`brand_id` = VALUES(`brand_id`),\n"
                    + "`name` = VALUES(`name`),\n"
                    + "`short_description` = VALUES(`short_description`),\n"
                    + "`full_description` = VALUES(`full_description`),\n"
                    + "`base_price` = VALUES(`base_price`),\n"
                    + "`cost_price` = VALUES(`cost_price`),\n"
                    + "`weight_kg` = VALUES(`weight_kg`),\n"
                    + "`dimensions_json` = VALUES(`dimensions_json`),\n"
                    + "`status` = VALUES(`status`),\n"
                    + "`tax_class` = VALUES(`tax_class`),\n"
                    + "`tags` = VALUES(`tags`),\n"
                    + "`attributes` = VALUES(`attributes`),\n"
                    + "`seo_metadata` = VALUES(`seo_metadata`),\n"
                    + "`created_at` = VALUES(`created_at`),\n"
                    + "`updated_at` = VALUES(`updated_at`),\n"
                    + "`published_at` = VALUES(`published_at`)\n"
                    + "RETURNING `product_id`, `sku`, `brand_id`, `name`, `short_description`,"
                    + " `full_description`, `base_price`, `cost_price`, `weight_kg`,"
                    + " `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`,"
                    + " `seo_metadata`, `created_at`, `updated_at`, `published_at`"))
        .updateReturning(ProductsRow._rowParser.exactlyOne())
        .runUnchecked(c);
  }
  ;

  @Override
  public List<ProductsRow> upsertBatch(Iterator<ProductsRow> unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "INSERT INTO `products`(`product_id`, `sku`, `brand_id`, `name`,"
                    + " `short_description`, `full_description`, `base_price`, `cost_price`,"
                    + " `weight_kg`, `dimensions_json`, `status`, `tax_class`, `tags`,"
                    + " `attributes`, `seo_metadata`, `created_at`, `updated_at`, `published_at`)\n"
                    + "VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n"
                    + "ON DUPLICATE KEY UPDATE `sku` = VALUES(`sku`),\n"
                    + "`brand_id` = VALUES(`brand_id`),\n"
                    + "`name` = VALUES(`name`),\n"
                    + "`short_description` = VALUES(`short_description`),\n"
                    + "`full_description` = VALUES(`full_description`),\n"
                    + "`base_price` = VALUES(`base_price`),\n"
                    + "`cost_price` = VALUES(`cost_price`),\n"
                    + "`weight_kg` = VALUES(`weight_kg`),\n"
                    + "`dimensions_json` = VALUES(`dimensions_json`),\n"
                    + "`status` = VALUES(`status`),\n"
                    + "`tax_class` = VALUES(`tax_class`),\n"
                    + "`tags` = VALUES(`tags`),\n"
                    + "`attributes` = VALUES(`attributes`),\n"
                    + "`seo_metadata` = VALUES(`seo_metadata`),\n"
                    + "`created_at` = VALUES(`created_at`),\n"
                    + "`updated_at` = VALUES(`updated_at`),\n"
                    + "`published_at` = VALUES(`published_at`)\n"
                    + "RETURNING `product_id`, `sku`, `brand_id`, `name`, `short_description`,"
                    + " `full_description`, `base_price`, `cost_price`, `weight_kg`,"
                    + " `dimensions_json`, `status`, `tax_class`, `tags`, `attributes`,"
                    + " `seo_metadata`, `created_at`, `updated_at`, `published_at`"))
        .updateReturningEach(ProductsRow._rowParser, unsaved)
        .runUnchecked(c);
  }
  ;
}
