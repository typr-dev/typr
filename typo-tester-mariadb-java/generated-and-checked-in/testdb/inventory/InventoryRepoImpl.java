/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.inventory;

import java.sql.Connection;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import testdb.products.ProductsId;
import testdb.warehouses.WarehousesId;
import typo.dsl.DeleteBuilder;
import typo.dsl.Dialect;
import typo.dsl.SelectBuilder;
import typo.dsl.UpdateBuilder;
import typo.runtime.Fragment;
import typo.runtime.Fragment.Literal;
import typo.runtime.MariaTypes;
import static typo.runtime.Fragment.interpolate;

public class InventoryRepoImpl implements InventoryRepo {
  @Override
  public DeleteBuilder<InventoryFields, InventoryRow> delete() {
    return DeleteBuilder.of("`inventory`", InventoryFields.structure(), Dialect.MARIADB);
  };

  @Override
  public Boolean deleteById(
    InventoryId inventoryId,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("delete from `inventory` where `inventory_id` = "),
      InventoryId.pgType.encode(inventoryId),
      typo.runtime.Fragment.lit("")
    ).update().runUnchecked(c) > 0;
  };

  @Override
  public Integer deleteByIds(
    InventoryId[] inventoryIds,
    Connection c
  ) {
    ArrayList<Fragment> fragments = new ArrayList<Fragment>();
    for (var id : inventoryIds) { fragments.add(InventoryId.pgType.encode(id)); };
    return Fragment.interpolate(Fragment.lit("delete from `inventory` where `inventory_id` in ("), Fragment.comma(fragments), Fragment.lit(")")).update().runUnchecked(c);
  };

  @Override
  public InventoryRow insert(
    InventoryRow unsaved,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
         insert into `inventory`(`product_id`, `warehouse_id`, `quantity_on_hand`, `quantity_reserved`, `quantity_on_order`, `reorder_point`, `reorder_quantity`, `bin_location`, `last_counted_at`, `updated_at`)
         values ("""),
      ProductsId.pgType.encode(unsaved.productId()),
      typo.runtime.Fragment.lit(", "),
      WarehousesId.pgType.encode(unsaved.warehouseId()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.int_.encode(unsaved.quantityOnHand()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.int_.encode(unsaved.quantityReserved()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.int_.encode(unsaved.quantityOnOrder()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.int_.encode(unsaved.reorderPoint()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.int_.encode(unsaved.reorderQuantity()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.binLocation()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.datetime.opt().encode(unsaved.lastCountedAt()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.datetime.encode(unsaved.updatedAt()),
      typo.runtime.Fragment.lit("""
         )
         returning `inventory_id`, `product_id`, `warehouse_id`, `quantity_on_hand`, `quantity_reserved`, `quantity_on_order`, `reorder_point`, `reorder_quantity`, `bin_location`, `last_counted_at`, `updated_at`
      """)
    )
      .updateReturning(InventoryRow._rowParser.exactlyOne()).runUnchecked(c);
  };

  @Override
  public InventoryRow insert(
    InventoryRowUnsaved unsaved,
    Connection c
  ) {
    ArrayList<Literal> columns = new ArrayList<Literal>();;
    ArrayList<Fragment> values = new ArrayList<Fragment>();;
    columns.add(Fragment.lit("`product_id`"));
    values.add(interpolate(
      ProductsId.pgType.encode(unsaved.productId()),
      typo.runtime.Fragment.lit("""
      """)
    ));
    columns.add(Fragment.lit("`warehouse_id`"));
    values.add(interpolate(
      WarehousesId.pgType.encode(unsaved.warehouseId()),
      typo.runtime.Fragment.lit("""
      """)
    ));
    unsaved.quantityOnHand().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`quantity_on_hand`"));
        values.add(interpolate(
        MariaTypes.int_.encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.quantityReserved().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`quantity_reserved`"));
        values.add(interpolate(
        MariaTypes.int_.encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.quantityOnOrder().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`quantity_on_order`"));
        values.add(interpolate(
        MariaTypes.int_.encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.reorderPoint().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`reorder_point`"));
        values.add(interpolate(
        MariaTypes.int_.encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.reorderQuantity().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`reorder_quantity`"));
        values.add(interpolate(
        MariaTypes.int_.encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.binLocation().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`bin_location`"));
        values.add(interpolate(
        MariaTypes.text.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.lastCountedAt().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`last_counted_at`"));
        values.add(interpolate(
        MariaTypes.datetime.opt().encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    unsaved.updatedAt().visit(
      () -> {
  
      },
      value -> {
        columns.add(Fragment.lit("`updated_at`"));
        values.add(interpolate(
        MariaTypes.datetime.encode(value),
        typo.runtime.Fragment.lit("""
        """)
      ));
      }
    );;
    Fragment q = interpolate(
      typo.runtime.Fragment.lit("insert into `inventory`("),
      Fragment.comma(columns),
      typo.runtime.Fragment.lit("""
         )
         values ("""),
      Fragment.comma(values),
      typo.runtime.Fragment.lit("""
         )
         returning `inventory_id`, `product_id`, `warehouse_id`, `quantity_on_hand`, `quantity_reserved`, `quantity_on_order`, `reorder_point`, `reorder_quantity`, `bin_location`, `last_counted_at`, `updated_at`
      """)
    );;
    return q.updateReturning(InventoryRow._rowParser.exactlyOne()).runUnchecked(c);
  };

  @Override
  public SelectBuilder<InventoryFields, InventoryRow> select() {
    return SelectBuilder.of("`inventory`", InventoryFields.structure(), InventoryRow._rowParser, Dialect.MARIADB);
  };

  @Override
  public List<InventoryRow> selectAll(Connection c) {
    return interpolate(typo.runtime.Fragment.lit("""
       select `inventory_id`, `product_id`, `warehouse_id`, `quantity_on_hand`, `quantity_reserved`, `quantity_on_order`, `reorder_point`, `reorder_quantity`, `bin_location`, `last_counted_at`, `updated_at`
       from `inventory`
    """)).query(InventoryRow._rowParser.all()).runUnchecked(c);
  };

  @Override
  public Optional<InventoryRow> selectById(
    InventoryId inventoryId,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
         select `inventory_id`, `product_id`, `warehouse_id`, `quantity_on_hand`, `quantity_reserved`, `quantity_on_order`, `reorder_point`, `reorder_quantity`, `bin_location`, `last_counted_at`, `updated_at`
         from `inventory`
         where `inventory_id` = """),
      InventoryId.pgType.encode(inventoryId),
      typo.runtime.Fragment.lit("")
    ).query(InventoryRow._rowParser.first()).runUnchecked(c);
  };

  @Override
  public List<InventoryRow> selectByIds(
    InventoryId[] inventoryIds,
    Connection c
  ) {
    ArrayList<Fragment> fragments = new ArrayList<Fragment>();
    for (var id : inventoryIds) { fragments.add(InventoryId.pgType.encode(id)); };
    return Fragment.interpolate(Fragment.lit("select `inventory_id`, `product_id`, `warehouse_id`, `quantity_on_hand`, `quantity_reserved`, `quantity_on_order`, `reorder_point`, `reorder_quantity`, `bin_location`, `last_counted_at`, `updated_at` from `inventory` where `inventory_id` in ("), Fragment.comma(fragments), Fragment.lit(")")).query(InventoryRow._rowParser.all()).runUnchecked(c);
  };

  @Override
  public Map<InventoryId, InventoryRow> selectByIdsTracked(
    InventoryId[] inventoryIds,
    Connection c
  ) {
    HashMap<InventoryId, InventoryRow> ret = new HashMap<InventoryId, InventoryRow>();
    selectByIds(inventoryIds, c).forEach(row -> ret.put(row.inventoryId(), row));
    return ret;
  };

  @Override
  public Optional<InventoryRow> selectByUniqueProductIdAndWarehouseId(
    ProductsId productId,
    WarehousesId warehouseId,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
         select `inventory_id`, `product_id`, `warehouse_id`, `quantity_on_hand`, `quantity_reserved`, `quantity_on_order`, `reorder_point`, `reorder_quantity`, `bin_location`, `last_counted_at`, `updated_at`
         from `inventory`
         where `product_id` = """),
      ProductsId.pgType.encode(productId),
      typo.runtime.Fragment.lit(" AND `warehouse_id` = "),
      WarehousesId.pgType.encode(warehouseId),
      typo.runtime.Fragment.lit("""


      """)
    ).query(InventoryRow._rowParser.first()).runUnchecked(c);
  };

  @Override
  public UpdateBuilder<InventoryFields, InventoryRow> update() {
    return UpdateBuilder.of("`inventory`", InventoryFields.structure(), InventoryRow._rowParser.all(), Dialect.MARIADB);
  };

  @Override
  public Boolean update(
    InventoryRow row,
    Connection c
  ) {
    InventoryId inventoryId = row.inventoryId();;
    return interpolate(
      typo.runtime.Fragment.lit("""
         update `inventory`
         set `product_id` = """),
      ProductsId.pgType.encode(row.productId()),
      typo.runtime.Fragment.lit("""
         ,
         `warehouse_id` = """),
      WarehousesId.pgType.encode(row.warehouseId()),
      typo.runtime.Fragment.lit("""
         ,
         `quantity_on_hand` = """),
      MariaTypes.int_.encode(row.quantityOnHand()),
      typo.runtime.Fragment.lit("""
         ,
         `quantity_reserved` = """),
      MariaTypes.int_.encode(row.quantityReserved()),
      typo.runtime.Fragment.lit("""
         ,
         `quantity_on_order` = """),
      MariaTypes.int_.encode(row.quantityOnOrder()),
      typo.runtime.Fragment.lit("""
         ,
         `reorder_point` = """),
      MariaTypes.int_.encode(row.reorderPoint()),
      typo.runtime.Fragment.lit("""
         ,
         `reorder_quantity` = """),
      MariaTypes.int_.encode(row.reorderQuantity()),
      typo.runtime.Fragment.lit("""
         ,
         `bin_location` = """),
      MariaTypes.text.opt().encode(row.binLocation()),
      typo.runtime.Fragment.lit("""
         ,
         `last_counted_at` = """),
      MariaTypes.datetime.opt().encode(row.lastCountedAt()),
      typo.runtime.Fragment.lit("""
         ,
         `updated_at` = """),
      MariaTypes.datetime.encode(row.updatedAt()),
      typo.runtime.Fragment.lit("""
   
         where `inventory_id` = """),
      InventoryId.pgType.encode(inventoryId),
      typo.runtime.Fragment.lit("")
    ).update().runUnchecked(c) > 0;
  };

  @Override
  public InventoryRow upsert(
    InventoryRow unsaved,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
         INSERT INTO `inventory`(`product_id`, `warehouse_id`, `quantity_on_hand`, `quantity_reserved`, `quantity_on_order`, `reorder_point`, `reorder_quantity`, `bin_location`, `last_counted_at`, `updated_at`)
         VALUES ("""),
      ProductsId.pgType.encode(unsaved.productId()),
      typo.runtime.Fragment.lit(", "),
      WarehousesId.pgType.encode(unsaved.warehouseId()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.int_.encode(unsaved.quantityOnHand()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.int_.encode(unsaved.quantityReserved()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.int_.encode(unsaved.quantityOnOrder()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.int_.encode(unsaved.reorderPoint()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.int_.encode(unsaved.reorderQuantity()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.text.opt().encode(unsaved.binLocation()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.datetime.opt().encode(unsaved.lastCountedAt()),
      typo.runtime.Fragment.lit(", "),
      MariaTypes.datetime.encode(unsaved.updatedAt()),
      typo.runtime.Fragment.lit("""
         )
         ON DUPLICATE KEY UPDATE `product_id` = VALUES(`product_id`),
         `warehouse_id` = VALUES(`warehouse_id`),
         `quantity_on_hand` = VALUES(`quantity_on_hand`),
         `quantity_reserved` = VALUES(`quantity_reserved`),
         `quantity_on_order` = VALUES(`quantity_on_order`),
         `reorder_point` = VALUES(`reorder_point`),
         `reorder_quantity` = VALUES(`reorder_quantity`),
         `bin_location` = VALUES(`bin_location`),
         `last_counted_at` = VALUES(`last_counted_at`),
         `updated_at` = VALUES(`updated_at`)
         RETURNING `inventory_id`, `product_id`, `warehouse_id`, `quantity_on_hand`, `quantity_reserved`, `quantity_on_order`, `reorder_point`, `reorder_quantity`, `bin_location`, `last_counted_at`, `updated_at`""")
    )
      .updateReturning(InventoryRow._rowParser.exactlyOne())
      .runUnchecked(c);
  };

  @Override
  public List<InventoryRow> upsertBatch(
    Iterator<InventoryRow> unsaved,
    Connection c
  ) {
    return interpolate(typo.runtime.Fragment.lit("""
                INSERT INTO `inventory`(`inventory_id`, `product_id`, `warehouse_id`, `quantity_on_hand`, `quantity_reserved`, `quantity_on_order`, `reorder_point`, `reorder_quantity`, `bin_location`, `last_counted_at`, `updated_at`)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                ON DUPLICATE KEY UPDATE `product_id` = VALUES(`product_id`),
                `warehouse_id` = VALUES(`warehouse_id`),
                `quantity_on_hand` = VALUES(`quantity_on_hand`),
                `quantity_reserved` = VALUES(`quantity_reserved`),
                `quantity_on_order` = VALUES(`quantity_on_order`),
                `reorder_point` = VALUES(`reorder_point`),
                `reorder_quantity` = VALUES(`reorder_quantity`),
                `bin_location` = VALUES(`bin_location`),
                `last_counted_at` = VALUES(`last_counted_at`),
                `updated_at` = VALUES(`updated_at`)
                RETURNING `inventory_id`, `product_id`, `warehouse_id`, `quantity_on_hand`, `quantity_reserved`, `quantity_on_order`, `reorder_point`, `reorder_quantity`, `bin_location`, `last_counted_at`, `updated_at`"""))
      .updateReturningEach(InventoryRow._rowParser, unsaved)
      .runUnchecked(c);
  };
}