/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package oracledb.departments

import java.sql.Connection
import java.util.ArrayList
import java.util.HashMap
import java.util.Optional
import oracledb.MoneyT
import typo.dsl.DeleteBuilder
import typo.dsl.Dialect
import typo.dsl.SelectBuilder
import typo.dsl.UpdateBuilder
import typo.runtime.Fragment
import typo.runtime.OracleTypes
import typo.runtime.Fragment.interpolate

class DepartmentsRepoImpl extends DepartmentsRepo {
  override def delete: DeleteBuilder[DepartmentsFields, DepartmentsRow] = DeleteBuilder.of(""""DEPARTMENTS"""", DepartmentsFields.structure, Dialect.ORACLE)

  override def deleteById(compositeId: DepartmentsId)(using c: Connection): java.lang.Boolean = interpolate(Fragment.lit("""delete from "DEPARTMENTS" where "DEPT_CODE" = """), Fragment.encode(OracleTypes.varchar2, compositeId.deptCode), Fragment.lit(""" AND "DEPT_REGION" = """), Fragment.encode(OracleTypes.varchar2, compositeId.deptRegion), Fragment.lit("")).update().runUnchecked(c) > 0

  override def deleteByIds(compositeIds: Array[DepartmentsId])(using c: Connection): Integer = {
    val fragments: ArrayList[Fragment] = new ArrayList()
    compositeIds.foreach { id => fragments.add(Fragment.interpolate(Fragment.lit("("), Fragment.encode(OracleTypes.varchar2, id.deptCode), Fragment.lit(", "), Fragment.encode(OracleTypes.varchar2, id.deptRegion), Fragment.lit(")"))): @scala.annotation.nowarn }
    return Fragment.interpolate(Fragment.lit("""delete from "DEPARTMENTS" where ("DEPT_CODE", "DEPT_REGION") in ("""), Fragment.comma(fragments), Fragment.lit(")")).update().runUnchecked(c)
  }

  override def insert(unsaved: DepartmentsRow)(using c: Connection): DepartmentsId = {
  interpolate(Fragment.lit("""insert into "DEPARTMENTS"("DEPT_CODE", "DEPT_REGION", "DEPT_NAME", "BUDGET")
    values ("""), Fragment.encode(OracleTypes.varchar2, unsaved.deptCode), Fragment.lit(", "), Fragment.encode(OracleTypes.varchar2, unsaved.deptRegion), Fragment.lit(", "), Fragment.encode(OracleTypes.varchar2, unsaved.deptName), Fragment.lit(", "), Fragment.encode(MoneyT.oracleType.opt(), unsaved.budget), Fragment.lit(""")
    """))
    .updateReturningGeneratedKeys(Array[String]("DEPT_CODE", "DEPT_REGION"), DepartmentsId.`_rowParser`.exactlyOne()).runUnchecked(c)
  }

  override def select: SelectBuilder[DepartmentsFields, DepartmentsRow] = SelectBuilder.of(""""DEPARTMENTS"""", DepartmentsFields.structure, DepartmentsRow.`_rowParser`, Dialect.ORACLE)

  override def selectAll(using c: Connection): java.util.List[DepartmentsRow] = {
    interpolate(Fragment.lit("""select "DEPT_CODE", "DEPT_REGION", "DEPT_NAME", "BUDGET"
    from "DEPARTMENTS"
    """)).query(DepartmentsRow.`_rowParser`.all()).runUnchecked(c)
  }

  override def selectById(compositeId: DepartmentsId)(using c: Connection): Optional[DepartmentsRow] = {
    interpolate(Fragment.lit("""select "DEPT_CODE", "DEPT_REGION", "DEPT_NAME", "BUDGET"
    from "DEPARTMENTS"
    where "DEPT_CODE" = """), Fragment.encode(OracleTypes.varchar2, compositeId.deptCode), Fragment.lit(""" AND "DEPT_REGION" = """), Fragment.encode(OracleTypes.varchar2, compositeId.deptRegion), Fragment.lit("")).query(DepartmentsRow.`_rowParser`.first()).runUnchecked(c)
  }

  override def selectByIds(compositeIds: Array[DepartmentsId])(using c: Connection): java.util.List[DepartmentsRow] = {
    val fragments: ArrayList[Fragment] = new ArrayList()
    compositeIds.foreach { id => fragments.add(Fragment.interpolate(Fragment.lit("("), Fragment.encode(OracleTypes.varchar2, id.deptCode), Fragment.lit(", "), Fragment.encode(OracleTypes.varchar2, id.deptRegion), Fragment.lit(")"))): @scala.annotation.nowarn }
    return Fragment.interpolate(Fragment.lit("""select "DEPT_CODE", "DEPT_REGION", "DEPT_NAME", "BUDGET" from "DEPARTMENTS" where ("DEPT_CODE", "DEPT_REGION") in ("""), Fragment.comma(fragments), Fragment.lit(")")).query(DepartmentsRow.`_rowParser`.all()).runUnchecked(c)
  }

  override def selectByIdsTracked(compositeIds: Array[DepartmentsId])(using c: Connection): java.util.Map[DepartmentsId, DepartmentsRow] = {
    val ret: HashMap[DepartmentsId, DepartmentsRow] = new HashMap[DepartmentsId, DepartmentsRow]()
    selectByIds(compositeIds)(using c).forEach(row => ret.put(row.compositeId, row): @scala.annotation.nowarn)
    return ret
  }

  override def update: UpdateBuilder[DepartmentsFields, DepartmentsRow] = UpdateBuilder.of(""""DEPARTMENTS"""", DepartmentsFields.structure, DepartmentsRow.`_rowParser`, Dialect.ORACLE)

  override def update(row: DepartmentsRow)(using c: Connection): java.lang.Boolean = {
    val compositeId: DepartmentsId = row.compositeId
    return interpolate(Fragment.lit("""update "DEPARTMENTS"
    set "DEPT_NAME" = """), Fragment.encode(OracleTypes.varchar2, row.deptName), Fragment.lit(""",
    "BUDGET" = """), Fragment.encode(MoneyT.oracleType.opt(), row.budget), Fragment.lit("""
    where "DEPT_CODE" = """), Fragment.encode(OracleTypes.varchar2, compositeId.deptCode), Fragment.lit(""" AND "DEPT_REGION" = """), Fragment.encode(OracleTypes.varchar2, compositeId.deptRegion), Fragment.lit("")).update().runUnchecked(c) > 0
  }

  override def upsert(unsaved: DepartmentsRow)(using c: Connection): DepartmentsRow = {
  interpolate(Fragment.lit("""MERGE INTO "DEPARTMENTS" t
    USING (SELECT """), Fragment.encode(OracleTypes.varchar2, unsaved.deptCode), Fragment.lit(", "), Fragment.encode(OracleTypes.varchar2, unsaved.deptRegion), Fragment.lit(", "), Fragment.encode(OracleTypes.varchar2, unsaved.deptName), Fragment.lit(", "), Fragment.encode(MoneyT.oracleType.opt(), unsaved.budget), Fragment.lit(""" FROM DUAL) s
    ON ("DEPT_CODE", "DEPT_REGION")
    WHEN MATCHED THEN UPDATE SET t."DEPT_NAME" = s."DEPT_NAME",
    t."BUDGET" = s."BUDGET"
    WHEN NOT MATCHED THEN INSERT ("DEPT_CODE", "DEPT_REGION", "DEPT_NAME", "BUDGET") VALUES ("""), Fragment.encode(OracleTypes.varchar2, unsaved.deptCode), Fragment.lit(", "), Fragment.encode(OracleTypes.varchar2, unsaved.deptRegion), Fragment.lit(", "), Fragment.encode(OracleTypes.varchar2, unsaved.deptName), Fragment.lit(", "), Fragment.encode(MoneyT.oracleType.opt(), unsaved.budget), Fragment.lit(")"))
    .updateReturning(DepartmentsRow.`_rowParser`.exactlyOne())
    .runUnchecked(c)
  }

  override def upsertBatch(unsaved: java.util.Iterator[DepartmentsRow])(using c: Connection): java.util.List[DepartmentsRow] = {
    interpolate(Fragment.lit("""MERGE INTO "DEPARTMENTS" t
    USING (SELECT ?, ?, ?, ? FROM DUAL) s
    ON ("DEPT_CODE", "DEPT_REGION")
    WHEN MATCHED THEN UPDATE SET t."DEPT_NAME" = s."DEPT_NAME",
    t."BUDGET" = s."BUDGET"
    WHEN NOT MATCHED THEN INSERT ("DEPT_CODE", "DEPT_REGION", "DEPT_NAME", "BUDGET") VALUES (?, ?, ?, ?)"""))
      .updateReturningEach(DepartmentsRow.`_rowParser`, unsaved)
    .runUnchecked(c)
  }
}