/**
 * File has been automatically generated by `typo`.
 *
 * <p>IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.cte_test;

import static typr.runtime.Fragment.interpolate;

import java.sql.Connection;
import java.util.List;
import typr.runtime.Fragment;

public class CteTestSqlRepoImpl implements CteTestSqlRepo {
  @Override
  public List<CteTestSqlRow> apply(Connection c) {
    return interpolate(
            Fragment.lit(
                "-- Test CTE tracking\n"
                    + "WITH customer_totals AS (\n"
                    + "    SELECT\n"
                    + "        o.customer_id,\n"
                    + "        COUNT(*) as order_count,\n"
                    + "        SUM(o.total_amount) as total_spent\n"
                    + "    FROM orders o\n"
                    + "    GROUP BY o.customer_id\n"
                    + "),\n"
                    + "top_customers AS (\n"
                    + "    SELECT\n"
                    + "        c.customer_id,\n"
                    + "        c.email,\n"
                    + "        c.first_name,\n"
                    + "        ct.order_count,\n"
                    + "        ct.total_spent\n"
                    + "    FROM customers c\n"
                    + "    INNER JOIN customer_totals ct ON c.customer_id = ct.customer_id\n"
                    + "    WHERE ct.total_spent > 100\n"
                    + ")\n"
                    + "SELECT\n"
                    + "    tc.customer_id,\n"
                    + "    tc.email,\n"
                    + "    tc.first_name,\n"
                    + "    tc.order_count,\n"
                    + "    tc.total_spent,\n"
                    + "    b.name as favorite_brand\n"
                    + "FROM top_customers tc\n"
                    + "LEFT JOIN orders o ON tc.customer_id = o.customer_id\n"
                    + "LEFT JOIN order_items oi ON o.order_id = oi.order_id\n"
                    + "LEFT JOIN products p ON oi.product_id = p.product_id\n"
                    + "LEFT JOIN brands b ON p.brand_id = b.brand_id\n"))
        .query(CteTestSqlRow._rowParser.all())
        .runUnchecked(c);
  }
  ;
}
