/**
 * File has been automatically generated by `typo`.
 *
 * <p>IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.product_search;

import static typr.runtime.Fragment.interpolate;

import java.math.BigDecimal;
import java.sql.Connection;
import java.util.List;
import java.util.Optional;
import typr.runtime.Fragment;
import typr.runtime.MariaTypes;

public class ProductSearchSqlRepoImpl implements ProductSearchSqlRepo {
  @Override
  public List<ProductSearchSqlRow> apply(
      Optional<Integer> brandId,
      Optional<BigDecimal> minPrice,
      Optional<BigDecimal> maxPrice,
      Optional<String> status,
      Long limit,
      Connection c) {
    return interpolate(
            Fragment.lit(
                "-- Search products with optional filters\n"
                    + "SELECT p.product_id,\n"
                    + "       p.sku,\n"
                    + "       p.name,\n"
                    + "       p.short_description,\n"
                    + "       p.base_price,\n"
                    + "       p.status,\n"
                    + "       b.name AS brand_name\n"
                    + "FROM products p\n"
                    + "LEFT JOIN brands b ON p.brand_id = b.brand_id\n"
                    + "WHERE ("),
            Fragment.encode(MariaTypes.smallintUnsigned.opt(), brandId),
            Fragment.lit(" IS NULL OR p.brand_id = "),
            Fragment.encode(MariaTypes.smallintUnsigned.opt(), brandId),
            Fragment.lit(")\n  AND ("),
            Fragment.encode(MariaTypes.numeric.opt(), minPrice),
            Fragment.lit(" IS NULL OR p.base_price >= "),
            Fragment.encode(MariaTypes.numeric.opt(), minPrice),
            Fragment.lit(")\n  AND ("),
            Fragment.encode(MariaTypes.numeric.opt(), maxPrice),
            Fragment.lit(" IS NULL OR p.base_price <= "),
            Fragment.encode(MariaTypes.numeric.opt(), maxPrice),
            Fragment.lit(")\n  AND ("),
            Fragment.encode(MariaTypes.text.opt(), status),
            Fragment.lit(" IS NULL OR p.status = "),
            Fragment.encode(MariaTypes.text.opt(), status),
            Fragment.lit(")\nORDER BY p.name\nLIMIT "),
            Fragment.encode(MariaTypes.bigint, limit),
            Fragment.lit("\n"))
        .query(ProductSearchSqlRow._rowParser.all())
        .runUnchecked(c);
  }
  ;
}
