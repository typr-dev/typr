/**
 * File has been automatically generated by `typo`.
 *
 * <p>IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package testdb.categories;

import static typr.runtime.Fragment.interpolate;

import java.sql.Connection;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import typr.dsl.DeleteBuilder;
import typr.dsl.Dialect;
import typr.dsl.SelectBuilder;
import typr.dsl.UpdateBuilder;
import typr.runtime.Fragment;
import typr.runtime.MariaTypes;

public class CategoriesRepoImpl implements CategoriesRepo {
  @Override
  public DeleteBuilder<CategoriesFields, CategoriesRow> delete() {
    return DeleteBuilder.of("`categories`", CategoriesFields.structure(), Dialect.MARIADB);
  }
  ;

  @Override
  public Boolean deleteById(CategoriesId categoryId, Connection c) {
    return interpolate(
                Fragment.lit("delete from `categories` where `category_id` = "),
                Fragment.encode(CategoriesId.pgType, categoryId),
                Fragment.lit(""))
            .update()
            .runUnchecked(c)
        > 0;
  }
  ;

  @Override
  public Integer deleteByIds(CategoriesId[] categoryIds, Connection c) {
    ArrayList<Fragment> fragments = new ArrayList<>();
    for (var id : categoryIds) {
      fragments.add(Fragment.encode(CategoriesId.pgType, id));
    }
    ;
    return Fragment.interpolate(
            Fragment.lit("delete from `categories` where `category_id` in ("),
            Fragment.comma(fragments),
            Fragment.lit(")"))
        .update()
        .runUnchecked(c);
  }
  ;

  @Override
  public CategoriesRow insert(CategoriesRow unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "insert into `categories`(`parent_id`, `name`, `slug`, `description`, `image_url`,"
                    + " `sort_order`, `is_visible`, `metadata`)\n"
                    + "values ("),
            Fragment.encode(CategoriesId.pgType.opt(), unsaved.parentId()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar, unsaved.name()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar, unsaved.slug()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.mediumtext.opt(), unsaved.description()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar.opt(), unsaved.imageUrl()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.smallint, unsaved.sortOrder()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.bool, unsaved.isVisible()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.longtext.opt(), unsaved.metadata()),
            Fragment.lit(
                ")\n"
                    + "RETURNING `category_id`, `parent_id`, `name`, `slug`, `description`,"
                    + " `image_url`, `sort_order`, `is_visible`, `metadata`\n"))
        .updateReturning(CategoriesRow._rowParser.exactlyOne())
        .runUnchecked(c);
  }
  ;

  @Override
  public CategoriesRow insert(CategoriesRowUnsaved unsaved, Connection c) {
    ArrayList<Fragment> columns = new ArrayList<>();
    ;
    ArrayList<Fragment> values = new ArrayList<>();
    ;
    columns.add(Fragment.lit("`name`"));
    values.add(interpolate(Fragment.encode(MariaTypes.varchar, unsaved.name()), Fragment.lit("")));
    columns.add(Fragment.lit("`slug`"));
    values.add(interpolate(Fragment.encode(MariaTypes.varchar, unsaved.slug()), Fragment.lit("")));
    unsaved
        .parentId()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`parent_id`"));
              values.add(
                  interpolate(Fragment.encode(CategoriesId.pgType.opt(), value), Fragment.lit("")));
            });
    ;
    unsaved
        .description()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`description`"));
              values.add(
                  interpolate(
                      Fragment.encode(MariaTypes.mediumtext.opt(), value), Fragment.lit("")));
            });
    ;
    unsaved
        .imageUrl()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`image_url`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.varchar.opt(), value), Fragment.lit("")));
            });
    ;
    unsaved
        .sortOrder()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`sort_order`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.smallint, value), Fragment.lit("")));
            });
    ;
    unsaved
        .isVisible()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`is_visible`"));
              values.add(interpolate(Fragment.encode(MariaTypes.bool, value), Fragment.lit("")));
            });
    ;
    unsaved
        .metadata()
        .visit(
            () -> {},
            value -> {
              columns.add(Fragment.lit("`metadata`"));
              values.add(
                  interpolate(Fragment.encode(MariaTypes.longtext.opt(), value), Fragment.lit("")));
            });
    ;
    Fragment q =
        interpolate(
            Fragment.lit("insert into `categories`("),
            Fragment.comma(columns),
            Fragment.lit(")\nvalues ("),
            Fragment.comma(values),
            Fragment.lit(
                ")\n"
                    + "RETURNING `category_id`, `parent_id`, `name`, `slug`, `description`,"
                    + " `image_url`, `sort_order`, `is_visible`, `metadata`\n"));
    ;
    return q.updateReturning(CategoriesRow._rowParser.exactlyOne()).runUnchecked(c);
  }
  ;

  @Override
  public SelectBuilder<CategoriesFields, CategoriesRow> select() {
    return SelectBuilder.of(
        "`categories`", CategoriesFields.structure(), CategoriesRow._rowParser, Dialect.MARIADB);
  }
  ;

  @Override
  public List<CategoriesRow> selectAll(Connection c) {
    return interpolate(
            Fragment.lit(
                "select `category_id`, `parent_id`, `name`, `slug`, `description`, `image_url`,"
                    + " `sort_order`, `is_visible`, `metadata`\n"
                    + "from `categories`\n"))
        .query(CategoriesRow._rowParser.all())
        .runUnchecked(c);
  }
  ;

  @Override
  public Optional<CategoriesRow> selectById(CategoriesId categoryId, Connection c) {
    return interpolate(
            Fragment.lit(
                "select `category_id`, `parent_id`, `name`, `slug`, `description`, `image_url`,"
                    + " `sort_order`, `is_visible`, `metadata`\n"
                    + "from `categories`\n"
                    + "where `category_id` = "),
            Fragment.encode(CategoriesId.pgType, categoryId),
            Fragment.lit(""))
        .query(CategoriesRow._rowParser.first())
        .runUnchecked(c);
  }
  ;

  @Override
  public List<CategoriesRow> selectByIds(CategoriesId[] categoryIds, Connection c) {
    ArrayList<Fragment> fragments = new ArrayList<>();
    for (var id : categoryIds) {
      fragments.add(Fragment.encode(CategoriesId.pgType, id));
    }
    ;
    return Fragment.interpolate(
            Fragment.lit(
                "select `category_id`, `parent_id`, `name`, `slug`, `description`, `image_url`,"
                    + " `sort_order`, `is_visible`, `metadata` from `categories` where"
                    + " `category_id` in ("),
            Fragment.comma(fragments),
            Fragment.lit(")"))
        .query(CategoriesRow._rowParser.all())
        .runUnchecked(c);
  }
  ;

  @Override
  public Map<CategoriesId, CategoriesRow> selectByIdsTracked(
      CategoriesId[] categoryIds, Connection c) {
    HashMap<CategoriesId, CategoriesRow> ret = new HashMap<CategoriesId, CategoriesRow>();
    selectByIds(categoryIds, c).forEach(row -> ret.put(row.categoryId(), row));
    return ret;
  }
  ;

  @Override
  public Optional<CategoriesRow> selectByUniqueSlug(String slug, Connection c) {
    return interpolate(
            Fragment.lit(
                "select `category_id`, `parent_id`, `name`, `slug`, `description`, `image_url`,"
                    + " `sort_order`, `is_visible`, `metadata`\n"
                    + "from `categories`\n"
                    + "where `slug` = "),
            Fragment.encode(MariaTypes.varchar, slug),
            Fragment.lit("\n"))
        .query(CategoriesRow._rowParser.first())
        .runUnchecked(c);
  }
  ;

  @Override
  public UpdateBuilder<CategoriesFields, CategoriesRow> update() {
    return UpdateBuilder.of(
        "`categories`", CategoriesFields.structure(), CategoriesRow._rowParser, Dialect.MARIADB);
  }
  ;

  @Override
  public Boolean update(CategoriesRow row, Connection c) {
    CategoriesId categoryId = row.categoryId();
    ;
    return interpolate(
                Fragment.lit("update `categories`\nset `parent_id` = "),
                Fragment.encode(CategoriesId.pgType.opt(), row.parentId()),
                Fragment.lit(",\n`name` = "),
                Fragment.encode(MariaTypes.varchar, row.name()),
                Fragment.lit(",\n`slug` = "),
                Fragment.encode(MariaTypes.varchar, row.slug()),
                Fragment.lit(",\n`description` = "),
                Fragment.encode(MariaTypes.mediumtext.opt(), row.description()),
                Fragment.lit(",\n`image_url` = "),
                Fragment.encode(MariaTypes.varchar.opt(), row.imageUrl()),
                Fragment.lit(",\n`sort_order` = "),
                Fragment.encode(MariaTypes.smallint, row.sortOrder()),
                Fragment.lit(",\n`is_visible` = "),
                Fragment.encode(MariaTypes.bool, row.isVisible()),
                Fragment.lit(",\n`metadata` = "),
                Fragment.encode(MariaTypes.longtext.opt(), row.metadata()),
                Fragment.lit("\nwhere `category_id` = "),
                Fragment.encode(CategoriesId.pgType, categoryId),
                Fragment.lit(""))
            .update()
            .runUnchecked(c)
        > 0;
  }
  ;

  @Override
  public CategoriesRow upsert(CategoriesRow unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "INSERT INTO `categories`(`parent_id`, `name`, `slug`, `description`, `image_url`,"
                    + " `sort_order`, `is_visible`, `metadata`)\n"
                    + "VALUES ("),
            Fragment.encode(CategoriesId.pgType.opt(), unsaved.parentId()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar, unsaved.name()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar, unsaved.slug()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.mediumtext.opt(), unsaved.description()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.varchar.opt(), unsaved.imageUrl()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.smallint, unsaved.sortOrder()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.bool, unsaved.isVisible()),
            Fragment.lit(", "),
            Fragment.encode(MariaTypes.longtext.opt(), unsaved.metadata()),
            Fragment.lit(
                ")\n"
                    + "ON DUPLICATE KEY UPDATE `parent_id` = VALUES(`parent_id`),\n"
                    + "`name` = VALUES(`name`),\n"
                    + "`slug` = VALUES(`slug`),\n"
                    + "`description` = VALUES(`description`),\n"
                    + "`image_url` = VALUES(`image_url`),\n"
                    + "`sort_order` = VALUES(`sort_order`),\n"
                    + "`is_visible` = VALUES(`is_visible`),\n"
                    + "`metadata` = VALUES(`metadata`)\n"
                    + "RETURNING `category_id`, `parent_id`, `name`, `slug`, `description`,"
                    + " `image_url`, `sort_order`, `is_visible`, `metadata`"))
        .updateReturning(CategoriesRow._rowParser.exactlyOne())
        .runUnchecked(c);
  }
  ;

  @Override
  public List<CategoriesRow> upsertBatch(Iterator<CategoriesRow> unsaved, Connection c) {
    return interpolate(
            Fragment.lit(
                "INSERT INTO `categories`(`category_id`, `parent_id`, `name`, `slug`,"
                    + " `description`, `image_url`, `sort_order`, `is_visible`, `metadata`)\n"
                    + "VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n"
                    + "ON DUPLICATE KEY UPDATE `parent_id` = VALUES(`parent_id`),\n"
                    + "`name` = VALUES(`name`),\n"
                    + "`slug` = VALUES(`slug`),\n"
                    + "`description` = VALUES(`description`),\n"
                    + "`image_url` = VALUES(`image_url`),\n"
                    + "`sort_order` = VALUES(`sort_order`),\n"
                    + "`is_visible` = VALUES(`is_visible`),\n"
                    + "`metadata` = VALUES(`metadata`)\n"
                    + "RETURNING `category_id`, `parent_id`, `name`, `slug`, `description`,"
                    + " `image_url`, `sort_order`, `is_visible`, `metadata`"))
        .updateReturningEach(CategoriesRow._rowParser, unsaved)
        .runUnchecked(c);
  }
  ;
}
